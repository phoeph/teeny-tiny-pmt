<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>项目详情 - 项目管理系统</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
</head>
<body>
  <div id="left-sidebar"></div>
  <div class="header" style="display:flex; align-items:center;">
    <div class="header-left" style="display:flex; align-items:center; gap:12px;">
      <div id="breadcrumb" class="breadcrumb"></div>
    </div>
    <div class="header-center" style="flex:1; display:none;">
      <div id="projectHeader" style="font-weight:600;"></div>
    </div>
    <div class="header-right" style="display:flex; align-items:center; gap:12px;">
      <button id="globalAddJob" class="primary-btn">新增JOB</button>
      <div class="view-toggle">
        <button id="btnGantt" class="toggle-btn active" title="甘特视图"><span>Gantt</span><svg id="btnGanttCaret" viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg></button>
        <button id="btnCard" class="toggle-btn" title="卡片视图">Card</button>
      </div>
      <div id="userMenuContainer"></div>
    </div>
  </div>
  <div id="projectMeta"></div>
  <div class="jira-card" style="margin-top:24px; position:relative;"><h4 style="display:flex; align-items:center;">Description<span id="projDescMenu" class="desc-menu-btn" title="编辑" style="display:none; margin-left:auto;"><svg viewBox="0 0 24 24" width="18" height="18"><circle cx="5" cy="12" r="2" fill="var(--primary)"/><circle cx="12" cy="12" r="2" fill="var(--primary)"/><circle cx="19" cy="12" r="2" fill="var(--primary)"/></svg></span></h4><div id="issueDescProject" class="jira-desc"></div><div id="projDescEditor" style="margin-top:8px; display:none;"></div></div>
  <div id="projectMeta"></div>

  <div id="cardView" class="fade hidden">
    <div class="columns">
      <div class="col" id="col-todo">
        <h3>To Do</h3>
        <div class="kanban-list" id="todo"></div>
      </div>
      <div class="col" id="col-doing">
        <h3>In Progress</h3>
        <div class="kanban-list" id="doing"></div>
      </div>
      <div class="col" id="col-done">
        <h3>Done</h3>
        <div class="kanban-list" id="done"></div>
      </div>
    </div>
  </div>

  <div id="ganttView" class="fade visible">
    <div class="gantt">
    
      <div class="gantt-container">
        <div class="gantt-header">
          <div class="task-header">任务
            <div style="margin-left:auto; display:flex; align-items:center; gap:6px;">
              
            </div>
          </div>
          <div class="assignee-header">负责人</div>
          <div class="priority-header">优先级</div>
          <div class="time-header">
            <div class="year-row" id="yearRow"></div>
            <div class="month-row" id="monthRow"></div>
            <div class="day-row" id="dayRow"></div>
          </div>
        </div>
        <div class="gantt-body">
          <div class="task-list" id="taskList"></div>
          <div class="assignee-list" id="assigneeList"></div>
          <div class="priority-list" id="priorityList"></div>
          <div class="timeline">
            <div class="timeline-container" id="timelineContainer">
              <div class="timeline" id="timeline"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <div class="modal-backdrop" id="taskModalBackdrop">
      <div class="modal" id="taskModal">
        <h4>新增任务</h4>
        <div class="row"><label>所属JOB<span style="color:var(--danger)">*</span></label><select id="taskJobSelect"></select></div>
        <div class="row"><label>任务标题<span style="color:var(--danger)">*</span></label><input id="taskTitleInput" placeholder="请输入任务标题" /></div>
        <div class="row"><label>任务描述</label><textarea id="taskDescInput" placeholder="请输入任务描述" rows="3"></textarea></div>
        <div class="row"><label>负责人<span style="color:var(--danger)">*</span></label><input id="taskAssigneeInput" placeholder="请输入负责人" /></div>
        <div class="row"><label>状态<span style="color:var(--danger)">*</span></label><select id="taskStatusSelect"><option value="todo">待办</option><option value="doing">进行中</option><option value="blocked">阻塞</option><option value="done">已完成</option><option value="cancelled">已取消</option></select></div>
        <div class="row"><label>优先级</label><select id="taskPrioritySelect"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
        <div class="row" style="display:flex; gap:8px;">
          <div style="flex:1"><label>开始日期</label><input id="taskStartInput" type="datetime-local" step="1" /></div>
          <div style="flex:1"><label>结束日期</label><input id="taskEndInput" type="datetime-local" step="1" /></div>
        </div>
        <div class="row"><span id="taskDateError" style="color:var(--danger)"></span></div>
        <div class="actions">
          <button class="ghost-btn" id="taskCancelBtn">取消</button>
          <button class="primary-btn" id="taskCreateBtn">创建</button>
        </div>
      </div>
    </div>
    <div class="modal-backdrop" id="taskEditModalBackdrop">
      <div class="modal" id="taskEditModal">
        <h4>编辑任务</h4>
        <div class="row"><label>任务标题<span style="color:var(--danger)">*</span></label><input id="taskEditTitleInput" placeholder="请输入任务标题" /></div>
        <div class="row"><label>负责人<span style="color:var(--danger)">*</span></label><input id="taskEditAssigneeInput" placeholder="请输入负责人" /></div>
        <div class="row"><label>任务描述</label><textarea id="taskEditDescInput" placeholder="请输入任务描述" rows="3" style="min-height:60px; resize:vertical; padding:8px; border:1px solid var(--border-color); border-radius:8px; width:100%; background:var(--bg-input);"></textarea></div>
        <div class="row" style="display:flex; gap:8px;">
          <div style="flex:1"><label>开始日期<span style="color:var(--danger)">*</span></label><input id="taskEditStartInput" type="datetime-local" step="1" /></div>
          <div style="flex:1"><label>结束日期<span style="color:var(--danger)">*</span></label><input id="taskEditEndInput" type="datetime-local" step="1" /></div>
        </div>
      <div class="row"><label>状态<span style="color:var(--danger)">*</span></label><select id="taskEditStatusSelect"><option value="todo">待办</option><option value="doing">进行中</option><option value="blocked">阻塞</option><option value="done">已完成</option><option value="cancelled">已取消</option></select></div>
      <div class="row"><label>优先级</label><select id="taskEditPrioritySelect"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
      <div class="row"><label>预估工时</label><input id="taskEditEstimatedHoursInput" type="number" min="0" step="0.5" placeholder="小时" /></div>
      <div class="row"><label>实际工时</label><input id="taskEditActualHoursInput" type="number" min="0" step="0.5" placeholder="小时" /></div>
      <div class="row"><label>完成时间</label><input id="taskEditCompletedAtInput" type="datetime-local" /></div>
        <div class="actions">
          <button class="ghost-btn" id="taskEditCancelBtn">取消</button>
          <button class="primary-btn" id="taskEditSaveBtn">保存</button>
        </div>
      </div>
    </div>
    <div class="modal-backdrop" id="jobModalBackdrop">
      <div class="modal" id="jobModal">
        <h4>新增JOB</h4>
        <div class="row"><label>任务标题<span style="color:var(--danger)">*</span></label><input id="jobTitleInput" placeholder="请输入任务标题" /></div>
        <div class="row"><label>任务描述</label><textarea id="jobDescInput" placeholder="请输入JOB描述" rows="3"></textarea></div>
        <div class="row"><label>负责人<span style="color:var(--danger)">*</span></label><input id="jobAssigneeInput" placeholder="请输入负责人" /></div>
        <div class="row"><label>状态<span style="color:var(--danger)">*</span></label><select id="jobStatusSelect"><option value="todo">待办</option><option value="doing">进行中</option><option value="blocked">阻塞</option><option value="done">已完成</option><option value="cancelled">已取消</option></select></div>
        <div class="row"><label>优先级</label><select id="jobPrioritySelect"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
        <div class="row" style="display:flex; gap:8px;">
          <div style="flex:1"><label>开始日期<span style="color:var(--danger)">*</span></label><input id="jobStartInput" type="datetime-local" step="1" /></div>
          <div style="flex:1"><label>结束日期<span style="color:var(--danger)">*</span></label><input id="jobEndInput" type="datetime-local" step="1" /></div>
        </div>
        <div class="row"><span id="jobTitleError" style="color:var(--danger)"></span></div>
        <div class="row"><span id="jobDateError" style="color:var(--danger)"></span></div>
        <div class="actions">
          <button class="ghost-btn" id="jobCancelBtn">取消</button>
          <button class="primary-btn" id="jobCreateBtn">创建</button>
        </div>
      </div>
    </div>
    <div class="modal-backdrop" id="jobEditModalBackdrop">
      <div class="modal" id="jobEditModal">
        <h4>编辑JOB</h4>
        <div class="row"><label>任务名称<span style="color:var(--danger)">*</span></label><input id="jobEditTitleInput" placeholder="请输入任务名称" /></div>
        <div class="row"><label>负责人<span style="color:var(--danger)">*</span></label><input id="jobEditAssigneeInput" placeholder="请输入负责人" /></div>
        <div class="row"><label>任务描述</label><textarea id="jobEditDescInput" placeholder="请输入任务描述" rows="3" style="min-height:60px; resize:vertical; padding:8px; border:1px solid var(--border-color); border-radius:8px; width:100%; background:var(--bg-input);"></textarea></div>
        <div class="row" style="display:flex; gap:8px;">
          <div style="flex:1"><label>开始日期<span style="color:var(--danger)">*</span></label><input id="jobEditStartInput" type="datetime-local" step="1" /></div>
          <div style="flex:1"><label>结束日期<span style="color:var(--danger)">*</span></label><input id="jobEditEndInput" type="datetime-local" step="1" /></div>
        </div>
      <div class="row"><label>状态<span style="color:var(--danger)">*</span></label><select id="jobEditStatusSelect"><option value="todo">待办</option><option value="doing">进行中</option><option value="blocked">阻塞</option><option value="done">已完成</option><option value="cancelled">已取消</option></select></div>
      <div class="row"><label>优先级</label><select id="jobEditPrioritySelect"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div>
      <div class="row"><label>预估工时</label><input id="jobEditEstimatedHoursInput" type="number" min="0" step="0.5" placeholder="小时" /></div>
      <div class="row"><label>实际工时</label><input id="jobEditActualHoursInput" type="number" min="0" step="0.5" placeholder="小时" /></div>
      <div class="row"><label>完成时间</label><input id="jobEditCompletedAtInput" type="datetime-local" /></div>
        <div class="actions">
          <button class="ghost-btn" id="jobEditCancelBtn">取消</button>
          <button class="primary-btn" id="jobEditSaveBtn">保存</button>
        </div>
    </div>
    </div>
    
    

  <div class="gantt" style="margin-top:24px;">
    <div class="jira-tabs" style="margin-top:8px;">
      <div class="jira-tab active" id="tabComments">Comments</div>
    </div>
    <div id="commentsPane">
      <div id="comments"></div>
      <div id="commentEditor" style="margin-top:12px;"></div>
      <div style="margin-top:8px;"><span id="commentError" style="color:var(--danger);"></span></div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="addCommentBtn" class="primary-btn">添加评论</button>
        <button id="cancelCommentBtn" class="ghost-btn" style="display:none;">取消</button>
      </div>
    </div>
  </div>

  <style>
    .task-name-wrapper {
      display: flex;
      align-items: center;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      padding-right: 4px;
    }
    .collapse-btn {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      margin-right: 4px;
      transition: transform 0.2s;
      flex-shrink: 0;
      border-radius: 4px;
    }
    .collapse-btn:hover {
      background: var(--bg-hover);
      color: var(--text-main);
    }
    .collapse-btn.collapsed {
      transform: rotate(-90deg);
    }
    .more-btn {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
      transition: all 0.2s;
      margin-left: 4px;
      flex-shrink: 0;
    }
    .task-row:hover .more-btn {
      opacity: 1;
    }
    .more-btn:hover {
      background: var(--bg-hover);
      color: var(--text-main);
    }
    .action-dropdown {
      position: fixed;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      border-radius: 8px;
      padding: 4px;
      z-index: 10000;
      min-width: 140px;
      display: none;
      animation: fadeIn 0.1s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0.6; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .action-dropdown.show {
      display: block;
    }
    .action-item {
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-main);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .action-item:hover {
      background: var(--bg-hover);
    }
    .action-item.danger {
      color: var(--danger);
    }
    .action-item.danger:hover {
      background: var(--bg-danger-light);
    }
    .action-separator {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }
    /* Hide old buttons if they exist */
    .btn-icon[data-role="add"], .btn-icon[data-role="edit-job"], .btn-icon[data-role="del-job"], .btn-icon[data-role="edit-task"], .btn-icon[data-role="del-task"] {
        display: none !important;
    }

    /* Fix Column Alignment - Enforce fixed height for all rows */
    .task-row, .task-row-timeline, .assignee-row, .priority-row {
      height: 40px !important;
      line-height: 40px !important;
      box-sizing: border-box;
      overflow: hidden;
      margin: 0 !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      display: flex;
      align-items: center;
    }
    .task-row-timeline {
      position: relative; /* For absolute positioning of bars */
    }
    .task-name-wrapper { height: 100%; display: flex; align-items: center; }
    
    /* Fix Modal Overlap */
    .modal .row {
      margin-bottom: 16px;
      position: relative;
      /* Override modern-theme.css .row styles */
      height: auto !important;
      display: block !important;
      border-bottom: none !important;
      padding: 0 !important;
    }
    .modal label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      box-sizing: border-box;
    }

    /* Fix Modal Scroll - Limit height and enable scrolling */
    .modal {
      max-height: 90vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* Kanban Card Styles */
    .card { padding:10px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:10px; background:var(--bg-surface); box-shadow:0 1px 2px rgba(0,0,0,0.04); cursor:grab; transition: transform 120ms ease, box-shadow 120ms ease; }
    .card-header { display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--text-secondary); margin-bottom:4px; }
    .card-header .left { display:flex; align-items:center; gap:6px; }
    .card-header .center { display:flex; align-items:center; gap:8px; flex:1; justify-content:center; }
    .card-header .right { display:flex; align-items:center; gap:8px; }
    .card .title { font-weight:500; color:var(--text-main); margin-bottom:6px; font-size:14px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .card .meta { font-size:12px; color:var(--text-secondary); }
    .status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; }
    .dot-orange { background:var(--warning); }
    .dot-green { background:var(--success); }
    .dot-blue { background:var(--primary); }
    .status-todo { border-left:4px solid var(--warning); }
    .status-doing { border-left:4px solid var(--success); }
    .status-done { border-left:4px solid var(--primary); }
    .card.dragging { opacity: 0.8; transform: scale(0.98); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .kanban-list.drop-active { outline: 2px solid var(--primary); background: rgba(59,130,246,0.08); transition: background 0.12s ease; }

    /* Priority Styles */
    .priority-row { justify-content: center !important; }
    .priority-badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:12px; color:#fff; font-weight:500; line-height:1.5; }
    .priority-low { background-color:var(--success); }
    .priority-medium { background-color:var(--warning); color:#fff; }
    .priority-high { background-color:var(--danger); }
  </style>

  <link rel="stylesheet" href="assets/issue-layout.css" />
  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <script src="assets/rich-editor.js"></script>
  <script src="assets/meta-panel.js"></script>
  <script src="assets/label-cascader-multi.js"></script>
  <script src="assets/page-history.js"></script>
  <script src="assets/header-user-menu.js"></script>
  <script src="assets/left-sidebar.js"></script>
  <script src="assets/ux-enhancements.js"></script>
  <script src="assets/comments.js"></script>
  <script>
    // 全局滚动监听：滚动时显示滚动条，停止2秒后隐藏
    document.addEventListener('scroll', function(e) {
      const target = e.target;
      // 排除 document 自身滚动（通常是 window 滚动，但 e.target 可能是 document）
      // 只有元素节点的滚动才处理样式
      if (target.nodeType === 1) { 
        target.classList.add('is-scrolling');
        
        if (target._scrollTimeout) {
          clearTimeout(target._scrollTimeout);
        }
        
        target._scrollTimeout = setTimeout(() => {
          target.classList.remove('is-scrolling');
          target._scrollTimeout = null;
        }, 2000);
      }
    }, true); // useCapture = true 以捕获所有子元素的滚动

    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    const params = new URLSearchParams(location.search);
    const idParam = params.get('id');
    
    const parsedId = parseInt(idParam || '', 10);
    const projectId = parsedId;
    window.__projectId = projectId;
    window.__pageHistoryKey = `project:${projectId}`;
    PageHistory.init(window.__pageHistoryKey);
    
    if (!Number.isFinite(projectId)) {
      // 缺少或非法的项目ID参数
      document.getElementById('projectHeader').textContent = '错误：缺少项目ID参数';
      
      // 显示友好的错误页面
      const mainContent = document.querySelector('.main-content') || document.body;
      mainContent.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.7;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <h3 style="margin: 0 0 8px 0; color: var(--text-main);">项目ID参数缺失</h3>
          <p style="margin: 0 0 16px 0; color: var(--text-secondary);">请通过项目列表页面访问具体项目</p>
          <button onclick="location.href='projects.html'" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">返回项目列表</button>
        </div>
      `;
    } else {
      // 项目ID有效，继续执行正常的页面逻辑

    function fmtDate(d) { return d ? new Date(d) : null; }
    function __getPlannedStartStr(i){ return i && (i.planned_start_date || i.planned_start) || null; }
    function __getPlannedEndStr(i){ return i && (i.planned_end_date || i.planned_end) || null; }
    function __normalizeWorkItemShape(i){
      if (!i) return i;
      if (i.planned_start_date && !i.planned_start) i.planned_start = i.planned_start_date;
      if (i.planned_end_date && !i.planned_end) i.planned_end = i.planned_end_date;
      return i;
    }
    function __findFullItem(ref){
      const items = Array.isArray(window.__items) ? window.__items : [];
      const rid = ref && (ref.id||ref.code);
      if (!rid) return ref;
      for (let i=0;i<items.length;i++){
        const it = items[i];
        if ((it.id===ref.id) || (it.code===ref.code)) return it;
        const subs = it.subtasks || [];
        for (let j=0;j<subs.length;j++){
          const s = subs[j];
          if ((s.id===ref.id) || (s.code===ref.code)) return s;
        }
      }
      return ref;
    }
    function __displayName(i){
      if(!i) return '-';
      const isTask = String(i.kind||'').toUpperCase()==='TASK' || !!(i.parent_id || i.parentId || i.parent || i.parent_code || i.parentCode);
      const name = (i.title || i.name || i.code || '-');
      if(!isTask) return __limitChars(String(name||'-').trim(), 8);
      try{
        let pcode = String(i.parent_code || i.parentCode || i.parent || '').trim();
        if(!pcode) pcode = __parentJobCodeOfItem(i) || '';
        const items = Array.isArray(window.__items)? window.__items : [];
        const jobs = Array.isArray(window.__jobs)? window.__jobs : [];
        const parent = items.find(x=> x.kind==='JOB' && (x.code===pcode))
          || jobs.find(x=> x.code===pcode)
          || items.find(x=> x.kind==='JOB' && (Array.isArray(x.subtasks) && x.subtasks.find(s=> (s.id===i.id)||(s.code===i.code))));
        const jobName = parent ? (parent.title || parent.name || parent.code || '') : (pcode || '');
        const j = __limitChars(String(jobName||'').trim(), 8);
        const t = __limitChars(String(name||'').trim(), 8);
        return (j? (j + '：' + t) : t) || '-';
      }catch(_){ return __limitChars(String(name||'-').trim(), 8); }
    }
    function __fullDisplayName(i){
      if(!i) return '-';
      const isTask = String(i.kind||'').toUpperCase()==='TASK' || !!(i.parent_id || i.parentId || i.parent || i.parent_code || i.parentCode);
      const name = (i.title || i.name || i.code || '-');
      if(!isTask) return String(name||'-').trim() || '-';
      try{
        let pcode = String(i.parent_code || i.parentCode || i.parent || '').trim();
        if(!pcode) pcode = __parentJobCodeOfItem(i) || '';
        const items = Array.isArray(window.__items)? window.__items : [];
        const jobs = Array.isArray(window.__jobs)? window.__jobs : [];
        const parent = items.find(x=> x.kind==='JOB' && (x.code===pcode))
          || jobs.find(x=> x.code===pcode)
          || items.find(x=> x.kind==='JOB' && (Array.isArray(x.subtasks) && x.subtasks.find(s=> (s.id===i.id)||(s.code===i.code))));
        const jobName = parent ? (parent.title || parent.name || parent.code || '') : (pcode || '');
        const j = String(jobName||'').trim();
        const t = String(name||'').trim();
        return (j? (j + '：' + t) : t) || '-';
      }catch(_){ return String(name||'-').trim() || '-'; }
    }
    function __composeJobTask(job, task, max){
      const jFull = String((job && (job.title || job.name || job.code)) || '').trim();
      const tFull = String((task && (task.title || task.name || task.code)) || '').trim();
      const jShort = __limitChars(jFull, max);
      const tShort = __limitChars(tFull, max);
      return {
        short: (jShort ? (jShort + '：' + tShort) : tShort) || '-',
        full: (jFull ? (jFull + '：' + tFull) : tFull) || '-'
      };
    }
    function __limitChars(str, max){ try{ const arr=Array.from(String(str||'')); if(arr.length<=max) return String(str||''); return arr.slice(0,max).join('') + '...'; }catch(_){ const s=String(str||''); return s.length>max? (s.slice(0,max)+'...') : s; } }
    function __titleOrCode(i){ if(!i) return '-'; const t = i.title || i.name || i.description || i.code; const s = (t==null? '' : String(t)).trim(); return s? __limitChars(s, 10) : '-'; }
    function __codeOf(ref){ try{ const items=Array.isArray(window.__items)? window.__items : []; const rid = ref && (ref.id||ref.code); if(!rid) return ''; for(const it of items){ if((it.id===ref.id) || (it.code===ref.code) || (it.id===rid) || (it.code===rid)){ return String(it.code||''); } const subs=it.subtasks||[]; for(const s of subs){ if((s.id===ref.id) || (s.code===ref.code) || (s.id===rid) || (s.code===rid)){ return String(s.code||''); } } } return typeof rid==='string'? rid : String(rid||''); }catch(_){ return ''; } }
    function __toLocalInputValue(dtStr){
      try{
        if(!dtStr) return '';
        const d = new Date(dtStr);
        if(isNaN(d.getTime())) return '';
        // Convert to East 8 time string for datetime-local input
        // Add 8 hours to UTC timestamp to shift "UTC face value" to "East 8 face value"
        const ms = d.getTime() + (8 * 3600000);
        return new Date(ms).toISOString().slice(0, 19);
      }catch(_){ return ''; }
    }
    function colorForStatus(s) { return s === 'done' ? 'var(--primary)' : (s === 'doing' ? 'var(--success)' : 'var(--warning)'); }
    function enableDnD() {
      ['todo','doing','done'].forEach(id => {
        const container = document.getElementById(id);
        container.addEventListener('dragstart', ev => {
          const el = ev.target.closest('.card');
          if (!el) return;
          const val = el.dataset.wid || el.dataset.code || '';
          try { ev.dataTransfer.setData('text/plain', val); } catch (e) {}
          try { ev.dataTransfer.setData('text', val); } catch (e) {}
          ev.dataTransfer.effectAllowed = 'move';
          el.classList.add('dragging');
        });
        container.addEventListener('dragend', ev => { const el = ev.target.closest('.card'); if (el) el.classList.remove('dragging'); }, true);
        container.addEventListener('dragenter', ev => { const col = ev.currentTarget; col.classList.add('drop-active'); }, true);
        container.addEventListener('dragleave', ev => { const col = ev.currentTarget; col.classList.remove('drop-active'); }, true);
      });
      const setDrop = (colId, status) => {
        const col = document.getElementById(colId);
        col.addEventListener('dragover', ev => { ev.preventDefault(); if (ev.dataTransfer) ev.dataTransfer.dropEffect = 'move'; }, true);
        col.addEventListener('drop', async ev => {
          ev.preventDefault();
          const wid = ev.dataTransfer.getData('text/plain');
          const fallback = wid || ev.dataTransfer.getData('text');
          const idOrCode = fallback;
          if (!idOrCode) return;
          await performStatusChange(idOrCode, status);
          col.classList.remove('drop-active');
          col.classList.add('drop-flash');
          setTimeout(()=>col.classList.remove('drop-flash'), 300);
        }, true);
      };
      setDrop('todo','todo');
      setDrop('doing','doing');
      setDrop('done','done');
      bindTouchDnD();
    }

    async function performStatusChange(idOrCode, status) {
      const body = { status };
      try {
        const item = (window.__items || []).find(x => String(x.id) === String(idOrCode) || String(x.code) === String(idOrCode));
        const hasTasks = item && Array.isArray(item.subtasks) && item.subtasks.length > 0;
        const isJob = item && (hasTasks || !(item.parent_id || item.parentId || item.parent || item.parent_code || item.parentCode));
        if (isJob && hasTasks) {
          const dlg = document.createElement('div'); dlg.style.position='fixed'; dlg.style.inset='0'; dlg.style.background='var(--modal-overlay)'; dlg.style.display='flex'; dlg.style.alignItems='center'; dlg.style.justifyContent='center'; dlg.style.zIndex='9999'; const box=document.createElement('div'); box.style.background='var(--bg-surface)'; box.style.borderRadius='8px'; box.style.padding='16px'; box.style.width='400px'; box.innerHTML=`<div style="font-weight:600; color:var(--text-main);">此操作将使该JOB下的所有TASK状态同步变更为「${status}」</div><div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;"><button id="__dlgCancel" class="user-btn-ghost">取消</button><button id="__dlgOk" class="user-btn-primary">确认</button></div>`; dlg.appendChild(box); document.body.appendChild(dlg);
          await new Promise((resolve)=>{ box.querySelector('#__dlgCancel').onclick=function(){ dlg.remove(); resolve(false); }; box.querySelector('#__dlgOk').onclick=function(){ dlg.remove(); resolve(true); }; });
          const eid = item.id || idOrCode;
          const res2 = await fetch(`${API}/work-items/${eid}/cascade-status`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ status }) });
          if (res2.ok) { showToast('状态联动成功', 'success'); await fetchWorkItems(); return; }
          const changes = [];
          changes.push({ idOrCode: eid, status });
          (item.subtasks||[]).forEach(st=>{ const cid=st.id||st.code; if(cid) changes.push({ idOrCode: cid, status }); });
          const updated = await __batchPatch(changes);
          if (updated && updated.length>=0) { await fetchWorkItems(); showToast('状态联动完成', 'success'); return; }
          else { showToast('联动失败', 'error'); return; }
        }
        const res = await fetch(`${API}/work-items/${idOrCode}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify(body) });
        if (res.ok) { showToast('状态更新成功', 'success'); await fetchWorkItems(); }
        else { await __showErrorFromResponse(res, '更新失败'); }
      } catch (err) {
        console.error('[kanban] patch error', err);
        showToast('网络错误，更新失败', 'error');
      }
    }

    function bindTouchDnD() {
      const lists = ['todo','doing','done'];
      let dragCard = null; let startX=0, startY=0;
      lists.forEach(id=>{
        const container = document.getElementById(id);
        container.addEventListener('touchstart', (e)=>{
          const t = e.target.closest('.card'); if (!t) return; dragCard = t; dragCard.classList.add('dragging'); const touch=e.touches[0]; startX=touch.clientX; startY=touch.clientY; }, { passive: true });
        container.addEventListener('touchmove', (e)=>{
          if (!dragCard) return; const touch=e.touches[0]; const el = document.elementFromPoint(touch.clientX, touch.clientY); lists.forEach(k=>document.getElementById(k).classList.remove('drop-active')); const targetList = el ? el.closest('.kanban-list') : null; if (targetList) targetList.classList.add('drop-active'); }, { passive: true });
        container.addEventListener('touchend', async (e)=>{
          if (!dragCard) return; const touch=e.changedTouches[0]; const el = document.elementFromPoint(touch.clientX, touch.clientY);
          let target = el ? el.closest('.kanban-list') : null; let status=null; if (target) { if (target.id==='todo') status='todo'; else if (target.id==='doing') status='doing'; else if (target.id==='done') status='done'; }
          lists.forEach(k=>document.getElementById(k).classList.remove('drop-active')); dragCard.classList.remove('dragging');
          if (status) {
            const idOrCode = dragCard.dataset.wid || dragCard.dataset.code || '';
            await performStatusChange(idOrCode, status);
          } else { showToast('未识别投放区域', 'error'); }
          dragCard = null;
        }, { passive: true });
      });
    }

    function __initBoardToggle(){ try {
      const btnG = document.getElementById('btnGantt');
      const btnC = document.getElementById('btnCard');
      const gantt = document.getElementById('ganttView');
      const card = document.getElementById('cardView');
      function setActive(which){
        const showG = (which === 'gantt');
        if (gantt) { gantt.classList.toggle('visible', showG); gantt.classList.toggle('hidden', !showG); }
        if (card) { card.classList.toggle('visible', !showG); card.classList.toggle('hidden', showG); }
        if (btnG) { btnG.classList.toggle('active', showG); }
        if (btnC) { btnC.classList.toggle('active', !showG); }
        try{ const k = 'board_view_' + String(projectId || ''); localStorage.setItem(k, which); }catch(_){ }
      }
      function openGanttModeDropdown(anchor){
        try{
          let menu = document.getElementById('ganttModeDropdown');
          if (!menu) {
            menu = document.createElement('div');
            menu.id = 'ganttModeDropdown';
            menu.className = 'dropdown';
            document.body.appendChild(menu);
          }
          const rect = anchor.getBoundingClientRect();
          menu.style.display = 'block';
          menu.style.left = (rect.left + window.scrollX) + 'px';
          menu.style.top = (rect.bottom + window.scrollY) + 'px';
          const current = (typeof timeMode === 'string') ? timeMode : 'day';
          menu.innerHTML = [
            `<div class="dropdown-item" data-mode="day">日${current==='day' ? ' ✓' : ''}</div>`,
            `<div class="dropdown-item" data-mode="month">月${current==='month' ? ' ✓' : ''}</div>`
          ].join('');
          menu.querySelectorAll('.dropdown-item').forEach(function(it){
            it.onclick = function(){ const m = this.getAttribute('data-mode') || 'day'; try{ switchTimeMode(m); }catch(_){} menu.style.display='none'; };
          });
          const hider = function(e){ if(!menu.contains(e.target) && e.target!==anchor){ menu.style.display='none'; document.removeEventListener('mousedown', hider, true); } };
          setTimeout(function(){ document.addEventListener('mousedown', hider, true); }, 0);
        }catch(_){ }
      }
      window.__setBoardView = setActive;
      if (btnG) btnG.onclick = function(){ setActive('gantt'); };
      const caret = document.getElementById('btnGanttCaret');
      if (caret) caret.onclick = function(ev){ ev.stopPropagation(); openGanttModeDropdown(btnG); };
      if (btnC) btnC.onclick = function(){ setActive('card'); };
      try{
        const k = 'board_view_' + String(projectId || '');
        const saved = localStorage.getItem(k);
        if (saved === 'card' || saved === 'gantt') { setActive(saved); }
        else { setActive('gantt'); }
      }catch(_){ setActive('gantt'); }
    } catch (_) { } }

    document.addEventListener('DOMContentLoaded', function(){ __initBoardToggle(); });
    document.addEventListener('DOMContentLoaded', function(){ try{ var btn=document.getElementById('addCommentBtn'); var editor=document.getElementById('commentEditor'); if(btn && editor){ btn.addEventListener('click', function(){ var r=editor.getBoundingClientRect(); var vh=window.innerHeight || document.documentElement.clientHeight; if(r.bottom>vh){ window.scrollBy({ top: (r.bottom - vh) + 24, behavior: 'smooth' }); } else { editor.scrollIntoView({ behavior:'smooth', block:'center' }); } }); } }catch(_){ } });
    document.addEventListener('click', function(ev){ try{ var item = ev.target.closest('#priorityDropdown .dropdown-item'); if(!item) return; var p = item.getAttribute('data-p') || 'medium'; var link = document.getElementById('priorityEditLink'); var lab = document.getElementById('priorityLabel'); var color = (p==='low') ? 'var(--success)' : (p==='high' ? 'var(--danger)' : 'var(--warning)'); if(lab) { lab.textContent = (p==='low' ? 'Low' : (p==='high' ? 'High' : 'Medium')); } if(link){ var path = link.querySelector('path'); if(path){ path.setAttribute('fill', color); } } var menu = document.getElementById('priorityDropdown'); if(menu){ menu.style.width = '140px'; menu.style.minWidth = '120px'; } }catch(_){ } });

    async function fetchProject() {
      if (!Number.isFinite(projectId)) return;
      try {
        const res = await fetch(`${API}/projects/${projectId}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('backend unavailable');
        const p = await res.json();
        document.getElementById('projectHeader').textContent = `[${p.code} · ${p.name}]`;
        const metaTarget = document.getElementById('projectMeta');
        const bc = `<a href="projects.html">Projects</a> / ${p.code}`;
        const entity = normalizeEntity('project', p, { project: p });
        renderJiraIssueLayout(metaTarget, entity, { breadcrumb: bc, counter: '', linksHtml: '', hideHeader: true, rawProject: p });
        try{ setupLabelEditor(metaTarget, entity, { rawProject: p, project_id: p.id }); }catch(_){}
        try {
          const topBc = document.getElementById('breadcrumb');
          if (topBc) {
            topBc.innerHTML = `<a href="projects.html">Projects</a><span class="sep">/</span>${p.code} · ${p.name}`;
          }
        } catch (_) {}
        const descEl = document.getElementById('issueDescProject'); if(descEl) descEl.innerHTML = (p.description || '') || '暂无描述';
        try{ const meRes = await fetch(`${API}/auth/me`, { headers:{ Authorization:`Bearer ${token}` } }); if(meRes.ok){ const meRaw=await meRes.json(); const me=(meRaw && meRaw.user) ? meRaw.user : meRaw; window.__me = me; window.__isAdmin = !!(me && (me.username==='admin')); const canEdit = !!(me && ((me.username==='demo')||(me.username==='admin')||(me.id===p.creator_id))); const menu=document.getElementById('projDescMenu'); const editor=document.getElementById('projDescEditor'); if(menu){ menu.style.display = canEdit ? 'inline-flex' : 'none'; menu.onclick=function(){ if(!canEdit) return; editor.style.display='block'; const view=document.getElementById('issueDescProject'); if(view) view.style.display='none'; const ed = createRichEditor('projDescEditor', { entityType: 'project', entityId: projectId, saveText: '保存', onSave: async function(html){ try{ const res = await fetch(`${API}/projects/${projectId}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ description: html }) }); if(res.ok){ const view=document.getElementById('issueDescProject'); if(view){ view.innerHTML = html || '暂无描述'; view.style.display='block'; } editor.style.display='none'; showToast('描述已保存','success'); return true; } else { await __showErrorFromResponse(res); return false; } } catch (e) { showToast('网络错误：' + (e && e.message ? e.message : ''), 'error'); return false; } } }); ed.setHTML(p.description || ''); }; } }
        } catch (e) { }
        loadProjectAttachments();
      } catch (e) {
        document.getElementById('projectHeader').textContent = '错误：项目加载失败';
        console.error('[project] fetchProject failed', e);
      }
    }

    async function fetchWorkItems() {
      if (!Number.isFinite(projectId)) return;
      try{ await loadAssigneeDefaults(); }catch(_){}
      try{ await fetchDbAssignees(); }catch(_){}
      let data;
      try {
        const res = await fetch(`${API}/work-items/by-project/${projectId}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) { if (res.status===401) throw new Error('unauthorized'); throw new Error('backend unavailable'); }
        data = await res.json();
      } catch (e) {
        console.error('[project] fetchWorkItems failed', e);
        showToast(e && e.message==='unauthorized' ? '登录已过期，请重新登录' : '工作项加载失败', 'error');
        const prev = Array.isArray(window.__items) ? window.__items : [];
        data = { items: prev };
      }
      const norm = function(it){
        try{
          const email = it.assignee_email || it.owner_email || it.email || '';
          const rawPrefix = it.assignee_prefix || '';
          const raw = rawPrefix || it.assignee || it.owner || (email||'');
          const prefix = rawPrefix || __assigneeToPrefix(raw||'');
          it.assignee = prefix;
          if (Array.isArray(it.subtasks)) {
            it.subtasks = it.subtasks.map(function(s){
              const semail = s.assignee_email || s.owner_email || s.email || '';
              const srawPrefix = s.assignee_prefix || '';
              const sraw = srawPrefix || s.assignee || s.owner || (semail||'');
              const sprefix = srawPrefix || __assigneeToPrefix(sraw||'');
              return Object.assign({}, s, { assignee: sprefix });
            });
          }
        } catch(_){}
        return it;
      };
      let normalizedItems = (data.items || []).map(norm);
      const localAssign = __loadLocalAssignments();
      normalizedItems = normalizedItems.map(function(it){ const k=it.id||it.code; const lv = localAssign && localAssign[k]; if(typeof lv==='string' && lv.trim().length>0){ it.assignee = lv.trim(); }
        if(Array.isArray(it.subtasks)){
          it.subtasks = it.subtasks.map(function(s){ const sk=s.id||s.code; const lv2 = localAssign && localAssign[sk]; if(typeof lv2==='string' && lv2.trim().length>0){ s.assignee = lv2.trim(); } return s; });
        }
        return it; });
      const byStatus = { todo: [], doing: [], done: [] };
      const jobs = [];
      const tasksFlat = [];
      normalizedItems.forEach(it => {
        // 始终作为 JOB 渲染（后端列表仅返回 JOB + subtasks）
        byStatus[it.status]?.push({ kind: 'JOB', ...it });
        jobs.push(it);
        // 将子任务按自身状态分别加入对应列
        const kids = Array.isArray(it.subtasks) ? it.subtasks : [];
        kids.forEach(t => {
          const sameColumnWithParent = (String(it.status||'') === String(t.status||''));
          tasksFlat.push(t);
          if (!sameColumnWithParent) {
            byStatus[t.status]?.push({ kind: 'TASK', ...t });
          }
        });
      });
      try {  } catch (e) {}
      
      window.__items = normalizedItems || [];
      window.__jobs = jobs;
      window.__tasksFlat = tasksFlat;
      
      
      buildGanttTasks(window.__items);
      initGantt();
      
      renderKanban(byStatus);
      enableDnD();
      buildAssigneeSuggestions();
      hookAssigneeDelegation();
    }

    function renderAfterLocalUpdate(items) {
      const byStatus = { todo: [], doing: [], done: [] };
      items.forEach(i => { if (i.code && i.code.startsWith('JOB')) byStatus[i.status].push({ kind: 'JOB', ...i }); });
      items.forEach(i => { if (i.code && i.code.startsWith('TASK')) byStatus[i.status].push({ kind: 'TASK', ...i }); });
      const norm = function(it){
        try{
          const email = it.assignee_email || it.owner_email || it.email || '';
          const rawPrefix = it.assignee_prefix || '';
          const raw = rawPrefix || it.assignee || it.owner || (email||'');
          const prefix = rawPrefix || __assigneeToPrefix(raw||'');
          it.assignee = prefix;
          if (Array.isArray(it.subtasks)) {
            it.subtasks = it.subtasks.map(function(s){
              const semail = s.assignee_email || s.owner_email || s.email || '';
              const srawPrefix = s.assignee_prefix || '';
              const sraw = srawPrefix || s.assignee || s.owner || (semail||'');
              const sprefix = srawPrefix || __assigneeToPrefix(sraw||'');
              return Object.assign({}, s, { assignee: sprefix });
            });
          }
        } catch(_){}
        return it;
      };
      let normalized = (items||[]).map(norm);
      const localAssign2 = __loadLocalAssignments();
      normalized = normalized.map(function(it){ const k=it.id||it.code; const lv = localAssign2 && localAssign2[k]; if(typeof lv==='string' && lv.trim().length>0){ it.assignee = lv.trim(); }
        if(Array.isArray(it.subtasks)){
          it.subtasks = it.subtasks.map(function(s){ const sk=s.id||s.code; const lv2 = localAssign2 && localAssign2[sk]; if(typeof lv2==='string' && lv2.trim().length>0){ s.assignee = lv2.trim(); } return s; });
        }
        return it; });
      window.__items = normalized;
      
      buildGanttTasks(items);
      generateTimeColumns();
      renderAll();
      setupScrollSync();
      renderKanban(byStatus);
      enableDnD();
      buildAssigneeSuggestions();
      hookAssigneeDelegation();
    }

    function renderKanban(byStatus) {
      const mkCard = (item) => {
        const el = document.createElement('div');
        el.className = `card status-${item.status}`;
        el.dataset.wid = item.id || '';
        el.dataset.code = item.code || '';
        el.setAttribute('draggable','true');
        el.addEventListener('dragstart', ev => {
          const val = el.dataset.wid || el.dataset.code || '';
          try { ev.dataTransfer.setData('text/plain', val); } catch (e) {}
          try { ev.dataTransfer.setData('text', val); } catch (e) {}
          ev.dataTransfer.effectAllowed = 'move';
          
        });
        (function(){
          const codeStr = item.code || '';
          const prefix = (codeStr.match(/^([A-Z]+)/) || [null, ''])[1] || (item.kind||'');
          const first = prefix ? prefix.charAt(0) : '';
          const rest = prefix ? prefix.slice(1) : '';
          let countsHTML = '';
          if (item.kind === 'JOB') {
            const kidsAll = __findJobKids(item.code);
            const cTodo = kidsAll.filter(t=> t.status==='todo').length;
            const cDoing = kidsAll.filter(t=> t.status==='doing').length;
            const cDone = kidsAll.filter(t=> t.status==='done').length;
            countsHTML = `<span class="status-dot dot-orange"></span><span>${cTodo}</span><span class="status-dot dot-green"></span><span>${cDoing}</span><span class="status-dot dot-blue"></span><span>${cDone}</span>`;
          }
        const ellipsis = `<span class="ellipsis-btn" data-role="edit"><svg viewBox="0 0 24 24" width="16" height="16"><circle cx="5" cy="12" r="2" fill="var(--primary)"/><circle cx="12" cy="12" r="2" fill="var(--primary)"/><circle cx="19" cy="12" r="2" fill="var(--primary)"/></svg></span>`;
        const assigneeDisp = __assigneeToDisplay(item.assignee||'');
        const priClass = __priorityToClass(item.priority||'');
        const priLabel = __priorityToLabel(item.priority||'');
        el.innerHTML = `<div class="card-header">
            <div class="left"><span class="code"><span class="code-prefix-first">${first}</span>${rest}${codeStr.replace(/^([A-Z]+)/,'')}</span></div>
            <div class="center">${countsHTML}</div>
            <div class="right"><span class="priority-badge ${priClass}" title="优先级">${priLabel}</span>${ellipsis}</div>
          </div>
          <div class="title" title="${__fullDisplayName(item)}">${__displayName(item)}</div>
          <div class="meta" style="display:flex; justify-content:space-between;"><span class="assignee">${assigneeDisp || '-'}</span><span class="dates">${__getPlannedStartStr(item) || ''} ~ ${__getPlannedEndStr(item) || ''}</span></div>`;
        const editBtn = el.querySelector('.ellipsis-btn');
        if (editBtn) {
          editBtn.addEventListener('click', function(ev){ 
            ev.stopPropagation(); 
            showCardActionMenu(ev, item);
          });
        }
        el.addEventListener('mouseenter', function(){ if(item.kind==='JOB'){ __applyShakeForTaskHover(item.code||'', item.status||'', item.code||''); } else { const parent=__parentJobCodeOfItem(item)||''; if(parent){ __applyShakeForTaskHover(parent, item.status||'', item.code||''); } } });
        el.addEventListener('mouseleave', function(){ __clearShake(); });
        })();
        const assSpan = el.querySelector('.assignee');
        if (assSpan) {
          assSpan.style.cursor = 'pointer';
          assSpan.title = '点击编辑负责人';
          assSpan.addEventListener('click', function(ev){ ev.stopPropagation(); openAssigneePickerForItem(assSpan, item); });
        }
        let panel = null;
        let toggle = null;
        if (item.kind === 'JOB') {
          const kidsAll = __findJobKids(item.code);
          const kids = kidsAll.filter(t => t.status === item.status);
          toggle = document.createElement('div');
          toggle.style.marginTop = '6px';
          toggle.style.fontSize = '12px';
          toggle.style.color = 'var(--primary)';
          toggle.style.cursor = 'pointer';
          toggle.innerHTML = `<span style="display:inline-flex; align-items:center; gap:6px;"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="var(--primary)" d="M7 10l5 5 5-5z"/></svg>${kids.length}</span>`;
          panel = document.createElement('div');
          const expanded = !!(window.__expandedJobCards && window.__expandedJobCards[item.code]);
          panel.style.display = expanded ? 'block' : 'none';
          panel.style.marginTop = '6px';
          kids.forEach(t => {
            const row = document.createElement('div');
            row.className = `card status-${t.status}`;
            row.style.padding = '6px 8px';
            row.style.marginBottom = '6px';
            (function(){
              const codeStr = t.code || '';
              const prefix = (codeStr.match(/^([A-Z]+)/) || [null, ''])[1] || 'TASK';
              const first = prefix ? prefix.charAt(0) : '';
              const rest = prefix ? prefix.slice(1) : '';
            const ellipsis = `<span class="ellipsis-btn" data-role="edit-child"><svg viewBox="0 0 24 24" width="16" height="16"><circle cx="5" cy="12" r="2" fill="var(--primary)"/><circle cx="12" cy="12" r="2" fill="var(--primary)"/><circle cx="19" cy="12" r="2" fill="var(--primary)"/></svg></span>`;
            const priClassChild = __priorityToClass(t.priority||'');
            const priLabelChild = __priorityToLabel(t.priority||'');
            const assigneeDispChild = __assigneeToDisplay(t.assignee||'');
            const titles = __composeJobTask(item, t, 8);
            row.innerHTML = `<div class="card-header">
              <div class="left"><span class="code"><span class="code-prefix-first">${first}</span>${rest}${codeStr.replace(/^([A-Z]+)/,'')}</span></div>
                <div class="center"></div>
                <div class="right"><span class="priority-badge ${priClassChild}" title="优先级">${priLabelChild}</span>${ellipsis}</div>
              </div>
              <div class="title" title="${titles.full}">${titles.short}</div>
              <div class="meta" style="display:flex; justify-content:space-between;"><span class="assignee">${assigneeDispChild || '-'}</span><span class="dates">${__getPlannedStartStr(t) || ''} ~ ${__getPlannedEndStr(t) || ''}</span></div>`;
              const ebtn = row.querySelector('.ellipsis-btn');
              if (ebtn) ebtn.addEventListener('click', function(ev){ ev.stopPropagation(); openEditTaskModal(t); });
              row.addEventListener('mouseenter', function(){ const parent=item.code||''; __applyShakeForTaskHover(parent, t.status||'', t.code||''); });
              row.addEventListener('mouseleave', function(){ __clearShake(); });
              const a2 = row.querySelector('.assignee');
              if (a2) { a2.style.cursor='pointer'; a2.title='点击编辑负责人'; a2.addEventListener('click', function(ev){ ev.stopPropagation(); openAssigneePickerForItem(a2, t); }); }
            })();
            row.dataset.wid = t.id || '';
            row.dataset.code = t.code || '';
            row.setAttribute('draggable','true');
            row.addEventListener('dragstart', ev => {
              const val = row.dataset.wid || row.dataset.code || '';
              try { ev.dataTransfer.setData('text/plain', val); } catch (e) {}
              try { ev.dataTransfer.setData('text', val); } catch (e) {}
              ev.dataTransfer.effectAllowed = 'move';
              try {  } catch (e) {}
              row.classList.add('dragging');
            });
            row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
            row.ondblclick = function(ev){ ev.stopPropagation(); window.location.href = `job.html?code=${item.code}&project=${projectId}&task=${t.code}`; };
            panel.appendChild(row);
          });
          if (expanded) { try { toggle.querySelector('path').setAttribute('d','M10 7l5 5-5 5z'); } catch (e) { } }
          toggle.onclick = () => { const next = panel.style.display === 'none'; panel.style.display = next ? 'block' : 'none'; try { toggle.querySelector('path').setAttribute('d', next ? 'M10 7l5 5-5 5z' : 'M7 10l5 5 5-5z'); } catch(_){}; window.__expandedJobCards = window.__expandedJobCards || {}; window.__expandedJobCards[item.code] = next; };
          if (toggle) { toggle.ondblclick = function(ev){ ev.stopPropagation(); }; }
          el.appendChild(toggle);
          el.appendChild(panel);
        }
        el.ondblclick = function(ev){ if(item.kind==='JOB'){ if(toggle && (ev.target===toggle || toggle.contains(ev.target))) return; window.location.href = `job.html?code=${item.code}&project=${projectId}`; } else { let parentCode=''; const jobs=(window.__jobs||[]); for(const j of jobs){ const ks=j.subtasks||[]; if(ks.find(x=> (x.id===item.id)||(x.code===item.code))){ parentCode=j.code||''; break; } } if(parentCode){ const tid=item.code||item.id; window.location.href = `task.html?code=${tid}&project=${projectId}&job=${parentCode}`; } } };
        return el;
      };
      ['todo','doing','done'].forEach(s => { const c = document.getElementById(s); c.innerHTML=''; byStatus[s].forEach(it => c.appendChild(mkCard(it))); });
    }

    function __findJobKids(jobCode){
      try{
        const jobs = Array.isArray(window.__jobs) ? window.__jobs : [];
        const j = jobs.find(x=> x.code===jobCode);
        if (j && Array.isArray(j.subtasks)) return j.subtasks;
        const items = Array.isArray(window.__items) ? window.__items : [];
        return items.filter(t=> t.kind==='TASK' && (
          t.parent_id===j?.id || t.parentId===j?.id || t.parent_code===jobCode || t.parentCode===jobCode || t.parent===jobCode
        ));
      } catch(_){ return []; }
    }
    function __parentJobCodeOfItem(it){ try{ const code=it&&it.code; const jobs=Array.isArray(window.__jobs)?window.__jobs:[]; for(const j of jobs){ const subs=j.subtasks||[]; if(subs.find(s=> (s.id===it.id)||(s.code===code))) return j.code||''; } const items=Array.isArray(window.__items)?window.__items:[]; const match=items.find(x=> x.kind==='JOB' && (Array.isArray(x.subtasks) && x.subtasks.find(s=> (s.id===it.id)||(s.code===code)))); return match? (match.code||'') : ''; } catch(_){ return ''; } }
    function __applyShakeByCodes(codes, exclude){ try{ const set=new Set((codes||[]).filter(Boolean)); const cards=[...document.querySelectorAll('.card')]; cards.forEach(c=>{ const cd=c.getAttribute('data-code')||''; if(set.has(cd) && (!exclude || exclude!==cd)) c.classList.add('shake'); }); } catch(_){ } }
    function __clearShake(){ try{ [...document.querySelectorAll('.card.shake')].forEach(c=> c.classList.remove('shake')); } catch(_){ } }
    function __applyShakeForTaskHover(parentCode, currentStatus, excludeCode){ try{ const kids=__findJobKids(parentCode)||[]; const jobs=Array.isArray(window.__jobs)?window.__jobs:[]; const j=jobs.find(x=> x.code===parentCode); let codes=[]; if(j && (String(j.status||'')===String(currentStatus||''))){ codes = kids.filter(k=> (k && (String(k.status||'')!==String(currentStatus||'')))).map(k=> k.code||''); } else { codes = [parentCode].concat(kids.map(k=> k.code||'')); } const cards=[...document.querySelectorAll('.card')]; cards.forEach(c=>{ const cd=c.getAttribute('data-code')||''; if(codes.includes(cd) && cd!==excludeCode){ c.classList.add('shake'); } }); } catch(_){ } }

    function buildGanttTasks(items) {
      const startDates = (items||[]).map(i => fmtDate(__getPlannedStartStr(i))).filter(Boolean);
      const endDates = (items||[]).map(i => fmtDate(__getPlannedEndStr(i))).filter(Boolean);
      const now = new Date();
      const WINDOW_DAYS = 30;
      const half = Math.floor(WINDOW_DAYS/2);
      const baseStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - half);
      const baseEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + half - 1);
      if (startDates.length || endDates.length) {
        const minStart = startDates.length ? new Date(Math.min.apply(null, startDates.map(d=>d.getTime()))) : null;
        const maxEnd = endDates.length ? new Date(Math.max.apply(null, endDates.map(d=>d.getTime()))) : null;
        const msPerDay = 1000*60*60*24;
        const rangeDays = (minStart && maxEnd) ? Math.max(1, Math.ceil((maxEnd - minStart)/msPerDay) + 1) : 0;
        if (!rangeDays || rangeDays < WINDOW_DAYS) {
          startDate = minStart ? new Date(Math.min(minStart.getTime(), baseStart.getTime())) : baseStart;
          endDate = maxEnd ? new Date(Math.max(maxEnd.getTime(), baseEnd.getTime())) : baseEnd;
        } else {
          startDate = minStart;
          endDate = maxEnd;
        }
      } else {
        startDate = baseStart;
        endDate = baseEnd;
      }
      // Add buffer to prevent truncation
      totalDays = Math.ceil((endDate - startDate)/(1000*60*60*24)) + 5;
      ganttData.tasks = [];
      const parents = (items||[]).filter(i => (i.kind==='JOB') || (Array.isArray(i.subtasks) && i.subtasks.length>0) || !(i.parent_id || i.parentId || i.parent || i.parent_code || i.parentCode));
      const included = new Set();
      parents.forEach(p => {
        const pStart = fmtDate(__getPlannedStartStr(p)), pEnd = fmtDate(__getPlannedEndStr(p));
        const pStartDay = pStart ? Math.max(0, Math.floor((pStart - startDate)/(1000*60*60*24))) : 0;
        const pDuration = (pStart && pEnd) ? Math.max(1, Math.ceil((pEnd - pStart)/(1000*60*60*24)) + 1) : 1;
        const allItems = Array.isArray(items) ? items : (window.__items || []);
        let kids = allItems.filter(t => t.kind==='TASK' && (
          t.parent_id === p.id || t.parentId === p.id || t.parent_code === p.code || t.parentCode === p.code || t.parent === p.code
        ));
        if ((!kids || kids.length===0) && Array.isArray(p.subtasks)) { kids = p.subtasks; }
        const mappedKids = kids.map(t => {
          const s = fmtDate(__getPlannedStartStr(t)), e = fmtDate(__getPlannedEndStr(t));
          const sd = s ? Math.max(0, Math.floor((s - startDate)/(1000*60*60*24))) : 0;
          const du = (s && e) ? Math.max(1, Math.ceil((e - s)/(1000*60*60*24)) + 1) : 1;
          const kidId = t.id||t.code;
          included.add(kidId);
      return { id:kidId, name:(t.title||t.code||'-'), startDay:sd, duration:du, endDay:sd+du-1, color:colorForStatus(t.status), assignee:__assigneeToDisplay(t.assignee||''), description:(t.title||t.code||'-'), priority:(t.priority||'medium') };
        });
        ganttData.tasks.push({ id:p.id||p.code, name:(p.title||p.code||'-'), category:'', startDay:pStartDay, duration:pDuration, endDay:pStartDay+pDuration-1, color:colorForStatus(p.status), assignee:__assigneeToDisplay(p.assignee||''), description:__assigneeToDisplay(p.assignee||''), priority:(p.priority||'medium'), type:'parent', subtasks:mappedKids });
      });
      const orphanTasks = (items||[]).filter(t => t.kind==='TASK').filter(t => { const tid=t.id||t.code; return !included.has(tid); });
      if (orphanTasks.length) {
        const mapped = orphanTasks.map(t => {
          const s = fmtDate(__getPlannedStartStr(t)), e = fmtDate(__getPlannedEndStr(t));
          // 未归属任务按自身范围显示（不与父任务夹紧）
          const sd = s ? Math.max(0, Math.floor((s - startDate)/(1000*60*60*24))) : 0;
          const du = (s && e) ? Math.max(1, Math.ceil((e - s)/(1000*60*60*24)) + 1) : 1;
          return { id:t.id||t.code, name:(t.title||t.code||'-'), startDay:sd, duration:du, color:colorForStatus(t.status), assignee:__assigneeToDisplay(t.assignee||''), description:(t.title||t.code||'-'), priority:(t.priority||'medium') };
        });
        ganttData.tasks.push({ id:'__orphans__', name:'未归属任务', category:'', startDay:0, duration:1, color:'var(--text-secondary)', assignee:'', description:'未归属任务', type:'parent', subtasks:mapped });
      }
      
    }

    function bindEditHandlers(){ try{ const tCancel=document.getElementById('taskEditCancelBtn'); const tSave=document.getElementById('taskEditSaveBtn'); const jCancel=document.getElementById('jobEditCancelBtn'); const jSave=document.getElementById('jobEditSaveBtn'); if(tCancel){ tCancel.onclick=function(){ __creatingTask=false; __creatingParentRef=null; closeEditTaskModal(); }; } if(tSave){ tSave.onclick=async function(){ const ps=document.getElementById('taskEditStartInput').value||null; const pe=document.getElementById('taskEditEndInput').value||null; if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ showToast('结束日期不得早于开始日期','error'); return; } } const title=(document.getElementById('taskEditTitleInput').value||'').trim(); const assigneeInput=(document.getElementById('taskEditAssigneeInput').value||'').trim(); if(__creatingTask){ if(!title){ showToast('请输入任务标题','error'); return; } if(!assigneeInput){ showToast('请选择负责人','error'); return; } const parentIdOrCode = __creatingParentRef ? (__creatingParentRef.id||__creatingParentRef.code) : null; await __createTask(parentIdOrCode, title, ps, pe); __creatingTask=false; __creatingParentRef=null; closeEditTaskModal(); return; } if(!__editingTaskRef) return; if(!title){ showToast('请输入任务标题','error'); return; } if(!assigneeInput){ showToast('请选择负责人','error'); return; } const idOrCode=__editingTaskRef.id||__editingTaskRef.code; const prefix=__assigneeToPrefix(assigneeInput); const status=document.getElementById('taskEditStatusSelect').value||'todo'; const payload={ title, description: (document.getElementById('taskEditDescInput')? (document.getElementById('taskEditDescInput').value||'') : ''), assignee: prefix, assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix), planned_start_date: ps, planned_end_date: pe, status }; if(status==='done'){ const endStr = pe || __getPlannedEndStr(__editingTaskRef) || ps; const startStr = ps || __getPlannedStartStr(__editingTaskRef) || endStr; const eDate = endStr ? new Date(endStr) : new Date(); const sDate = startStr ? new Date(startStr) : null; const msPerDay = 1000*60*60*24; let days = 1; if(sDate){ days = Math.max(1, Math.floor((eDate - sDate)/msPerDay) + 1); } payload.completed_at = eDate.toISOString(); payload.actual_hours = days * 8; } await __patchTask(idOrCode, payload); __saveLocalAssignment(idOrCode, prefix); closeEditTaskModal(); }; } if(jCancel){ jCancel.onclick=function(){ __creatingJob=false; closeEditJobModal(); }; } if(jSave){ jSave.onclick=async function(){ const ps=document.getElementById('jobEditStartInput').value||null; const pe=document.getElementById('jobEditEndInput').value||null; if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ showToast('结束日期不得早于开始日期','error'); return; } } const title=(document.getElementById('jobEditTitleInput').value||'').trim(); const assigneeInput=(document.getElementById('jobEditAssigneeInput').value||'').trim(); if(__creatingJob){ if(!title){ showToast('请输入JOB标题','error'); return; } const dup=(Array.isArray(window.__items)? window.__items : []).some(function(i){ const isJob=i.kind==='JOB' || (!i.parent_id && !i.parentId && !i.parent && !i.parent_code && !i.parentCode); const t=(i.title||i.name||'').trim(); return isJob && t && t===title; }); if(dup){ showToast('JOB名称已存在，请更换','error'); return; } if(!assigneeInput){ showToast('请选择负责人','error'); return; } await __createJob(title, ps, pe); __creatingJob=false; closeEditJobModal(); return; } if(!__editingJobRef) return; if(!title){ showToast('请输入JOB标题','error'); return; } if(!assigneeInput){ showToast('请选择负责人','error'); return; } const idOrCode=__editingJobRef.id||__editingJobRef.code; const prefix=__assigneeToPrefix(assigneeInput); const status=document.getElementById('jobEditStatusSelect').value||'todo'; const payload={ title, description: (document.getElementById('jobEditDescInput')? (document.getElementById('jobEditDescInput').value||'') : ''), assignee: prefix, assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix), planned_start_date: ps, planned_end_date: pe, status }; if(status==='done'){ const endStr = pe || __getPlannedEndStr(__editingJobRef) || ps; const startStr = ps || __getPlannedStartStr(__editingJobRef) || endStr; const eDate = endStr ? new Date(endStr) : new Date(); const sDate = startStr ? new Date(startStr) : null; const msPerDay = 1000*60*60*24; let days = 1; if(sDate){ days = Math.max(1, Math.floor((eDate - sDate)/msPerDay) + 1); } payload.completed_at = eDate.toISOString(); payload.actual_hours = days * 8; } await __patchTask(idOrCode, payload); __saveLocalAssignment(idOrCode, prefix);
      try{ const allItems = Array.isArray(window.__items) ? window.__items.slice() : []; let kids=[]; for(const it of allItems){ const isTask = (it.kind==='TASK') || (!!it.parent_id || !!it.parentId || !!it.parent || !!it.parent_code || !!it.parentCode); const matchParent = (it.parent_id===__editingJobRef.id) || (it.parentId===__editingJobRef.id) || (it.parent_code===__editingJobRef.code) || (it.parentCode===__editingJobRef.code) || (it.parent===__editingJobRef.code); if(isTask && matchParent) kids.push(it); } if((!kids||kids.length===0) && Array.isArray(__editingJobRef.subtasks)) kids = __editingJobRef.subtasks; if(ps && pe){ for(const k of (kids||[])){ const cps=__getPlannedStartStr(k)||ps; const cpe=__getPlannedEndStr(k)||pe; const fit=__fitChildDatesToParentStr(cps, cpe, ps, pe); if(fit.ps!==cps || fit.pe!==cpe){ await __scheduleChange(k.id||k.code, fit.ps, fit.pe); } } } }catch(_){}
      await fetchWorkItems();
      closeEditJobModal(); }; } }catch(_){} }
    function initGantt() { try {  initScrollPosition(); ensureTotalDays(); generateTimeColumns(); renderAll(); centerOnCurrent(); setupScrollSync(); bindEditHandlers();  } catch(e){  } }
    function initScrollPosition() { const daysSinceStart = Math.floor((currentDate - startDate)/(1000*60*60*24)); columnWidth = timeMode==='day' ? 30 : 100; scrollPosition = Math.max(0, daysSinceStart*columnWidth - viewportWidth/2); }
    
    function setupScrollSync() {
      const th = document.querySelector('.time-header');
      const tl = document.getElementById('timelineContainer');
      const taskList = document.getElementById('taskList');
      const assigneeList = document.getElementById('assigneeList');
      const priorityList = document.getElementById('priorityList');
      
      let __syncing = false;
      const setVScroll = (y) => {
        if(__syncing) return; __syncing = true;
        if(tl) tl.scrollTop = y;
        if(taskList) taskList.scrollTop = y;
        if(assigneeList) assigneeList.scrollTop = y;
        if(priorityList) priorityList.scrollTop = y;
        requestAnimationFrame(()=>{ __syncing=false; updateUnifiedScrollbar(); positionActionMenu(); });
      };
      const onTlScroll = () => { 
        if(th) th.scrollLeft = tl.scrollLeft; 
        setVScroll(tl.scrollTop);
        maybeExtendTimeline();
      };
      const onThScroll = () => { 
        if(tl) tl.scrollLeft = th.scrollLeft; 
        positionActionMenu(); // 水平滚动时也重新定位菜单
      };
      const onListScroll = (e) => { if(__syncing) return; const y=e.target.scrollTop||0; setVScroll(y); };
      const onWheel = (e) => { const y=(tl?tl.scrollTop:0) + (e.deltaY||0); setVScroll(y); };
      
      if(tl) { tl.onscroll = onTlScroll; }
      if(th) { th.onscroll = onThScroll; }
      if(taskList) taskList.onscroll = onListScroll;
      if(assigneeList) assigneeList.onscroll = onListScroll;
      if(priorityList) priorityList.onscroll = onListScroll;
      [taskList, assigneeList, priorityList, tl].forEach(el=>{ if(el){ el.addEventListener('wheel', onWheel, { passive: true }); } });
      
      if(th) bindPan(th); if(tl) bindPan(tl);
      initUnifiedScrollbar();
    }

    
    
    function extendRange(dir){ if(timeMode==='day'){ if(dir==='left'){ startDate = __addDays(startDate, -90); } else { endDate = __addDays(endDate, 90); } } else { if(dir==='left'){ const y=startDate.getFullYear(), m=startDate.getMonth(); startDate = new Date(y, m-6, 1); } else { const y=endDate.getFullYear(), m=endDate.getMonth(); endDate = new Date(y, m+6, 1); endDate = new Date(endDate.getFullYear(), endDate.getMonth()+1, 0); } } const before = ganttData.timeColumns.length; ensureTotalDays(); generateTimeColumns(); const after = ganttData.timeColumns.length; const added = Math.max(0, after - before); if(dir==='left' && added>0){ scrollPosition += added*columnWidth; } renderAll(); updateScrollPosition(); setupScrollSync(); }
    function maybeExtendTimeline(){ return; }
    
    function switchTimeMode(mode){ timeMode=mode; document.querySelectorAll('.time-mode-btn').forEach(btn=>btn.classList.remove('active')); const btn=document.querySelector(`.time-mode-btn[data-mode="${mode}"]`); if(btn) btn.classList.add('active'); columnWidth = timeMode==='day' ? 30 : 100; generateTimeColumns(); renderAll(); updateScrollPosition(); }
    function updateScrollPosition(){ const tl=document.getElementById('timelineContainer'); const th=document.querySelector('.time-header'); if(tl) tl.scrollLeft=scrollPosition; if(th) th.scrollLeft=scrollPosition; }
    function centerOnCurrent(){ const th=document.querySelector('.time-header'); const vw = th ? th.clientWidth : viewportWidth; if(timeMode==='day'){ const offset = Math.floor((currentDate - startDate)/(1000*60*60*24)); const dayIdx = Math.max(0, Math.min(totalDays-1, offset)); scrollPosition = Math.max(0, dayIdx*columnWidth - vw/2); } else { const yDiff = currentDate.getFullYear()-startDate.getFullYear(); const mDiff = currentDate.getMonth()-startDate.getMonth(); const monthIdx = Math.max(0, Math.min(((ganttData.timeColumns||[]).length-1), yDiff*12 + mDiff)); scrollPosition = Math.max(0, monthIdx*columnWidth - vw/2); } updateScrollPosition(); }
    function generateTimeColumns(){ ganttData.timeColumns=[]; if(timeMode==='day'){ let d=new Date(startDate.getTime()); for(let day=0; day<totalDays; day++){ ganttData.timeColumns.push({ id:`day-${day}`, label:`${d.getMonth()+1}/${d.getDate()}`, date:new Date(d.getTime()), type:'day', width:columnWidth }); d.setDate(d.getDate()+1); } } else { const sy=startDate.getFullYear(), sm=startDate.getMonth(), ey=endDate.getFullYear(), em=endDate.getMonth(); let cur=new Date(sy,sm,1), tgt=new Date(ey,em,1); while(cur<=tgt){ const y=cur.getFullYear(), m=cur.getMonth()+1, days=new Date(y, cur.getMonth()+1, 0).getDate(); ganttData.timeColumns.push({ id:`month-${y}-${m}`, label:`${m}月`, year:y, month:m, days, type:'month', width:columnWidth }); cur.setMonth(cur.getMonth()+1); } } }
    function ensureTotalDays(){
      if (!Number.isFinite(totalDays) || totalDays <= 0) {
        totalDays = Math.ceil((endDate - startDate)/(1000*60*60*24)) + 5;
      }
    }
    function dayOffsetToMonthIndex(dayOffset){
      const d=new Date(startDate.getTime());
      d.setDate(d.getDate()+Math.max(0, dayOffset||0));
      const yearDiff=d.getFullYear()-startDate.getFullYear();
      const monthDiff=d.getMonth()-startDate.getMonth();
      let idx=yearDiff*12+monthDiff;
      idx=Math.max(0, Math.min(idx, (ganttData.timeColumns||[]).length-1));
      return idx;
    }
    function renderAll(){  __buildFixedDurations(); renderTimeHeaderFixed(); renderTaskList(); tweakTaskListLayout(); applyTaskExpansionStates(); fixTaskTitles(); renderTimeline(); applyTaskExpansionStates(); renderAssigneeList(); renderPriorityList();  }

    function initUnifiedScrollbar(){ try{ const body=document.querySelector('.gantt-body'); if(!body) return; body.style.position='relative'; let track=document.getElementById('unifiedScrollTrack'); if(!track){ track=document.createElement('div'); track.id='unifiedScrollTrack'; track.innerHTML='<div id="unifiedScrollThumb"></div>'; body.appendChild(track); } updateUnifiedScrollbar(); const tl=document.getElementById('timelineContainer'); const thumb=document.getElementById('unifiedScrollThumb'); let dragging=false, startY=0, startTop=0; const setByRatio=(ratio)=>{ const max= (tl.scrollHeight - tl.clientHeight); const y=Math.max(0, Math.min(max, ratio*max)); tl.scrollTop=y; const evt=new Event('scroll'); tl.dispatchEvent(evt); }; const onDown=(e)=>{ dragging=true; startY=e.clientY; startTop=thumb.offsetTop; document.body.style.userSelect='none'; }; const onMove=(e)=>{ if(!dragging) return; const trackRect=track.getBoundingClientRect(); const thumbRect=thumb.getBoundingClientRect(); const maxThumbTop = trackRect.height - thumbRect.height; const delta = e.clientY - startY; const nextTop = Math.max(0, Math.min(maxThumbTop, startTop + delta)); const ratio = nextTop / maxThumbTop; setByRatio(ratio); }; const onUp=()=>{ dragging=false; document.body.style.userSelect=''; }; thumb.onmousedown=onDown; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); window.addEventListener('resize', updateUnifiedScrollbar); }catch(_){ } }

    function updateUnifiedScrollbar(){ try{ const tl=document.getElementById('timelineContainer'); const track=document.getElementById('unifiedScrollTrack'); const thumb=document.getElementById('unifiedScrollThumb'); if(!tl||!track||!thumb) return; const total=tl.scrollHeight; const viewport=tl.clientHeight; const maxThumbTop = track.clientHeight - Math.max(40, Math.floor(viewport*viewport/Math.max(viewport, total))); const ratio = Math.max(0, Math.min(1, tl.scrollTop / Math.max(1, (total - viewport)))); const thumbHeight = Math.max(40, Math.floor(viewport*viewport/Math.max(viewport, total))); thumb.style.height = thumbHeight+'px'; thumb.style.top = Math.floor(ratio * (track.clientHeight - thumbHeight))+'px'; }catch(_){ } }
    function renderTimeHeader(){ const yearRow=document.getElementById('yearRow'); const monthRow=document.getElementById('monthRow'); const dayRow=document.getElementById('dayRow'); const timeline=document.getElementById('timeline'); yearRow.innerHTML=''; monthRow.innerHTML=''; dayRow.innerHTML=''; if(timeMode==='day'){ const totalWidth=ganttData.timeColumns.length*columnWidth; [timeline,yearRow,monthRow,dayRow].forEach(el=>el.style.width=totalWidth+'px'); dayRow.style.display='flex'; const monthGroups={}; ganttData.timeColumns.forEach(col=>{ const d=col.date; const ym=`${d.getFullYear()}-${d.getMonth()+1}`; if(!monthGroups[ym]) monthGroups[ym]={ year:d.getFullYear(), month:d.getMonth()+1, count:0 }; monthGroups[ym].count++; }); const yearGroups={}; Object.values(monthGroups).forEach(m=>{ if(!yearGroups[m.year]) yearGroups[m.year]=0; yearGroups[m.year]+=m.count; }); Object.keys(yearGroups).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{ const div=document.createElement('div'); div.className='year-cell'; div.style.width=(yearGroups[y]*columnWidth)+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=y+'年'; yearRow.appendChild(div); }); Object.keys(monthGroups).sort((a,b)=>{ const [ya,ma]=a.split('-').map(Number); const [yb,mb]=b.split('-').map(Number); return ya!==yb?ya-yb:ma-mb; }).forEach(key=>{ const m=monthGroups[key]; const div=document.createElement('div'); div.className='month-cell'; div.style.width=(m.count*columnWidth)+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=`${m.month}月`; monthRow.appendChild(div); }); ganttData.timeColumns.forEach(col=>{ const div=document.createElement('div'); div.className='day-cell'; div.style.width=columnWidth+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=col.date.getDate(); dayRow.appendChild(div); }); } else { dayRow.style.display='none'; const totalWidth=ganttData.timeColumns.length*columnWidth; [timeline,yearRow,monthRow].forEach(el=>el.style.width=totalWidth+'px'); const years={}; ganttData.timeColumns.forEach((col,idx)=>{ if(!years[col.year]) years[col.year]={ count:0 }; years[col.year].count++; }); Object.keys(years).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{ const div=document.createElement('div'); div.className='year-cell'; div.style.width=(years[y].count*columnWidth)+'px'; div.style.minWidth=div.style.width; div.style.maxWidth=div.style.width; div.style.flexShrink='0'; div.textContent=y+'年'; yearRow.appendChild(div); }); ganttData.timeColumns.forEach(col=>{ const div=document.createElement('div'); div.className='month-cell'; div.style.width=columnWidth+'px'; div.style.minWidth=div.style.width; div.style.maxWidth=div.style.width; div.style.flexShrink='0'; div.textContent=col.label; monthRow.appendChild(div); }); } updateScrollPosition(); setupScrollSync(); }
        function renderTaskList() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      (ganttData.tasks || []).forEach((task, ti) => {
        const parent = document.createElement('div');
        parent.className = 'task-row parent-task';
        const pid = task.id || task.code;
        const entry = (window.__expandedParents || {})[pid];
        const expanded = (entry === undefined) ? true : !!entry;
        const jcode = __codeOf(task);
        const displayName = __titleOrCode(task);
        
        parent.innerHTML = `
          <div class="task-name-wrapper">
            <span class="collapse-btn ${expanded ? '' : 'collapsed'}" data-ti="${ti}" data-role="toggle" title="展开/折叠">
              <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
            </span>
            <div class="task-name-text" style="flex:0 1 auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:600;">
              <a class="task-title" href="job.html?code=${jcode}&project=${projectId}" style="color:inherit; text-decoration:none;">${displayName}</a>
            </div>
            <button class="more-btn" onclick="showTaskMenu(event, ${ti}, -1)" title="更多操作">
              <svg viewBox="0 0 24 24" width="16" height="16"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>
            </button>
          </div>
        `;
        taskList.appendChild(parent);
        
        const subs = (task.subtasks || []);
        subs.forEach((st, si) => {
          const div = document.createElement('div');
          div.className = 'task-row subtask';
          div.style.paddingLeft = '36px'; 
          const tDisplayName = __titleOrCode(st);
          const tCode = st.code || st.id;
          div.innerHTML = `
            <div class="task-name-wrapper">
              <div class="task-name-text" style="flex:0 1 auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                <a class="task-title" href="task.html?code=${tCode}&project=${projectId}&job=${jcode}" style="color:inherit; text-decoration:none;">${tDisplayName}</a>
              </div>
              <button class="more-btn" onclick="showTaskMenu(event, ${ti}, ${si})" title="更多操作">
                <svg viewBox="0 0 24 24" width="16" height="16"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>
              </button>
            </div>
          `;
          // Keep double click for editing if user prefers, but link handles navigation
          div.ondblclick = (e) => {
             if(e.target.closest('.more-btn') || e.target.closest('a')) return;
             openEditTaskModal(st);
          };
          taskList.appendChild(div);
        });
      });
    }

    function openCreateTaskModal(parentItem){ console.log('[DEBUG] openCreateTaskModal called with:', parentItem); const backdrop=document.getElementById('taskModalBackdrop'); const sel=document.getElementById('taskJobSelect'); sel.innerHTML=''; (ganttData.tasks||[]).forEach(p=>{ const opt=document.createElement('option'); opt.value=String(p.id||p.code); opt.textContent=p.name; sel.appendChild(opt); }); if(parentItem){ sel.value=String(parentItem.id||parentItem.code||''); } document.getElementById('taskTitleInput').value=''; try{ document.getElementById('taskDescInput').value=''; }catch(_){ } try{ document.getElementById('taskAssigneeInput').value=''; }catch(_){ } try{ enableAssigneeDropdown('taskAssigneeInput'); }catch(_){ } const statusSel=document.getElementById('taskStatusSelect'); if(statusSel) statusSel.value='todo'; const priSel=document.getElementById('taskPrioritySelect'); if(priSel) priSel.value='medium'; const psEl=document.getElementById('taskStartInput'); const peEl=document.getElementById('taskEndInput'); const err=document.getElementById('taskDateError'); if(err) err.textContent=''; let pStart=__toDateTimeLocal(__getCurrentDateWith9AM()), pEnd=__toDateTimeLocal(__getCurrentDateWith6PM()); try{ let parentForValidation = null; if(parentItem){ console.log('[task] Input parentItem:', parentItem); console.log('[task] parentItem.startDay:', parentItem.startDay, 'parentItem.duration:', parentItem.duration); if(parentItem.startDay !== undefined && parentItem.duration !== undefined){ console.log('[task] Using parentItem directly (gantt data)'); parentForValidation = parentItem; } else { console.log('[task] Converting original data to gantt data'); console.log('[task] Looking for gantt data with id/code:', parentItem.id, parentItem.code); console.log('[task] Available gantt tasks:', (ganttData.tasks||[]).map(t => ({id: t.id, code: t.code, name: t.name}))); const ganttParent = (ganttData.tasks||[]).find(t=> String(t.id||t.code)===String(parentItem.id||parentItem.code||'')); console.log('[task] Found gantt parent:', ganttParent); if(ganttParent){ console.log('[task] Found corresponding gantt data:', ganttParent); parentForValidation = ganttParent; } else { console.warn('[task] Could not find gantt data for parent'); } } } else { console.log('[task] No parentItem, using dropdown selection'); const parent=(ganttData.tasks||[]).find(t=> String(t.id||t.code)===String(sel.value||'')); parentForValidation = parent; } console.log('[task] Final parentForValidation:', parentForValidation); if(parentForValidation){ const validation = __validateTaskCreationTimeFromItem(parentForValidation); if(!validation.valid){ if(err) err.textContent=validation.message; showToast(validation.message, 'error'); backdrop.style.display='none'; return; } pStart=__toDateTimeLocal(validation.defaultStart); pEnd=__toDateTimeLocal(validation.defaultEnd); } }catch(e){ console.error('[task] Error validating parent job:', e); } psEl.value=pStart; peEl.value=pEnd; psEl.min=pStart; psEl.max=pEnd; peEl.min=pStart; peEl.max=pEnd; (async function(){ try{ await fetchDbAssignees(); }catch(_){ } })(); backdrop.style.display='flex'; }
    function closeCreateTaskModal(){ const backdrop=document.getElementById('taskModalBackdrop'); backdrop.style.display='none'; }
    function openCreateJobModal(){ const backdrop=document.getElementById('jobModalBackdrop'); const titleEl=document.getElementById('jobTitleInput'); const descEl=document.getElementById('jobDescInput'); const assEl=document.getElementById('jobAssigneeInput'); const statusEl=document.getElementById('jobStatusSelect'); const sEl=document.getElementById('jobStartInput'); const eEl=document.getElementById('jobEndInput'); if(titleEl) titleEl.value=''; if(descEl) descEl.value=''; if(assEl) assEl.value=''; if(statusEl) statusEl.value='todo'; const pri=document.getElementById('jobPrioritySelect'); if(pri) pri.value='medium'; if(sEl) sEl.value=__toDateTimeLocal(__getJobDefaultStartDate()); if(eEl) eEl.value=__toDateTimeLocal(__getJobDefaultEndDate()); const errTitle=document.getElementById('jobTitleError'); if(errTitle) errTitle.textContent=''; const errDate=document.getElementById('jobDateError'); if(errDate) errDate.textContent=''; (async function(){ try{ await fetchDbAssignees(); }catch(_){ } try{ enableAssigneeDropdown('jobAssigneeInput'); }catch(_){ } })(); backdrop.style.display='flex'; }
    function closeCreateJobModal(){ const backdrop=document.getElementById('jobModalBackdrop'); backdrop.style.display='none'; }
    let __editingTaskRef=null;
    async function openEditTaskModal(ref){ __editingTaskRef=__findFullItem(ref); const b=document.getElementById('taskEditModalBackdrop'); const titleEl=document.querySelector('#taskEditModal h4'); if(titleEl) titleEl.textContent='编辑子任务'; document.getElementById('taskEditTitleInput').value=__editingTaskRef.title||__editingTaskRef.name||'';
      try{
        const descEl = document.getElementById('taskEditDescInput');
        if (descEl) descEl.value = __editingTaskRef.description || '';
      }catch(_){ } const assEl=document.getElementById('taskEditAssigneeInput'); await fetchDbAssignees(); (function(){ const base=(__editingTaskRef.assignee||__editingTaskRef.assignee_prefix||__editingTaskRef.assignee_username||''); const disp=__assigneeToDisplay(base); assEl.value=(disp==='NA')? '' : disp; })(); if(!assEl.value){ const alt=(__editingTaskRef.assignee_prefix||__editingTaskRef.assignee_username||''); const disp2=__assigneeToDisplay(alt); assEl.value=(disp2==='NA')? '' : disp2; } enableAssigneeDropdown('taskEditAssigneeInput'); try{ assEl.addEventListener('blur', commitTaskAssigneeAuto); assEl.addEventListener('keydown', function(e){ if(e.key==='Enter'){ commitTaskAssigneeAuto(); } }); }catch(_){} const sStr=__getPlannedStartStr(__editingTaskRef)||'';
      const eStr=__getPlannedEndStr(__editingTaskRef)||'';
      const startEl=document.getElementById('taskEditStartInput');
      const endEl=document.getElementById('taskEditEndInput');
      if(startEl) startEl.value=__toLocalInputValue(sStr);
      if(endEl) endEl.value=__toLocalInputValue(eStr); const priSel=document.getElementById('taskEditPrioritySelect'); if(priSel) priSel.value=(__editingTaskRef.priority||'medium'); (function(){ try{ const items=Array.isArray(window.__items)?window.__items:[]; const pcode=__parentJobCodeOfItem(__editingTaskRef)||''; let parent=null; if(pcode){ parent=items.find(x=> x.kind==='JOB' && x.code===pcode); } if(!parent){ parent=items.find(x=> x.kind==='JOB' && (Array.isArray(x.subtasks) && x.subtasks.find(s=> (s.id===__editingTaskRef.id)||(s.code===__editingTaskRef.code)))); } const pStartStr=parent? (__getPlannedStartStr(parent)||'') : ''; const pEndStr=parent? (__getPlannedEndStr(parent)||'') : ''; if(pStartStr){ if(startEl) startEl.min=pStartStr; if(endEl) endEl.min=pStartStr; } if(pEndStr){ if(startEl) startEl.max=pEndStr; if(endEl) endEl.max=pEndStr; } if(pStartStr && sStr && startEl && (new Date(sStr) < new Date(pStartStr))) startEl.value=pStartStr; if(pEndStr && eStr && endEl && (new Date(eStr) > new Date(pEndStr))) endEl.value=pEndStr; const onCheck=function(){ const ps=startEl.value||''; const pe=endEl.value||''; const invalidOrder=(ps && pe && (new Date(pe)<new Date(ps))); const min=startEl.min||''; const max=endEl.max||''; const outOfRange=( (min && ps<min) || (max && pe>max) ); const btn=document.getElementById('taskEditSaveBtn'); if(btn){ btn.disabled=invalidOrder||outOfRange; } }; if(startEl) startEl.oninput=onCheck; if(endEl) endEl.oninput=onCheck; onCheck(); }catch(_){ } })(); attachDatePicker(startEl); attachDatePicker(endEl); const estEl=document.getElementById('taskEditEstimatedHoursInput'); if(estEl) estEl.value = (__editingTaskRef.estimated_hours!=null ? __editingTaskRef.estimated_hours : (__daysBetween(sStr,eStr)*8)) || 0; const actEl=document.getElementById('taskEditActualHoursInput'); if(actEl) actEl.value=(__editingTaskRef.actual_hours!=null ? __editingTaskRef.actual_hours : ''); const compEl=document.getElementById('taskEditCompletedAtInput'); if(compEl) compEl.value=(__editingTaskRef.completed_at? __toLocalInputValue(__editingTaskRef.completed_at) : ''); const sel=document.getElementById('taskEditStatusSelect'); sel.value=__editingTaskRef.status||'todo'; b.style.display='flex'; document.body.style.overflow='hidden'; }
    function closeEditTaskModal(){ const b=document.getElementById('taskEditModalBackdrop'); b.style.display='none'; __editingTaskRef=null; document.body.style.overflow=''; }
    async function __batchPatch(items){ try{ const payload={ items: (items||[]).map(function(ch){ const it = Object.assign({}, ch); if(it.idOrCode && !it.id) it.id = it.idOrCode; delete it.idOrCode; 
      if(it.planned_start_date && typeof it.planned_start_date==='string') it.planned_start_date=it.planned_start_date.slice(0,10);
      if(it.planned_end_date && typeof it.planned_end_date==='string') it.planned_end_date=it.planned_end_date.slice(0,10);
      return it; }) }; const res=await fetch(`${API}/work-items/batch`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(payload) }); if(res.ok){ const data=await res.json(); const updatedList=(data&&data.items)||[]; showToast('批量更新成功','success'); const itemsLocal = Array.isArray(window.__items)? window.__items.slice() : []; for(const updated of updatedList){ const norm=__normalizeWorkItemShape(updated); const idx = itemsLocal.findIndex(i=> (i.id===norm.id) || (i.code===norm.code)); if(idx>=0){ itemsLocal[idx] = Object.assign({}, itemsLocal[idx], norm); } else { for (let i=0;i<itemsLocal.length;i++){ const subs=itemsLocal[i].subtasks||[]; const si=subs.findIndex(s=> (s.id===norm.id) || (s.code===norm.code)); if(si>=0){ subs[si]=Object.assign({}, subs[si], norm); break; } } } }
        renderAfterLocalUpdate(itemsLocal);
        return updatedList;
      } else { await __showErrorFromResponse(res, '保存失败'); return []; } } catch(e){  showToast('网络错误，保存失败：' + (e && e.message ? e.message : ''), 'error'); return []; } }
    let __editingJobRef=null;
    async function openEditJobModal(ref){ __editingJobRef=__findFullItem(ref); const b=document.getElementById('jobEditModalBackdrop'); const titleEl=document.querySelector('#jobEditModal h4'); if(titleEl) titleEl.textContent='编辑任务'; document.getElementById('jobEditTitleInput').value=__editingJobRef.title||__editingJobRef.name||''; try{ document.getElementById('jobEditDescInput').value=__editingJobRef.description||''; }catch(_){ } const assEl=document.getElementById('jobEditAssigneeInput'); await fetchDbAssignees(); (function(){ const base=(__editingJobRef.assignee||__editingJobRef.assignee_prefix||__editingJobRef.assignee_username||''); const disp=__assigneeToDisplay(base); assEl.value=(disp==='NA')? '' : disp; })(); if(!assEl.value){ const alt=(__editingJobRef.assignee_prefix||__editingJobRef.assignee_username||''); const disp2=__assigneeToDisplay(alt); assEl.value=(disp2==='NA')? '' : disp2; } enableAssigneeDropdown('jobEditAssigneeInput'); try{ assEl.addEventListener('blur', commitJobAssigneeAuto); assEl.addEventListener('keydown', function(e){ if(e.key==='Enter'){ commitJobAssigneeAuto(); } }); }catch(_){} const sStr=__getPlannedStartStr(__editingJobRef)||''; const eStr=__getPlannedEndStr(__editingJobRef)||''; document.getElementById('jobEditStartInput').value=__toLocalInputValue(sStr); document.getElementById('jobEditEndInput').value=__toLocalInputValue(eStr); const priSel=document.getElementById('jobEditPrioritySelect'); if(priSel) priSel.value=(__editingJobRef.priority||'medium'); attachDatePicker(document.getElementById('jobEditStartInput')); attachDatePicker(document.getElementById('jobEditEndInput')); const estEl=document.getElementById('jobEditEstimatedHoursInput'); if(estEl) estEl.value=(__editingJobRef.estimated_hours!=null? __editingJobRef.estimated_hours : (__daysBetween(sStr,eStr)*8))||0; const actEl=document.getElementById('jobEditActualHoursInput'); if(actEl) actEl.value=(__editingJobRef.actual_hours!=null? __editingJobRef.actual_hours : ''); const compEl=document.getElementById('jobEditCompletedAtInput'); if(compEl) compEl.value=(__editingJobRef.completed_at? __toLocalInputValue(__editingJobRef.completed_at) : ''); const sel=document.getElementById('jobEditStatusSelect'); sel.value=__editingJobRef.status||'todo'; b.style.display='flex'; document.body.style.overflow='hidden'; }
    function closeEditJobModal(){ const b=document.getElementById('jobEditModalBackdrop'); b.style.display='none'; __editingJobRef=null; document.body.style.overflow=''; }
    async function __createTask(parentIdOrCode, title, ps, pe){ try{ const prefix=(function(){ const elc=document.getElementById('taskAssigneeInput'); if(elc){ return __assigneeToPrefix(elc.value||''); } const ele=document.getElementById('taskEditAssigneeInput'); return __assigneeToPrefix(ele? (ele.value||'') : ''); })(); const status=(function(){ const elc=document.getElementById('taskStatusSelect'); if(elc){ return elc.value||'todo'; } const ele=document.getElementById('taskEditStatusSelect'); return ele? (ele.value||'todo') : 'todo'; })(); const desc=(function(){ const elc=document.getElementById('taskDescInput'); if(elc){ return elc.value||''; } const ele=document.getElementById('taskEditDescInput'); return ele? (ele.value||'') : ''; })(); const priority=(function(){ const elc=document.getElementById('taskPrioritySelect'); if(elc){ return elc.value||'medium'; } const ele=document.getElementById('taskEditPrioritySelect'); return ele? (ele.value||'medium') : 'medium'; })();
      try{ const parent=(ganttData.tasks||[]).find(t=> String(t.id||t.code)===String(parentIdOrCode)); if(parent){ const pStart=__toYMD(__addDays(startDate, parent.startDay||0)); const pEnd=__toYMD(__addDays(__addDays(startDate, parent.startDay||0), Math.max(1,parent.duration||1)-1)); if(ps && ps<pStart) ps=pStart; if(pe && pe>pEnd) pe=pEnd; } }catch(e){ console.error('[task] Error adjusting dates to parent:', e); }
      const psDate = ps ? String(ps).slice(0, 10) : null;
      const peDate = pe ? String(pe).slice(0, 10) : null;
      const payload={ kind:'TASK', project_id: projectId, parent_id: typeof parentIdOrCode==='string'? (parseInt(parentIdOrCode,10)||null) : parentIdOrCode, title, status, planned_start_date: psDate, planned_end_date: peDate, description: desc, assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix), priority }; 
      const res=await fetch(`${API}/work-items/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(payload) }); 
      if(res.ok){ let created=await res.json(); created=__normalizeWorkItemShape(created); if((!created.assignee||created.assignee==='') && prefix){ created.assignee = prefix; } showToast('任务创建成功','success'); const items = Array.isArray(window.__items)? window.__items.slice() : []; const pid = payload.parent_id; const parent = items.find(i=> i.id===pid); if(parent){ parent.subtasks = Array.isArray(parent.subtasks)? parent.subtasks : []; parent.subtasks.push(created); } else { items.push(created); } renderAfterLocalUpdate(items); await fetchWorkItems(); } else { console.error('[task] Creation failed:', res.status, res.statusText); const errorText = await res.text(); console.error('[task] Error response:', errorText); await __showErrorFromResponse(res); } } catch(e){ console.error('[task] Exception in __createTask:', e); showToast('网络错误，创建失败：' + (e && e.message ? e.message : ''), 'error'); } }
    async function __createJob(title, ps, pe){ try{ const prefix=(function(){ const elc=document.getElementById('jobAssigneeInput'); if(elc){ return __assigneeToPrefix(elc.value||''); } const ele=document.getElementById('jobEditAssigneeInput'); return __assigneeToPrefix(ele? (ele.value||'') : ''); })(); const status=(function(){ const elc=document.getElementById('jobStatusSelect'); if(elc){ return elc.value||'todo'; } const ele=document.getElementById('jobEditStatusSelect'); return ele? (ele.value||'todo') : 'todo'; })(); const desc=(function(){ const elc=document.getElementById('jobDescInput'); if(elc){ return elc.value||''; } const ele=document.getElementById('jobEditDescInput'); return ele? (ele.value||'') : ''; })(); const priority=(function(){ const elc=document.getElementById('jobPrioritySelect'); if(elc){ return elc.value||'medium'; } const ele=document.getElementById('jobEditPrioritySelect'); return ele? (ele.value||'medium') : 'medium'; })();
      const psDate = ps ? String(ps).slice(0, 10) : null;
      const peDate = pe ? String(pe).slice(0, 10) : null;
      const payload={ kind:'JOB', project_id: projectId, title, status, planned_start_date: psDate, planned_end_date: peDate, description: desc, assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix), priority }; 
      const res=await fetch(`${API}/work-items/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(payload) }); 
      if(res.ok){ 
        let created=await res.json(); 
        created=__normalizeWorkItemShape(created); 
        if((!created.assignee||created.assignee==='') && prefix){ created.assignee = prefix; } 
        showToast('JOB 创建成功','success'); 
        const items = Array.isArray(window.__items)? window.__items.slice() : []; 
        items.push(created); 
        renderAfterLocalUpdate(items); 
        await fetchWorkItems(); 
      } else { 
        await __showErrorFromResponse(res); 
      } 
    } catch(e){  
      showToast('网络错误，创建失败：' + (e && e.message ? e.message : ''), 'error'); 
    } 
  }
    
    async function __deleteItem(idOrCode){ 
      console.log('[DEBUG] __deleteItem called with:', idOrCode);
      try{ 
        const r=await fetch(`${API}/work-items/${idOrCode}`, { 
          method:'DELETE', 
          headers:{ Authorization:`Bearer ${token}` } 
        }); 
        if(r.ok){ 
          await fetchWorkItems(); 
          showToast('删除成功', 'success');
          return; 
        } 
        const r2=await fetch(`${API}/work-items/${idOrCode}`, { 
          method:'PATCH', 
          headers:{ 
            'Content-Type':'application/json', 
            Authorization:`Bearer ${token}` 
          }, 
          body: JSON.stringify({ status:'deleted' }) 
        }); 
        if(r2.ok){ 
          await fetchWorkItems(); 
          showToast('删除成功', 'success');
        } else {
          await __showErrorFromResponse(r2, '删除失败');
        }
      }catch(e){
        console.error('[delete] Error deleting item:', e);
        showToast('网络错误，删除失败', 'error');
      } 
    }
    function renderTimeline(){ const tl=document.getElementById('timeline'); tl.innerHTML=''; if(!ganttData.tasks || ganttData.tasks.length===0){ const empty=document.createElement('div'); empty.style.padding='12px'; empty.style.color='var(--text-secondary)'; empty.textContent='暂无可显示的任务'; tl.appendChild(empty); return; } (ganttData.tasks||[]).forEach((task, ti)=>{ const row=document.createElement('div'); row.className='task-row-timeline'; row.setAttribute('data-ti', ti); row.setAttribute('data-si', -1); row.appendChild(createTaskBar(task, ti, -1)); tl.appendChild(row); (task.subtasks||[]).forEach((st, si)=>{ const sub=document.createElement('div'); sub.className='task-row-timeline'; sub.setAttribute('data-ti', ti); sub.setAttribute('data-si', si); sub.appendChild(createTaskBar(st, ti, si)); tl.appendChild(sub); }); }); enforceBarBounds(); applyTaskExpansionStates(); }
    function fixTaskTitles(){ try{ const list=document.getElementById('taskList'); if(!list) return; const titles=[...list.querySelectorAll('.task-title')]; if(!titles.length) return; const expected=[]; (ganttData.tasks||[]).forEach(t=>{ expected.push(__titleOrCode(t)); (t.subtasks||[]).forEach(st=> expected.push(__titleOrCode(st))); }); for(let i=0;i<Math.min(titles.length, expected.length); i++){ const el=titles[i]; const val=expected[i]; if(el && typeof val==='string'){ el.textContent=val; } } } catch(_){} }
    function tweakTaskListLayout(){}
    function applyTaskExpansionStates(){ 
      try{ 
        const tasks=(ganttData.tasks||[]); 
        const list=document.getElementById('taskList'); 
        if(!list) return; 
        for(let ti=0; ti<tasks.length; ti++){ 
          const t=tasks[ti]; 
          const pid=t.id||t.code; 
          const entry=(window.__expandedParents||{})[pid]; 
          const expanded=(entry===undefined)? true : !!entry; 
          const tog=list.querySelector(`[data-role="toggle"][data-ti="${ti}"]`); 
          if(tog){ 
            if(expanded) tog.classList.remove('collapsed');
            else tog.classList.add('collapsed');
            
            const parentRow=tog.closest('.parent-task'); 
            if(parentRow){ 
              let count=(t.subtasks||[]).length; 
              let sibling=parentRow.nextSibling; 
              while(count>0 && sibling){ 
                sibling.style.display = expanded ? 'flex' : 'none'; 
                sibling = sibling.nextSibling; 
                count--; 
              } 
            } 
          } 
        } 
        const tlRowsAll=[...document.querySelectorAll('#timeline .task-row-timeline')]; 
        tasks.forEach((t, ti)=>{ 
          const pid=t.id||t.code; 
          const entry=(window.__expandedParents||{})[pid]; 
          const expanded=(entry===undefined)? true : !!entry; 
          const subs=(t.subtasks||[]).length; 
          if(!subs) return; 
          const tlRows=tlRowsAll.filter(r=> parseInt(r.getAttribute('data-ti'))===ti && parseInt(r.getAttribute('data-si'))>=0 ); 
          tlRows.forEach(r=>{ r.style.display = expanded ? 'flex' : 'none'; }); 
          const assRows=[...document.querySelectorAll('#assigneeList .assignee-row')].filter(r=> parseInt(r.getAttribute('data-ti'))===ti && parseInt(r.getAttribute('data-si'))>=0 ); 
          assRows.forEach(r=>{ r.style.display = expanded ? 'flex' : 'none'; }); 
          const priRows=[...document.querySelectorAll('#priorityList .priority-row')].filter(r=> parseInt(r.getAttribute('data-ti'))===ti && parseInt(r.getAttribute('data-si'))>=0 ); 
          priRows.forEach(r=>{ r.style.display = expanded ? 'flex' : 'none'; });
        }); 
      } catch(_){} 
    }

    function enforceBarBounds(){ try{ const total=(ganttData.timeColumns||[]).length*columnWidth; const bars=[...document.querySelectorAll('#timeline .task-bar')]; bars.forEach(bar=>{ let l=parseFloat(bar.style.left)||0; let w=parseFloat(bar.style.width)||0; const tIdx=parseInt(bar.getAttribute('data-task-index')); const sIdx=parseInt(bar.getAttribute('data-subtask-index')); const taskRef = sIdx>=0 ? (ganttData.tasks[tIdx] && ganttData.tasks[tIdx].subtasks[sIdx]) : (ganttData.tasks[tIdx]); let expectedW = w; if (taskRef) { if (timeMode==='day') { expectedW = Math.max((taskRef.duration||1)*columnWidth, columnWidth); } else { const sI=dayOffsetToMonthIndex(taskRef.startDay||0); const eI=dayOffsetToMonthIndex((taskRef.startDay||0)+(taskRef.duration||1)-1); expectedW = Math.max(((eI - sI + 1) * columnWidth), columnWidth); } } w = Math.max(w, expectedW); l=Math.max(0, Math.min(l, Math.max(0, total - w))); const nw=Math.max(2, Math.min(w, Math.max(0, total - l))); bar.style.left=l+'px'; bar.style.width=nw+'px'; }); } catch(e){} }
    let __dragLimitEl=null;
    function createTaskBar(task, ti, si){ const bar=document.createElement('div'); bar.className='task-bar'; let left,width; if(timeMode==='day'){ left=(task.startDay||0)*columnWidth; width=Math.max((task.duration||1)*columnWidth,columnWidth); } else { const sIdx=dayOffsetToMonthIndex(task.startDay||0); const eIdx=dayOffsetToMonthIndex((task.startDay||0)+(task.duration||1)-1); left=sIdx*columnWidth; width=Math.max(((eIdx - sIdx + 1) * columnWidth),60); } bar.style.left=left+'px'; bar.style.width=width+'px'; bar.style.height=BAR_HEIGHT+'px'; bar.style.top=((40-BAR_HEIGHT)/2)+'px'; bar.style.backgroundColor=task.color||'var(--primary)'; bar.setAttribute('data-task-index', ti); bar.setAttribute('data-subtask-index', si); bar.setAttribute('title', task.name); bar.innerHTML = `<div class="resize-handle left"></div><span class="task-bar-text">${task.name}</span><div class="resize-handle right"></div>`; bar.addEventListener('mousedown', function(e){ const isLeft=e.target.classList.contains('left'); const isRight=e.target.classList.contains('right'); const type=isLeft?'left':(isRight?'right':'move'); const originX=e.clientX; const tIdx=parseInt(bar.getAttribute('data-task-index')); const sIdx=parseInt(bar.getAttribute('data-subtask-index')); const ref=sIdx>=0?ganttData.tasks[tIdx].subtasks[sIdx]:ganttData.tasks[tIdx]; __drag={ type, originX, tIdx, sIdx, start: ref.startDay||0, dur: ref.duration||1 }; document.addEventListener('mousemove', __onDragMove); document.addEventListener('mouseup', __onDragEnd); e.preventDefault(); }); bar.addEventListener('click', function(){ const tIdx=parseInt(bar.getAttribute('data-task-index')); const sIdx=parseInt(bar.getAttribute('data-subtask-index')); const ref=sIdx>=0?ganttData.tasks[tIdx].subtasks[sIdx]:ganttData.tasks[tIdx]; const pid=ref.id||ref.code; if(ref.type==='parent'){ window.location.href = `job.html?code=${pid}&project=${projectId}`; } else { const parent=ganttData.tasks[tIdx]; const jcode=parent.id||parent.code; window.location.href = `job.html?code=${jcode}&project=${projectId}`; } }); return bar; }
    function __onDragMove(e){
      if(!__drag) return;
      const dx=e.clientX-__drag.originX;
      const delta=Math.round(dx/columnWidth);
      const t=ganttData.tasks[__drag.tIdx];
      const isChild=__drag.sIdx>=0;
      const ref=isChild?t.subtasks[__drag.sIdx]:t;
      const parentStart=t.startDay||0;
      const parentEnd=(t.startDay||0)+(t.duration||1)-1;
      const tl=document.getElementById('timelineContainer');
      if(__drag.type==='move'){
        let attemptNs=__drag.start+delta;
        let ns=attemptNs;
        let nd=__drag.dur;
        const maxStartGlobal = Math.max(0, (totalDays - 1) - (nd - 1));
        ns = Math.max(0, Math.min(ns, maxStartGlobal));
        if(isChild){
          const maxStartParent = parentEnd - nd + 1;
          ns = Math.max(parentStart, Math.min(ns, maxStartParent));
          const outside = (attemptNs < parentStart) || ((attemptNs + nd - 1) > parentEnd);
          if(tl) tl.style.cursor = outside ? 'not-allowed' : 'default';
        } else {
          // 父任务移动：不改变父任务持续天数，只夹紧起始点；子任务长度不变，仅位置夹紧到父窗口
          const maxChildDur = __getMaxChildDuration(t);
          if(nd < maxChildDur){ if(tl) tl.style.cursor='not-allowed'; if(!__ruleToastShown){ showToast('父任务长度不可小于子任务最大长度','error'); __ruleToastShown=true; } }
          nd = Math.max(nd, maxChildDur);
          const maxStartGlobal = Math.max(0, (totalDays - 1) - (nd - 1));
          ns = Math.max(0, Math.min(ns, maxStartGlobal));
          const finalDur=nd; const finalEnd=ns + finalDur - 1;
          (t.subtasks||[]).forEach(function(st){ const d0=__fixedDurFor(st); const s0=(st.startDay||0); const fit=__fitChildToParent(s0,d0,ns,finalEnd); if(fit.s!==s0 || fit.d!==d0){ st.startDay=fit.s; st.duration=fit.d; } });
        }
        ref.startDay=ns; ref.duration=nd; try{ const k=__keyOf(ref); if(!window.__fixedDurations) window.__fixedDurations={}; window.__fixedDurations[k]=Math.max(1, nd); }catch(_){ }
      } else if(__drag.type==='left'){
        let attemptNs=__drag.start+delta;
        let ns=attemptNs;
        let nd=__drag.dur-delta;
        nd=Math.max(1, nd);
        // 全局范围限制（左闭右闭）
        if (ns < 0) ns = 0;
        const maxEndGlobal = (totalDays - 1);
        if (ns + nd - 1 > maxEndGlobal) {
          nd = Math.max(1, maxEndGlobal - ns + 1);
        }
        if(isChild){
          // 左侧缩放不得越过父起始，且右端不得超过父结束
          ns=Math.max(parentStart, ns);
          const endCandidate=ns + nd - 1;
          if(endCandidate>parentEnd){ nd = Math.max(1, parentEnd - ns + 1); }
          const outside = (attemptNs < parentStart);
          if(tl) tl.style.cursor = outside ? 'not-allowed' : 'col-resize';
        } else {
          // 规则：父任务最小持续时间不得小于所有子任务的最大持续时间；左缩放父任务时子任务长度不变，结束与父结束对齐
          const maxChildDur = __getMaxChildDuration(t);
          if(nd < maxChildDur){ if(tl) tl.style.cursor='not-allowed'; if(!__ruleToastShown){ showToast('父任务长度不可小于子任务最大长度','error'); __ruleToastShown=true; } }
          nd = Math.max(nd, maxChildDur);
          const cl2=__clamp(ns, nd); ns=cl2.s; nd=cl2.d;
          const finalDur=nd; const finalEnd=ns + finalDur - 1;
          (t.subtasks||[]).forEach(function(st){ const d0=__fixedDurFor(st); const s0=(st.startDay||0); const fit=__fitChildToParent(s0,d0,ns,finalEnd); if(fit.s!==s0 || fit.d!==d0){ st.startDay=fit.s; st.duration=fit.d; } });
        }
        ref.startDay=ns; ref.duration=nd; try{ const k=__keyOf(ref); if(!window.__fixedDurations) window.__fixedDurations={}; window.__fixedDurations[k]=Math.max(1, nd); }catch(_){ }
      } else { // right
        let attemptNd=__drag.dur+delta;
        let nd=attemptNd;
        nd=Math.max(1, nd);
        const maxDurGlobal = (totalDays - 1) - (__drag.start||0) + 1;
        nd = Math.min(nd, maxDurGlobal);
        if(isChild){
          // 右侧缩放不得超过父结束
          const maxDur = parentEnd - (ref.startDay||0) + 1;
          nd = Math.max(1, Math.min(nd, maxDur));
          const outside = ((ref.startDay||0) + attemptNd - 1) > parentEnd;
          if(tl) tl.style.cursor = outside ? 'not-allowed' : 'col-resize';
        } else {
          // 规则：父任务最小持续时间不得小于所有子任务的最大持续时间；右缩放父任务时子任务长度不变，开始与父开始对齐
          const maxChildDur = __getMaxChildDuration(t);
          if(nd < maxChildDur){ if(tl) tl.style.cursor='not-allowed'; if(!__ruleToastShown){ showToast('父任务长度不可小于子任务最大长度','error'); __ruleToastShown=true; } }
          const cl2=__clamp(__drag.start, Math.max(nd, maxChildDur)); nd=cl2.d;
          const finalDur=nd; const finalEnd=__drag.start + finalDur - 1;
          (t.subtasks||[]).forEach(function(st){ const d0=__fixedDurFor(st); const s0=(st.startDay||0); const fit=__fitChildToParent(s0,d0,__drag.start,finalEnd); if(fit.s!==s0 || fit.d!==d0){ st.startDay=fit.s; st.duration=fit.d; } });
        }
        ref.startDay=__drag.start; ref.duration=nd; try{ const k=__keyOf(ref); if(!window.__fixedDurations) window.__fixedDurations={}; window.__fixedDurations[k]=Math.max(1, nd); }catch(_){ }
      }
      renderTimeline(); enforceBarBounds();
    }
    window.__runGanttLinkageTest = function(){
      try {
        const ms = 1000*60*60*24;
        startDate = new Date('2025-11-01'); endDate = new Date('2025-11-30'); totalDays = Math.ceil((endDate-startDate)/ms)+1; columnWidth = 30;
        ganttData.tasks = [ { id:'JOB-TEST', name:'父', startDay:0, duration:10, color:'var(--primary)', type:'parent', subtasks:[ { id:'TASK-A', name:'子A', startDay:2, duration:4, color:'var(--success)' }, { id:'TASK-B', name:'子B', startDay:5, duration:3, color:'var(--success)' } ] } ];
        renderTimeline();
        // 模拟父移动 +3 天
        __drag = { type:'move', originX:0, tIdx:0, sIdx:-1, start: ganttData.tasks[0].startDay, dur: ganttData.tasks[0].duration };
        const e = { clientX: __drag.originX + 3*columnWidth };
        __onDragMove(e);
        const t = ganttData.tasks[0];
        const a = t.subtasks[0], b = t.subtasks[1];
        
        
        
        
        
      } catch(err){  }
    };
    function __onDragEnd(){
      if(!__drag) return;
      const parent=ganttData.tasks[__drag.tIdx];
      const isChild=__drag.sIdx>=0;
      const ref=isChild?parent.subtasks[__drag.sIdx]:parent;
      const oldStart=__drag.start; const oldDur=__drag.dur;
      const newStart=ref.startDay||0; const newDur=Math.max(1, ref.duration||1);
      if(newStart===oldStart && newDur===oldDur){ __drag=null; document.removeEventListener('mousemove', __onDragMove); document.removeEventListener('mouseup', __onDragEnd); renderTimeline(); enforceBarBounds(); return; }
      const changes=[];
      if(!isChild){
        const oldEnd=oldStart + oldDur - 1;
        const newEnd=newStart + newDur - 1;
        if(__drag.type==='move'){
          const maxChildDur = __getMaxChildDuration(parent);
          const finalDur = Math.max(newDur, maxChildDur);
          const finalEnd = newStart + finalDur - 1;
          (parent.subtasks||[]).forEach(st=>{
            const d0=Math.max(1, st.duration||1);
            const s0=st.startDay||0; const e0=s0 + d0 - 1;
            if (s0>=newStart && e0<=finalEnd) { return; }
            let ns=Math.max(newStart, Math.min(s0, finalEnd - d0 + 1));
            st.startDay=ns; st.duration=d0;
            const ps=__toYMD(__addDays(startDate, ns));
            const pe=__toYMD(__addDays(__addDays(startDate, ns), d0-1));
            changes.push({ idOrCode: st.id||st.code, ps, pe });
          });
          const pps=__toYMD(__addDays(startDate, newStart));
          const ppe=__toYMD(__addDays(__addDays(startDate, newStart), finalDur-1));
          changes.unshift({ idOrCode: ref.id||ref.code, ps: pps, pe: ppe });
        } else if(__drag.type==='left'){
          const maxChildDur = __getMaxChildDuration(parent);
          const finalDur = Math.max(newDur, maxChildDur);
          const finalEnd = newStart + finalDur - 1;
          (parent.subtasks||[]).forEach(st=>{
            const d0=Math.max(1, st.duration||1);
            const s0=st.startDay||0;
            const fit=__fitChildToParent(s0,d0,newStart,finalEnd);
            if(fit.s!==s0 || fit.d!==d0){
              st.startDay = fit.s; st.duration = fit.d;
              const ps=__toYMD(__addDays(startDate, fit.s));
              const pe=__toYMD(__addDays(__addDays(startDate, fit.s), fit.d-1));
              changes.push({ idOrCode: st.id||st.code, ps, pe });
            }
          });
          const pps=__toYMD(__addDays(startDate, newStart));
          const ppe=__toYMD(__addDays(__addDays(startDate, newStart), finalDur-1));
          changes.unshift({ idOrCode: ref.id||ref.code, ps: pps, pe: ppe });
        } else { // right
          const maxChildDur = __getMaxChildDuration(parent);
          const finalDur = Math.max(newDur, maxChildDur);
          const finalEnd = newStart + finalDur - 1;
          (parent.subtasks||[]).forEach(st=>{
            const d0=Math.max(1, st.duration||1);
            const s0=st.startDay||0;
            const fit=__fitChildToParent(s0,d0,newStart,finalEnd);
            if(fit.s!==s0 || fit.d!==d0){
              st.startDay=fit.s; st.duration=fit.d;
              const ps=__toYMD(__addDays(startDate, fit.s));
              const pe=__toYMD(__addDays(__addDays(startDate, fit.s), fit.d-1));
              changes.push({ idOrCode: st.id||st.code, ps, pe });
            }
          });
          const pps=__toYMD(__addDays(startDate, newStart));
          const ppe=__toYMD(__addDays(__addDays(startDate, newStart), finalDur-1));
          changes.unshift({ idOrCode: ref.id||ref.code, ps: pps, pe: ppe });
        }
      } else {
        const ps=__toYMD(__addDays(startDate, newStart));
        const pe=__toYMD(__addDays(__addDays(startDate, newStart), newDur-1));
        changes.push({ idOrCode: ref.id||ref.code, ps, pe });
      }
      const tl=document.getElementById('timelineContainer'); if(tl) tl.style.cursor='default'; if(__dragLimitEl && __dragLimitEl.parentElement){ __dragLimitEl.parentElement.removeChild(__dragLimitEl); } __dragLimitEl=null; __drag=null; __ruleToastShown=false; document.removeEventListener('mousemove', __onDragMove); document.removeEventListener('mouseup', __onDragEnd);
      (async function(){ await __batchPatch(changes.map(function(ch){ return { idOrCode: ch.idOrCode, planned_start_date: ch.ps, planned_end_date: ch.pe }; })); await fetchWorkItems(); })();
    }
    function __clamp(s,d){ const max=totalDays-1; let ns=Math.max(0, Math.min(s, max)); let nd=Math.max(1, d); if(ns+nd-1>max){ nd = Math.max(1, max - ns + 1); } return { s: ns, d: nd }; }
    function __keyOf(x){ return x && (x.id||x.code); }
    function __fixedDurFor(x){ const k=__keyOf(x); const d=(window.__fixedDurations && k)? window.__fixedDurations[k] : undefined; return Math.max(1, typeof d==='number'? d : (x && x.duration || 1)); }
    function __buildFixedDurations(){ try{ const map={}; (ganttData.tasks||[]).forEach(function(t){ map[__keyOf(t)] = Math.max(1, t.duration||1); (t.subtasks||[]).forEach(function(st){ map[__keyOf(st)] = Math.max(1, st.duration||1); }); }); window.__fixedDurations = map; }catch(_){} }
    function __clampChildrenToParents(){ try{ (ganttData.tasks||[]).forEach(function(t){ const pStart=t.startDay||0; const pEnd=(t.startDay||0)+(t.duration||1)-1; (t.subtasks||[]).forEach(function(st){ const d0=__fixedDurFor(st); const s0=st.startDay||0; const fit=__fitChildToParent(s0,d0,pStart,pEnd); st.startDay=fit.s; st.duration=fit.d; }); }); }catch(_){} }
    function __getMaxChildDuration(t){ let m=1; (t.subtasks||[]).forEach(function(st){ m = Math.max(m, Math.max(1, st.duration||1)); }); return m; }
    function __addDays(date, n){ const d=new Date(date.getTime()); d.setDate(d.getDate()+n); return d; }
    function __toYMD(date){ if(!date) return ''; const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    function __toDateTimeLocal(date){ if(!date) return ''; const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); const h=String(date.getHours()).padStart(2,'0'); const min=String(date.getMinutes()).padStart(2,'0'); const s=String(date.getSeconds()).padStart(2,'0'); return `${y}-${m}-${d}T${h}:${min}:${s}`; }
    function __createDateWithTime(date, hours, minutes = 0, seconds = 0) { const newDate = new Date(date); newDate.setHours(hours, minutes, seconds, 0); return newDate; }
    function __getCurrentDateWith9AM() { return __createDateWithTime(new Date(), 9, 0, 0); }
    function __getCurrentDateWith6PM() { return __createDateWithTime(new Date(), 18, 0, 0); }
    function __getJobDefaultStartDate() { return __getCurrentDateWith9AM(); }
    function __getJobDefaultEndDate() { return __createDateWithTime(__addDays(new Date(), 5), 18, 0, 0); }

    function __validateTaskCreationTimeFromItem(parentItem) { const now = new Date(); console.log('[validation] Direct item validation for:', parentItem); if (!parentItem) { return { valid: true, message: '', defaultStart: __getCurrentDateWith9AM(), defaultEnd: __getCurrentDateWith6PM() }; } let parentStartDate, parentEndDate; if (parentItem.planned_start || parentItem.planned_start_date) { parentStartDate = new Date(parentItem.planned_start || parentItem.planned_start_date); parentEndDate = new Date(parentItem.planned_end || parentItem.planned_end_date); console.log('[validation] Using original date fields'); } else if (typeof parentItem.startDay === 'number') { console.log('[validation] Using gantt data - startDay:', parentItem.startDay, 'endDay:', parentItem.endDay, 'duration:', parentItem.duration); console.log('[validation] Gantt startDate:', startDate); parentStartDate = __addDays(startDate, parentItem.startDay); if (typeof parentItem.endDay === 'number') { parentEndDate = __addDays(startDate, parentItem.endDay); console.log('[validation] Using endDay field'); } else if (typeof parentItem.duration === 'number') { parentEndDate = __addDays(parentStartDate, parentItem.duration - 1); console.log('[validation] Calculated from duration'); } else { console.warn('[validation] No endDay or duration found'); return { valid: true, message: '', defaultStart: __getCurrentDateWith9AM(), defaultEnd: __getCurrentDateWith6PM() }; } console.log('[validation] Calculated dates:', {parentStartDate, parentEndDate}); } else { console.warn('[validation] No valid date data found, allowing creation'); return { valid: true, message: '', defaultStart: __getCurrentDateWith9AM(), defaultEnd: __getCurrentDateWith6PM() }; } if (!parentStartDate || !parentEndDate) { console.warn('[validation] Could not determine parent dates, allowing creation'); return { valid: true, message: '', defaultStart: __getCurrentDateWith9AM(), defaultEnd: __getCurrentDateWith6PM() }; } const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const parentEndDateOnly = new Date(parentEndDate.getFullYear(), parentEndDate.getMonth(), parentEndDate.getDate()); console.log('[validation] Final time comparison:', {now: nowDateOnly, parentEnd: parentEndDateOnly, isAfterEnd: nowDateOnly > parentEndDateOnly, parentName: parentItem.name}); if (nowDateOnly > parentEndDateOnly) { const daysDiff = Math.ceil((nowDateOnly - parentEndDateOnly) / (1000 * 60 * 60 * 24)); return { valid: false, message: `当前日期（${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}）已超过父任务${parentItem.name || parentItem.id}结束日期（${parentEndDate.getFullYear()}-${String(parentEndDate.getMonth()+1).padStart(2,'0')}-${String(parentEndDate.getDate()).padStart(2,'0')}）${daysDiff}天，无法创建子任务。请先修改父任务的结束时间。`, defaultStart: null, defaultEnd: null }; } const taskStart = nowDateOnly < new Date(parentStartDate.getFullYear(), parentStartDate.getMonth(), parentStartDate.getDate()) ? __createDateWithTime(parentStartDate, 9, 0, 0) : __getCurrentDateWith9AM(); const taskEnd = __createDateWithTime(parentEndDate, 18, 0, 0); return { valid: true, message: '', defaultStart: taskStart, defaultEnd: taskEnd }; }
    function __fitChildToParent(s0,d0,pStart,pEnd){ let d=Math.max(1,d0); const span=Math.max(1,pEnd-pStart+1); if(d>span){ d=span; } let s=s0; let e=s+d-1; if(s<pStart){ s=pStart; e=s+d-1; } if(e>pEnd){ s=pEnd-d+1; e=pEnd; } if(s<pStart){ s=pStart; d=Math.max(1,pEnd-pStart+1); } return { s, d }; }
    function __fitChildDatesToParentStr(childStartStr, childEndStr, parentStartStr, parentEndStr){ try{ const msPerDay=1000*60*60*24; const d0=Math.max(1, __daysBetween(childStartStr, childEndStr)||1); const span=Math.max(1, __daysBetween(parentStartStr, parentEndStr)||1); const d=Math.max(1, Math.min(d0, span)); const pStart=new Date(parentStartStr); const pEnd=new Date(parentEndStr); const latestStart=__addDays(pEnd, -(d-1)); let ns = childStartStr ? new Date(childStartStr) : new Date(parentStartStr); if(ns < pStart) ns = pStart; if(ns > latestStart) ns = latestStart; const ne = __addDays(ns, d-1); return { ps: __toYMD(ns), pe: __toYMD(ne) }; } catch(_){ return { ps: parentStartStr, pe: parentEndStr }; } }
    async function __scheduleChange(idOrCode, ps, pe){ try{ const res=await fetch(`${API}/work-items/${idOrCode}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ planned_start_date: ps, planned_end_date: pe }) }); if(res.ok){ let updated=await res.json(); updated=__normalizeWorkItemShape(updated); showToast('时间已更新','success'); const items = Array.isArray(window.__items)? window.__items.slice() : []; const idx = items.findIndex(i=> (i.id===updated.id) || (i.code===updated.code)); if(idx>=0){ items[idx] = Object.assign({}, items[idx], updated); } else { for (let i=0;i<items.length;i++){ const subs=items[i].subtasks||[]; const si=subs.findIndex(s=> (s.id===updated.id) || (s.code===updated.code)); if(si>=0){ subs[si]=Object.assign({}, subs[si], updated); break; } } } renderAfterLocalUpdate(items); } else { await __showErrorFromResponse(res, '保存失败'); } } catch(e){  showToast('网络错误，保存失败：' + (e && e.message ? e.message : ''), 'error'); } }
    async function __checkJobTitleExists(title){ try{ if(!Number.isFinite(projectId)) { console.warn('[API] Invalid project ID for title validation'); return null; } if(!title || typeof title !== 'string') { return null; } const trimmedTitle = title.trim(); if(!trimmedTitle || trimmedTitle.length === 0) { return null; } if(!token) { console.warn('[API] No authentication token available for title validation'); return null; } const url=`${API}/work-items/name-exists?project_id=${encodeURIComponent(projectId)}&type=job&title=${encodeURIComponent(trimmedTitle)}`; console.log('[API] Checking title exists:', url); const res=await fetch(url, { headers:{ Authorization:`Bearer ${token}` } }); if(!res.ok){ console.error('[API] Title validation failed:', res.status, res.statusText); if(res.status === 422) { console.error('[API] Validation error - possibly invalid parameters or authentication issue'); } else if(res.status === 401 || res.status === 403) { console.error('[API] Authentication/authorization error for title validation'); } try{ const errorBody = await res.text(); console.error('[API] Error response body:', errorBody); }catch(_){} return null; } const result = await res.json(); console.log('[API] Title validation result:', result); return result; } catch(e){ console.error('[API] Exception in title validation:', e); return null; } }
    function renderAssigneeList(){ const list=document.getElementById('assigneeList'); list.innerHTML=''; (ganttData.tasks||[]).forEach((task, ti)=>{ const pRow=document.createElement('div'); pRow.className='assignee-row'; pRow.setAttribute('data-ti', ti); pRow.setAttribute('data-si', -1); const dn=__assigneeToDisplay(task.assignee||''); pRow.innerHTML=`<div class="assignee-avatar"></div><span class="assignee-name">${dn}</span>`; list.appendChild(pRow); (task.subtasks||[]).forEach((st, si)=>{ const row=document.createElement('div'); row.className='assignee-row'; row.setAttribute('data-ti', ti); row.setAttribute('data-si', si); const dn2=__assigneeToDisplay(st.assignee||''); row.innerHTML=`<div class="assignee-avatar"></div><span class="assignee-name">${dn2}</span>`; list.appendChild(row); }); }); }
    function __priorityToLabel(p){ const v=String(p||'').toLowerCase(); if(v==='low') return 'Low'; if(v==='high') return 'High'; return 'Medium'; }
    function __priorityToClass(p){ const v=String(p||'').toLowerCase(); if(v==='low') return 'priority-low'; if(v==='high') return 'priority-high'; return 'priority-medium'; }
    function renderPriorityList(){ const list=document.getElementById('priorityList'); if(!list) return; list.innerHTML=''; (ganttData.tasks||[]).forEach((task, ti)=>{ const pRow=document.createElement('div'); pRow.className='priority-row'; pRow.setAttribute('data-ti', ti); pRow.setAttribute('data-si', -1); const lab=__priorityToLabel(task.priority||''); const cls=__priorityToClass(task.priority||''); pRow.innerHTML=`<span class="priority-badge ${cls}">${lab}</span>`; list.appendChild(pRow); (task.subtasks||[]).forEach((st, si)=>{ const row=document.createElement('div'); row.className='priority-row'; row.setAttribute('data-ti', ti); row.setAttribute('data-si', si); const lab2=__priorityToLabel(st.priority||''); const cls2=__priorityToClass(st.priority||''); row.innerHTML=`<span class="priority-badge ${cls2}">${lab2}</span>`; list.appendChild(row); }); }); }
    function __assigneeDefaults(){ return []; }
    async function loadAssigneeDefaults(){ return; }
    function __assigneeDefaults(){ return []; }
    function __assigneeToDisplay(val){ const v=(val==null?'' : String(val)).trim(); if(!v) return 'NA'; const list=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; const byPrefix=list.find(u=>u.prefix===v); if(byPrefix) return byPrefix.name||byPrefix.prefix; const byEmail=list.find(u=>u.email===v); if(byEmail) return byEmail.name||byEmail.prefix; const byName=list.find(u=>u.name===v); if(byName) return byName.name; return v; }
    function __assigneeToPrefix(input){ const v=(input==null?'' : String(input)).trim(); if(!v) return ''; const list=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; const byName=list.find(u=>u.name===v); if(byName) return byName.prefix||''; const emailIdx=v.indexOf('@'); if(emailIdx>0) return v.slice(0, emailIdx); return v; }
    function __prefixToEmail(prefix){ const p=(prefix==null?'' : String(prefix)).trim(); if(!p) return ''; if(p.indexOf('@')>0) return p; return p+"@chinaunicom.cn"; }
    function __loadLocalAssignments(){ try{ const raw=localStorage.getItem('gantt_assignments')||'{}'; const obj=JSON.parse(raw); return (obj && typeof obj==='object')? obj : {}; } catch(_){ return {}; } }
    function __saveLocalAssignment(key, prefix){ try{ const data=__loadLocalAssignments(); data[String(key)]=String(prefix||''); localStorage.setItem('gantt_assignments', JSON.stringify(data)); } catch(_){} }
    function __daysBetween(startStr, endStr){ try{ if(!startStr||!endStr) return 0; const s=new Date(startStr); const e=new Date(endStr); const ms=1000*60*60*24; return Math.max(0, Math.floor((e - s)/ms) + 1); }catch(_){ return 0; } }
    function __isHoliday(d){ return false; }
    function __isWorkday(d){ const wd=d.getDay(); if(wd===0||wd===6) return false; if(__isHoliday(d)) return false; return true; }
    function __businessHoursBetween(startStr, endDate){ try{ if(!startStr) return 0; const s=new Date(startStr); const e=endDate||new Date(); const oneDay=1000*60*60*24; let cur=new Date(s.getFullYear(), s.getMonth(), s.getDate()); const end=new Date(e.getFullYear(), e.getMonth(), e.getDate()); let days=0; while(cur<=end){ if(__isWorkday(cur)) days++; cur=new Date(cur.getTime()+oneDay); } return days*8; }catch(_){ return 0; } }
    function updateStatusDot(selectEl, dotEl){ if(!selectEl||!dotEl) return; const val=selectEl.value||'todo'; const color=colorForStatus(val); dotEl.style.backgroundColor=color; dotEl.setAttribute('title', val); selectEl.style.background=color; const textColor = (val==='todo') ? 'var(--text-main)' : 'var(--bg-surface)'; selectEl.style.color=textColor; selectEl.style.borderColor=color; }
    function buildAssigneeSuggestions(){ const dl=document.getElementById('assigneesList'); if(!dl) return; const list=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; const html=list.map(function(u){ const n=u.name||u.prefix||''; const label=u.prefix||''; return '<option value="'+n+'" label="'+label+'" title="'+label+'"></option>'; }).join(''); dl.innerHTML=html; }
    function buildAssigneeIndex(){ const map=new Map(); const seed=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; seed.forEach(function(u){ const p=String((u.prefix||u.email_prefix||u.username||'')).trim(); if(!p) return; const n=String((u.name||u.full_name||u.username||p)); const em=String(u.email|| (p.indexOf('@')>0 ? p : (p+'@chinaunicom.cn'))); map.set(p, { name:n, prefix:p, email:em }); }); const arr=[...map.values()].sort(function(a,b){ return String(a.name||a.prefix).localeCompare(String(b.name||b.prefix)); }); window.__assigneesIndex=arr; }
    function showAssigneeDropdown(input, q){
      const list = Array.isArray(window.__assigneesIndex) ? window.__assigneesIndex : [];
      const query = String(q || '').trim().toLowerCase();
      const filtered = query ? list.filter(function(u){ return String(u.name).toLowerCase().includes(query) || String(u.prefix||'').toLowerCase().includes(query) || String(u.email||'').toLowerCase().includes(query); }) : list.slice();
      const dedup = [];
      const seen = new Set();
      for (const u of filtered) {
        const key = String(u.prefix||u.email||'').toLowerCase();
        if (!key || seen.has(key)) continue;
        seen.add(key);
        dedup.push(u);
      }
      const pageSize = 10;
      const state = window.__assigneeDropdownState || {};
      const page = (state[input.id] && state[input.id].page) || 1;
      const total = dedup.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      const cur = Math.max(1, Math.min(page, pages));
      const start = (cur - 1) * pageSize;
      const end = Math.min(start + pageSize, total);

      let el = document.getElementById('assigneeDropdown');
      if (!el) {
        el = document.createElement('div');
        el.id = 'assigneeDropdown';
        el.className = 'dropdown';
        document.body.appendChild(el);
      }
      const rect = input.getBoundingClientRect();
      el.style.display = 'block';
      el.style.position = 'fixed';
      el.style.left = rect.left + 'px';
      el.style.top = (rect.bottom + 10) + 'px';
      el.style.width = rect.width + 'px';
      if (window.__assigneesLoading) { el.innerHTML = '<div class="dropdown-item">加载中...</div>'; return; }
      if (total === 0) { el.innerHTML = '<div class="dropdown-item">暂无负责人数据</div>'; return; }
      el.style.background = 'var(--bg-surface)';
      el.style.border = '1px solid var(--border-color)';
      el.style.borderRadius = '8px';
      el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
      el.style.zIndex = 11000;
      el.style.maxHeight = '240px';
      el.style.overflowY = 'auto';
      

      const itemsHtml = dedup.slice(start, end).map(function(u){
        const tip = u.prefix || u.email || '';
        const label = (u.name || '') + (u.prefix ? ' (' + u.prefix + ')' : '');
        return '<div class="dropdown-item" style="padding:8px 10px; cursor:pointer;" title="'+ tip +'" data-name="' + u.name + '">' + label + '</div>';
      }).join('');
      const footerHtml = '<div class="dropdown-footer" style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; border-top:1px solid var(--border-color); background:var(--bg-surface);"><span style="color:var(--text-secondary); font-size:12px;">共' + total + '人，显示' + (start + 1) + '-' + end + '</span><div class="pager" style="display:flex; gap:8px;"><button data-act="prev" style="padding:4px 8px; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-surface);">上一页</button><button data-act="next" style="padding:4px 8px; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-surface);">下一页</button></div></div>';
      el.innerHTML = itemsHtml + footerHtml;

      el.querySelectorAll('.dropdown-item').forEach(function(it){
        it.onclick = function(){
          input.value = this.getAttribute('data-name') || '';
          hideAssigneeDropdown();
        };
      });

      const prev = el.querySelector('button[data-act="prev"]');
      const next = el.querySelector('button[data-act="next"]');
      if (prev) {
        prev.onclick = function(){
          window.__assigneeDropdownState = window.__assigneeDropdownState || {};
          window.__assigneeDropdownState[input.id] = { page: Math.max(1, cur - 1) };
          showAssigneeDropdown(input, input.value);
        };
      }
      if (next) {
        next.onclick = function(){
          window.__assigneeDropdownState = window.__assigneeDropdownState || {};
          window.__assigneeDropdownState[input.id] = { page: Math.min(pages, cur + 1) };
          showAssigneeDropdown(input, input.value);
        };
      }
      el.onmousedown = function(e){ e.preventDefault(); };
      el.addEventListener('wheel', function(e){ e.preventDefault(); this.scrollTop += (e.deltaY || 0); }, { passive: false });
      document.addEventListener('mousedown', function onDoc(e){ const inside=e.target===el || (el.contains(e.target)); const targetInput=e.target===input; if(!inside && !targetInput){ hideAssigneeDropdown(); document.removeEventListener('mousedown', onDoc); } });
    }
    function hookAssigneeDelegation(){
      try{
        if(window.__assigneeDelegationBound) return;
        const onClick = function(e){
          const span = e.target.closest('.assignee');
          const card = e.target.closest('.card');
          if(!span || !card) return;
          e.stopPropagation();
          const id = card.getAttribute('data-wid') || card.dataset.wid || '';
          const code = card.getAttribute('data-code') || card.dataset.code || '';
          let ref = null;
          const items = Array.isArray(window.__items)? window.__items : [];
          for(const it of items){ if(String(it.id)===String(id) || String(it.code)===String(code)){ ref = it; break; }
            const subs = it.subtasks||[]; for(const s of subs){ if(String(s.id)===String(id) || String(s.code)===String(code)){ ref = s; break; } }
            if(ref) break;
          }
          if(!ref) return;
          openAssigneePickerForItem(span, ref);
        };
        ['todo','doing','done'].forEach(function(id){ const c=document.getElementById(id); if(c){ c.addEventListener('click', onClick, true); }});
        window.__assigneeDelegationBound = true;
      }catch(_){ }
    }
    function openAssigneePickerForItem(anchorEl, itemRef){
      try{
        const list = __assigneeDefaults();
        let el = document.getElementById('assigneePicker');
        if (!el) { el = document.createElement('div'); el.id='assigneePicker'; el.className='dropdown'; document.body.appendChild(el); }
        const rect = anchorEl.getBoundingClientRect();
        el.style.display = 'block';
        el.style.left = (rect.left + window.scrollX) + 'px';
        el.style.top = (rect.bottom + window.scrollY) + 'px';
        el.style.width = Math.max(160, rect.width) + 'px';
        const itemsHtml = list.map(function(u){ const tip = u.prefix || u.email || ''; return '<div class="dropdown-item" title="'+ tip +'" data-name="' + u.name + '">' + u.name + '</div>'; }).join('');
        el.innerHTML = itemsHtml;
        el.querySelectorAll('.dropdown-item').forEach(function(it){ it.onclick = async function(){ const name=this.getAttribute('data-name')||''; const prefix=__assigneeToPrefix(name); const idOrCode=itemRef.id||itemRef.code; await __patchTask(idOrCode, { assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix) }); __saveLocalAssignment(idOrCode, prefix); el.style.display='none'; }; });
        el.onmousedown = function(e){ e.preventDefault(); };
        document.addEventListener('mousedown', function onDoc(e){ const inside=e.target===el || (el.contains(e.target)); const target= e.target===anchorEl; if(!inside && !target){ el.style.display='none'; document.removeEventListener('mousedown', onDoc); } });
      }catch(_){ }
    }
    function hideAssigneeDropdown(){ const el=document.getElementById('assigneeDropdown'); if(el) el.style.display='none'; }
    async function fetchDbAssignees(){ try{ const now=Date.now(); const cache=window.__assigneesCache||{}; if(cache.ts && Array.isArray(cache.data) && (now - cache.ts < 5*60*1000)){ window.__assigneesIndex = cache.data; return; } if(window.__assigneesLoadingPromise){ await window.__assigneesLoadingPromise; return; } window.__assigneesLoading = true; const ctrl=new AbortController(); const timer=setTimeout(()=>{ try{ ctrl.abort(); }catch(_){} }, 4000); const p=(async function(){ try{ const r=await fetch(`${API}/users`, { headers:{ Authorization:`Bearer ${token}` }, signal: ctrl.signal }); if(r.ok){ const list=await r.json(); const data = Array.isArray(list)? list.map(function(u){ return { name: u.full_name || u.username || u.email_prefix, prefix: u.email_prefix || u.username || '', email: u.email || '' }; }) : []; window.__assigneesIndex = data; window.__assigneesCache = { ts: Date.now(), data }; } else { window.__assigneesIndex=[]; showToast && showToast('加载负责人失败','error'); } }catch(e){ window.__assigneesIndex=[]; showToast && showToast('网络错误，加载负责人失败','error'); } finally { clearTimeout(timer); window.__assigneesLoading = false; window.__assigneesLoadingPromise=null; } })(); window.__assigneesLoadingPromise=p; await p; }catch(_){ window.__assigneesIndex=[]; window.__assigneesLoading=false; window.__assigneesLoadingPromise=null; } }
    function enableAssigneeDropdown(inputId){ const input=document.getElementById(inputId); if(!input) return; input.addEventListener('focus', async function(e){ e.stopPropagation(); await (window.__assigneesIndex? Promise.resolve() : fetchDbAssignees()); showAssigneeDropdown(input, input.value); }); input.addEventListener('click', function(e){ e.stopPropagation(); showAssigneeDropdown(input, input.value); }); input.addEventListener('input', function(){ showAssigneeDropdown(input, input.value); }); input.addEventListener('blur', function(){ setTimeout(hideAssigneeDropdown, 120); }); input.addEventListener('keydown', function(e){ const el=document.getElementById('assigneeDropdown'); if(!el || el.style.display!=='block') return; const items=Array.from(el.querySelectorAll('.dropdown-item')); if(items.length===0) return; const state=window.__assigneeDropdownState||{}; const st=state[input.id]||{}; let idx=st.activeIndex||0; if(e.key==='ArrowDown'){ idx=Math.min(items.length-1, idx+1); e.preventDefault(); } else if(e.key==='ArrowUp'){ idx=Math.max(0, idx-1); e.preventDefault(); } else if(e.key==='Enter'){ e.preventDefault(); const it=items[idx]; if(it){ input.value=it.getAttribute('data-name')||''; hideAssigneeDropdown(); } return; } items.forEach(i=>i.classList.remove('active')); const active=items[idx]; if(active){ active.classList.add('active'); active.scrollIntoView({ block:'nearest' }); } state[input.id]={ ...(state[input.id]||{}), activeIndex: idx }; window.__assigneeDropdownState=state; }); }
    window.__assigneeDropdownSelfTest = function(id){ try{ const input=document.getElementById(id); if(!input) return false; enableAssigneeDropdown(id); input.focus(); const count=document.querySelectorAll('#assigneeDropdown').length;  hideAssigneeDropdown(); return count===1; }catch(e){  return false; } };
    async function commitTaskAssigneeAuto(){ try{ if(!__editingTaskRef) return; const idOrCode=__editingTaskRef.id||__editingTaskRef.code; const inputVal=(document.getElementById('taskEditAssigneeInput').value||'').trim(); const prefix=__assigneeToPrefix(inputVal); if(!prefix){ return; } const currentPrefix = __assigneeToPrefix(__editingTaskRef.assignee||__editingTaskRef.assignee_prefix||''); if(prefix === currentPrefix) return; const list=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; const ok=list.some(function(u){ return u.prefix===prefix || u.name===inputVal || (u.email && inputVal.indexOf('@')>0 && u.email===inputVal); }); if(!ok){ showToast('负责人必须为数据库用户','error'); return; } const payload={ assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix) }; await __patchTask(idOrCode, payload); __saveLocalAssignment(idOrCode, prefix); }catch(_){ } }
    async function commitJobAssigneeAuto(){ try{ if(!__editingJobRef) return; const idOrCode=__editingJobRef.id||__editingJobRef.code; const inputVal=(document.getElementById('jobEditAssigneeInput').value||'').trim(); const prefix=__assigneeToPrefix(inputVal); if(!prefix){ return; } const currentPrefix = __assigneeToPrefix(__editingJobRef.assignee||__editingJobRef.assignee_prefix||''); if(prefix === currentPrefix) return; const list=Array.isArray(window.__assigneesIndex)? window.__assigneesIndex : []; const ok=list.some(function(u){ return u.prefix===prefix || u.name===inputVal || (u.email && inputVal.indexOf('@')>0 && u.email===inputVal); }); if(!ok){ showToast('负责人必须为数据库用户','error'); return; } const payload={ assignee_prefix: prefix, assignee_email: __prefixToEmail(prefix) }; await __patchTask(idOrCode, payload); __saveLocalAssignment(idOrCode, prefix); }catch(_){ } }
    function attachDatePicker(input){ if(!input) return; input.addEventListener('focus', function(){ openDatePicker(input); }); input.addEventListener('click', function(){ openDatePicker(input); }); }
    function openDatePicker(input){ const rect=input.getBoundingClientRect(); let el=document.getElementById('datePicker'); if(!el){ el=document.createElement('div'); el.id='datePicker'; el.className='date-picker'; document.body.appendChild(el); } const baseStr=input.value||__toYMD(new Date()); const base=new Date(baseStr); const year=base.getFullYear(); const month=base.getMonth(); positionDatePicker(el, rect); renderDatePicker(el, input, year, month); el.style.display='block'; }
    function positionDatePicker(el, rect){ el.style.left=(rect.left+window.scrollX)+'px'; el.style.top=(rect.bottom+window.scrollY)+'px'; }
    function renderDatePicker(el, input, year, month){ const header=`<div class="date-picker-header"><button data-act="prev">上个月</button><span>${year}年${month+1}月</span><button data-act="next">下个月</button></div>`; const first=new Date(year, month, 1); const startIdx=first.getDay(); const days=new Date(year, month+1, 0).getDate(); const minStr=input.min||''; const maxStr=input.max||''; const minDate=minStr?new Date(minStr):null; const maxDate=maxStr?new Date(maxStr):null; const cells=[]; for(let i=0;i<startIdx;i++){ cells.push('<div></div>'); } for(let d=1; d<=days; d++){ const cur=new Date(year, month, d); const disabled=(minDate && cur<minDate) || (maxDate && cur>maxDate); const style=disabled?' style="color:var(--text-secondary);cursor:not-allowed;opacity:.6;"':''; cells.push(`<div class="date-cell" data-day="${d}"${style}>${d}</div>`); } el.innerHTML=header+`<div class="date-grid">${cells.join('')}</div>`; const prev=el.querySelector('button[data-act="prev"]'); const next=el.querySelector('button[data-act="next"]'); if(prev){ prev.onclick=function(){ const m=month-1; const y=m<0?year-1:year; const mm=m<0?11:m; renderDatePicker(el, input, y, mm); }; } if(next){ next.onclick=function(){ const m=month+1; const y=m>11?year+1:year; const mm=m>11?0:m; renderDatePicker(el, input, y, mm); }; } el.querySelectorAll('.date-cell').forEach(c=>{ c.onclick=function(){ const d=parseInt(this.getAttribute('data-day')); const sel=new Date(year, month, d); if((minDate && sel<minDate) || (maxDate && sel>maxDate)) return; input.value=__toYMD(sel); el.style.display='none'; }; }); document.addEventListener('mousedown', function onDoc(e){ const inside=e.target===el || (el.contains(e.target)); const targetInput=e.target===input; if(!inside && !targetInput){ el.style.display='none'; document.removeEventListener('mousedown', onDoc); } }); }
    function getInitials(name){ if(!name) return 'NA'; return name.length>2?name.slice(-2):name; }
    // 平移
    let isPanning=false, panStartX=0, panStartScroll=0; function bindPan(el){
      if(el.__panBound) return;
      el.__panBound = true;
      el.addEventListener('mousedown', function(e){ if(e.target.closest('.task-bar') || e.target.classList.contains('resize-handle')) return; isPanning=true; panStartX=e.clientX; const th=document.querySelector('.time-header'); panStartScroll=th.scrollLeft; el.classList.add('is-panning'); e.preventDefault(); }); 
      el.addEventListener('mousemove', function(e){ if(!isPanning) return; const th=document.querySelector('.time-header'); const tl=document.getElementById('timelineContainer'); const delta=e.clientX-panStartX; th.scrollLeft=panStartScroll-delta; tl.scrollLeft=th.scrollLeft; scrollPosition=th.scrollLeft; maybeExtendTimeline(); }); 
      el.addEventListener('mouseup', function(){ isPanning=false; el.classList.remove('is-panning'); }); 
      el.addEventListener('mouseleave', function(){ isPanning=false; el.classList.remove('is-panning'); }); 
    }
    bindPan(document.querySelector('.time-header')); bindPan(document.getElementById('timelineContainer'));
    (function(){ const taskH=document.querySelector('.task-header'); const assH=document.querySelector('.assignee-header'); if(taskH){ taskH.style.cursor='pointer'; taskH.title='点击切换按名称排序'; taskH.onclick=function(){ __sortTaskAsc=!__sortTaskAsc; renderTaskList(); applyTaskExpansionStates(); renderTimeline(); applyTaskExpansionStates(); renderAssigneeList(); applyTaskExpansionStates(); }; const tog=document.getElementById('toggleAll'); const togPath=document.getElementById('toggleAllPath'); if(tog){ tog.onclick=function(){ window.__expandedParents = window.__expandedParents || {}; const tasks=(ganttData.tasks||[]); let allExpanded=true; for(const t of tasks){ const pid=t.id||t.code; const entry=(window.__expandedParents||{})[pid]; const expanded=(entry===undefined)? true : !!entry; if(!expanded){ allExpanded=false; break; } } const next=!allExpanded; tasks.forEach(t=>{ window.__expandedParents[t.id||t.code]=next; }); if(togPath){ togPath.setAttribute('d', next ? 'M7 10l5 5 5-5z' : 'M10 7l5 5-5 5z'); } applyTaskExpansionStates(); }; } } if(assH){ assH.style.cursor='pointer'; assH.title='点击切换按负责人排序'; assH.onclick=function(){ __sortAssigneeAsc=!__sortAssigneeAsc; renderAssigneeList(); applyTaskExpansionStates(); }; } })();
    (function(){ const res=document.getElementById('colResizer'); if(!res) return; let down=false, sx=0, tw=260, aw=120, pw=100; const taskH=document.querySelector('.task-header'); const assH=document.querySelector('.assignee-header'); const priH=document.querySelector('.priority-header'); const taskL=document.getElementById('taskList'); const assL=document.getElementById('assigneeList'); const priL=document.getElementById('priorityList'); const apply=()=>{ if(taskH) taskH.style.width=tw+'px'; if(assH) assH.style.width=aw+'px'; if(priH) priH.style.width=pw+'px'; if(taskL) taskL.style.width=tw+'px'; if(assL) assL.style.width=aw+'px'; if(priL) priL.style.width=pw+'px'; }; apply(); res.addEventListener('mousedown', function(e){ down=true; sx=e.clientX; document.body.style.cursor='col-resize'; }); document.addEventListener('mousemove', function(e){ if(!down) return; const dx=e.clientX-sx; tw=Math.max(160, tw+dx); aw=Math.max(100, aw-dx); sx=e.clientX; apply(); }); document.addEventListener('mouseup', function(){ if(!down) return; down=false; document.body.style.cursor='default'; }); })();
  (function(){ const tl=document.getElementById('timeline'); const tc=document.getElementById('timelineContainer'); if(!tl||!tc) return; tl.addEventListener('click', function(e){ const bar=e.target.closest('.task-bar'); if(!bar) return; e.stopPropagation(); e.preventDefault(); }, true); tl.addEventListener('dblclick', function(e){ const bar=e.target.closest('.task-bar'); if(!bar) return; const tIdx=parseInt(bar.getAttribute('data-task-index')); const sIdx=parseInt(bar.getAttribute('data-subtask-index')); const ref=sIdx>=0?ganttData.tasks[tIdx].subtasks[sIdx]:ganttData.tasks[tIdx]; if(ref.type==='parent'){ const pid=ref.id||ref.code; window.location.href = `job.html?code=${pid}&project=${projectId}`; } else { const parent=ganttData.tasks[tIdx]; const jcode=parent.id||parent.code; const tid=ref.id||ref.code; window.location.href = `task.html?code=${tid}&project=${projectId}&job=${jcode}`; } }); })();
  (function(){ 
    const tl=document.getElementById('taskList'); 
    if(!tl) return; 
    tl.addEventListener('click', function(e){ 
      const tog=e.target.closest('[data-role="toggle"]'); 
      if(!tog) return; 
      const ti=parseInt(tog.getAttribute('data-ti')); 
      const t=(ganttData.tasks||[])[ti]; 
      const pid=t&&(t.id||t.code); 
      
      const current = (window.__expandedParents || {})[pid];
      const isExpanded = (current === undefined) ? true : !!current;
      
      window.__expandedParents = window.__expandedParents || {}; 
      window.__expandedParents[pid] = !isExpanded; 
      applyTaskExpansionStates(); 
    }, false); 
  })();

  (function(){ const cancel=document.getElementById('taskEditCancelBtn'); const save=document.getElementById('taskEditSaveBtn'); if(cancel){ cancel.onclick=function(){ closeEditTaskModal(); }; } if(save){ save.onclick=async function(){ if(!__editingTaskRef) return; const idOrCode=__editingTaskRef.id||__editingTaskRef.code; const ps=document.getElementById('taskEditStartInput').value||null; const pe=document.getElementById('taskEditEndInput').value||null; if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ showToast('结束日期不得早于开始日期','error'); return; } } const prefix=__assigneeToPrefix(document.getElementById('taskEditAssigneeInput').value||''); const payload={ title: document.getElementById('taskEditTitleInput').value||'', assignee: prefix, owner: prefix, assignee_email: __prefixToEmail(prefix), planned_start_date: ps, planned_end_date: pe, status: document.getElementById('taskEditStatusSelect').value||'todo' }; await __patchTask(idOrCode, payload); closeEditTaskModal(); }; } })();
  (function(){ const cancel=document.getElementById('taskEditCancelBtn'); const save=document.getElementById('taskEditSaveBtn'); if(cancel){ cancel.onclick=function(){ closeEditTaskModal(); }; } if(save){ save.onclick=async function(){ if(!__editingTaskRef) return; const idOrCode=__editingTaskRef.id||__editingTaskRef.code; const ps=document.getElementById('taskEditStartInput').value||null; const pe=document.getElementById('taskEditEndInput').value||null; if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ showToast('结束日期不得早于开始日期','error'); return; } } const prefix=__assigneeToPrefix(document.getElementById('taskEditAssigneeInput').value||''); const payload={ title: document.getElementById('taskEditTitleInput').value||'', assignee: prefix, owner: prefix, assignee_email: __prefixToEmail(prefix), planned_start_date: ps, planned_end_date: pe, status: document.getElementById('taskEditStatusSelect').value||'todo' }; await __patchTask(idOrCode, payload); closeEditTaskModal(); }; } })();
  (function(){ const cancel=document.getElementById('jobEditCancelBtn'); const save=document.getElementById('jobEditSaveBtn'); if(cancel){ cancel.onclick=function(){ closeEditJobModal(); }; } if(save){ save.onclick=async function(){ if(!__editingJobRef) return; const idOrCode=__editingJobRef.id||__editingJobRef.code; const ps=document.getElementById('jobEditStartInput').value||null; const pe=document.getElementById('jobEditEndInput').value||null; if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ showToast('结束日期不得早于开始日期','error'); return; } const msPerDay = 1000*60*60*24; const newDurDays = Math.max(1, Math.floor((e - s)/msPerDay) + 1); let maxChildDays = 1; const kids0 = Array.isArray(__editingJobRef.subtasks)? __editingJobRef.subtasks : []; for(const k of kids0){ const ks = __getPlannedStartStr(k); const ke = __getPlannedEndStr(k); const d = __daysBetween(ks, ke) || 1; if(d>maxChildDays) maxChildDays=d; } if(newDurDays < maxChildDays){ showToast('父任务长度不可小于子任务最大长度','error'); return; } }
        const changes = [];
        changes.push({ idOrCode: idOrCode, title: document.getElementById('jobEditTitleInput').value||'', description: (document.getElementById('jobEditDescInput')? (document.getElementById('jobEditDescInput').value||'') : ''), assignee_prefix: __assigneeToPrefix(document.getElementById('jobEditAssigneeInput').value||''), planned_start_date: ps, planned_end_date: pe, status: document.getElementById('jobEditStatusSelect').value||'todo', priority: (function(){ const el=document.getElementById('jobEditPrioritySelect'); return el? (el.value||'medium') : 'medium'; })() });
        try {
          const allItems = Array.isArray(window.__items) ? window.__items.slice() : [];
          let kids = [];
          for (const it of allItems) {
            const isTask = (it.kind==='TASK') || (!!it.parent_id || !!it.parentId || !!it.parent || !!it.parent_code || !!it.parentCode);
            const matchParent = (it.parent_id===__editingJobRef.id) || (it.parentId===__editingJobRef.id) || (it.parent_code===__editingJobRef.code) || (it.parentCode===__editingJobRef.code) || (it.parent===__editingJobRef.code);
            if (isTask && matchParent) kids.push(it);
          }
          if ((!kids || kids.length===0) && Array.isArray(__editingJobRef.subtasks)) kids = __editingJobRef.subtasks;
          if (ps && pe) {
            for (const k of (kids||[])) {
              const cps = __getPlannedStartStr(k) || ps;
              const cpe = __getPlannedEndStr(k) || pe;
              const fit = __fitChildDatesToParentStr(cps, cpe, ps, pe);
              if (fit.ps !== cps || fit.pe !== cpe) {
                changes.push({ idOrCode: k.id||k.code, planned_start_date: fit.ps, planned_end_date: fit.pe });
              }
            }
          }
        } catch(_){ }
        await __batchPatch(changes);
        await fetchWorkItems();
        closeEditJobModal(); }; } })();

    function renderTimeHeaderFixed(){
      const yearRow=document.getElementById('yearRow');
      const monthRow=document.getElementById('monthRow');
      const dayRow=document.getElementById('dayRow');
      const timeline=document.getElementById('timeline');
      yearRow.innerHTML=''; monthRow.innerHTML=''; dayRow.innerHTML='';
      if(timeMode==='day'){
        const totalWidth=ganttData.timeColumns.length*columnWidth;
        [timeline,yearRow,monthRow,dayRow].forEach(el=>el.style.width=totalWidth+'px');
        dayRow.style.display='flex';
        const monthGroups={};
        ganttData.timeColumns.forEach(col=>{
          const d=col.date;
          const ym=d.getFullYear()+'-'+(d.getMonth()+1);
          if(!monthGroups[ym]) monthGroups[ym]={ year:d.getFullYear(), month:d.getMonth()+1, count:0 };
          monthGroups[ym].count++;
        });
        const yearGroups={};
        Object.values(monthGroups).forEach(m=>{ if(!yearGroups[m.year]) yearGroups[m.year]=0; yearGroups[m.year]+=m.count; });
        Object.keys(yearGroups).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{
          const div=document.createElement('div');
          div.className='year-cell';
          div.style.width=(yearGroups[y]*columnWidth)+'px';
          div.style.minWidth=div.style.width; div.style.flexShrink='0';
          div.textContent=y+'年';
          yearRow.appendChild(div);
        });
        Object.keys(monthGroups).sort((a,b)=>{
          const ya=parseInt(a.split('-')[0]);
          const ma=parseInt(a.split('-')[1]);
          const yb=parseInt(b.split('-')[0]);
          const mb=parseInt(b.split('-')[1]);
          return ya!==yb?ya-yb:ma-mb;
        }).forEach(key=>{
          const m=monthGroups[key];
          const div=document.createElement('div');
          div.className='month-cell';
          div.style.width=(m.count*columnWidth)+'px';
          div.style.minWidth=div.style.width; div.style.flexShrink='0';
          div.textContent=m.month+'月';
          monthRow.appendChild(div);
        });
        ganttData.timeColumns.forEach(col=>{
          const div=document.createElement('div');
          div.className='day-cell';
          div.style.width=columnWidth+'px';
          div.style.minWidth=div.style.width; div.style.flexShrink='0';
          div.textContent=col.date.getDate();
          dayRow.appendChild(div);
        });
      } else {
        dayRow.style.display='none';
        const totalWidth=ganttData.timeColumns.length*columnWidth;
        [timeline,yearRow,monthRow].forEach(el=>el.style.width=totalWidth+'px');
        const yearCounts={};
        (ganttData.timeColumns||[]).forEach(m=>{ const y=m.year; if(!yearCounts[y]) yearCounts[y]=0; yearCounts[y]++; });
        Object.keys(yearCounts).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{
          const div=document.createElement('div');
          div.className='year-cell';
          div.style.width=(yearCounts[y]*columnWidth)+'px';
          div.style.minWidth=div.style.width; div.style.flexShrink='0';
          div.textContent=y+'年';
          yearRow.appendChild(div);
        });
        (ganttData.timeColumns||[]).forEach(m=>{
          const div=document.createElement('div');
          div.className='month-cell';
          div.style.width=columnWidth+'px';
          div.style.minWidth=div.style.width; div.style.flexShrink='0';
          div.textContent=m.month+'月';
          monthRow.appendChild(div);
        });
      }
    }


    async function loadComments() {
      if(window.loadComments) return window.loadComments();
      try {
        const res = await fetch(`${API}/comments/project/${projectId}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('comments fetch failed');
        const raw = await res.json();
        const items = Array.isArray(raw) ? raw : [];
        const rx = /^\[reply:(\d+)\]\s*/;
        const MAX_INDENT = 1;
        const map = new Map();
        const children = new Map();
        items.forEach(function(c){
          const m = rx.exec(c.content || '');
          const replyTo = m ? parseInt(m[1], 10) : null;
          const clean = m ? (c.content || '').replace(rx, '') : (c.content || '');
          const node = Object.assign({}, c, { replyTo, content: clean });
          map.set(c.id, node);
          if (replyTo != null) {
            if (!children.has(replyTo)) children.set(replyTo, []);
            children.get(replyTo).push(node);
          }
        });
        window.__expandedReplies = window.__expandedReplies || {};
        try {
          Object.keys(window.__expandedReplies).forEach(function(k){
            const id = parseInt(k, 10);
            let cur = map.get(id);
            while(cur && cur.replyTo!=null){ cur = map.get(cur.replyTo); }
            if(cur && cur.id !== id){ window.__expandedReplies[cur.id] = true; }
          });
        } catch (_) {}
        try {
          const h=(location.hash||'').trim(); const qId=new URLSearchParams(location.search).get('commentId');
          const targetIdStr = h && h.startsWith('#comment-') ? h.slice(9) : (qId||'');
          const targetId = parseInt(targetIdStr||'', 10);
          if(Number.isFinite(targetId) && map.has(targetId)){
            let root = map.get(targetId);
            while(root && root.replyTo!=null){ root = map.get(root.replyTo); }
            if(root){
              window.__expandedReplies[root.id] = true;
              const kids = (children.get(root.id) || []).sort(function(a,b){ return new Date(a.created_at) - new Date(b.created_at); });
              const idx = kids.findIndex(function(x){ return Number(x.id)===targetId; });
              if(idx>=0){ const size=10; const page = Math.floor(idx/size)+1; window.__replyPager = window.__replyPager || {}; window.__replyPager[root.id] = { page, size }; }
            }
          }
        } catch(_){}
        const topsAll = items.filter(function(c){ const m = rx.exec(c.content || ''); return !m; }).sort(function(a,b){ return new Date(a.created_at) - new Date(b.created_at); });
        const tops = topsAll;
        function depthFor(id){ let d=0; let cur=map.get(id); const seen=new Set(); while(cur && cur.replyTo!=null && !seen.has(cur.id)){ seen.add(cur.id); d++; cur = map.get(cur.replyTo); if(d>32) break; } return d; }
        async function renderOne(c, depth, target){
          const wrap = document.createElement('div');
          wrap.id = `comment-${c.id}`;
          wrap.style.border = 'none';
          wrap.style.borderBottom = '1px solid var(--border-color)';
          wrap.style.borderRadius = '0';
          wrap.style.padding = '8px 0';
          wrap.style.margin = '0';
          const d = Math.min((depth||0), MAX_INDENT);
          if (d>0) { wrap.style.marginLeft = (16 * d) + 'px'; wrap.style.borderLeft = '2px solid var(--border-color)'; wrap.style.paddingLeft = '8px'; wrap.style.borderBottom = 'none'; }
          const replyLabel = (c.replyTo!=null ? ` · 回复 #${c.replyTo}` : '');
          const authorLabel = (c && c.author && (c.author.full_name || c.author.username || c.author.email_prefix)) || (`用户#${c.author_id}`);
          wrap.innerHTML = `<div style=\"color:var(--text-main);\">#${c.id} · ${authorLabel}${replyLabel}</div><div class=\"comment-content\" style=\"color:var(--text-main);\">${c.content}</div><div style=\"color:var(--text-secondary); font-size:12px;\">${c.created_at}</div>`;
          try{ const contentEl=wrap.querySelector('.comment-content'); if(contentEl){ contentEl.querySelectorAll('.mention').forEach(function(m){ const a=document.createElement('a'); a.href=`#comment-${c.id}`; a.textContent=m.textContent; contentEl.replaceChild(a, m); }); } }catch(_){ }
          const attachDiv = document.createElement('div'); attachDiv.style.marginTop = '6px'; attachDiv.id = `att-${c.id}`; wrap.appendChild(attachDiv);
          const actions=document.createElement('div');
          actions.style.display='flex'; actions.style.gap='12px'; actions.style.fontSize='12px'; actions.style.marginTop='6px';
          const me=window.__me||null; const isAdmin=!!window.__isAdmin; const canEditDel = !!(isAdmin || (me && (String(me.id)===String(c.author_id))));
          const mkLink=function(text, handler){ const a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=text; a.style.color='var(--primary)'; a.onclick=function(ev){ ev.preventDefault(); handler && handler(); }; return a; };
          actions.appendChild(mkLink('回复', function(){ const holderId=`reply-${c.id}`; let holder=document.getElementById(holderId); if(!holder){ holder=document.createElement('div'); holder.id=holderId; holder.style.marginTop='6px'; wrap.appendChild(holder); } const ed=createRichEditor(holderId, { entityType:'project', entityId: projectId, saveText:'发布', onSave: async function(html){ const content=(html||'').trim(); if(!content) return false; try{ const r=await fetch(`${API}/comments/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ entity_type:'project', entity_id: projectId, content: `[reply:${c.id}] ` + content }) }); if(!r.ok) return false; const data=await r.json(); const newId = (data && data.id) ? data.id : null; window.__expandedReplies = window.__expandedReplies || {}; window.__expandedReplies[c.id] = true; if(newId){ try{ location.hash = `#comment-${newId}`; }catch(_){ } } window.__restoreScrollY = window.scrollY; await loadComments(); return true; }catch(_){ return false; } } }); try{ const editorEl=document.querySelector(`#${holderId} div[contenteditable]`); if(editorEl){ editorEl.style.minHeight='80px'; } }catch(_){ } }));
          if(canEditDel){ actions.appendChild(mkLink('编辑', function(){ const holderId=`edit-${c.id}`; let holder=document.getElementById(holderId); if(!holder){ holder=document.createElement('div'); holder.id=holderId; holder.style.marginTop='6px'; wrap.appendChild(holder); } const prefix=(function(){ const m=rx.exec(items.find(function(x){ return x.id===c.id; })?.content||''); return m? m[0] : ''; })(); const ed=createRichEditor(holderId, { entityType:'project', entityId: projectId, saveText:'发布', onSave: async function(html){ const body=(html||'').trim(); if(!body) return false; try{ const r=await fetch(`${API}/comments/${c.id}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ content: prefix + body }) }); if(!r.ok) return false; window.__restoreScrollY = window.scrollY; await loadComments(); return true; }catch(_){ return false; } } }); ed.setHTML(c.content||''); try{ const editorEl=document.querySelector(`#${holderId} div[contenteditable]`); if(editorEl){ editorEl.style.minHeight='80px'; } }catch(_){ } })); actions.appendChild(mkLink('删除', async function(){ if(!confirm('确定删除这条评论吗？')) return; try{ const r=await fetch(`${API}/comments/${c.id}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` } }); if(r.ok){ window.__restoreScrollY = window.scrollY; await loadComments(); } }catch(_){ } })); }
          wrap.appendChild(actions);
          const parent = target || list;
          parent.appendChild(wrap);
          await loadAttachments(c.id);
          const kids = (children.get(c.id) || []).sort(function(a,b){ return new Date(a.created_at) - new Date(b.created_at); });
          const expanded = (window.__expandedReplies && window.__expandedReplies[c.id]) ? true : false;
          const replies = document.createElement('div'); replies.id = `replies-${c.id}`; wrap.appendChild(replies);
          const nextDepth = Math.min((depth||0) + 1, MAX_INDENT);
          const pagerBar = document.createElement('div'); pagerBar.style.fontSize='12px'; pagerBar.style.marginLeft='16px'; pagerBar.style.display='flex'; pagerBar.style.alignItems='center'; pagerBar.style.gap='8px';
          async function renderReplyPage(){ const info=(window.__replyPager && window.__replyPager[c.id]) || { page:1, size:10 }; const total=kids.length; const pageCount=Math.max(1, Math.ceil(total / info.size)); const page=Math.min(info.page, pageCount); window.__replyPager = window.__replyPager || {}; window.__replyPager[c.id] = { page, size: info.size }; replies.innerHTML=''; const start=(page-1)*info.size; const end=Math.min(start+info.size, total); for(let i=start;i<end;i++){ await renderOne(kids[i], nextDepth, replies); } pagerBar.innerHTML=''; const prev=document.createElement('a'); prev.href='javascript:void(0)'; prev.textContent='上一页'; prev.style.color = page>1? 'var(--primary)' : 'var(--text-secondary)'; if(page>1){ prev.onclick=async function(){ window.__replyPager[c.id].page = page-1; await renderReplyPage(); }; } const infoSpan=document.createElement('span'); infoSpan.style.color='var(--text-secondary)'; infoSpan.textContent = `${page}/${pageCount}`; const next=document.createElement('a'); next.href='javascript:void(0)'; next.textContent='下一页'; next.style.color = page<pageCount? 'var(--primary)' : 'var(--text-secondary)'; if(page<pageCount){ next.onclick=async function(){ window.__replyPager[c.id].page = page+1; await renderReplyPage(); }; } pagerBar.appendChild(prev); pagerBar.appendChild(infoSpan); pagerBar.appendChild(next); }
          if ((depth||0)===0 && kids.length>0) {
            if(!expanded){
              await renderOne(kids[0], nextDepth, replies);
              if(kids.length>1){
                const oldMore=wrap.querySelector(`#more-${c.id}`); if(oldMore) oldMore.remove();
                const more=document.createElement('a');
                more.href='javascript:void(0)';
                more.textContent=`展开全部回复(${kids.length-1})`;
                more.style.color='var(--primary)';
                more.style.fontSize='12px';
                more.style.marginLeft='16px';
                more.id=`more-${c.id}`;
                more.onclick=async function(){
                  window.__expandedReplies = window.__expandedReplies || {};
                  window.__expandedReplies[c.id] = true;
                  window.__replyPager = window.__replyPager || {};
                  window.__replyPager[c.id] = { page:1, size:10 };
                  more.remove();
                  await renderReplyPage();
                  const oldCollapse=wrap.querySelector(`#collapse-${c.id}`); if(oldCollapse) oldCollapse.remove();
                  const collapse=document.createElement('a');
                  collapse.href='javascript:void(0)';
                  collapse.textContent='收起回复';
                  collapse.style.color='var(--primary)';
                  collapse.style.fontSize='12px';
                  collapse.style.marginLeft='16px';
                  collapse.id=`collapse-${c.id}`;
                  collapse.onclick=function(){ try{ this.remove(); }catch(_){ }
                    window.__expandedReplies[c.id] = false;
                    replies.innerHTML='';
                    pagerBar.innerHTML='';
                    const prevMore=wrap.querySelector(`#more-${c.id}`); if(prevMore) prevMore.remove();
                    const m=document.createElement('a');
                    m.href='javascript:void(0)';
                    m.textContent=`展开全部回复(${kids.length-1})`;
                    m.style.color='var(--primary)';
                    m.style.fontSize='12px';
                    m.style.marginLeft='16px';
                    m.id=`more-${c.id}`;
                    m.onclick=more.onclick;
                    wrap.appendChild(m);
                  };
                  wrap.appendChild(collapse);
                  wrap.appendChild(pagerBar);
                };
                wrap.appendChild(more);
              }
            } else {
              await renderReplyPage();
              const oldCollapse=wrap.querySelector(`#collapse-${c.id}`); if(oldCollapse) oldCollapse.remove();
              const collapse=document.createElement('a');
              collapse.href='javascript:void(0)';
              collapse.textContent='收起回复';
              collapse.style.color='var(--primary)';
              collapse.style.fontSize='12px';
              collapse.style.marginLeft='16px';
              collapse.id=`collapse-${c.id}`;
              collapse.onclick=function(){ try{ this.remove(); }catch(_){ }
                window.__expandedReplies[c.id] = false;
                replies.innerHTML='';
                pagerBar.innerHTML='';
                const prevMore=wrap.querySelector(`#more-${c.id}`); if(prevMore) prevMore.remove();
                const m=document.createElement('a');
                m.href='javascript:void(0)';
                m.textContent=`展开全部回复(${kids.length-1})`;
                m.style.color='var(--primary)';
                m.style.fontSize='12px';
                m.style.marginLeft='16px';
                m.onclick=async function(){
                  window.__expandedReplies[c.id] = true;
                  window.__replyPager = window.__replyPager || {};
                  window.__replyPager[c.id] = { page:1, size:10 };
                  m.remove();
                  await renderReplyPage();
                  const oldCollapse2=wrap.querySelector(`#collapse-${c.id}`); if(oldCollapse2) oldCollapse2.remove();
                  const cc=document.createElement('a');
                  cc.href='javascript:void(0)';
                  cc.textContent='收起回复';
                  cc.style.color='var(--primary)';
                  cc.style.fontSize='12px';
                  cc.style.marginLeft='16px';
                  cc.onclick=collapse.onclick;
                  cc.id=`collapse-${c.id}`;
                  wrap.appendChild(cc);
                  wrap.appendChild(pagerBar);
                };
                m.id=`more-${c.id}`;
                wrap.appendChild(m);
              };
              wrap.appendChild(collapse);
              wrap.appendChild(pagerBar);
            }
          }
          else if (kids.length>0) {
            let root = c;
            while(root && root.replyTo!=null){ root = map.get(root.replyTo); }
            const rootId = root ? root.id : c.id;
            const isExpanded = !!(window.__expandedReplies && window.__expandedReplies[rootId]);
            if (isExpanded) {
              for (let i=0; i<kids.length; i++) { await renderOne(kids[i], nextDepth, replies); }
            }
          }
        }
        for (const c of tops) { await renderOne(map.get(c.id), 0, null); }
        const history = document.getElementById('historyList'); if(history){ PageHistory.renderTo('historyList'); }
        try{ const h=(location.hash||'').trim(); const qId=new URLSearchParams(location.search).get('commentId'); const targetId = h && h.startsWith('#comment-') ? h.slice(1) : (qId? `comment-${qId}` : ''); if(targetId){ const target=document.getElementById(targetId); if(target){ target.scrollIntoView({ behavior:'smooth', block:'start' }); target.style.boxShadow='0 0 0 2px var(--primary) inset'; setTimeout(()=>{ target.style.boxShadow=''; }, 1500); } } }catch(_){}
        try{ const onHashChange=async function(){ const h=(location.hash||'').trim(); const tidStr = h && h.startsWith('#comment-') ? h.slice(9) : ''; const tid = parseInt(tidStr||'', 10); if(Number.isFinite(tid)){ try{ window.__expandedReplies = window.__expandedReplies || {}; window.__replyPager = window.__replyPager || {}; const rx = /^\[reply:(\d+)\]/; let root = map.get(tid); while(root && root.replyTo!=null){ root = map.get(root.replyTo); } if(root){ window.__expandedReplies[root.id] = true; const kids = (children.get(root.id) || []).sort(function(a,b){ return new Date(a.created_at) - new Date(b.created_at); }); const idx = kids.findIndex(function(x){ return Number(x.id)===tid; }); if(idx>=0){ const size=10; const page = Math.floor(idx/size)+1; window.__replyPager[root.id] = { page, size }; } } await loadComments(); }catch(_){ } } }; window.addEventListener('hashchange', onHashChange); }catch(_){}
        if(typeof window.__restoreScrollY==='number'){ try{ window.scrollTo({ top: window.__restoreScrollY }); }catch(_){ window.scrollTo(0, window.__restoreScrollY); } window.__restoreScrollY=undefined; }
      } catch (e) {
        list.textContent = '评论加载失败';
      }
    }

    async function loadAttachments(commentId) {}

    
    function bindCommentTabs(){ const cTab=document.getElementById('tabComments'); const hTab=document.getElementById('tabHistory'); const cPane=document.getElementById('commentsPane'); const hPane=document.getElementById('historyPane'); if(cTab&&hTab){ cTab.onclick=function(){ cTab.classList.add('active'); hTab.classList.remove('active'); cPane.style.display='block'; hPane.style.display='none'; PageHistory.log('切换标签','Comments'); }; hTab.onclick=function(){ hTab.classList.add('active'); cTab.classList.remove('active'); cPane.style.display='none'; hPane.style.display='block'; PageHistory.renderTo('historyList'); PageHistory.log('切换标签','History'); }; } }
    async function loadProjectAttachments(){ try{ const res=await fetch(`${API}/comments/project/${projectId}`, { headers:{ Authorization:`Bearer ${token}` } }); if(!res.ok) return; const items=await res.json(); const files=[]; for(const c of items){ try{ const r=await fetch(`${API}/attachments/comments/${c.id}`, { headers:{ Authorization:`Bearer ${token}` } }); if(r.ok){ const list=await r.json(); list.forEach(a=> files.push({ id:a.id, name:a.file_name })); } } catch (e) {} } const div=document.getElementById('projAttachmentList'); if(div){ div.innerHTML = files.length? files.map(a=> `<a href="${API}/attachments/${a.id}" target="_blank">${a.name}</a>`).join(' · ') : '暂无附件'; } } catch (e) {} }
    (function(){ const up=document.getElementById('projAttachUpload'); const file=document.getElementById('projAttachFile'); if(up){ up.onclick = async function(){ if(!file || !file.files.length) return; try{ const r = await fetch(`${API}/comments/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ entity_type:'project', entity_id: projectId, content: '附件' }) }); if(!r.ok) return; const data=await r.json(); const id=data.id; const fd=new FormData(); fd.append('file', file.files[0]); const rr=await fetch(`${API}/attachments/comments/${id}`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body: fd }); if(rr.ok){ PageHistory.log('上传附件', `项目#${projectId}`); await loadProjectAttachments(); } } catch (e) {} } } bindCommentTabs(); })();
    (function(){ var cm=CommentsModule.init({ entityType:'project', entityId: projectId, selectors:{ listId:'comments', editorId:'commentEditor', addBtnId:'addCommentBtn', cancelBtnId:'cancelCommentBtn', errorId:'commentError', historyListId:'historyList' }, hooks:{ PageHistory: PageHistory } }); window.loadComments=cm.load; window.__disableLegacyProjectComments=true; })();

    window.addEventListener('error', (e)=>{  });
    if (Number.isFinite(projectId)) {
      fetchProject();
      fetchWorkItems();
      window.loadComments && window.loadComments();
    }
    (function(){ const btnTask=document.getElementById('globalAddTask'); if(btnTask){ btnTask.onclick=function(){ const firstJob=(Array.isArray(ganttData.tasks)?ganttData.tasks:[]).find(t=>t.type==='parent'); if(!firstJob){ showToast('请先创建一个JOB','error'); return; } openCreateTaskModal(firstJob); }; } const btnJob=document.getElementById('globalAddJob'); if(btnJob){ btnJob.onclick=function(){ openCreateJobModal(); }; } const jobCancel=document.getElementById('jobCancelBtn'); if(jobCancel){ jobCancel.onclick=function(){ closeCreateJobModal(); }; } const taskCancel=document.getElementById('taskCancelBtn'); if(taskCancel){ taskCancel.onclick=function(){ closeCreateTaskModal(); }; } const taskCreate=document.getElementById('taskCreateBtn'); if(taskCreate){ taskCreate.onclick=function(){ const sel=document.getElementById('taskJobSelect'); const pid=sel && sel.value ? sel.value : null; const title=(document.getElementById('taskTitleInput').value||'').trim(); const ass=(document.getElementById('taskAssigneeInput').value||'').trim(); const status=(document.getElementById('taskStatusSelect').value||'todo'); const ps=document.getElementById('taskStartInput').value||''; const pe=document.getElementById('taskEndInput').value||''; if(!pid){ showToast('请选择所属JOB','error'); return; } if(!title){ showToast('请输入任务标题','error'); return; } if(!ass){ showToast('请输入负责人','error'); return; } const parent=(ganttData.tasks||[]).find(t=> String(t.id||t.code)===String(pid)); if(parent){ const validation = __validateTaskCreationTimeFromItem(parent); if(!validation.valid){ const err=document.getElementById('taskDateError'); if(err) err.textContent=validation.message; showToast(validation.message, 'error'); return; } } if(ps && pe){ const s=new Date(ps); const e=new Date(pe); if(e<s){ const err=document.getElementById('taskDateError'); if(err) err.textContent='结束日期不得早于开始日期'; showToast('结束日期不得早于开始日期','error'); return; } } __createTask(pid, title, ps, pe); closeCreateTaskModal(); }; } const jobCreate=document.getElementById('jobCreateBtn'); if(jobCreate){ jobCreate.onclick=async function(){ const title=(document.getElementById('jobTitleInput').value||'').trim(); const ass=(document.getElementById('jobAssigneeInput').value||'').trim(); const status=(document.getElementById('jobStatusSelect').value||'todo'); const ps=document.getElementById('jobStartInput').value||''; const pe=document.getElementById('jobEndInput').value||''; if(!title){ showToast('请输入任务标题','error'); return; } if(!ass){ showToast('请输入负责人','error'); return; } if(!ps||!pe){ showToast('请选择开始/结束日期','error'); return; } if(new Date(pe)<new Date(ps)){ const err=document.getElementById('jobDateError'); if(err) err.textContent='结束日期不得早于开始日期'; showToast('结束日期不得早于开始日期','error'); return; } try{ const exists=await __checkJobTitleExists(title); if(exists && exists.exists){ const err=document.getElementById('jobTitleError'); if(err) err.textContent='名称在项目内已存在'; showToast('名称在项目内已存在','error'); return; } }catch(e){ console.warn('[validation] Title validation failed, proceeding with creation:', e); } await __createJob(title, ps, pe); closeCreateJobModal(); }; } const jobTitle=document.getElementById('jobTitleInput'); if(jobTitle){ let tmr=null; let validationEnabled = true; jobTitle.oninput=function(){ const err=document.getElementById('jobTitleError'); if(err) err.textContent=''; clearTimeout(tmr); const val=(jobTitle.value||'').trim(); if(!val || val.length === 0){ return; } if(val.length > 500){ if(err) err.textContent='标题长度不能超过500个字符'; return; } if(!validationEnabled){ return; } tmr=setTimeout(async function(){ try{ const exists=await __checkJobTitleExists(val); const err=document.getElementById('jobTitleError'); if(exists && exists.exists){ if(err) err.textContent='名称在项目内已存在'; } }catch(e){ console.error('[validation] Error checking title:', e); validationEnabled = false; console.warn('[validation] Disabling title validation due to repeated errors'); } }, 300); }; } const sel=document.getElementById('taskJobSelect'); if(sel){ sel.onchange=function(){ try{ const parent=(ganttData.tasks||[]).find(t=> (t.id||t.code)===(sel.value||'')); if(parent){ const validation = __validateTaskCreationTimeFromItem(parent); const err=document.getElementById('taskDateError'); if(!validation.valid){ if(err) err.textContent=validation.message; showToast(validation.message, 'error'); return; } const ps=__toDateTimeLocal(validation.defaultStart); const pe=__toDateTimeLocal(validation.defaultEnd); const sEl=document.getElementById('taskStartInput'); const eEl=document.getElementById('taskEndInput'); sEl.value=ps; eEl.value=pe; sEl.min=ps; sEl.max=pe; eEl.min=ps; eEl.max=pe; if(err) err.textContent=''; } }catch(e){ console.error('[task] Error in job selection change:', e); } }; } const sEl=document.getElementById('taskStartInput'); const eEl=document.getElementById('taskEndInput'); [sEl,eEl].forEach(function(el){ if(!el) return; el.oninput=function(){ const ps=document.getElementById('taskStartInput').value||''; const pe=document.getElementById('taskEndInput').value||''; const err=document.getElementById('taskDateError'); if(err) err.textContent=''; if(ps && pe){ if(new Date(pe)<new Date(ps)){ if(err) err.textContent='结束日期不得早于开始日期'; } const min=el.min, max=el.max; if((min && ps<min) || (max && pe>max)){ if(err) err.textContent='日期超出所属JOB范围'; } } }; }); window.openCreateTaskEditModal = function(parent){ openCreateTaskModal(parent); }; window.openCreateJobEditModal = function(){ openCreateJobModal(); }; })();
    window.__runGanttSelfTest = function(){
      try{
        const sd0=new Date(startDate.getTime()); const ed0=new Date(endDate.getTime()); const tm0=timeMode; const cw0=columnWidth; const cols0=(ganttData.timeColumns||[]).slice();
        startDate=new Date('2025-01-01'); endDate=new Date('2025-03-31'); timeMode='month'; columnWidth=100; generateTimeColumns();
        const a=dayOffsetToMonthIndex(0); const b=dayOffsetToMonthIndex(40);
        
        
        const items=[{kind:'JOB',code:'JOB-1',title:'J',status:'todo',planned_start:'2025-01-10',planned_end:'2025-02-20'}];
        buildGanttTasks(items);
        
        startDate=sd0; endDate=ed0; timeMode=tm0; columnWidth=cw0; ganttData.timeColumns=cols0;
        
      }catch(e){  }
    };

    // Add dropdown menu HTML if not exists
    if (!document.getElementById('actionMenu')) {
      const menu = document.createElement('div');
      menu.id = 'actionMenu';
      menu.className = 'action-dropdown';
      document.body.appendChild(menu);
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.more-btn') && !e.target.closest('.action-dropdown')) {
          closeActionMenu();
        }
      });
      
      // Add scroll and resize listeners for dynamic positioning
      window.addEventListener('scroll', positionActionMenu, true);
      window.addEventListener('resize', positionActionMenu);
    }

  } // 闭合 else 块

  // 全局变量定义 - 移到 else 块外部确保全局可访问
  let startDate = (function(){ const y=new Date().getFullYear()-1; return new Date(y,0,1); })();
  let endDate = (function(){ const y=new Date().getFullYear()+1; return new Date(y,11,31); })();
  let __creatingTask = false;
  let __creatingParentRef = null;
  let __creatingJob = false;
  let totalDays = 0;
  let columnWidth = 30;
  let timeMode = 'day';
  let scrollPosition = 0;
  let viewportWidth = 1200;
  let currentDate = new Date();
  let BAR_HEIGHT = 20;
  let __drag = null;
  let __ruleToastShown = false;
  // ganttData moved to global scope
  let __sortTaskAsc = true;
  let __sortAssigneeAsc = true;
  window.__expandedParents = window.__expandedParents || {};
  window.__expandedJobCards = window.__expandedJobCards || {};

  // 全局辅助函数 - 确保在全局作用域
  async function __patchTask(idOrCode, payload){
    try{
      try{
        if(payload && payload.priority===undefined){
          const jel=document.getElementById('jobEditPrioritySelect');
          const tel=document.getElementById('taskEditPrioritySelect');
          if(jel && jel.value){ payload.priority = jel.value || 'medium'; }
          else if(tel && tel.value){ payload.priority = tel.value || 'medium'; }
        }
        if(payload && payload.planned_start_date && typeof payload.planned_start_date==='string'){
          payload.planned_start_date = payload.planned_start_date.slice(0, 10);
        }
        if(payload && payload.planned_end_date && typeof payload.planned_end_date==='string'){
          payload.planned_end_date = payload.planned_end_date.slice(0, 10);
        }
      }catch(_){ }
      const res=await fetch(`${API}/work-items/${idOrCode}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(payload) });
      if(res.ok){ 
        let updated=await res.json(); 
        updated=__normalizeWorkItemShape(updated); 
        if((!updated.assignee || updated.assignee==='') && payload){ 
          if(payload.assignee){ 
            updated.assignee = payload.assignee; 
          } else if(payload.assignee_prefix){ 
            updated.assignee = payload.assignee_prefix; 
          } else if(payload.assignee_email){ 
            updated.assignee = __assigneeToPrefix(payload.assignee_email); 
          } 
        } 
        showToast('任务已更新','success'); 
        const items = Array.isArray(window.__items)? window.__items.slice() : []; 
        const idx = items.findIndex(i=> (i.id===updated.id) || (i.code===updated.code)); 
        if(idx>=0){ 
          items[idx] = Object.assign({}, items[idx], updated); 
        } else { 
          for (let i=0;i<items.length;i++){ 
            const subs=items[i].subtasks||[]; 
            const si=subs.findIndex(s=> (s.id===updated.id) || (s.code===updated.code)); 
            if(si>=0){ 
              subs[si]=Object.assign({}, subs[si], updated); 
              break; 
            } 
          } 
        } 
        renderAfterLocalUpdate(items); 
      } else { 
        await __showErrorFromResponse(res, '保存失败'); 
      }
    } catch(e){ 
       
      showToast('网络错误，保存失败：' + (e && e.message ? e.message : ''), 'error'); 
    }
  }

// 全局下拉菜单变量和函数 - 移到else块外部确保全局可访问
let currentActionTarget = null;
let __actionMenuAnchor = null;
const ganttData = { tasks: [], timeColumns: [], assignees: [] };

function showTaskMenu(e, ti, si) {
  e.stopPropagation();
  e.preventDefault();
  
  const menu = document.getElementById('actionMenu');
  currentActionTarget = { ti, si };
  __actionMenuAnchor = e.target.closest('.more-btn') || e.target;
  
  const isParent = si === -1;
  const task = ganttData.tasks[ti];
  const subtask = isParent ? null : task.subtasks[si];
  const currentItem = isParent ? task : subtask;
  
  let html = '';
  if (isParent) {
    // 新增子任务
    html += `<div class="action-item" onclick="handleAction('add-task')">
      <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      新增子任务
    </div>`;
    
    // 编辑 JOB
    html += `<div class="action-item" onclick="handleAction('edit-job')">
      <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      编辑 JOB
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 优先级选项
    html += `<div class="action-item" onclick="updatePriority('high')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger); margin-right: 4px;"></div>
      设为 High
    </div>`;
    html += `<div class="action-item" onclick="updatePriority('medium')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning); margin-right: 4px;"></div>
      设为 Medium
    </div>`;
    html += `<div class="action-item" onclick="updatePriority('low')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); margin-right: 4px;"></div>
      设为 Low
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 状态选项
    html += `<div class="action-item" onclick="updateStatus('todo')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning); margin-right: 8px;"></div>
      设为 待办
    </div>`;
    html += `<div class="action-item" onclick="updateStatus('doing')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success); margin-right: 8px;"></div>
      设为 进行中
    </div>`;
    html += `<div class="action-item" onclick="updateStatus('done')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--primary); margin-right: 8px;"></div>
      设为 已完成
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 删除 JOB
    html += `<div class="action-item danger" onclick="handleAction('del-job')">
      <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
      删除 JOB
    </div>`;
  } else {
    // 编辑任务
    html += `<div class="action-item" onclick="handleAction('edit-task')">
      <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      编辑任务
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 优先级选项
    html += `<div class="action-item" onclick="updatePriority('high')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger); margin-right: 4px;"></div>
      设为 High
    </div>`;
    html += `<div class="action-item" onclick="updatePriority('medium')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning); margin-right: 4px;"></div>
      设为 Medium
    </div>`;
    html += `<div class="action-item" onclick="updatePriority('low')">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); margin-right: 4px;"></div>
      设为 Low
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 状态选项
    html += `<div class="action-item" onclick="updateStatus('todo')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning); margin-right: 8px;"></div>
      设为 待办
    </div>`;
    html += `<div class="action-item" onclick="updateStatus('doing')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success); margin-right: 8px;"></div>
      设为 进行中
    </div>`;
    html += `<div class="action-item" onclick="updateStatus('done')">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--primary); margin-right: 8px;"></div>
      设为 已完成
    </div>`;
    
    // 分隔线
    html += `<div style="height: 1px; background: var(--border-color); margin: 4px 0;"></div>`;
    
    // 删除任务
    html += `<div class="action-item danger" onclick="handleAction('del-task')">
      <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
      删除任务
    </div>`;
  }
  
  menu.innerHTML = html;
  menu.classList.add('show');
  
  // 延迟定位，确保菜单已渲染
  setTimeout(() => {
    positionActionMenu();
  }, 10);
}

function positionActionMenu(){ 
  const menu = document.getElementById('actionMenu'); 
  if (!menu) return; 
  if (!menu.classList.contains('show')) return; 
  if (!__actionMenuAnchor) return; 
  
  // getBoundingClientRect 返回相对于视窗的位置，配合 fixed 定位正好
  const rect = __actionMenuAnchor.getBoundingClientRect(); 
  const menuWidth = 160; 
  
  // 获取菜单的实际高度，如果还没渲染则使用估算值
  let menuHeight = menu.offsetHeight || 200;
  
  // 计算左侧位置，优先显示在右侧
  let left = rect.right + 4; 
  if (left + menuWidth > window.innerWidth) { 
    // 如果右侧空间不够，显示在左侧
    left = rect.left - menuWidth - 4; 
  }
  // 确保不超出左边界
  if (left < 4) {
    left = 4;
  }
  
  // 智能计算垂直位置
  let top = rect.top;
  const spaceBelow = window.innerHeight - rect.bottom;
  const spaceAbove = rect.top;
  
  // 如果下方空间不足，但上方空间充足，则向上显示
  if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
    top = rect.top - menuHeight - 4; // 显示在按钮上方
  } else if (spaceBelow < menuHeight && spaceAbove < menuHeight) {
    // 如果上下空间都不足，选择空间较大的一侧，并调整到边界
    if (spaceBelow > spaceAbove) {
      top = window.innerHeight - menuHeight - 4; // 贴底显示
    } else {
      top = 4; // 贴顶显示
    }
  }
  // 如果下方空间充足，保持默认的 top = rect.top
  
  // 最终边界检查
  if (top < 4) {
    top = 4;
  }
  if (top + menuHeight > window.innerHeight - 4) {
    top = window.innerHeight - menuHeight - 4;
  }
  
  menu.style.left = `${left}px`; 
  menu.style.top = `${top}px`; 
}

function closeActionMenu() {
  const menu = document.getElementById('actionMenu');
  if (menu) menu.classList.remove('show');
  currentActionTarget = null;
  __actionMenuAnchor = null;
}

function handleAction(action) {
  // 临时在这里定义__deleteItem函数
  if (typeof __deleteItem === 'undefined') {
    window.__deleteItem = async function(idOrCode) {
      try {
        const API = (window.API) || 'http://localhost:8000/api';
        const token = localStorage.getItem('token') || '';
        
        const r = await fetch(`${API}/work-items/${idOrCode}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (r.ok) {
          // 直接从DOM中移除元素，无需刷新页面
          removeItemFromDOM(idOrCode);
          showToast('删除成功', 'success');
          return;
        }
        
        const r2 = await fetch(`${API}/work-items/${idOrCode}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ status: 'deleted' })
        });
        
        if (r2.ok) {
          // 直接从DOM中移除元素，无需刷新页面
          removeItemFromDOM(idOrCode);
          showToast('删除成功', 'success');
        } else {
          showToast('删除失败', 'error');
        }
      } catch (e) {
        console.error('[delete] Error deleting item:', e);
        showToast('网络错误，删除失败', 'error');
      }
    };
    
    // 辅助函数：从DOM中移除已删除的元素
    function removeItemFromDOM(idOrCode) {
      try {
        let removedCount = 0;
        
        // 移除看板卡片 - 尝试多种选择器
        const kanbanSelectors = [
          `[data-wid="${idOrCode}"]`,
          `[data-code="${idOrCode}"]`,
          `[data-id="${idOrCode}"]`
        ];
        
        kanbanSelectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(element => {
            element.remove();
            removedCount++;
          });
        });
        
        // 移除甘特图中的任务行 - 查找包含该ID的所有相关元素
        const allElements = document.querySelectorAll('*[data-wid], *[data-code], *[data-id]');
        allElements.forEach(element => {
          const elementId = element.dataset.wid || element.dataset.code || element.dataset.id;
          if (elementId === String(idOrCode)) {
            element.remove();
            removedCount++;
          }
        });
        
        // 特别处理卡片容器
        const cards = document.querySelectorAll('.card, .kanban-card, .task-card');
        cards.forEach(card => {
          const cardId = card.dataset.wid || card.dataset.code || card.dataset.id;
          if (cardId === String(idOrCode)) {
            card.remove();
            removedCount++;
          }
        });
        
        // 更新全局数据
        if (window.__items) {
          window.__items = window.__items.filter(item => {
            const itemId = String(item.id || item.code);
            const targetId = String(idOrCode);
            return itemId !== targetId;
          });
          
          // 同时更新任务的子任务
          window.__items.forEach(item => {
            if (item.subtasks && Array.isArray(item.subtasks)) {
              item.subtasks = item.subtasks.filter(subtask => {
                const subtaskId = String(subtask.id || subtask.code);
                const targetId = String(idOrCode);
                return subtaskId !== targetId;
              });
            }
          });
        }
        
        // 重新渲染甘特图以反映更改
        if (typeof buildGanttTasks === 'function' && typeof renderAll === 'function') {
          try {
            buildGanttTasks(window.__items);
            renderAll();
          } catch (e) {
            // 如果甘特图渲染失败，静默处理
          }
        }
        
        if (removedCount === 0) {
          // 如果没有找到任何元素，延迟刷新页面
          setTimeout(() => window.location.reload(), 1000);
        }
        
      } catch (e) {
        console.error('[delete] Error removing item from DOM:', e);
        setTimeout(() => window.location.reload(), 1000);
      }
    }
  }
  
  console.log('[DEBUG] __deleteItem function exists:', typeof __deleteItem);
  if (!currentActionTarget) return;
  const { ti, si } = currentActionTarget;
  const task = ganttData.tasks[ti];
  const subtask = si >= 0 ? task.subtasks[si] : null;
  
  closeActionMenu();
  
  if (action === 'add-task') {
    openCreateTaskModal(task);
  } else if (action === 'edit-job') {
    openEditJobModal(task);
  } else if (action === 'del-job') {
    if(confirm('确定要删除这个 JOB 及其所有子任务吗？')){
       __deleteItem(task.id || task.code);
    }
  } else if (action === 'edit-task') {
    openEditTaskModal(subtask);
  } else if (action === 'del-task') {
    if(confirm('确定要删除这个任务吗？')){
       __deleteItem(subtask.id || subtask.code);
    }
  }
}

async function updatePriority(priority) {
  if (!currentActionTarget) return;
  const { ti, si } = currentActionTarget;
  const task = ganttData.tasks[ti];
  const item = si >= 0 ? task.subtasks[si] : task;
  
  closeActionMenu();
  
  try {
    const idOrCode = item.id || item.code;
    await __patchTask(idOrCode, { priority });
    showToast('优先级已更新', 'success');
  } catch (e) {
    
    showToast('更新优先级失败', 'error');
  }
}

async function updateStatus(status) {
  if (!currentActionTarget) return;
  const { ti, si } = currentActionTarget;
  const task = ganttData.tasks[ti];
  const item = si >= 0 ? task.subtasks[si] : task;
  
  closeActionMenu();
  
  try {
    const idOrCode = item.id || item.code;
    await __patchTask(idOrCode, { status });
    showToast('状态已更新', 'success');
  } catch (e) {
    
    showToast('更新状态失败', 'error');
  }
}

// 全局辅助函数 - 移到else块外部确保全局可访问
  async function __showErrorFromResponse(res){
    let msg = '';
    try {
      const ct = (res.headers && res.headers.get && res.headers.get('content-type')) || '';
      if (ct.indexOf('application/json') >= 0) {
        const data = await res.json();
        const detail = typeof data === 'string' ? data : (data && (data.detail || data.message || ''));
        const t = String(detail || '').trim();
        msg = t || '';
      } else {
        const t = String((await res.text()) || '').trim();
        msg = t || '';
      }
    } catch (_) {
      msg = '';
    }
    showToast(msg || '操作失败', 'error');
  }

  function __normalizeWorkItemShape(i){
    if (!i) return i;
    if (i.planned_start_date && !i.planned_start) i.planned_start = i.planned_start_date;
    if (i.planned_end_date && !i.planned_end) i.planned_end = i.planned_end_date;
    return i;
  }

  function showToast(text, type) {
    const el = document.createElement('div'); 
    el.className = `toast ${type}`; 
    el.textContent = text; 
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 1800);
  }
  
  // 卡片菜单系统 - 与甘特图菜单样式和功能完全一致
  let currentCardItem = null;
  let cardMenuAnchor = null;
  
  // 创建卡片菜单HTML
  if (!document.getElementById('cardActionMenu')) {
    const cardMenu = document.createElement('div');
    cardMenu.id = 'cardActionMenu';
    cardMenu.className = 'action-dropdown';
    document.body.appendChild(cardMenu);
    
    // 点击外部关闭菜单
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.ellipsis-btn') && !e.target.closest('#cardActionMenu')) {
        closeCardActionMenu();
      }
    });
    
    // 滚动和窗口大小改变时重新定位
    window.addEventListener('scroll', positionCardActionMenu, true);
    window.addEventListener('resize', positionCardActionMenu);
  }
  
  function showCardActionMenu(e, item) {
    e.preventDefault();
    
    const menu = document.getElementById('cardActionMenu');
    currentCardItem = item;
    cardMenuAnchor = e.target.closest('.ellipsis-btn') || e.target;
    
    const isParent = item.kind === 'JOB';
    
    // 生成菜单HTML - 卡片菜单不包含状态选项（通过拖拽修改状态）
    let html = '';
    
    if (isParent) {
      // JOB菜单项
      html += `<div class="action-item" onclick="handleCardAction('add-task')">
        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        新增子任务
      </div>`;
      
      html += `<div class="action-item" onclick="handleCardAction('edit-job')">
        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        编辑 JOB
      </div>`;
      
      html += `<div class="action-separator"></div>`;
      
      // 优先级选项 - 扁平显示
      html += `<div class="action-item" onclick="updateCardPriority('high')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ef4444;margin-right:8px;"></span>
        设为 High
      </div>`;
      
      html += `<div class="action-item" onclick="updateCardPriority('medium')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#f97316;margin-right:8px;"></span>
        设为 Medium
      </div>`;
      
      html += `<div class="action-item" onclick="updateCardPriority('low')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#22c55e;margin-right:8px;"></span>
        设为 Low
      </div>`;
      
      html += `<div class="action-separator"></div>`;
      
      html += `<div class="action-item danger" onclick="handleCardAction('del-job')">
        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        删除 JOB
      </div>`;
    } else {
      // TASK菜单项
      html += `<div class="action-item" onclick="handleCardAction('edit-task')">
        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        编辑任务
      </div>`;
      
      html += `<div class="action-separator"></div>`;
      
      // 优先级选项 - 扁平显示
      html += `<div class="action-item" onclick="updateCardPriority('high')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ef4444;margin-right:8px;"></span>
        设为 High
      </div>`;
      
      html += `<div class="action-item" onclick="updateCardPriority('medium')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#f97316;margin-right:8px;"></span>
        设为 Medium
      </div>`;
      
      html += `<div class="action-item" onclick="updateCardPriority('low')">
        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#22c55e;margin-right:8px;"></span>
        设为 Low
      </div>`;
      
      html += `<div class="action-separator"></div>`;
      
      html += `<div class="action-item danger" onclick="handleCardAction('del-task')">
        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        删除任务
      </div>`;
    }
    
    menu.innerHTML = html;
    menu.classList.add('show');
    
    // 延迟定位，确保菜单已渲染
    setTimeout(() => {
      positionCardActionMenu();
    }, 10);
  }
  
  function positionCardActionMenu() {
    const menu = document.getElementById('cardActionMenu');
    if (!menu) return;
    if (!menu.classList.contains('show')) return;
    if (!cardMenuAnchor) return;
    
    // 使用与甘特图菜单完全相同的定位逻辑
    const rect = cardMenuAnchor.getBoundingClientRect();
    const menuWidth = 160;
    let menuHeight = menu.offsetHeight || 200;
    
    // 计算左侧位置，优先显示在右侧
    let left = rect.right + 4;
    if (left + menuWidth > window.innerWidth) {
      left = rect.left - menuWidth - 4;
    }
    if (left < 4) {
      left = 4;
    }
    
    // 智能计算垂直位置
    let top = rect.top;
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
      top = rect.top - menuHeight - 4;
    } else if (spaceBelow < menuHeight && spaceAbove < menuHeight) {
      if (spaceBelow > spaceAbove) {
        top = window.innerHeight - menuHeight - 4;
      } else {
        top = 4;
      }
    }
    
    if (top < 4) {
      top = 4;
    }
    if (top + menuHeight > window.innerHeight - 4) {
      top = window.innerHeight - menuHeight - 4;
    }
    
    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
  }
  
  function closeCardActionMenu() {
    const menu = document.getElementById('cardActionMenu');
    if (menu) menu.classList.remove('show');
    currentCardItem = null;
    cardMenuAnchor = null;
  }
  
  function handleCardAction(action) {
    if (!currentCardItem) return;
    
    // 保存当前项目，因为closeCardActionMenu会将其设为null
    const savedItem = currentCardItem;
    closeCardActionMenu();
    
    if (action === 'add-task') {
      openCreateTaskModal(savedItem);
    } else if (action === 'edit-job') {
      openEditJobModal(savedItem);
    } else if (action === 'del-job') {
      if(confirm('确定要删除这个 JOB 及其所有子任务吗？')){
        if (typeof __deleteItem === 'function') {
          __deleteItem(savedItem.id || savedItem.code);
        }
      }
    } else if (action === 'edit-task') {
      openEditTaskModal(savedItem);
    } else if (action === 'del-task') {
      if(confirm('确定要删除这个任务吗？')){
        if (typeof __deleteItem === 'function') {
          __deleteItem(savedItem.id || savedItem.code);
        }
      }
    }
  }
  
  async function updateCardPriority(priority) {
    const item = currentCardItem; // 保存引用，避免在closeCardActionMenu后丢失
    closeCardActionMenu();
    
    if (!item) {
      console.error('[card] No current item for priority update');
      return;
    }
    
    try {
      const idOrCode = item.id || item.code;
      if (typeof __patchTask === 'function') {
        await __patchTask(idOrCode, { priority });
        showToast('优先级已更新', 'success');
      } else {
        // 如果__patchTask不存在，使用fetch直接调用API
        const API = (window.API) || 'http://localhost:8000/api';
        const token = localStorage.getItem('token') || '';
        
        const response = await fetch(`${API}/work-items/${idOrCode}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ priority })
        });
        
        if (response.ok) {
          showToast('优先级已更新', 'success');
          // 刷新数据
          if (typeof fetchWorkItems === 'function') {
            await fetchWorkItems();
          } else {
            window.location.reload();
          }
        } else {
          showToast('更新优先级失败', 'error');
        }
      }
    } catch (e) {
      console.error('[card] Error updating priority:', e);
      showToast('更新优先级失败', 'error');
    }
  }
  
  </script>
</body>
</html>
