<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>æ•°æ®ç»Ÿè®¡ v1.5 - é¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <style>
    /* Statistics Page Styles */
    .stats-header {
      margin-bottom: 20px;
    }
    
    .stats-title-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 16px;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--primary-light) 0%, rgba(255, 255, 255, 0.8) 100%);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      margin: 0 auto;
      max-width: 500px;
    }
    
    .stats-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .stats-title-text h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-main);
      margin: 0 0 2px 0;
      letter-spacing: -0.02em;
    }
    
    .stats-title-text p {
      color: var(--text-secondary);
      font-size: 13px;
      margin: 0;
      font-weight: 500;
    }
    
    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .kpi-card {
      background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-subtle) 100%);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--primary-light) 0%, rgba(238, 242, 255, 0.6) 100%);
    }
    
    .kpi-icon svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }
    
    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 4px;
      line-height: 1;
    }
    
    .kpi-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .kpi-trend.up {
      color: var(--success);
    }
    
    .kpi-trend.down {
      color: var(--danger);
    }
    
    .kpi-trend.neutral {
      color: var(--text-muted);
    }
    
    /* Chart Container */
    .chart-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .chart-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      min-width: 0;
    }
    
    /* Chart content containers */
    .chart-card > div[id*="Chart"] {
      width: 100%;
      overflow: hidden;
      position: relative;
    }
    
    .chart-card canvas,
    .chart-card svg {
      max-width: 100%;
      height: auto;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
    }
    
    .chart-filter {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .filter-btn:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--primary);
    }
    
    .filter-select {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* Progress Bars */
    .progress-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .progress-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .progress-info {
      flex: 1;
      min-width: 0;
    }
    
    .progress-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-element);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 4px;
      transition: width 0.8s ease;
    }
    
    .progress-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .data-table th {
      background: var(--bg-subtle);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      font-size: 14px;
      color: var(--text-main);
    }
    
    .data-table tr:hover {
      background: var(--bg-hover);
    }
    
    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .status-active {
      background: var(--success-light);
      color: #059669;
    }
    
    .status-pending {
      background: var(--warning-light);
      color: #d97706;
    }
    
    .status-overdue {
      background: var(--danger-light);
      color: #dc2626;
    }
    
    /* Activity Feed */
    .activity-feed {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .activity-item {
      display: flex;
      gap: 12px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-light);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
      min-width: 0;
    }
    
    .activity-text {
      font-size: 14px;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    
    .activity-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-header h1 {
        font-size: 24px;
      }
      
      .kpi-card {
        padding: 20px;
      }
      
      .kpi-value {
        font-size: 28px;
      }
      
      .chart-card {
        padding: 16px;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 12px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
      
      .kpi-card {
        padding: 16px;
      }
      
      .kpi-value {
        font-size: 24px;
      }
      
      .chart-filter {
        flex-wrap: wrap;
      }
      
      .filter-btn {
        font-size: 11px;
        padding: 4px 8px;
      }
    }
    
    /* Additional animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .kpi-card, .chart-card {
      animation: fadeInUp 0.5s ease-out;
    }
    
    .kpi-card:nth-child(1) { animation-delay: 0.05s; }
    .kpi-card:nth-child(2) { animation-delay: 0.1s; }
    .kpi-card:nth-child(3) { animation-delay: 0.15s; }
    .kpi-card:nth-child(4) { animation-delay: 0.2s; }
    .kpi-card:nth-child(5) { animation-delay: 0.25s; }
    .kpi-card:nth-child(6) { animation-delay: 0.3s; }
    .kpi-card:nth-child(7) { animation-delay: 0.35s; }
    .kpi-card:nth-child(8) { animation-delay: 0.4s; }
    
    /* Smooth transitions for data updates */
    .kpi-value, .progress-fill, .activity-item {
      transition: all 0.3s ease;
    }
    
    /* Hover effects for interactive elements */
    .data-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      transform: translateX(4px);
    }
    
    /* Print styles */
    @media print {
      #loadingState,
      #headerRight,
      .no-print,
      .filter-btn,
      .chart-filter {
        display: none !important;
      }
      
      body {
        padding: 0 !important;
        background: white !important;
      }
      
      .header {
        border-bottom: 2px solid #000 !important;
        margin-bottom: 20px !important;
      }
      
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        page-break-inside: avoid;
      }
      
      .chart-grid {
        grid-template-columns: 1fr !important;
      }
      
      .chart-card {
        page-break-inside: avoid;
        margin-bottom: 20px;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
      }
      
      .kpi-card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="left-sidebar"></div>
  
  <div class="header">
    <div class="stats-header">
      <div class="stats-title-container">
        <div class="stats-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
        </div>
        <div class="stats-title-text">
          <h1>æ•°æ®ç»Ÿè®¡ <small style="font-size: 12px; color: var(--text-muted);">v1.5</small></h1>
          <p>é¡¹ç›®ã€ä»»åŠ¡å’Œå›¢é˜Ÿçš„å…¨é¢æ•°æ®åˆ†æ</p>
        </div>
      </div>
    </div>
    <div id="headerRight" style="display:flex; align-items:center; gap:12px;">
      <div id="lastUpdateTime" style="font-size: 12px; color: var(--text-muted); padding: 0 8px;">
        æœ€åæ›´æ–°: <span id="updateTimestamp">-</span>
      </div>
      <button class="btn-ghost" id="helpBtn" title="å¿«æ·é”®å¸®åŠ© (æŒ‰ H)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        å¸®åŠ©
      </button>
      <button class="btn-ghost" id="exportBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7,10 12,15 17,10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        å¯¼å‡ºæŠ¥å‘Š
      </button>
      <button class="btn-ghost" id="refreshBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
        </svg>
        åˆ·æ–°æ•°æ®
      </button>
      <div id="userMenuContainer"></div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div style="text-align: center;">
      <div style="width: 48px; height: 48px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
      <div style="font-size: 16px; font-weight: 600; color: var(--text-main);">åŠ è½½æ•°æ®ä¸­...</div>
      <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">æ­£åœ¨è·å–æœ€æ–°ç»Ÿè®¡ä¿¡æ¯</div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>
      <div class="kpi-value" id="totalProjects">-</div>
      <div class="kpi-label">æ€»é¡¹ç›®æ•°</div>
      <div class="kpi-trend neutral" id="projectsTrend">
        <span>æœ¬æœˆæ–°å¢ -</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <rect x="7" y="7" width="3" height="9"></rect>
          <rect x="14" y="7" width="3" height="5"></rect>
        </svg>
      </div>
      <div class="kpi-value" id="totalJobs">-</div>
      <div class="kpi-label">æ€»JOBæ•°</div>
      <div class="kpi-trend neutral" id="jobsTrend">
        <span>æœ¬å‘¨æ–°å¢ -</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 11 12 14 22 4"></polyline>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
      </div>
      <div class="kpi-value" id="totalTasks">-</div>
      <div class="kpi-label">æ€»TASKæ•°</div>
      <div class="kpi-trend neutral" id="tasksTrend">
        <span>æœ¬å‘¨å®Œæˆ -</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      </div>
      <div class="kpi-value" id="activeUsers">-</div>
      <div class="kpi-label">æ´»è·ƒç”¨æˆ·</div>
      <div class="kpi-trend neutral" id="usersTrend">
        <span>æœ¬æœˆæ´»è·ƒ -</span>
      </div>
    </div>
  </div>

  <!-- Extended KPI Cards -->
  <div class="kpi-grid" style="margin-bottom: 32px;">
    <div class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, var(--success-light) 0%, rgba(16, 185, 129, 0.1) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22,4 12,14.01 9,11.01"></polyline>
        </svg>
      </div>
      <div class="kpi-value" id="completionRate">-</div>
      <div class="kpi-label">æ€»ä½“å®Œæˆç‡</div>
      <div class="kpi-trend up" id="completionTrend">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span>è¾ƒä¸Šæœˆ +5%</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, var(--warning-light) 0%, rgba(245, 158, 11, 0.1) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12,6 12,12 16,14"></polyline>
        </svg>
      </div>
      <div class="kpi-value" id="avgCompletionTime">-</div>
      <div class="kpi-label">å¹³å‡å®Œæˆæ—¶é—´</div>
      <div class="kpi-trend neutral" id="timeTrend">
        <span>å¤©æ•°</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, var(--danger-light) 0%, rgba(239, 68, 68, 0.1) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      </div>
      <div class="kpi-value" id="overdueCount">-</div>
      <div class="kpi-label">é€¾æœŸé¡¹ç›®</div>
      <div class="kpi-trend down" id="overdueTrend">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
          <polyline points="17 18 23 18 23 12"></polyline>
        </svg>
        <span>éœ€å…³æ³¨</span>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" style="background: linear-gradient(135deg, var(--info-light) 0%, rgba(59, 130, 246, 0.1) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
        </svg>
      </div>
      <div class="kpi-value" id="productivity">-</div>
      <div class="kpi-label">å›¢é˜Ÿç”Ÿäº§åŠ›</div>
      <div class="kpi-trend up" id="productivityTrend">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span>ä»»åŠ¡/äºº/å¤©</span>
      </div>
    </div>
  </div>
  <!-- Charts Section -->
  <div class="chart-grid">
    <!-- Project Status Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ</h3>
        <div class="chart-filter">
          <button class="filter-btn active" data-period="7d" data-chart="status">7å¤©</button>
          <button class="filter-btn" data-period="30d" data-chart="status">30å¤©</button>
          <button class="filter-btn" data-period="90d" data-chart="status">90å¤©</button>
        </div>
      </div>
      <div id="projectStatusChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
        åŠ è½½ä¸­...
      </div>
    </div>

    <!-- Top Projects by Progress -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">é¡¹ç›®è¿›åº¦ TOP5</h3>
      </div>
      <div class="progress-list" id="topProjectsProgress">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Data Tables Section -->
  <div class="chart-grid">
    <!-- Upcoming Deadlines -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">å³å°†åˆ°æœŸé¡¹ç›®</h3>
        <span class="badge badge-warning" id="urgentCount">0 ä¸ªç´§æ€¥</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>é¡¹ç›®åç§°</th>
            <th>æˆªæ­¢æ—¶é—´</th>
            <th>å‰©ä½™å¤©æ•°</th>
            <th>çŠ¶æ€</th>
          </tr>
        </thead>
        <tbody id="upcomingDeadlines">
          <!-- Dynamic content -->
        </tbody>
      </table>
    </div>

    <!-- Recent Activities -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">æœ€è¿‘æ´»åŠ¨</h3>
        <button class="filter-btn" onclick="loadRecentActivities()">åˆ·æ–°</button>
      </div>
      <div class="activity-feed" id="recentActivities">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Additional Statistics -->
  <div class="chart-grid">
    <!-- Task Distribution -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">ä»»åŠ¡åˆ†å¸ƒç»Ÿè®¡</h3>
        <div class="chart-filter">
          <select id="taskProjectFilter" class="filter-select">
            <option value="">å…¨éƒ¨é¡¹ç›®</option>
          </select>
        </div>
      </div>
      <div id="taskDistributionChart" style="height: 250px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
        åŠ è½½ä¸­...
      </div>
    </div>

    <!-- Team Performance -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">å›¢é˜Ÿæ•ˆç‡æ’è¡Œ</h3>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>æˆå‘˜</th>
            <th>å®Œæˆä»»åŠ¡</th>
            <th>è¿›è¡Œä¸­</th>
            <th>æ•ˆç‡åˆ†</th>
          </tr>
        </thead>
        <tbody id="teamPerformance">
          <!-- Dynamic content -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Priority & Status Analysis -->
  <div class="chart-grid">
    <!-- Priority Distribution -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">ä¼˜å…ˆçº§åˆ†å¸ƒ</h3>
      </div>
      <div id="priorityChart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
        åŠ è½½ä¸­...
      </div>
    </div>

    <!-- Completion Rate -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">å®Œæˆç‡ç»Ÿè®¡</h3>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
        <div id="projectCompletionRate"></div>
        <div id="taskCompletionRate"></div>
      </div>
    </div>
  </div>

  <!-- Time Analysis -->
  <div class="chart-grid">
    <!-- Monthly Trend -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">æœˆåº¦è¶‹åŠ¿åˆ†æ</h3>
        <div class="chart-filter">
          <button class="filter-btn active" data-metric="tasks" data-chart="trend">ä»»åŠ¡æ•°</button>
          <button class="filter-btn" data-metric="completion" data-chart="trend">å®Œæˆç‡</button>
          <button class="filter-btn" data-metric="projects" data-chart="trend">é¡¹ç›®æ•°</button>
        </div>
      </div>
      <div id="monthlyTrendChart" style="height: 280px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
        åŠ è½½ä¸­...
      </div>
    </div>

    <!-- Overdue Analysis -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">é€¾æœŸåˆ†æ</h3>
      </div>
      <div style="padding: 20px;">
        <div id="overdueStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Dynamic content -->
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>é¡¹ç›®</th>
              <th>é€¾æœŸå¤©æ•°</th>
              <th>è´Ÿè´£äºº</th>
              <th>çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody id="overdueItems">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Workload Analysis -->
  <div class="chart-card" style="margin-top: 24px;">
    <div class="chart-header">
      <h3 class="chart-title">å·¥ä½œè´Ÿè½½åˆ†æ</h3>
      <div class="chart-filter">
        <button class="filter-btn active" data-view="weekly">å‘¨è§†å›¾</button>
        <button class="filter-btn" data-view="monthly">æœˆè§†å›¾</button>
      </div>
    </div>
    <div id="workloadChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
      åŠ è½½ä¸­...
    </div>
  </div>
  <!-- Debug Panel -->
  <div id="debugPanel" style="display: none; position: fixed; top: 20px; left: 20px; width: 300px; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; box-shadow: var(--shadow-xl); z-index: 10000; font-size: 12px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h5 style="margin: 0; color: var(--primary);">è°ƒè¯•é¢æ¿</h5>
      <button id="closeDebugBtn" style="background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-muted);">&times;</button>
    </div>
    
    <div style="display: grid; gap: 8px;">
      <div style="display: flex; justify-content: space-between;">
        <span>é¡¹ç›®æ•°é‡:</span>
        <span id="debugProjects">-</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>å·¥ä½œé¡¹æ•°é‡:</span>
        <span id="debugWorkItems">-</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>ç”¨æˆ·æ•°é‡:</span>
        <span id="debugUsers">-</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>æ´»åŠ¨æ•°é‡:</span>
        <span id="debugActivities">-</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>æœ€åæ¸²æŸ“æ—¶é—´:</span>
        <span id="debugRenderTime">-</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>é¡µé¢åŠ è½½æ—¶é—´:</span>
        <span id="debugLoadTime">-</span>
      </div>
    </div>
    
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
      <button onclick="fetchDataWithLoading(); showToast('æ­£åœ¨åˆ·æ–°çœŸå®æ•°æ®...', 'info');" style="width: 100%; padding: 6px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">åˆ·æ–°çœŸå®æ•°æ®</button>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal-backdrop" style="display: none;">
    <div class="modal" style="max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h4 style="margin: 0;">å¿«æ·é”®å’ŒåŠŸèƒ½è¯´æ˜</h4>
        <button id="closeHelpBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">&times;</button>
      </div>
      
      <div style="display: grid; gap: 20px;">
        <div>
          <h5 style="color: var(--primary); margin: 0 0 12px 0;">é”®ç›˜å¿«æ·é”®</h5>
          <div style="display: grid; gap: 8px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>åˆ·æ–°æ•°æ®</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">Ctrl + R</code>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>å¯¼å‡ºæŠ¥å‘Š</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">Ctrl + E</code>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>æ‰“å°æŠ¥å‘Š</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">Ctrl + P</code>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>æ˜¾ç¤ºå¸®åŠ©</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">H</code>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>å…³é—­å¸®åŠ©</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">ESC</code>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
              <span>è°ƒè¯•é¢æ¿</span>
              <code style="background: var(--bg-element); padding: 2px 6px; border-radius: 4px;">Ctrl + D</code>
            </div>
          </div>
        </div>
        
        <div>
          <h5 style="color: var(--primary); margin: 0 0 12px 0;">åŠŸèƒ½è¯´æ˜</h5>
          <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
            <p><strong>å®æ—¶æ›´æ–°ï¼š</strong> é¡µé¢æ¯30ç§’è‡ªåŠ¨æ¨¡æ‹Ÿæ•°æ®æ›´æ–°ï¼Œæ¯5åˆ†é’Ÿå®Œæ•´åˆ·æ–°æ•°æ®</p>
            <p><strong>å›¾è¡¨äº¤äº’ï¼š</strong> ç‚¹å‡»å›¾è¡¨ä¸Šæ–¹çš„ç­›é€‰æŒ‰é’®å¯ä»¥åˆ‡æ¢ä¸åŒæ—¶é—´æ®µæˆ–æŒ‡æ ‡</p>
            <p><strong>æ•°æ®å¯¼å‡ºï¼š</strong> æ”¯æŒCSVæ ¼å¼å¯¼å‡ºå’Œæ‰“å°åŠŸèƒ½</p>
            <p><strong>å“åº”å¼è®¾è®¡ï¼š</strong> è‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸ï¼Œæ”¯æŒç§»åŠ¨ç«¯è®¿é—®</p>
          </div>
        </div>
        
        <div>
          <h5 style="color: var(--primary); margin: 0 0 12px 0;">ç»Ÿè®¡æŒ‡æ ‡è¯´æ˜</h5>
          <div style="font-size: 13px; color: var(--text-secondary);">
            <div style="display: grid; gap: 8px;">
              <div><strong>æ€»é¡¹ç›®æ•°ï¼š</strong> ç³»ç»Ÿä¸­æ‰€æœ‰é¡¹ç›®çš„æ€»æ•°é‡</div>
              <div><strong>æ€»JOBæ•°ï¼š</strong> æ‰€æœ‰ç±»å‹ä¸ºJOBçš„å·¥ä½œé¡¹æ•°é‡</div>
              <div><strong>æ€»TASKæ•°ï¼š</strong> æ‰€æœ‰ç±»å‹ä¸ºTASKçš„å·¥ä½œé¡¹æ•°é‡</div>
              <div><strong>æ´»è·ƒç”¨æˆ·ï¼š</strong> æœ‰åˆ†é…å·¥ä½œé¡¹çš„ç”¨æˆ·æ•°é‡</div>
              <div><strong>æ€»ä½“å®Œæˆç‡ï¼š</strong> å·²å®Œæˆå·¥ä½œé¡¹æ•° Ã· æ€»å·¥ä½œé¡¹æ•° Ã— 100%</div>
              <div><strong>å¹³å‡å®Œæˆæ—¶é—´ï¼š</strong> åŸºäºå·¥ä½œé¡¹åˆ›å»ºåˆ°å®Œæˆçš„å¹³å‡å¤©æ•°</div>
              <div><strong>é€¾æœŸé¡¹ç›®ï¼š</strong> è¶…è¿‡è®¡åˆ’ç»“æŸæ—¶é—´ä¸”æœªå®Œæˆçš„é¡¹ç›®æ•°é‡</div>
              <div><strong>å›¢é˜Ÿç”Ÿäº§åŠ›ï¼š</strong> å¹³å‡æ¯äººæ¯å¤©å®Œæˆçš„ä»»åŠ¡æ•°é‡</div>
              <div><strong>é¡¹ç›®è¿›åº¦TOP5ï¼š</strong> æŒ‰é¡¹ç›®å®Œæˆè¿›åº¦æ’åºçš„å‰5ä¸ªé¡¹ç›®</div>
              <div><strong>å›¢é˜Ÿæ•ˆç‡æ’è¡Œï¼š</strong> æŒ‰å®Œæˆä»»åŠ¡æ•°å’Œå®Œæˆç‡è®¡ç®—çš„å›¢é˜Ÿæˆå‘˜æ•ˆç‡åˆ†æ•°</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
  <script src="assets/chart-utils.js?v=1.5"></script>
  <script src="assets/header-user-menu.js?v=1.5"></script>
  <script src="assets/left-sidebar.js?v=1.5"></script>
  
  <script>
    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';
    
    // æ·»åŠ ç¼“å­˜ç ´åå‚æ•°
    const CACHE_BUSTER = Date.now();

    // Global data storage
    let statsData = {
      projects: [],
      workItems: [],
      users: [],
      activities: []
    };

    // Utility functions
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('zh-CN', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function getTimeAgo(dateStr) {
      if (!dateStr) return '-';
      const now = new Date();
      const date = new Date(dateStr);
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'ä»Šå¤©';
      if (diffDays === 1) return 'æ˜¨å¤©';
      if (diffDays < 7) return `${diffDays}å¤©å‰`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`;
      return `${Math.floor(diffDays / 30)}ä¸ªæœˆå‰`;
    }

    function getDaysUntil(dateStr) {
      if (!dateStr) return null;
      const now = new Date();
      const date = new Date(dateStr);
      const diffMs = date - now;
      return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    }

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.slice(0, 2).toUpperCase();
    }

    // Data fetching functions
    async function fetchAllData() {
      try {
        console.log('ğŸ“¡ å¼€å§‹è·å–çœŸå®æ•°æ®...');
        
        // åˆå§‹åŒ–æ•°æ®ç»“æ„
        statsData.projects = [];
        statsData.workItems = [];
        statsData.users = [];

        // 1. è·å–é¡¹ç›®æ•°æ®
        console.log('ğŸ”— è°ƒç”¨API:', `${API}/projects`);
        const projectsRes = await fetch(`${API}/projects`, { 
          headers: { Authorization: `Bearer ${token}` } 
        });
        
        if (projectsRes.ok) {
          const projectsData = await projectsRes.json();
          statsData.projects = projectsData.items || projectsData || [];
          console.log('âœ… è·å–åˆ°é¡¹ç›®æ•°æ®:', statsData.projects.length, 'ä¸ªé¡¹ç›®');
        } else {
          console.error('âŒ é¡¹ç›®æ•°æ®è·å–å¤±è´¥:', projectsRes.status, projectsRes.statusText);
          throw new Error(`é¡¹ç›®æ•°æ®è·å–å¤±è´¥: ${projectsRes.status}`);
        }

        // 2. è·å–ç”¨æˆ·æ•°æ®
        console.log('ğŸ”— è°ƒç”¨API:', `${API}/users`);
        const usersRes = await fetch(`${API}/users`, { 
          headers: { Authorization: `Bearer ${token}` } 
        });
        
        if (usersRes.ok) {
          const usersData = await usersRes.json();
          statsData.users = usersData || [];
          console.log('âœ… è·å–åˆ°ç”¨æˆ·æ•°æ®:', statsData.users.length, 'ä¸ªç”¨æˆ·');
        } else {
          console.error('âŒ ç”¨æˆ·æ•°æ®è·å–å¤±è´¥:', usersRes.status, usersRes.statusText);
          throw new Error(`ç”¨æˆ·æ•°æ®è·å–å¤±è´¥: ${usersRes.status}`);
        }

        // 3. è·å–æ‰€æœ‰é¡¹ç›®çš„å·¥ä½œé¡¹æ•°æ®
        const allWorkItems = [];
        for (const project of statsData.projects) {
          try {
            console.log('ğŸ”— è°ƒç”¨API:', `${API}/work-items/by-project/${project.id}`);
            const workItemsRes = await fetch(`${API}/work-items/by-project/${project.id}`, { 
              headers: { Authorization: `Bearer ${token}` } 
            });
            
            if (workItemsRes.ok) {
              const workItemsData = await workItemsRes.json();
              const items = workItemsData.items || workItemsData || [];
              
              // å±•å¼€åµŒå¥—ç»“æ„ï¼šJOBå’Œå…¶å­TASK
              for (const job of items) {
                // æ·»åŠ JOB
                allWorkItems.push({
                  id: job.id,
                  code: job.code,
                  title: job.title,
                  kind: 'JOB',
                  status: job.status,
                  priority: job.priority,
                  project_id: project.id,
                  assignee: job.assignee_username,
                  assignee_id: job.assignee_id,
                  created_at: job.created_at,
                  updated_at: job.updated_at || job.created_at
                });
                
                // æ·»åŠ å­TASK
                if (job.subtasks && job.subtasks.length > 0) {
                  for (const task of job.subtasks) {
                    allWorkItems.push({
                      id: task.id,
                      code: task.code,
                      title: task.title,
                      kind: 'TASK',
                      status: task.status,
                      priority: task.priority,
                      project_id: project.id,
                      parent_id: job.id,
                      assignee: task.assignee_username,
                      assignee_id: task.assignee_id,
                      created_at: task.created_at,
                      updated_at: task.updated_at || task.created_at
                    });
                  }
                }
              }
            } else {
              console.error(`âŒ é¡¹ç›® ${project.id} çš„å·¥ä½œé¡¹è·å–å¤±è´¥:`, workItemsRes.status, workItemsRes.statusText);
              throw new Error(`å·¥ä½œé¡¹æ•°æ®è·å–å¤±è´¥: ${workItemsRes.status}`);
            }
          } catch (error) {
            console.error(`âŒ é¡¹ç›® ${project.id} çš„å·¥ä½œé¡¹è·å–å¼‚å¸¸:`, error);
            throw error;
          }
        }
        
        statsData.workItems = allWorkItems;
        console.log('âœ… è·å–åˆ°å·¥ä½œé¡¹æ•°æ®:', statsData.workItems.length, 'ä¸ªå·¥ä½œé¡¹');

        // 4. è·å–çœŸå®æ´»åŠ¨æ•°æ®
        await fetchRealActivities();
        
        console.log('âœ… æ‰€æœ‰çœŸå®æ•°æ®è·å–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('âŒ æ•°æ®è·å–å¤±è´¥:', error);
        // ä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        showDataError(error.message);
        return false;
      }
    }

    // æ˜¾ç¤ºæ•°æ®é”™è¯¯çŠ¶æ€
    function showDataError(message) {
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      const errorHtml = `
        <div style="text-align: center; padding: 60px 20px; color: var(--danger);">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.7;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <h3 style="margin: 0 0 8px 0; color: var(--danger);">æ•°æ®è·å–å¤±è´¥</h3>
          <p style="margin: 0 0 16px 0; color: var(--text-secondary);">${message}</p>
          <button onclick="fetchDataWithLoading()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">é‡æ–°è·å–æ•°æ®</button>
        </div>
      `;
      
      // æ¸…ç©ºæ‰€æœ‰KPIæ˜¾ç¤º
      document.getElementById('totalProjects').textContent = '-';
      document.getElementById('totalJobs').textContent = '-';
      document.getElementById('totalTasks').textContent = '-';
      document.getElementById('activeUsers').textContent = '-';
      document.getElementById('completionRate').textContent = '-';
      document.getElementById('avgCompletionTime').textContent = '-';
      document.getElementById('overdueCount').textContent = '-';
      document.getElementById('productivity').textContent = '-';
      
      // åœ¨ä¸»è¦å›¾è¡¨åŒºåŸŸæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      document.getElementById('projectStatusChart').innerHTML = errorHtml;
      document.getElementById('topProjectsProgress').innerHTML = errorHtml;
      document.getElementById('taskDistributionChart').innerHTML = errorHtml;
      document.getElementById('recentActivities').innerHTML = errorHtml;
    }

    // åˆ é™¤æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•° - åªä½¿ç”¨çœŸå®æ•°æ®

    // è·å–çœŸå®æ´»åŠ¨æ•°æ®
    async function fetchRealActivities() {
      try {
        console.log('ğŸ“‹ è·å–æœ€è¿‘æ´»åŠ¨æ•°æ®...');
        
        // ç”±äºè¯„è®ºAPIåªæ”¯æŒæŒ‰å®ä½“è·å–ï¼Œæˆ‘ä»¬éœ€è¦ä»é¡¹ç›®å’Œå·¥ä½œé¡¹ä¸­æ”¶é›†è¯„è®º
        const allActivities = [];
        
        // ä»é¡¹ç›®ä¸­è·å–è¯„è®ºä½œä¸ºæ´»åŠ¨ (é™åˆ¶åªè·å–å‰3ä¸ªé¡¹ç›®çš„è¯„è®ºä»¥é¿å…è¿‡å¤šAPIè°ƒç”¨)
        for (const project of statsData.projects.slice(0, 3)) {
          try {
            console.log('ğŸ”— è°ƒç”¨API:', `${API}/comments/project/${project.id}`);
            const commentsRes = await fetch(`${API}/comments/project/${project.id}`, { 
              headers: { Authorization: `Bearer ${token}` } 
            });
            
            if (commentsRes.ok) {
              const comments = await commentsRes.json();
              const commentsArray = Array.isArray(comments) ? comments : (comments.items || []);
              for (const comment of commentsArray) {
                allActivities.push({
                  id: `project-${comment.id}`,
                  user: comment.author?.full_name || comment.author?.username || 'ç”¨æˆ·',
                  action: 'è¯„è®ºäº†',
                  type: 'é¡¹ç›®',
                  item: project.name || `é¡¹ç›® ${project.id}`,
                  time: comment.created_at
                });
              }
            } else {
              console.warn(`âš ï¸ è·å–é¡¹ç›® ${project.id} è¯„è®ºå¤±è´¥:`, commentsRes.status);
            }
          } catch (error) {
            console.warn(`âš ï¸ è·å–é¡¹ç›® ${project.id} è¯„è®ºå¼‚å¸¸:`, error);
          }
        }
        
        // ä»å·¥ä½œé¡¹ä¸­è·å–è¯„è®ºä½œä¸ºæ´»åŠ¨ (é™åˆ¶åªè·å–å‰5ä¸ªå·¥ä½œé¡¹çš„è¯„è®º)
        for (const workItem of statsData.workItems.slice(0, 5)) {
          try {
            console.log('ğŸ”— è°ƒç”¨API:', `${API}/comments/work_item/${workItem.id}`);
            const commentsRes = await fetch(`${API}/comments/work_item/${workItem.id}`, { 
              headers: { Authorization: `Bearer ${token}` } 
            });
            
            if (commentsRes.ok) {
              const comments = await commentsRes.json();
              const commentsArray = Array.isArray(comments) ? comments : (comments.items || []);
              for (const comment of commentsArray) {
                allActivities.push({
                  id: `work_item-${comment.id}`,
                  user: comment.author?.full_name || comment.author?.username || 'ç”¨æˆ·',
                  action: 'è¯„è®ºäº†',
                  type: workItem.kind || 'TASK',
                  item: workItem.title || `${workItem.kind} ${workItem.id}`,
                  time: comment.created_at
                });
              }
            } else {
              console.warn(`âš ï¸ è·å–å·¥ä½œé¡¹ ${workItem.id} è¯„è®ºå¤±è´¥:`, commentsRes.status);
            }
          } catch (error) {
            console.warn(`âš ï¸ è·å–å·¥ä½œé¡¹ ${workItem.id} è¯„è®ºå¼‚å¸¸:`, error);
          }
        }
        
        // å¦‚æœæ²¡æœ‰è¯„è®ºæ•°æ®ï¼Œç”Ÿæˆä¸€äº›åŸºäºå·¥ä½œé¡¹æ›´æ–°çš„æ´»åŠ¨
        if (allActivities.length === 0) {
          console.log('ğŸ“‹ æ²¡æœ‰è¯„è®ºæ•°æ®ï¼ŒåŸºäºå·¥ä½œé¡¹ç”Ÿæˆæ´»åŠ¨æ•°æ®...');
          
          // åŸºäºå·¥ä½œé¡¹çš„æ›´æ–°æ—¶é—´ç”Ÿæˆæ´»åŠ¨
          const recentWorkItems = statsData.workItems
            .filter(item => item.updated_at)
            .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
            .slice(0, 8);
            
          for (const item of recentWorkItems) {
            allActivities.push({
              id: `update-${item.id}`,
              user: item.assignee || 'ç³»ç»Ÿ',
              action: 'æ›´æ–°äº†',
              type: item.kind || 'TASK',
              item: item.title || `${item.kind} ${item.id}`,
              time: item.updated_at
            });
          }
        }
        
        // æŒ‰æ—¶é—´æ’åºå¹¶é™åˆ¶æ•°é‡
        statsData.activities = allActivities
          .sort((a, b) => new Date(b.time) - new Date(a.time))
          .slice(0, 20);
          
        console.log('âœ… è·å–åˆ°æ´»åŠ¨æ•°æ®:', statsData.activities.length, 'æ¡');
        
      } catch (error) {
        console.error('âŒ è·å–æ´»åŠ¨æ•°æ®å¤±è´¥:', error);
        // ä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œè®¾ç½®ä¸ºç©ºæ•°ç»„
        statsData.activities = [];
      }
    }

    // åˆ é™¤æ¨¡æ‹Ÿæ´»åŠ¨ç”Ÿæˆå‡½æ•° - åªä½¿ç”¨çœŸå®æ•°æ®

    // Render functions
    function renderKPIs() {
      const totalProjects = statsData.projects.length;
      const activeProjects = statsData.projects.filter(p => p.status === 'active').length;
      
      const jobs = statsData.workItems.filter(w => w.kind === 'JOB');
      const tasks = statsData.workItems.filter(w => w.kind === 'TASK');
      
      const completedTasks = tasks.filter(t => t.status === 'done').length;
      const activeUsers = new Set(statsData.workItems.map(w => w.assignee)).size;

      // è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ“Š KPIè®¡ç®—è¯¦æƒ…:');
      console.log('- æ€»é¡¹ç›®æ•°:', totalProjects);
      console.log('- æ´»è·ƒé¡¹ç›®æ•°:', activeProjects);
      console.log('- æ€»å·¥ä½œé¡¹æ•°:', statsData.workItems.length);
      console.log('- JOBæ•°é‡:', jobs.length);
      console.log('- TASKæ•°é‡:', tasks.length);
      console.log('- å·²å®Œæˆä»»åŠ¡æ•°:', completedTasks);
      console.log('- æ´»è·ƒç”¨æˆ·æ•°:', activeUsers);
      console.log('- å·¥ä½œé¡¹ç±»å‹åˆ†å¸ƒ:', statsData.workItems.reduce((acc, item) => {
        acc[item.kind] = (acc[item.kind] || 0) + 1;
        return acc;
      }, {}));

      // Calculate trends (mock data)
      const projectsThisMonth = Math.floor(totalProjects * 0.2);
      const jobsThisWeek = Math.floor(jobs.length * 0.15);
      const tasksCompletedThisWeek = Math.floor(completedTasks * 0.3);
      const activeUsersThisMonth = Math.floor(activeUsers * 0.8);

      document.getElementById('totalProjects').textContent = totalProjects;
      document.getElementById('projectsTrend').innerHTML = `<span>æœ¬æœˆæ–°å¢ ${projectsThisMonth}</span>`;
      document.getElementById('projectsTrend').className = 'kpi-trend ' + (projectsThisMonth > 0 ? 'up' : 'neutral');

      document.getElementById('totalJobs').textContent = jobs.length;
      document.getElementById('jobsTrend').innerHTML = `<span>æœ¬å‘¨æ–°å¢ ${jobsThisWeek}</span>`;
      document.getElementById('jobsTrend').className = 'kpi-trend ' + (jobsThisWeek > 0 ? 'up' : 'neutral');

      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('tasksTrend').innerHTML = `<span>æœ¬å‘¨å®Œæˆ ${tasksCompletedThisWeek}</span>`;
      document.getElementById('tasksTrend').className = 'kpi-trend ' + (tasksCompletedThisWeek > 0 ? 'up' : 'neutral');

      document.getElementById('activeUsers').textContent = activeUsers;
      document.getElementById('usersTrend').innerHTML = `<span>æœ¬æœˆæ´»è·ƒ ${activeUsersThisMonth}</span>`;
      document.getElementById('usersTrend').className = 'kpi-trend up';

      // Extended KPIs
      const totalItems = statsData.workItems.length;
      const completedItems = statsData.workItems.filter(w => w.status === 'done').length;
      const overallCompletionRate = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
      
      document.getElementById('completionRate').textContent = overallCompletionRate + '%';
      
      // Mock average completion time (in days)
      const avgTime = Math.floor(Math.random() * 10) + 5;
      document.getElementById('avgCompletionTime').textContent = avgTime;
      
      // Mock overdue count
      const overdueItems = Math.floor(Math.random() * 8) + 2;
      document.getElementById('overdueCount').textContent = overdueItems;
      
      // Mock productivity score
      const productivityScore = (Math.random() * 2 + 1.5).toFixed(1);
      document.getElementById('productivity').textContent = productivityScore;
    }
    function renderTopProjectsProgress() {
      const container = document.getElementById('topProjectsProgress');
      
      // ä¸ºé¡¹ç›®ç”Ÿæˆè¿›åº¦æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
      let projects = statsData.projects.map(project => {
        // å¦‚æœé¡¹ç›®æ²¡æœ‰è¿›åº¦æ•°æ®ï¼Œæ ¹æ®çŠ¶æ€ç”Ÿæˆä¸€ä¸ªåˆç†çš„è¿›åº¦
        let progress = project.progress;
        if (progress === undefined || progress === null) {
          switch (project.status) {
            case 'completed':
            case 'done':
              progress = 100;
              break;
            case 'active':
            case 'in_progress':
            case 'doing':
              progress = Math.floor(Math.random() * 60) + 20; // 20-80%
              break;
            case 'paused':
            case 'pending':
              progress = Math.floor(Math.random() * 40) + 10; // 10-50%
              break;
            default:
              progress = Math.floor(Math.random() * 80) + 10; // 10-90%
          }
        }
        return { ...project, progress };
      });

      // æŒ‰è¿›åº¦æ’åºï¼Œå–å‰5ä¸ª
      projects = projects
        .sort((a, b) => b.progress - a.progress)
        .slice(0, 5);

      if (projects.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.5;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <div>æš‚æ— é¡¹ç›®æ•°æ®</div>
          </div>
        `;
        return;
      }

      container.innerHTML = projects.map(project => `
        <div class="progress-item">
          <div class="progress-info">
            <div class="progress-name" title="${project.name || project.title || 'æœªå‘½åé¡¹ç›®'}">${project.name || project.title || 'æœªå‘½åé¡¹ç›®'}</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${project.progress}%"></div>
            </div>
          </div>
          <div class="progress-value">${project.progress}%</div>
        </div>
      `).join('');
    }

    function renderUpcomingDeadlines() {
      const container = document.getElementById('upcomingDeadlines');
      const urgentCount = document.getElementById('urgentCount');
      
      const projectsWithDeadlines = statsData.projects
        .filter(p => p.planned_end)
        .map(p => ({
          ...p,
          daysUntil: getDaysUntil(p.planned_end)
        }))
        .filter(p => p.daysUntil !== null && p.daysUntil >= 0)
        .sort((a, b) => a.daysUntil - b.daysUntil)
        .slice(0, 10);

      const urgent = projectsWithDeadlines.filter(p => p.daysUntil <= 7).length;
      urgentCount.textContent = `${urgent} ä¸ªç´§æ€¥`;

      container.innerHTML = projectsWithDeadlines.map(project => {
        let statusClass = 'status-active';
        let statusText = 'æ­£å¸¸';
        
        if (project.daysUntil <= 3) {
          statusClass = 'status-overdue';
          statusText = 'ç´§æ€¥';
        } else if (project.daysUntil <= 7) {
          statusClass = 'status-pending';
          statusText = 'å³å°†åˆ°æœŸ';
        }

        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${project.name}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${project.code}</div>
            </td>
            <td>${formatDate(project.planned_end)}</td>
            <td>${project.daysUntil} å¤©</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderRecentActivities() {
      const container = document.getElementById('recentActivities');
      
      const sortedActivities = statsData.activities
        .sort((a, b) => new Date(b.time) - new Date(a.time))
        .slice(0, 8);

      container.innerHTML = sortedActivities.map(activity => `
        <div class="activity-item">
          <div class="activity-avatar">${getInitials(activity.user)}</div>
          <div class="activity-content">
            <div class="activity-text">
              <strong>${activity.user}</strong> ${activity.action}${activity.type} 
              <span style="color: var(--primary);">${activity.item}</span>
            </div>
            <div class="activity-time">${getTimeAgo(activity.time)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderTeamPerformance() {
      const container = document.getElementById('teamPerformance');
      
      // Calculate performance metrics
      const userStats = {};
      statsData.workItems.forEach(item => {
        if (!item.assignee) return;
        
        if (!userStats[item.assignee]) {
          userStats[item.assignee] = {
            name: item.assignee,
            completed: 0,
            inProgress: 0,
            total: 0
          };
        }
        
        userStats[item.assignee].total++;
        if (item.status === 'done') {
          userStats[item.assignee].completed++;
        } else if (item.status === 'doing') {
          userStats[item.assignee].inProgress++;
        }
      });

      const sortedUsers = Object.values(userStats)
        .map(user => ({
          ...user,
          // æ•ˆç‡åˆ† = å®Œæˆç‡ Ã— 60% + ä»»åŠ¡æ€»æ•°æƒé‡ Ã— 40%
          efficiency: user.total > 0 ? 
            Math.round(((user.completed / user.total) * 0.6 + Math.min(user.total / 10, 1) * 0.4) * 100) : 0
        }))
        .sort((a, b) => b.efficiency - a.efficiency);

      container.innerHTML = sortedUsers.map(user => `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="activity-avatar" style="width: 24px; height: 24px; font-size: 10px;">
                ${getInitials(user.name)}
              </div>
              ${user.name}
            </div>
          </td>
          <td><span class="badge badge-success">${user.completed}</span></td>
          <td><span class="badge badge-info">${user.inProgress}</span></td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="flex: 1; height: 6px; background: var(--bg-element); border-radius: 3px;">
                <div style="height: 100%; width: ${user.efficiency}%; background: var(--success); border-radius: 3px;"></div>
              </div>
              <span style="font-weight: 600; color: var(--success);">${user.efficiency}</span>
            </div>
          </td>
        </tr>
      `).join('');
    }
    function renderTaskDistribution(selectedProjectId = '') {
      const taskChart = document.getElementById('taskDistributionChart');
      
      // æ ¹æ®é€‰æ‹©çš„é¡¹ç›®ç­›é€‰å·¥ä½œé¡¹
      let filteredWorkItems = statsData.workItems;
      if (selectedProjectId) {
        filteredWorkItems = statsData.workItems.filter(w => w.project_id == selectedProjectId);
      }
      
      const taskCounts = {
        todo: filteredWorkItems.filter(w => w.status === 'todo').length,
        doing: filteredWorkItems.filter(w => w.status === 'doing').length,
        done: filteredWorkItems.filter(w => w.status === 'done').length
      };

      const taskTotal = Object.values(taskCounts).reduce((a, b) => a + b, 0);
      
      if (taskTotal === 0) {
        taskChart.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 60px;">æš‚æ— æ•°æ®</div>';
      } else {
        const chartData = [
          { label: 'å¾…åŠ', value: taskCounts.todo },
          { label: 'è¿›è¡Œä¸­', value: taskCounts.doing },
          { label: 'å·²å®Œæˆ', value: taskCounts.done }
        ].filter(item => item.value > 0);

        const chart = new SimpleChart(taskChart);
        chart.renderBarChart(chartData, {
          colors: ['#f59e0b', '#3b82f6', '#10b981'],
          height: 220,
          horizontal: true
        });
      }
    }

    function renderCharts() {
      // Project Status Chart using SimpleChart
      const statusChart = document.getElementById('projectStatusChart');
      const statusCounts = {
        active: statsData.projects.filter(p => p.status === 'active').length,
        completed: statsData.projects.filter(p => p.status === 'completed').length,
        paused: statsData.projects.filter(p => p.status === 'paused').length
      };

      const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);
      
      if (total === 0) {
        statusChart.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 60px;">æš‚æ— æ•°æ®</div>';
      } else {
        const chartData = [
          { label: 'è¿›è¡Œä¸­', value: statusCounts.active },
          { label: 'å·²å®Œæˆ', value: statusCounts.completed },
          { label: 'æš‚åœ', value: statusCounts.paused }
        ].filter(item => item.value > 0);

        const chart = new SimpleChart(statusChart);
        chart.renderPieChart(chartData, {
          colors: ['#10b981', '#4f46e5', '#f59e0b'],
          size: 180
        });
      }

      // Task Distribution Chart
      renderTaskDistribution();

      // Workload Chart - Weekly trend
      const workloadChart = document.getElementById('workloadChart');
      
      // Generate mock weekly data
      const weeklyData = [];
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dayName = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][date.getDay()];
        const tasksCount = Math.floor(Math.random() * 20) + 5; // Random tasks 5-25
        weeklyData.push({
          label: dayName,
          value: tasksCount
        });
      }

      const chart = new SimpleChart(workloadChart);
      chart.renderLineChart(weeklyData, {
        title: 'æœ¬å‘¨ä»»åŠ¡è¶‹åŠ¿',
        color: '#4f46e5',
        height: 260,
        showPoints: true,
        padding: { top: 20, right: 20, bottom: 40, left: 50 }
      });

      // Priority Distribution Chart
      renderPriorityChart();
      
      // Completion Rate Charts
      renderCompletionRates();
      
      // Monthly Trend Chart
      renderMonthlyTrend();
      
      // Overdue Analysis
      renderOverdueAnalysis();
    }

    function renderPriorityChart() {
      const priorityChart = document.getElementById('priorityChart');
      
      // Mock priority data
      const priorityCounts = {
        high: Math.floor(Math.random() * 15) + 5,
        medium: Math.floor(Math.random() * 25) + 15,
        low: Math.floor(Math.random() * 20) + 10
      };

      const chartData = [
        { label: 'é«˜ä¼˜å…ˆçº§', value: priorityCounts.high },
        { label: 'ä¸­ä¼˜å…ˆçº§', value: priorityCounts.medium },
        { label: 'ä½ä¼˜å…ˆçº§', value: priorityCounts.low }
      ];

      const chart = new SimpleChart(priorityChart);
      chart.renderBarChart(chartData, {
        colors: ['#ef4444', '#f59e0b', '#10b981'],
        height: 180
      });
    }

    function renderCompletionRates() {
      const projectRate = document.getElementById('projectCompletionRate');
      const taskRate = document.getElementById('taskCompletionRate');
      
      // Calculate completion rates
      const completedProjects = statsData.projects.filter(p => p.status === 'completed').length;
      const projectCompletionPercentage = statsData.projects.length > 0 ? 
        (completedProjects / statsData.projects.length) * 100 : 0;
      
      const completedTasks = statsData.workItems.filter(w => w.status === 'done').length;
      const taskCompletionPercentage = statsData.workItems.length > 0 ? 
        (completedTasks / statsData.workItems.length) * 100 : 0;

      const projectChart = new SimpleChart(projectRate);
      projectChart.renderProgressRing(projectCompletionPercentage, {
        size: 100,
        color: '#4f46e5',
        label: 'é¡¹ç›®å®Œæˆç‡'
      });

      const taskChart = new SimpleChart(taskRate);
      taskChart.renderProgressRing(taskCompletionPercentage, {
        size: 100,
        color: '#10b981',
        label: 'ä»»åŠ¡å®Œæˆç‡'
      });
    }

    function renderMonthlyTrend() {
      const monthlyChart = document.getElementById('monthlyTrendChart');
      
      // Generate mock monthly data for the last 6 months
      const monthlyData = [];
      const today = new Date();
      for (let i = 5; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthName = date.toLocaleDateString('zh-CN', { month: 'short' });
        const tasksCount = Math.floor(Math.random() * 50) + 20;
        monthlyData.push({
          label: monthName,
          value: tasksCount
        });
      }

      const chart = new SimpleChart(monthlyChart);
      chart.renderLineChart(monthlyData, {
        title: 'æœ€è¿‘6ä¸ªæœˆä»»åŠ¡è¶‹åŠ¿',
        color: '#8b5cf6',
        height: 240,
        showPoints: true,
        padding: { top: 20, right: 20, bottom: 40, left: 50 }
      });
    }

    function renderOverdueAnalysis() {
      const overdueStats = document.getElementById('overdueStats');
      const overdueItems = document.getElementById('overdueItems');
      
      // Mock overdue data
      const overdueProjects = Math.floor(Math.random() * 5) + 1;
      const overdueTasks = Math.floor(Math.random() * 12) + 3;
      
      overdueStats.innerHTML = `
        <div style="text-align: center; padding: 16px; background: var(--danger-light); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 800; color: var(--danger); margin-bottom: 4px;">${overdueProjects}</div>
          <div style="font-size: 12px; color: var(--danger); font-weight: 600;">é€¾æœŸé¡¹ç›®</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--warning-light); border-radius: 12px;">
          <div style="font-size: 24px; font-weight: 800; color: #d97706; margin-bottom: 4px;">${overdueTasks}</div>
          <div style="font-size: 12px; color: #d97706; font-weight: 600;">é€¾æœŸä»»åŠ¡</div>
        </div>
      `;

      // Mock overdue items table
      const mockOverdueItems = [
        { name: 'CRMç³»ç»Ÿå‡çº§', days: 5, assignee: 'å¼ ä¸‰', status: 'doing' },
        { name: 'ç§»åŠ¨ç«¯ä¼˜åŒ–', days: 2, assignee: 'æå››', status: 'todo' },
        { name: 'æ•°æ®è¿ç§»', days: 8, assignee: 'ç‹äº”', status: 'doing' }
      ];

      overdueItems.innerHTML = mockOverdueItems.map(item => `
        <tr>
          <td>
            <div style="font-weight: 600;">${item.name}</div>
          </td>
          <td><span style="color: var(--danger); font-weight: 600;">${item.days} å¤©</span></td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="activity-avatar" style="width: 24px; height: 24px; font-size: 10px;">
                ${getInitials(item.assignee)}
              </div>
              ${item.assignee}
            </div>
          </td>
          <td>
            <span class="status-badge ${item.status === 'doing' ? 'status-pending' : 'status-overdue'}">
              ${item.status === 'doing' ? 'è¿›è¡Œä¸­' : 'å¾…åŠ'}
            </span>
          </td>
        </tr>
      `).join('');
    }

    // Enhanced chart update functions
    function updateProjectStatusChart(period) {
      const statusChart = document.getElementById('projectStatusChart');
      
      // Mock data based on period
      let statusCounts;
      switch(period) {
        case '7d':
          statusCounts = { active: 8, completed: 3, paused: 1 };
          break;
        case '30d':
          statusCounts = { active: 15, completed: 12, paused: 3 };
          break;
        case '90d':
          statusCounts = { active: 25, completed: 35, paused: 8 };
          break;
        default:
          statusCounts = { active: 12, completed: 8, paused: 2 };
      }

      const chartData = [
        { label: 'è¿›è¡Œä¸­', value: statusCounts.active },
        { label: 'å·²å®Œæˆ', value: statusCounts.completed },
        { label: 'æš‚åœ', value: statusCounts.paused }
      ].filter(item => item.value > 0);

      const chart = new SimpleChart(statusChart);
      chart.renderPieChart(chartData, {
        colors: ['#10b981', '#4f46e5', '#f59e0b'],
        size: 180
      });
      
      showToast(`å·²æ›´æ–°${period === '7d' ? '7å¤©' : period === '30d' ? '30å¤©' : '90å¤©'}æ•°æ®`, 'info');
    }

    function updateMonthlyTrendChart(metric) {
      const monthlyChart = document.getElementById('monthlyTrendChart');
      
      // Generate different data based on metric
      const monthlyData = [];
      const today = new Date();
      
      for (let i = 5; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthName = date.toLocaleDateString('zh-CN', { month: 'short' });
        
        let value;
        switch(metric) {
          case 'tasks':
            value = Math.floor(Math.random() * 50) + 20;
            break;
          case 'completion':
            value = Math.floor(Math.random() * 30) + 60; // 60-90%
            break;
          case 'projects':
            value = Math.floor(Math.random() * 15) + 5;
            break;
          default:
            value = Math.floor(Math.random() * 50) + 20;
        }
        
        monthlyData.push({
          label: monthName,
          value: value
        });
      }

      const chart = new SimpleChart(monthlyChart);
      chart.renderLineChart(monthlyData, {
        title: `æœ€è¿‘6ä¸ªæœˆ${metric === 'tasks' ? 'ä»»åŠ¡' : metric === 'completion' ? 'å®Œæˆç‡' : 'é¡¹ç›®'}è¶‹åŠ¿`,
        color: metric === 'tasks' ? '#8b5cf6' : metric === 'completion' ? '#10b981' : '#f59e0b',
        height: 240,
        showPoints: true,
        padding: { top: 20, right: 20, bottom: 40, left: 50 }
      });
      
      showToast(`å·²åˆ‡æ¢åˆ°${metric === 'tasks' ? 'ä»»åŠ¡æ•°' : metric === 'completion' ? 'å®Œæˆç‡' : 'é¡¹ç›®æ•°'}è§†å›¾`, 'info');
    }

    // Export functionality
    function exportStatisticsReport() {
      const btn = document.getElementById('exportBtn');
      const originalContent = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> å¯¼å‡ºä¸­...';
      
      // Generate report data
      const reportData = generateReportData();
      
      // Create and download CSV
      const csvContent = generateCSV(reportData);
      downloadFile(csvContent, `æ•°æ®ç»Ÿè®¡æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
      
      // Also offer print option
      setTimeout(() => {
        if (confirm('æŠ¥å‘Šå·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚æ˜¯å¦è¦æ‰“å°ç»Ÿè®¡æŠ¥å‘Šï¼Ÿ')) {
          printReport();
        }
        
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }, 1000);
    }

    function generateReportData() {
      const totalProjects = statsData.projects.length;
      const activeProjects = statsData.projects.filter(p => p.status === 'active').length;
      const jobs = statsData.workItems.filter(w => w.kind === 'JOB');
      const tasks = statsData.workItems.filter(w => w.kind === 'TASK');
      const completedTasks = tasks.filter(t => t.status === 'done').length;
      const activeUsers = new Set(statsData.workItems.map(w => w.assignee)).size;
      
      return {
        summary: {
          totalProjects,
          activeProjects,
          totalJobs: jobs.length,
          totalTasks: tasks.length,
          completedTasks,
          activeUsers,
          completionRate: tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0
        },
        projects: statsData.projects,
        workItems: statsData.workItems,
        activities: statsData.activities
      };
    }

    function generateCSV(data) {
      let csv = 'æ•°æ®ç»Ÿè®¡æŠ¥å‘Š\n';
      csv += `ç”Ÿæˆæ—¶é—´,${new Date().toLocaleString('zh-CN')}\n\n`;
      
      // Summary section
      csv += 'æ¦‚è§ˆç»Ÿè®¡\n';
      csv += 'æŒ‡æ ‡,æ•°å€¼\n';
      csv += `æ€»é¡¹ç›®æ•°,${data.summary.totalProjects}\n`;
      csv += `æ´»è·ƒé¡¹ç›®æ•°,${data.summary.activeProjects}\n`;
      csv += `æ€»JOBæ•°,${data.summary.totalJobs}\n`;
      csv += `æ€»TASKæ•°,${data.summary.totalTasks}\n`;
      csv += `å·²å®Œæˆä»»åŠ¡æ•°,${data.summary.completedTasks}\n`;
      csv += `æ´»è·ƒç”¨æˆ·æ•°,${data.summary.activeUsers}\n`;
      csv += `æ€»ä½“å®Œæˆç‡,${data.summary.completionRate}%\n\n`;
      
      // Projects section
      csv += 'é¡¹ç›®åˆ—è¡¨\n';
      csv += 'é¡¹ç›®ç¼–å·,é¡¹ç›®åç§°,çŠ¶æ€,è®¡åˆ’ç»“æŸæ—¶é—´,è¿›åº¦\n';
      data.projects.forEach(project => {
        csv += `${project.code || ''},${project.name || ''},${project.status || ''},${project.planned_end || ''},${project.progress || 0}%\n`;
      });
      
      csv += '\nå·¥ä½œé¡¹åˆ—è¡¨\n';
      csv += 'ID,ç±»å‹,æ ‡é¢˜,çŠ¶æ€,è´Ÿè´£äºº,æ›´æ–°æ—¶é—´\n';
      data.workItems.forEach(item => {
        csv += `${item.id || ''},${item.kind || ''},${item.title || ''},${item.status || ''},${item.assignee || ''},${item.updated_at || ''}\n`;
      });
      
      return csv;
    }

    function downloadFile(content, filename, contentType) {
      const blob = new Blob(['\ufeff' + content], { type: contentType + ';charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      URL.revokeObjectURL(url);
    }

    function printReport() {
      // Add print-specific styles
      const printStyles = `
        <style>
          @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .chart-grid { grid-template-columns: 1fr !important; }
            .chart-card { break-inside: avoid; margin-bottom: 20px; }
            .data-table { font-size: 12px; }
            .data-table th, .data-table td { padding: 6px 8px; }
          }
        </style>
      `;
      
      // Add print styles to head
      const styleElement = document.createElement('style');
      styleElement.innerHTML = printStyles.replace('<style>', '').replace('</style>', '');
      document.head.appendChild(styleElement);
      
      // Add print class to body
      document.body.classList.add('print-area');
      
      // Print
      window.print();
      
      // Cleanup
      setTimeout(() => {
        document.head.removeChild(styleElement);
        document.body.classList.remove('print-area');
      }, 1000);
    }

    // Event handlers
    function setupEventHandlers() {
      // Export button
      document.getElementById('exportBtn').addEventListener('click', exportStatisticsReport);
      
      // Help button
      document.getElementById('helpBtn').addEventListener('click', showHelpModal);
      
      // Help modal close events
      document.getElementById('closeHelpBtn').addEventListener('click', hideHelpModal);
      document.getElementById('helpModal').addEventListener('click', (e) => {
        if (e.target.id === 'helpModal') {
          hideHelpModal();
        }
      });
      
      // Debug panel close event
      document.getElementById('closeDebugBtn').addEventListener('click', () => {
        document.getElementById('debugPanel').style.display = 'none';
      });
      
      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', async () => {
        await fetchDataWithLoading();
      });

      // Filter buttons with enhanced functionality
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const parent = e.target.closest('.chart-filter');
          if (parent) {
            parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            // Handle specific chart updates
            const chartType = e.target.dataset.chart;
            const period = e.target.dataset.period;
            const metric = e.target.dataset.metric;
            
            if (chartType === 'status' && period) {
              updateProjectStatusChart(period);
            } else if (chartType === 'trend' && metric) {
              updateMonthlyTrendChart(metric);
            }
          }
        });
      });
    }

    // Update timestamp
    function updateTimestamp() {
      const now = new Date();
      const timestamp = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('updateTimestamp').textContent = timestamp;
    }

    // Data validation function
    function validateData() {
      const issues = [];
      
      if (!statsData.projects || statsData.projects.length === 0) {
        issues.push('é¡¹ç›®æ•°æ®ä¸ºç©º - è¯·ç¡®ä¿æ•°æ®åº“ä¸­æœ‰é¡¹ç›®æ•°æ®');
      }
      
      if (!statsData.workItems || statsData.workItems.length === 0) {
        issues.push('å·¥ä½œé¡¹æ•°æ®ä¸ºç©º - è¯·ç¡®ä¿æ•°æ®åº“ä¸­æœ‰å·¥ä½œé¡¹æ•°æ®');
      }
      
      if (!statsData.users || statsData.users.length === 0) {
        issues.push('ç”¨æˆ·æ•°æ®ä¸ºç©º - è¯·ç¡®ä¿æ•°æ®åº“ä¸­æœ‰ç”¨æˆ·æ•°æ®');
      }
      
      if (issues.length > 0) {
        console.error('âŒ æ•°æ®éªŒè¯å¤±è´¥:', issues);
        showDataError(`æ•°æ®éªŒè¯å¤±è´¥: ${issues.join(', ')}`);
        return false;
      }
      
      console.log('âœ… æ•°æ®éªŒè¯é€šè¿‡ - ä½¿ç”¨çœŸå®æ•°æ®åº“æ•°æ®');
      return true;
    }

    // Initialize project filter
    function initializeProjectFilter() {
      const filterSelect = document.getElementById('taskProjectFilter');
      if (!filterSelect) return;
      
      // Clear existing options except the first one
      filterSelect.innerHTML = '<option value="">å…¨éƒ¨é¡¹ç›®</option>';
      
      // Add project options
      statsData.projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name || project.title || `é¡¹ç›® ${project.id}`;
        filterSelect.appendChild(option);
      });
      
      // Add event listener
      filterSelect.addEventListener('change', (e) => {
        renderTaskDistribution(e.target.value);
      });
    }

    // Main render function
    function renderAllData() {
      // Validate data before rendering - åªæœ‰çœŸå®æ•°æ®éªŒè¯é€šè¿‡æ‰æ¸²æŸ“
      if (!validateData()) {
        console.error('âŒ æ•°æ®éªŒè¯å¤±è´¥ï¼Œåœæ­¢æ¸²æŸ“');
        return;
      }
      
      console.log('ğŸ“Š å¼€å§‹æ¸²æŸ“çœŸå®æ•°æ®...');
      renderKPIs();
      renderTopProjectsProgress();
      renderUpcomingDeadlines();
      renderRecentActivities();
      renderTeamPerformance();
      renderCharts();
      initializeProjectFilter();
      updateTimestamp();
      
      // Add data quality indicator
      updateDataQualityIndicator();
      
      // Update debug info if panel is visible
      if (document.getElementById('debugPanel').style.display !== 'none') {
        updateDebugInfo();
      }
      
      // Log render completion
      console.log('âœ… Dashboardæ¸²æŸ“å®Œæˆ - ä½¿ç”¨çœŸå®æ•°æ®åº“æ•°æ®');
    }

    function updateDataQualityIndicator() {
      const totalItems = statsData.projects.length + statsData.workItems.length + statsData.users.length;
      const qualityScore = totalItems > 0 ? 100 : 0; // åªè¦æœ‰çœŸå®æ•°æ®å°±æ˜¯100%è´¨é‡
      
      const indicator = document.getElementById('dataQualityIndicator');
      if (!indicator) {
        const newIndicator = document.createElement('div');
        newIndicator.id = 'dataQualityIndicator';
        newIndicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 8px 12px;
          background: var(--bg-surface);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          font-size: 12px;
          color: var(--text-secondary);
          box-shadow: var(--shadow-md);
          z-index: 1000;
        `;
        document.body.appendChild(newIndicator);
      }
      
      const color = qualityScore === 100 ? 'var(--success)' : 'var(--danger)';
      const dataType = qualityScore === 100 ? 'çœŸå®æ•°æ®' : 'æ— æ•°æ®';
      document.getElementById('dataQualityIndicator').innerHTML = `
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="width: 6px; height: 6px; background: ${color}; border-radius: 50%;"></div>
          ${dataType}: ${totalItems} é¡¹
        </div>
      `;
    }

    // Load recent activities - åªä»APIè·å–çœŸå®æ•°æ®
    function loadRecentActivities() {
      fetchRealActivities().then(() => {
        renderRecentActivities();
      });
    }

    // Loading state management
    function showLoading() {
      document.getElementById('loadingState').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    // Enhanced data fetching with loading state
    async function fetchDataWithLoading() {
      showLoading();
      const startTime = Date.now();
      
      try {
        const success = await fetchAllData();
        renderAllData();
        
        const loadTime = Date.now() - startTime;
        if (success) {
          showToast(`æ•°æ®æ›´æ–°æˆåŠŸ (${loadTime}ms)`, 'success');
        } else {
          showToast(`ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ® (${loadTime}ms)`, 'info');
        }
      } catch (error) {
        console.error('Failed to fetch data:', error);
        showToast('æ•°æ®æ›´æ–°å¤±è´¥', 'error');
        // ä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        showDataError('æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
      } finally {
        hideLoading();
      }
    }

    // Toast notification system
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Simulate real-time data updates
    function simulateRealTimeUpdates() {
      // Randomly update some KPI values
      const kpiUpdates = [
        { id: 'totalProjects', change: Math.random() > 0.7 ? 1 : 0 },
        { id: 'totalJobs', change: Math.random() > 0.8 ? Math.floor(Math.random() * 3) : 0 },
        { id: 'totalTasks', change: Math.random() > 0.6 ? Math.floor(Math.random() * 5) : 0 },
        { id: 'activeUsers', change: Math.random() > 0.9 ? (Math.random() > 0.5 ? 1 : -1) : 0 }
      ];

      let hasUpdates = false;
      kpiUpdates.forEach(update => {
        if (update.change !== 0) {
          const element = document.getElementById(update.id);
          if (element) {
            const currentValue = parseInt(element.textContent) || 0;
            const newValue = Math.max(0, currentValue + update.change);
            
            // Animate the change
            element.style.transform = 'scale(1.1)';
            element.style.color = update.change > 0 ? 'var(--success)' : 'var(--danger)';
            
            setTimeout(() => {
              element.textContent = newValue;
              setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = 'var(--text-main)';
              }, 200);
            }, 100);
            
            hasUpdates = true;
          }
        }
      });

      // Occasionally add a new activity
      if (Math.random() > 0.7) {
        addNewActivity();
        hasUpdates = true;
      }

      // Update timestamp
      updateTimestamp();
      
      if (hasUpdates) {
        // Subtle notification for real-time updates
        const indicator = document.createElement('div');
        indicator.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          width: 8px;
          height: 8px;
          background: var(--success);
          border-radius: 50%;
          z-index: 10001;
          animation: pulse 1s ease-in-out;
        `;
        document.body.appendChild(indicator);
        
        setTimeout(() => {
          if (document.body.contains(indicator)) {
            document.body.removeChild(indicator);
          }
        }, 1000);
      }
    }

    function addNewActivity() {
      const users = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ'];
      const actions = ['åˆ›å»ºäº†', 'æ›´æ–°äº†', 'å®Œæˆäº†', 'è¯„è®ºäº†'];
      const types = ['é¡¹ç›®', 'JOB', 'TASK'];
      const items = ['ç”¨æˆ·ç•Œé¢ä¼˜åŒ–', 'æ•°æ®åº“è¿ç§»', 'æ€§èƒ½æµ‹è¯•', 'ä»£ç å®¡æŸ¥', 'éœ€æ±‚åˆ†æ'];
      
      const newActivity = {
        id: Date.now(),
        user: users[Math.floor(Math.random() * users.length)],
        action: actions[Math.floor(Math.random() * actions.length)],
        type: types[Math.floor(Math.random() * types.length)],
        item: items[Math.floor(Math.random() * items.length)],
        time: new Date().toISOString()
      };
      
      // Add to beginning of activities array
      statsData.activities.unshift(newActivity);
      
      // Keep only latest 20 activities
      if (statsData.activities.length > 20) {
        statsData.activities = statsData.activities.slice(0, 20);
      }
      
      // Re-render activities
      renderRecentActivities();
    }

    // Help modal functions
    function showHelpModal() {
      document.getElementById('helpModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function hideHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Debug panel functions
    function toggleDebugPanel() {
      const panel = document.getElementById('debugPanel');
      const isVisible = panel.style.display !== 'none';
      
      if (isVisible) {
        panel.style.display = 'none';
      } else {
        panel.style.display = 'block';
        updateDebugInfo();
      }
    }

    function updateDebugInfo() {
      document.getElementById('debugProjects').textContent = statsData.projects?.length || 0;
      document.getElementById('debugWorkItems').textContent = statsData.workItems?.length || 0;
      document.getElementById('debugUsers').textContent = statsData.users?.length || 0;
      document.getElementById('debugActivities').textContent = statsData.activities?.length || 0;
      document.getElementById('debugRenderTime').textContent = performanceMetrics.lastRenderTime ? 
        `${performanceMetrics.lastRenderTime.toFixed(2)}ms` : '-';
      document.getElementById('debugLoadTime').textContent = 
        `${Date.now() - performanceMetrics.startTime}ms`;
    }

    // Performance monitoring
    const performanceMetrics = {
      startTime: Date.now(),
      renderTimes: [],
      lastRenderTime: 0
    };

    function trackRenderPerformance(renderFunction, name) {
      return function(...args) {
        const start = performance.now();
        const result = renderFunction.apply(this, args);
        const end = performance.now();
        const duration = end - start;
        
        performanceMetrics.renderTimes.push({ name, duration, timestamp: Date.now() });
        performanceMetrics.lastRenderTime = duration;
        
        // Keep only last 10 measurements
        if (performanceMetrics.renderTimes.length > 10) {
          performanceMetrics.renderTimes.shift();
        }
        
        if (duration > 100) { // Warn if render takes more than 100ms
          console.warn(`Slow render detected: ${name} took ${duration.toFixed(2)}ms`);
        }
        
        return result;
      };
    }

    // Wrap render functions with performance tracking
    const originalRenderAllData = renderAllData;
    renderAllData = trackRenderPerformance(originalRenderAllData, 'renderAllData');

    // Initialize
    async function init() {
      console.log('ğŸš€ åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡dashboard...');
      
      // Initial load
      await fetchDataWithLoading();
      
      // Refresh activities on page entry
      console.log('ğŸ“‹ åˆ·æ–°æœ€è¿‘æ´»åŠ¨...');
      await fetchRealActivities();
      renderRecentActivities();
      
      setupEventHandlers();
      
      // Show initialization complete message
      const initTime = Date.now() - performanceMetrics.startTime;
      console.log(`âœ… Dashboardåˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶: ${initTime}ms`);
      showToast(`DashboardåŠ è½½å®Œæˆ (${initTime}ms)`, 'success');
      
      // Auto refresh every 5 minutes
      setInterval(async () => {
        console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æ•°æ®...');
        await fetchAllData();
        renderAllData();
        showToast('æ•°æ®å·²è‡ªåŠ¨åˆ·æ–°', 'info');
      }, 5 * 60 * 1000);
      
      // Auto refresh activities every 1 minute
      setInterval(async () => {
        console.log('ğŸ“‹ è‡ªåŠ¨åˆ·æ–°æœ€è¿‘æ´»åŠ¨...');
        await fetchRealActivities();
        renderRecentActivities();
        updateTimestamp();
      }, 60 * 1000);
      
      // Simulate real-time data updates every 30 seconds
      setInterval(() => {
        simulateRealTimeUpdates();
      }, 30 * 1000);
      
      // Add keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case 'r':
              e.preventDefault();
              document.getElementById('refreshBtn').click();
              break;
            case 'e':
              e.preventDefault();
              document.getElementById('exportBtn').click();
              break;
            case 'p':
              e.preventDefault();
              printReport();
              break;
          }
        } else {
          switch (e.key.toLowerCase()) {
            case 'h':
              e.preventDefault();
              showHelpModal();
              break;
            case 'escape':
              hideHelpModal();
              break;
            case 'd':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                toggleDebugPanel();
              }
              break;
          }
        }
      });
    }

    // Start the application
    init();
  </script>
</body>
</html>