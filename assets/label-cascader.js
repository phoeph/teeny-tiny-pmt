function setupLabelEditor(container, entity, extras){ try { const API=(window.API)||'http://localhost:8000/api'; const token=localStorage.getItem('token')||''; const anchor = (function(){ const rows = container ? container.querySelectorAll('.jira-item') : []; for (var i=0;i<rows.length;i++){ var lab = rows[i].querySelector('.jira-label'); if (lab && String(lab.textContent||'').trim()==='Labels'){ var val = rows[i].querySelector('.jira-value'); if (val) return val; } } return null; })(); if (!anchor) return; const current = (extras && extras.rawProject && extras.rawProject.label_path) || (entity && entity.label_path) || ''; anchor.innerHTML = '<a id="labelsEditLink" href="javascript:void(0)" style="color:var(--primary);">' + (current || 'Select Label') + '</a>'; const link=document.getElementById('labelsEditLink'); if(!link) return; const fetchTree = async function(){ try{ const res = await fetch(API + '/labels/tree', { headers:{ Authorization: 'Bearer ' + token } }); if(!res.ok) return { items: [] }; return await res.json(); }catch(_){ return { items: [] }; } }; const showMenu = function(list, trail){ let menu=document.getElementById('labelCascaderDropdown'); if(!menu){ menu=document.createElement('div'); menu.id='labelCascaderDropdown'; menu.className='dropdown'; document.body.appendChild(menu); } const rect=link.getBoundingClientRect(); menu.style.display='block'; menu.style.left=(rect.left + window.scrollX) + 'px'; menu.style.top=(rect.bottom + window.scrollY) + 'px'; menu.style.minWidth = Math.max(180, Math.round(rect.width + 60)) + 'px'; menu.style.zIndex = '1000'; const bc = (trail||[]).map(function(n,i){ return '<span data-i="'+i+'" class="dropdown-bc" style="margin-right:6px;color:var(--text-secondary);">'+ n.name +'</span>'; }).join(''); const items = (list||[]).map(function(n){ const leaf = !n.children || n.children.length===0; const right = leaf ? '' : '<span style="float:right;color:var(--text-secondary);">›</span>'; const cls = leaf ? '' : ' has-children'; return '<div class="dropdown-item'+cls+'" data-leaf="'+(leaf?'1':'0')+'" data-name="'+(n.name||'')+'" data-path="'+(n.path||'')+'">'+ (n.name||'') + right +'</div>'; }).join(''); menu.innerHTML = '<div style="padding:6px 10px;border-bottom:1px solid var(--border-color);">'+ (bc || '选择标签') +'</div>' + items + '<div class="dropdown-footer" style="border-top:1px solid var(--border-color);">仅可选择叶子节点</div>'; Array.prototype.forEach.call(menu.querySelectorAll('.dropdown-bc'), function(bcEl){ bcEl.onclick=function(){ const idx = Number(this.getAttribute('data-i'))||0; const backTrail = (trail||[]).slice(0, idx+1); const parent = backTrail[backTrail.length-1] || { children: list }; showMenu(parent.children||[], backTrail); }; }); Array.prototype.forEach.call(menu.querySelectorAll('.dropdown-item'), function(it){ it.onclick = async function(){ const leaf = this.getAttribute('data-leaf')==='1'; const name = this.getAttribute('data-name')||''; const path = this.getAttribute('data-path')||''; const node = { name: name, path: path }; const curTrail = (trail||[]).slice(); if (!leaf){ var parent = (list||[]).find(function(n){ return n.name===name; }) || { children: [] }; curTrail.push(parent); showMenu(parent.children||[], curTrail); return; } menu.style.display='none'; const newPath = path || (curTrail.map(function(t){ return t.name; }).concat([name]).join('/')); link.textContent = newPath; try{ const projId = (entity && entity.type==='project') ? (entity.id || 0) : ((extras && extras.project_id) || 0); const wid = Number(entity && entity.type!=='project' ? (entity.id||0) : 0); const payload = { label_path: newPath }; if (entity.type==='project'){ const res = await fetch(API + '/projects/' + projId, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(payload) }); if(!res.ok){ const txt = await res.text(); alert('保存失败(' + res.status + '): ' + txt); } } else { const res2 = await fetch(API + '/work-items/' + wid, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(payload) }); if(!res2.ok){ const t2 = await res2.text(); alert('保存失败(' + res2.status + '): ' + t2); } } }catch(e){  } }; }); menu.onmousedown=function(e){ e.preventDefault(); }; };
  link.onclick = async function(){ const meRes = await fetch(API + '/auth/me', { headers:{ Authorization:'Bearer ' + token } }); if (!meRes.ok) { link.style.color = 'var(--text-secondary)'; return; } const tree = await fetchTree(); const list = Array.isArray(tree.items) ? tree.items : []; showMenu(list, []); };
} catch(_){} }
