function __fmtDateStr(s){ try { if (!s) return ''; const d = new Date(s); if (!isNaN(d.getTime())) { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); const hh = String(d.getHours()).padStart(2, '0'); const mm = String(d.getMinutes()).padStart(2, '0'); return y + '-' + m + '-' + dd + ' ' + hh + ':' + mm; } return String(s); } catch (_) { return String(s || ''); } }
function __safe(v){ const s = (v == null ? '' : String(v)).trim(); return s ? s : '-'; }
function __prefixToName(p){ const defs = __defaultUsers(); const byPrefix = defs.find(function(u){ return u.prefix === p; }); return byPrefix ? byPrefix.name : (p || ''); }
function __resolveDisplayUser(v){ if (!v) return ''; let s = String(v); const idx = s.indexOf('@'); if (idx > 0) s = s.slice(0, idx); return __prefixToName(s);
}
function normalizeEntity(type, raw, ctx){ const r = raw || {}; const project = (ctx && ctx.project) || {}; const job = (ctx && ctx.job) || {}; let assRaw = r.assignee || r.assignee_prefix || r.assignee_username || ''; const creatorRaw = r.creator || r.creator_prefix || r.creator_username || ''; let ownerRaw = r.owner || r.owner_prefix || r.owner_username || creatorRaw || assRaw; if ((type||'')==='project'){ ownerRaw = creatorRaw || ownerRaw; } if ((type||'')==='project' && !assRaw){ assRaw = r.owner_prefix || r.owner_username || ''; try{ const key='project_people_'+String(r.id||r.code||''); const obj=JSON.parse(localStorage.getItem(key)||'{}'); if(obj && obj.assignee){ assRaw = obj.assignee; } }catch(_){ } } return { type: type || '', id: r.id || r.code || '', code: r.code || '', name: r.name || r.title || '', title: r.title || r.name || '', description: r.description || '', owner: __resolveDisplayUser(ownerRaw), assignee: __resolveDisplayUser(assRaw), creator: __resolveDisplayUser(creatorRaw), created_at: r.created_at || '', updated_at: r.updated_at || r.modified_at || '', status: r.status || '', priority: r.priority || '', label_path: r.label_path || '', start_date: r.start_date || r.planned_start_date || r.planned_start || '', end_date: r.end_date || r.planned_end_date || r.planned_end || '', planned_start_date: r.planned_start_date || r.planned_start || '', planned_end_date: r.planned_end_date || r.planned_end || '', actual_hours: r.actual_hours || '', estimated_hours: r.estimated_hours || '', project_code: project.code || r.project_code || '', project_name: project.name || r.project_name || '', job_code: job.code || r.parent_code || '', job_name: job.title || job.name || '', parent_id: r.parent_id || r.parentId || '' }; }

function renderJiraIssueLayout(target, entity, extras){ if (!target || !entity) return; const e = entity; const priIcon = function(p){ const c = (p==='low')?'var(--success)':(p==='high')?'var(--danger)':'var(--warning)'; const txt=(p==='low'?'Low':(p==='high'?'High':'Medium')); return '<span style="display:inline-flex;align-items:center;gap:6px;"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="'+c+'" d="M12 3c2 3 6 4 6 9a6 6 0 1 1-12 0c0-2 1-4 3-5c1 2 3 3 3 6a3 3 0 1 0 3-3c0-3-1-4-3-7z"/></svg><span id="priorityLabel">'+ txt +'</span></span>'; }; const priVal = String(e.priority||'').toLowerCase(); const priHtml = '<a id="priorityEditLink" href="javascript:void(0)" style="color:var(--primary);">'+ priIcon(priVal||'medium') +'</a>'; const detailsCol1 = [ { label: 'Type', value: __safe(e.type || '') }, { label: 'Labels', value: '' }, { label: 'Priority', value: priHtml } ]; const detailsCol2 = [ { label: 'Status', value: '<span class="jira-badge">' + __safe(e.status || '') + '</span>' }, { label: 'Created', value: __safe(__fmtDateStr(e.created_at)) }, { label: 'Updated', value: __safe(__fmtDateStr(e.updated_at)) } ]; const assLabel = (__safe(e.assignee) === '-' ? 'Unassigned' : __safe(e.assignee)); const reporterLabel = (__safe(e.owner) !== '-' ? __safe(e.owner) : assLabel); const people = [ { label: 'Assignee', value: '<a id="peopleAssigneeLink" href="javascript:void(0)" style="color:var(--primary);">' + assLabel + '</a>' }, { label: 'Reporter', value: '<span id="peopleReporterLabel">' + reporterLabel + '</span>' }, { label: 'Watchers', value: '<span id="watchersBadge" class="jira-badge" title="">0</span> <a id="watchToggleLink" href="javascript:void(0)" style="color:var(--primary);">Start Watching</a>' } ]; const mk = function(arr){ return arr.map(function(it){ return '<div class="jira-item"><div class="jira-label">' + it.label + '</div><div class="jira-value">' + (String(it.value||'').trim() || '-') + '</div></div>'; }).join(''); }; const hideHeader = !!(extras && extras.hideHeader); const header = hideHeader ? '' : ('<div class="jira-header"><div><div class="jira-breadcrumb">' + __safe(extras && extras.breadcrumb || '') + '<span class="jira-issue-key">' + __safe(e.code) + '</span></div><div class="jira-title">' + __safe(e.title || e.name) + '</div></div><div class="jira-actions"><span class="counter">' + __safe(extras && extras.counter || '') + '</span></div></div>'); const html = '<div class="jira-container">' + header + '<div class="jira-columns">' + '<div><div class="jira-card"><h4>Details</h4><div class="jira-items-grid"><div class="jira-items jira-col">' + mk(detailsCol1) + '</div><div class="jira-items jira-col">' + mk(detailsCol2) + '</div></div></div></div>' + '<div><div class="jira-card"><h4>People</h4><div class="jira-items">' + mk(people) + '</div></div></div>' + '</div></div>'; target.innerHTML = html; setupPeopleEditors(target, e); setupPriorityEditor(target, e, extras); }

function setupPriorityEditor(container, entity, extras){ try{ const link=document.getElementById('priorityEditLink'); if(!link) return; const API=(window.API)||'http://localhost:8000/api'; const token=localStorage.getItem('token')||''; const isProject = (entity && entity.type==='project'); const projectId = isProject ? (entity.id||0) : ((extras && extras.project_id) || 0); const creatorId = (extras && extras.rawProject && extras.rawProject.creator_id) ? extras.rawProject.creator_id : null; const workItemId = (!isProject && extras && extras.rawItem && extras.rawItem.id) ? extras.rawItem.id : null; const meFetch = fetch(`${API}/auth/me`, { headers:{ Authorization: 'Bearer ' + token } }); meFetch.then(function(r){ if(!r.ok) return null; return r.json(); }).then(function(me){ const user = me && me.user ? me.user : me; const isAdmin = !!(user && user.username==='admin'); const isReporter = !!(user && creatorId && (user.id===creatorId)); const can = isAdmin || isReporter; if(!can){ link.style.color='var(--text-secondary)'; return; } link.style.cursor='pointer'; link.onclick=function(){ let menu=document.getElementById('priorityDropdown'); if(!menu){ menu=document.createElement('div'); menu.id='priorityDropdown'; menu.className='dropdown'; document.body.appendChild(menu); } const rect=link.getBoundingClientRect(); menu.style.display='block'; menu.style.left=(rect.left + window.scrollX) + 'px'; menu.style.top=(rect.bottom + window.scrollY) + 'px'; menu.style.width = Math.max(120, Math.round(rect.width + 40)) + 'px'; menu.style.minWidth = '120px'; menu.style.zIndex = '1000'; menu.innerHTML=['low','medium','high'].map(function(p){ const txt=p==='low'?'Low':(p==='high'?'High':'Medium'); return '<div class="dropdown-item" data-p="'+p+'">'+txt+'</div>'; }).join(''); menu.querySelectorAll('.dropdown-item').forEach(function(it){ it.onclick=async function(){ const p=this.getAttribute('data-p')||'medium'; try{ if(isProject){ const res=await fetch(`${API}/projects/${projectId}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ priority: p }) }); if(res.ok){ entity.priority = p; link.innerHTML = priIcon(p); } } else if (workItemId){ const res=await fetch(`${API}/work-items/${workItemId}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ priority: p }) }); if(res.ok){ entity.priority = p; link.innerHTML = priIcon(p); } } }catch(_){ } menu.style.display='none'; }; }); const hider=function(e){ if(!menu.contains(e.target) && e.target!==link){ menu.style.display='none'; document.removeEventListener('mousedown', hider, true); } }; setTimeout(function(){ document.addEventListener('mousedown', hider, true); }, 0); }; }); }catch(_){ } }

function __defaultUsers(){ return [ { name: '张三', prefix: 'zhangsan', email: 'zhangsan@chinaunicom.cn' }, { name: '李四', prefix: 'lisi', email: 'lisi@chinaunicom.cn' }, { name: '王五', prefix: 'wangwu', email: 'wangwu@chinaunicom.cn' }, { name: '赵六', prefix: 'zhaoliu', email: 'zhaoliu@chinaunicom.cn' }, { name: '钱七', prefix: 'qianqi', email: 'qianqi@chinaunicom.cn' }, { name: '智飞', prefix: 'zhif1', email: 'zhif1@chinaunicom.cn' } ]; }
function __nameToPrefix(v){ const defs = __defaultUsers(); const byName = defs.find(function(u){ return u.name === v; }); if (byName) return byName.prefix; const idx = (v || '').indexOf('@'); if (idx > 0) return v.slice(0, idx); return v; }
function __buildUserIndex(){ const set = []; __defaultUsers().forEach(function(u){ set.push(u); }); return set; }

function setupPeopleEditors(container, entity){ const assLink = document.getElementById('peopleAssigneeLink'); const repLabel = document.getElementById('peopleReporterLabel'); const w = document.getElementById('watchersBadge'); const link = document.getElementById('watchToggleLink'); const users = __buildUserIndex(); const showDropdown = function(anchor, onPick){ let el = document.getElementById('assigneeDropdown'); if (!el) { el = document.createElement('div'); el.id = 'assigneeDropdown'; el.className = 'dropdown'; document.body.appendChild(el); } const rect = anchor.getBoundingClientRect(); const filtered = users; el.style.display = 'block'; el.style.left = (rect.left + window.scrollX) + 'px'; el.style.top = (rect.bottom + window.scrollY) + 'px'; el.style.width = rect.width + 'px'; el.innerHTML = filtered.map(function(u){ return '<div class="dropdown-item" data-name="' + u.name + '" title="' + u.email + '">' + u.name + '</div>'; }).join(''); el.querySelectorAll('.dropdown-item').forEach(function(it){ it.onclick = function(){ const name = this.getAttribute('data-name') || ''; el.style.display = 'none'; if (typeof onPick === 'function') onPick(name); }; }); el.onmousedown = function(e){ e.preventDefault(); }; };
  if (assLink) { assLink.onclick = function(){ showDropdown(assLink, function(name){ assLink.textContent = name || 'Unassigned'; autoSavePeople(name); }); }; }
  if (repLabel) { repLabel.style.cursor = 'pointer'; repLabel.style.color = 'var(--primary)'; repLabel.onclick = function(){ showDropdown(repLabel, function(name){ repLabel.textContent = name || 'Unassigned'; autoSaveReporter(name); }); }; }
  async function autoSavePeople(assName){ try { const API = (window.API) || 'http://localhost:8000/api'; const token = localStorage.getItem('token') || ''; const payload = {}; if (assName) { const p = __nameToPrefix(assName); payload.assignee = p; payload.assignee_prefix = p; payload.assignee_email = p ? (p + '@chinaunicom.cn') : ''; }
    if (entity.type === 'project') { const pfx = __nameToPrefix(assName||''); const idVal = entity.id || entity.code; const res = await fetch(API + '/projects/' + idVal, { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify({ owner_prefix: pfx, owner_email: pfx ? (pfx + '@chinaunicom.cn') : '' }) }); if(!res.ok){ const txt = await res.text();  alert('保存失败(' + res.status + '): ' + txt); } else { const getRes = await fetch(API + '/projects/' + idVal, { headers: { Authorization: 'Bearer ' + token } }); if(getRes.ok){ const proj = await getRes.json(); const disp = __resolveDisplayUser((proj.owner_prefix || proj.owner_username || '')); const link = document.getElementById('peopleAssigneeLink'); if (link) link.textContent = disp || 'Unassigned'; try{ const key = 'project_people_' + String(idVal); const obj = { assignee: (proj.owner_prefix || proj.owner_username || '') }; localStorage.setItem(key, JSON.stringify(obj)); }catch(_){ } } } } else { const wid = Number(entity.id)||0; const res = await fetch(API + '/work-items/' + wid, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify(payload) }); if(!res.ok){ const txt = await res.text();  alert('保存失败(' + res.status + '): ' + txt); } } } catch (e) {  alert('网络错误：' + (e && e.message ? e.message : '')); } }
  async function autoSaveReporter(repName){ try { const API = (window.API) || 'http://localhost:8000/api'; const token = localStorage.getItem('token') || ''; const payload = {}; if (repName) { const p = __nameToPrefix(repName); payload.creator_id = null; payload.creator_prefix = p; payload.creator_email = p ? (p + '@chinaunicom.cn') : ''; }
    if (entity.type === 'project') { const idVal = entity.id || entity.code; await fetch(API + '/projects/' + idVal, { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify(payload) }); } else { const wid = Number(entity.id)||0; await fetch(API + '/work-items/' + wid, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify(payload) }); } } catch (_) {} }
  async function getMe(){ try { const API = (window.API) || 'http://localhost:8000/api'; const token = localStorage.getItem('token') || ''; const res = await fetch(`${API}/auth/me`, { headers: { Authorization: 'Bearer ' + token } }); if (!res.ok) return null; return await res.json(); } catch (_) { return null; } }
  async function refreshWatch(){ try { const API = (window.API) || 'http://localhost:8000/api'; const token = localStorage.getItem('token') || ''; const et = entity.type === 'project' ? 'project' : 'work_item'; const eid = Number(entity.id)||0; const res = await fetch(API + '/watch/' + et + '/' + eid, { headers: { Authorization: 'Bearer ' + token } }); if (!res.ok) return; const watchers = await res.json(); if (w) { w.textContent = String(watchers.length); w.setAttribute('title', watchers.map(function(u){ return (u.username || '') + ' (' + (u.email_prefix || '') + ')'; }).join('、')); } const me = await getMe(); const watched = !!(me && watchers.find(function(u){ return u.id === me.user.id; })); if (link) { link.textContent = watched ? 'Watched' : 'Start Watching'; } return watched; } catch (_) { return false; } }
  async function toggleWatch(){ const API = (window.API) || 'http://localhost:8000/api'; const token = localStorage.getItem('token') || ''; const et = entity.type === 'project' ? 'project' : 'work_item'; const eid = Number(entity.id)||0; const watched = await refreshWatch(); try { const url = API + '/watch?entity_type=' + et + '&entity_id=' + eid; const method = watched ? 'DELETE' : 'POST'; await fetch(url, { method: method, headers: { Authorization: 'Bearer ' + token } }); await refreshWatch(); } catch (_) {} }
  if (link) { link.onclick = toggleWatch; refreshWatch(); }
}
