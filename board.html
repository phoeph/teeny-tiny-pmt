<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Board - 双视图切换</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <style>
    /* Board specific overrides */
    .tool-btn {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .tool-btn:hover {
      background: var(--bg-hover);
      color: var(--primary);
    }
    /* Responsive overrides */
    @media (max-width: 960px) {
      .columns { flex-direction: column; }
      .assignee-header { display:none; }
      .assignee-list { display:none; }
      .task-header { width:200px; }
      .task-list { width:200px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title" style="font-weight:700; font-size:18px; color:var(--text-main);">Board</div>
    <div class="tools" style="display:flex; gap:8px;">
      <div class="view-toggle">
        <button id="btnGantt" class="toggle-btn active">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          Gantt
        </button>
        <button id="btnCard" class="toggle-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
          Card
        </button>
      </div>
      <button id="zoomOut" class="tool-btn" title="缩小">-</button>
      <button id="zoomIn" class="tool-btn" title="放大">+</button>
      <button id="modeDay" class="tool-btn" title="日视图">日</button>
      <button id="modeMonth" class="tool-btn" title="月视图">月</button>
    </div>
  </div>

  <div class="content" style="margin-top:24px;">
    <div id="ganttView" class="fade visible">
      <div class="gantt-container">
        <div class="gantt-header">
          <div class="task-header">任务</div>
          <div class="assignee-header">负责人</div>
          <div class="time-header">
            <div class="year-row" id="yearRow"></div>
            <div class="month-row" id="monthRow"></div>
            <div class="day-row" id="dayRow"></div>
          </div>
        </div>
        <div class="gantt-body">
          <div class="task-list" id="taskList"></div>
          <div class="assignee-list" id="assigneeList"></div>
          <div class="timeline">
            <div class="timeline-container" id="timelineContainer">
              <div class="timeline" id="timeline"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="cardView" class="fade hidden">
      <div class="columns">
        <div class="col">
          <h3>待办</h3>
          <div class="kanban-list" id="todo"></div>
        </div>
        <div class="col">
          <h3>进行中</h3>
          <div class="kanban-list" id="doing"></div>
        </div>
        <div class="col">
          <h3>已完成</h3>
          <div class="kanban-list" id="done"></div>
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="assets/issue-layout.css" />
  <script>
    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    const params = new URLSearchParams(location.search);
    const projectId = parseInt(params.get('project') || params.get('id') || '0', 10);

    const state = {
      startDate: (function(){ const y=new Date().getFullYear()-1; return new Date(y,0,1); })(),
      endDate: (function(){ const y=new Date().getFullYear()+1; return new Date(y,11,31); })(),
      totalDays: 0,
      columnWidth: 30,
      timeMode: 'day',
      scrollPosition: 0,
      currentDate: new Date(),
      items: [],
      jobs: [],
      tasksFlat: [],
      timeColumns: [],
      ganttTasks: []
    };

    function fmtDate(d) { return d ? new Date(d) : null; }
    function getPlannedStartStr(i){ return i && (i.planned_start_date || i.planned_start) || null; }
    function getPlannedEndStr(i){ return i && (i.planned_end_date || i.planned_end) || null; }
    function assigneeDisplay(v){ const s=(v||''); if(!s) return 'NA'; const idx=s.indexOf('@'); const name=idx>0?s.slice(0,idx):s; const map={ zhangsan:'张三', lisi:'李四', wangwu:'王五', zhaoliu:'赵六', qianqi:'钱七', zhif1:'智飞' }; return map[name]||name; }

    function colorForStatus(s){ return s==='done'? 'var(--success)' : (s==='doing'? 'var(--primary)' : 'var(--text-secondary)'); }

    function initViewToggle(){
      const btnG=document.getElementById('btnGantt');
      const btnC=document.getElementById('btnCard');
      const gantt=document.getElementById('ganttView');
      const card=document.getElementById('cardView');
      function setActive(which){
        if(which==='gantt'){ gantt.classList.remove('hidden'); gantt.classList.add('visible'); card.classList.remove('visible'); card.classList.add('hidden'); btnG.classList.add('active'); btnC.classList.remove('active'); }
        else { card.classList.remove('hidden'); card.classList.add('visible'); gantt.classList.remove('visible'); gantt.classList.add('hidden'); btnC.classList.add('active'); btnG.classList.remove('active'); }
      }
      btnG.onclick=function(){ setActive('gantt'); };
      btnC.onclick=function(){ setActive('card'); };
      setActive('gantt');
    }

    function applyZoom(delta){ const min=20, max=160; state.columnWidth = Math.max(min, Math.min(max, state.columnWidth + delta)); generateTimeColumns(); renderAll(); }
    function switchMode(mode){ state.timeMode = (mode==='month') ? 'month' : 'day'; state.columnWidth = state.timeMode==='day' ? 30 : 100; generateTimeColumns(); renderAll(); }

    function showToast(text){ try{ const el=document.createElement('div'); el.className='toast success'; el.textContent=text; document.body.appendChild(el); setTimeout(()=>el.remove(), 1600); }catch(_){} }

    async function fetchWorkItems(){ if(!Number.isFinite(projectId)) return; try{ const res=await fetch(`${API}/work-items/by-project/${projectId}`, { headers:{ Authorization:`Bearer ${token}` } }); if(!res.ok){ throw new Error('failed'); } const data=await res.json(); const items=(data.items||[]);
        state.items = items;
        const byStatus = { todo: [], doing: [], done: [] };
        const jobs=[]; const tasksFlat=[];
        items.forEach(it=>{ const kind = (it.kind==='JOB'||(Array.isArray(it.subtasks)&&it.subtasks.length>0))?'JOB':'TASK'; const ass = assigneeDisplay(it.assignee||it.assignee_prefix||''); const base = Object.assign({}, it, { assignee: ass }); if(kind==='JOB'){ byStatus[it.status]?.push(Object.assign({ kind:'JOB' }, base)); jobs.push(base); const kids=Array.isArray(it.subtasks)? it.subtasks : []; kids.forEach(t=>{ const a2=assigneeDisplay(t.assignee||t.assignee_prefix||''); const t2=Object.assign({}, t, { assignee:a2 }); tasksFlat.push(t2); if(String(t.status||'')!==String(it.status||'')) byStatus[t.status]?.push(Object.assign({ kind:'TASK' }, t2)); }); } else { byStatus[it.status]?.push(Object.assign({ kind:'TASK' }, base)); tasksFlat.push(base); }
        });
        state.jobs=jobs; state.tasksFlat=tasksFlat;
        buildGanttTasks(items);
        generateTimeColumns();
        renderAll();
        renderKanban(byStatus);
        enableDnD();
      } catch(e){ console.error('[board] fetchWorkItems error', e); }
    }

    function buildGanttTasks(items){ const startDates=(items||[]).map(i=> fmtDate(getPlannedStartStr(i))).filter(Boolean); const endDates=(items||[]).map(i=> fmtDate(getPlannedEndStr(i))).filter(Boolean);
      const now=new Date(); const clampMin=new Date(now.getFullYear(), now.getMonth()-6, 1); const clampMax=new Date(now.getFullYear(), now.getMonth()+7, 0);
      if(startDates.length||endDates.length){ const minStart = startDates.length ? new Date(Math.min.apply(null, startDates.map(d=>d.getTime()))) : null; const maxEnd = endDates.length ? new Date(Math.max.apply(null, endDates.map(d=>d.getTime()))) : null; state.startDate = minStart ? new Date(Math.max(minStart.getTime(), clampMin.getTime())) : clampMin; state.endDate = maxEnd ? new Date(Math.min(maxEnd.getTime(), clampMax.getTime())) : clampMax; } else { state.startDate=clampMin; state.endDate=clampMax; }
      state.totalDays = Math.ceil((state.endDate - state.startDate)/(1000*60*60*24)) + 1;
      const ganttTasks=[]; const included=new Set();
      const parents=(items||[]).filter(i=> (i.kind==='JOB') || (Array.isArray(i.subtasks)&&i.subtasks.length>0) || !(i.parent_id||i.parentId||i.parent||i.parent_code||i.parentCode));
      parents.forEach(p=>{ const pS=fmtDate(getPlannedStartStr(p)), pE=fmtDate(getPlannedEndStr(p)); const pStartDay=pS? Math.max(0, Math.floor((pS - state.startDate)/(1000*60*60*24))) : 0; const pDur=(pS&&pE)? Math.max(1, Math.ceil((pE - pS)/(1000*60*60*24))+1) : 1; let kids=(state.items||[]).filter(t=> t.kind==='TASK' && (t.parent_id===p.id || t.parentId===p.id || t.parent_code===p.code || t.parentCode===p.code || t.parent===p.code)); if((!kids||kids.length===0) && Array.isArray(p.subtasks)) kids=p.subtasks; const mappedKids = (kids||[]).map(t=>{ const s=fmtDate(getPlannedStartStr(t)), e=fmtDate(getPlannedEndStr(t)); const sd=s? Math.max(0, Math.floor((s - state.startDate)/(1000*60*60*24))) : 0; const du=(s&&e)? Math.max(1, Math.ceil((e - s)/(1000*60*60*24))+1) : 1; const kidId=t.id||t.code; included.add(kidId); return { id:kidId, name:(t.title||t.code||'-'), startDay:sd, duration:du, color:colorForStatus(t.status), assignee:assigneeDisplay(t.assignee||''), description:(t.title||t.code||'-') }; });
        ganttTasks.push({ id:p.id||p.code, name:(p.title||p.code||'-'), category:'', startDay:pStartDay, duration:pDur, color:colorForStatus(p.status), assignee:assigneeDisplay(p.assignee||''), description:(p.title||p.code||'-'), type:'parent', subtasks:mappedKids });
      });
      const orphans=(items||[]).filter(t=> t.kind==='TASK').filter(t=>{ const tid=t.id||t.code; return !included.has(tid); });
      if(orphans.length){ const mapped=orphans.map(t=>{ const s=fmtDate(getPlannedStartStr(t)), e=fmtDate(getPlannedEndStr(t)); const sd=s? Math.max(0, Math.floor((s - state.startDate)/(1000*60*60*24))) : 0; const du=(s&&e)? Math.max(1, Math.ceil((e - s)/(1000*60*60*24))+1) : 1; return { id:t.id||t.code, name:(t.title||t.code||'-'), startDay:sd, duration:du, color:colorForStatus(t.status), assignee:assigneeDisplay(t.assignee||''), description:(t.title||t.code||'-') }; }); ganttTasks.push({ id:'__orphans__', name:'未归属任务', category:'', startDay:0, duration:1, color:'var(--text-secondary)', assignee:'', description:'未归属任务', type:'parent', subtasks:mapped }); }
      state.ganttTasks=ganttTasks;
    }

    function generateTimeColumns(){ state.timeColumns=[]; if(state.timeMode==='day'){ let d=new Date(state.startDate.getTime()); for(let day=0; day<state.totalDays; day++){ state.timeColumns.push({ id:`day-${day}`, label:`${d.getMonth()+1}/${d.getDate()}`, date:new Date(d.getTime()), type:'day', width:state.columnWidth }); d.setDate(d.getDate()+1); } } else { const sy=state.startDate.getFullYear(), sm=state.startDate.getMonth(), ey=state.endDate.getFullYear(), em=state.endDate.getMonth(); let cur=new Date(sy,sm,1), tgt=new Date(ey,em,1); while(cur<=tgt){ const y=cur.getFullYear(), m=cur.getMonth()+1, days=new Date(y, cur.getMonth()+1, 0).getDate(); state.timeColumns.push({ id:`month-${y}-${m}`, label:`${m}月`, year:y, month:m, days, type:'month', width:state.columnWidth }); cur.setMonth(cur.getMonth()+1); } } }

    function renderAll(){ renderTimeHeader(); renderTaskList(); renderTimeline(); renderAssigneeList(); }

    function renderTimeHeader(){ const yearRow=document.getElementById('yearRow'); const monthRow=document.getElementById('monthRow'); const dayRow=document.getElementById('dayRow'); const timeline=document.getElementById('timeline'); yearRow.innerHTML=''; monthRow.innerHTML=''; dayRow.innerHTML=''; const totalWidth=state.timeColumns.length*state.columnWidth; [timeline,yearRow,monthRow].forEach(el=>{ if(el){ el.style.width=totalWidth+'px'; } }); if(state.timeMode==='day'){ dayRow.style.display='flex'; const monthGroups={}; state.timeColumns.forEach(col=>{ const d=col.date; const ym=`${d.getFullYear()}-${d.getMonth()+1}`; if(!monthGroups[ym]) monthGroups[ym]={ year:d.getFullYear(), month:d.getMonth()+1, count:0 }; monthGroups[ym].count++; }); const yearGroups={}; Object.values(monthGroups).forEach(m=>{ if(!yearGroups[m.year]) yearGroups[m.year]=0; yearGroups[m.year]+=m.count; }); Object.keys(yearGroups).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{ const div=document.createElement('div'); div.className='year-cell'; div.style.width=(yearGroups[y]*state.columnWidth)+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=y+'年'; yearRow.appendChild(div); }); Object.keys(monthGroups).sort((a,b)=>{ const [ya,ma]=a.split('-').map(Number); const [yb,mb]=b.split('-').map(Number); return ya!==yb?ya-yb:ma-mb; }).forEach(key=>{ const m=monthGroups[key]; const div=document.createElement('div'); div.className='month-cell'; div.style.width=(m.count*state.columnWidth)+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=`${m.month}月`; monthRow.appendChild(div); }); state.timeColumns.forEach(col=>{ const div=document.createElement('div'); div.className='day-cell'; div.style.width=state.columnWidth+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=col.date.getDate(); dayRow.appendChild(div); }); } else { dayRow.style.display='none'; const years={}; state.timeColumns.forEach((col,idx)=>{ if(!years[col.year]) years[col.year]=0; years[col.year]+=col.width; }); Object.keys(years).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(y=>{ const div=document.createElement('div'); div.className='year-cell'; div.style.width=years[y]+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=y+'年'; yearRow.appendChild(div); }); state.timeColumns.forEach(col=>{ const div=document.createElement('div'); div.className='month-cell'; div.style.width=col.width+'px'; div.style.minWidth=div.style.width; div.style.flexShrink='0'; div.textContent=col.label; monthRow.appendChild(div); }); } }

    function renderAssigneeList(){ const list=document.getElementById('assigneeList'); list.innerHTML=''; (state.ganttTasks||[]).forEach((task)=>{ const parent=document.createElement('div'); parent.className='assignee-row'; parent.innerHTML=`<div class="assignee-avatar">${task.assignee.slice(0,1)}</div><div class="assignee-name">${task.assignee}</div>`; list.appendChild(parent); (task.subtasks||[]).forEach(st=>{ const div=document.createElement('div'); div.className='assignee-row'; div.innerHTML=`<div class="assignee-avatar">${st.assignee.slice(0,1)}</div><div class="assignee-name">${st.assignee}</div>`; list.appendChild(div); }); }); }

    function renderTaskList(){ const taskList=document.getElementById('taskList'); taskList.innerHTML=''; (state.ganttTasks||[]).forEach((task)=>{ const parent=document.createElement('div'); parent.className='task-row parent-task'; parent.innerHTML=`<div class="task-name"><div class="task-title">${task.name}</div></div>`; taskList.appendChild(parent); (task.subtasks||[]).forEach(st=>{ const div=document.createElement('div'); div.className='task-row subtask'; div.innerHTML=`<div class="task-name"><div class="task-title">${st.name}</div></div>`; taskList.appendChild(div); }); }); }

    function renderTimeline(){ const tl=document.getElementById('timeline'); tl.innerHTML=''; (state.ganttTasks||[]).forEach((task, ti)=>{ const row=document.createElement('div'); row.className='task-row-timeline'; row.appendChild(createTaskBar(task, ti, -1)); tl.appendChild(row); (task.subtasks||[]).forEach((st, si)=>{ const sub=document.createElement('div'); sub.className='task-row-timeline'; sub.appendChild(createTaskBar(st, ti, si)); tl.appendChild(sub); }); }); }

    function dayOffsetToMonthIndex(dayOffset){ const d=new Date(state.startDate.getTime()); d.setDate(d.getDate()+Math.max(0, dayOffset||0)); const yearDiff=d.getFullYear()-state.startDate.getFullYear(); const monthDiff=d.getMonth()-state.startDate.getMonth(); let idx=yearDiff*12+monthDiff; idx=Math.max(0, Math.min(idx, (state.timeColumns||[]).length-1)); return idx; }

    function createTaskBar(task, ti, si){ const bar=document.createElement('div'); bar.className='task-bar'; let left,width; if(state.timeMode==='day'){ left=(task.startDay||0)*state.columnWidth; width=Math.max((task.duration||1)*state.columnWidth,60); } else { const sIdx=dayOffsetToMonthIndex(task.startDay||0); const eIdx=dayOffsetToMonthIndex((task.startDay||0)+(task.duration||1)-1); left=sIdx*state.columnWidth; width=Math.max(((eIdx - sIdx + 1) * state.columnWidth),60); } bar.style.left=left+'px'; bar.style.width=width+'px'; bar.style.backgroundColor=task.color||'var(--primary)'; bar.innerHTML = `<div class="resize-handle left"></div><span style="padding:0 6px;">${task.description||task.name}</span><div class="resize-handle right"></div>`; return bar; }

    function renderKanban(byStatus){ ['todo','doing','done'].forEach(s=>{ const el=document.getElementById(s); el.innerHTML=''; (byStatus[s]||[]).forEach(item=>{ const card=document.createElement('div'); card.className='card'; card.draggable=true; card.dataset.id=item.id; card.dataset.status=s; card.innerHTML=`<div class="card-header"><span class="code">${item.code}</span><span class="assignee">${item.assignee||''}</span></div><div class="title-line">${item.title||item.name||item.code}</div><div class="meta"><span>${(item.planned_end||'').slice(5)}截止</span></div><div class="status-dot status-${s}"></div>`; el.appendChild(card); }); }); }

    function enableDnD(){ const cards=document.querySelectorAll('.card[draggable="true"]'); const lists=document.querySelectorAll('.kanban-list');
      cards.forEach(c=>{ c.addEventListener('dragstart', ()=>{ c.classList.add('dragging'); }); c.addEventListener('dragend', ()=>{ c.classList.remove('dragging'); lists.forEach(l=>l.classList.remove('drop-active')); }); });
      lists.forEach(l=>{ l.addEventListener('dragover', e=>{ e.preventDefault(); const afterElement=getDragAfterElement(l, e.clientY); const dragging=document.querySelector('.dragging'); if(dragging){ if(afterElement==null){ l.appendChild(dragging); } else { l.insertBefore(dragging, afterElement); } l.classList.add('drop-active'); } }); l.addEventListener('dragleave', ()=>{ l.classList.remove('drop-active'); }); l.addEventListener('drop', async (e)=>{ e.preventDefault(); const dragging=document.querySelector('.dragging'); if(!dragging) return; const newStatus=l.id; const id=dragging.dataset.id; if(dragging.dataset.status!==newStatus){ dragging.dataset.status=newStatus; showToast(`Moved to ${newStatus}`); try{ await fetch(`${API}/work-items/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ status: newStatus }) }); }catch(_){} } }); });
    }
    function getDragAfterElement(container, y){ const draggableElements=[...container.querySelectorAll('.card:not(.dragging)')]; return draggableElements.reduce((closest, child)=>{ const box=child.getBoundingClientRect(); const offset=y - box.top - box.height / 2; if(offset < 0 && offset > closest.offset){ return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }

    document.getElementById('zoomIn').onclick=()=>applyZoom(10);
    document.getElementById('zoomOut').onclick=()=>applyZoom(-10);
    document.getElementById('modeDay').onclick=()=>switchMode('day');
    document.getElementById('modeMonth').onclick=()=>switchMode('month');

    initViewToggle();
    fetchWorkItems();
  </script>
</body>
</html>
