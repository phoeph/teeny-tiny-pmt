<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>项目列表 - 项目管理系统</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <style>
    /* Page specific overrides if needed */
  </style>
</head>
<body>
  <div id="left-sidebar"></div>
  <div class="header">
    <h2 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-main);">项目列表</h2>
    <div id="headerRight" style="display:flex; align-items:center; gap:12px;">
      <div class="view-toggle">
        <button id="btnCard" class="toggle-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          卡片
        </button>
        <button id="btnList" class="toggle-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
          列表
        </button>
      </div>
      <button id="btnCreateProject" class="btn-primary">新建项目</button>
    </div>
  </div>
  <div id="list"></div>

  <div id="projectCreateBackdrop" class="modal-backdrop">
    <div class="modal">
      <h4>新建项目</h4>
      <div class="row"><label>项目名称</label><input id="projNameInput" placeholder="例如 官网改版 2026Q1" /></div>
      <div class="row"><label>项目描述</label><textarea id="projDescInput" placeholder="例如 项目背景与目标" style="min-height:120px; resize:vertical; padding:8px; border:1px solid var(--border-color); border-radius:6px; width:100%; font-family:inherit; color: var(--text-main); background: var(--bg-input);"></textarea></div>
      <div class="row"><label>负责人</label><input id="projOwnerInput" placeholder="输入邮箱或前缀，例如 zhangsan" /></div>
      <div id="projError" style="color:var(--danger); font-size:12px; margin-top:8px;"></div>
      <div class="actions"><button id="projCancelBtn" class="btn-ghost">取消</button><button id="projCreateBtn" class="btn-primary">创建</button></div>
    </div>
  </div>

  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
  <script src="assets/header-user-menu.js"></script>
  <script src="assets/left-sidebar.js"></script>
  <script>
    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';

    let viewMode = localStorage.getItem('projectsViewMode') || 'card';
    let projectsData = null;

    function applyViewMode(mode) {
      viewMode = mode;
      localStorage.setItem('projectsViewMode', mode);
      document.getElementById('btnCard').classList.toggle('active', mode === 'card');
      document.getElementById('btnList').classList.toggle('active', mode === 'list');
      renderProjects();
    }

    function renderProjects() {
      const container = document.getElementById('list');
      container.className = viewMode === 'card' ? 'card-grid' : 'list-view';
      container.innerHTML = '';
      if (!projectsData) return;
      projectsData.forEach(p => {
        const el = document.createElement('div');
        if (viewMode === 'card') {
          el.className = 'card project-card';
          el.innerHTML = `<div class="code">${p.code}</div><div class="name">${p.name}</div>`;
          el.onclick = () => location.href = `project?id=${p.id}`;
        } else {
          el.className = 'list-item';
          el.innerHTML = `<div class="code">${p.code}</div><div class="name">${p.name}</div>`;
          el.onclick = () => location.href = `project?id=${p.id}`;
        }
        container.appendChild(el);
      });
    }

    async function fetchProjects() {
      try {
        const res = await fetch(`${API}/projects`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error('backend unavailable');
        const data = await res.json();
        projectsData = data.items;
      } catch (e) {
        projectsData = [
          { id: 1, code: 'PRO-0001', name: '官网改版 2025Q4' },
          { id: 2, code: 'PRO-0002', name: '移动App 1.2发布（演示）' }
        ];
      } finally {
        renderProjects();
      }
    }

    async function fetchOwners(){ try{ const r=await fetch(`${API}/users`, { headers:{ Authorization:`Bearer ${token}` } }); if(r.ok){ const list=await r.json(); window.__assigneesIndex = Array.isArray(list)? list.map(function(u){ return { name: u.full_name || u.username || u.email_prefix, prefix: u.email_prefix || u.username || '', email: u.email || '' }; }) : []; } else { window.__assigneesIndex = []; } }catch(_){ window.__assigneesIndex = []; } }
    function getOwners(){ const a = (window.__assigneesIndex && Array.isArray(window.__assigneesIndex))? window.__assigneesIndex.slice() : []; return a; }
    function showOwnerDropdown(input, q){ let el=document.getElementById('ownerDropdown'); if(!el){ el=document.createElement('div'); el.id='ownerDropdown'; el.className='dropdown'; document.body.appendChild(el); } const rect=input.getBoundingClientRect(); const list=getOwners(); const query=String(q||'').toLowerCase(); const filtered = query? list.filter(function(u){ return String(u.name||'').toLowerCase().includes(query) || String(u.prefix||'').toLowerCase().includes(query) || String(u.email||'').toLowerCase().includes(query); }) : list.slice(); el.style.display='block'; el.style.left=(rect.left + window.scrollX) + 'px'; el.style.top=(rect.bottom + window.scrollY + 6) + 'px'; el.style.width=rect.width + 'px'; el.innerHTML = filtered.map(function(u){ const tip=u.prefix||u.email||''; const pref = u.prefix||''; return '<div class="dropdown-item" title="'+tip+'" data-name="'+(u.name||pref)+'" data-prefix="'+pref+'" data-email="'+(u.email||'')+'">'+(u.name||pref)+'</div>'; }).join(''); el.querySelectorAll('.dropdown-item').forEach(function(it){ it.onclick=function(){ input.value=this.getAttribute('data-name')||''; input.dataset.prefix=this.getAttribute('data-prefix')||''; input.dataset.email=this.getAttribute('data-email')||''; hideOwnerDropdown(); }; }); el.onmousedown=function(e){ e.preventDefault(); };
      document.addEventListener('mousedown', function onDoc(e){ const inside=e.target===el || el.contains(e.target) || e.target===input; if(!inside){ hideOwnerDropdown(); document.removeEventListener('mousedown', onDoc); } }); }
    function hideOwnerDropdown(){ const el=document.getElementById('ownerDropdown'); if(el) el.style.display='none'; }
    function enableOwnerDropdown(inputId){ const input=document.getElementById(inputId); if(!input) return; input.addEventListener('focus', function(){ showOwnerDropdown(input, input.value); }); input.addEventListener('input', function(){ showOwnerDropdown(input, input.value); }); input.addEventListener('blur', function(){ setTimeout(hideOwnerDropdown, 120); }); }

    function openCreateProjectModal(){ const b=document.getElementById('projectCreateBackdrop'); const name=document.getElementById('projNameInput'); const desc=document.getElementById('projDescInput'); const owner=document.getElementById('projOwnerInput'); const err=document.getElementById('projError'); if(b){ b.style.display='flex'; } if(name){ name.value=''; } if(desc){ desc.value=''; } if(owner){ owner.value=''; } if(err){ err.textContent=''; } }
    function closeCreateProjectModal(){ const b=document.getElementById('projectCreateBackdrop'); if(b){ b.style.display='none'; } }
    async function createProject(){ const name=document.getElementById('projNameInput').value.trim(); const desc=document.getElementById('projDescInput').value.trim(); const owner=document.getElementById('projOwnerInput').value.trim(); const err=document.getElementById('projError'); err.textContent=''; if(!name){ err.textContent='请输入项目名称'; return; } try{ const res=await fetch(`${API}/projects/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ name, description: desc||undefined }) }); if(res.ok){ const p=await res.json(); const pid=p && p.id; if(owner && pid){ try{ const isEmail = owner.indexOf('@')>0; const body = isEmail? { owner_email: owner } : { owner_prefix: owner }; await fetch(`${API}/projects/${pid}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(body) }); }catch(_){ } } closeCreateProjectModal(); if(pid){ location.href = `project?id=${pid}`; } else { await fetchProjects(); } } else { try{ const txt=await res.text(); err.textContent = (txt||'创建失败'); }catch(_){ err.textContent='创建失败'; } } } catch(e){ err.textContent='网络错误'; } }

    document.getElementById('btnCard').addEventListener('click', () => applyViewMode('card'));
    document.getElementById('btnList').addEventListener('click', () => applyViewMode('list'));
    document.getElementById('btnCreateProject').addEventListener('click', openCreateProjectModal);
    document.getElementById('projCancelBtn').addEventListener('click', closeCreateProjectModal);
    document.getElementById('projCreateBtn').addEventListener('click', createProject);
    setTimeout(function(){ try{ var right=document.getElementById('headerRight'); var um=document.getElementById('userMenuContainer'); if(right && um){ right.appendChild(um); } }catch(_){ } }, 0);
    fetchOwners().then(function(){ enableOwnerDropdown('projOwnerInput'); });
    applyViewMode(viewMode);
    fetchProjects();
  </script>
</body>
</html>
