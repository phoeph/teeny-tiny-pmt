<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡¹ç›®åˆ—è¡¨ - é¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <style>
    /* Page Header Enhancement */
    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .page-title h2 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      color: var(--text-main);
      letter-spacing: -0.02em;
    }
    .page-title .count-badge {
      background: var(--primary-light);
      color: var(--primary);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    /* Card Actions */
    .card-actions { 
      position: absolute; 
      top: 14px; 
      right: 14px; 
      z-index: 10; 
      opacity: 0; 
      transition: all 0.2s ease; 
    }
    .project-card:hover .card-actions, .list-item:hover .card-actions { opacity: 1; }
    .action-btn { 
      background: rgba(255,255,255,0.95); 
      border: 1px solid var(--border-color); 
      padding: 6px; 
      cursor: pointer; 
      border-radius: 8px; 
      color: var(--text-secondary); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      width: 30px; 
      height: 30px;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    .action-btn:hover { 
      background: var(--bg-surface); 
      color: var(--primary); 
      border-color: var(--primary);
      box-shadow: var(--shadow-md); 
    }
    .card-dropdown { 
      position: absolute; 
      top: 100%; 
      right: 0; 
      background: var(--bg-surface); 
      border: 1px solid var(--border-color); 
      border-radius: 12px; 
      box-shadow: var(--shadow-xl); 
      min-width: 160px; 
      display: none; 
      z-index: 20; 
      padding: 6px; 
      margin-top: 6px;
      animation: dropdownFade 0.15s ease;
    }
    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card-dropdown.show { display: block; }
    .card-dropdown-item { 
      padding: 10px 14px; 
      font-size: 13px; 
      font-weight: 500;
      color: var(--text-main); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      border-radius: 8px;
      transition: all 0.15s ease;
    }
    .card-dropdown-item:hover { background: var(--bg-hover); }
    .card-dropdown-item.danger { color: var(--danger); }
    .card-dropdown-item.danger:hover { background: var(--danger-light); }
    
    /* Project Card - Premium Design */
    .project-card { 
      position: relative; 
      background: var(--bg-surface); 
      border: 1px solid var(--border-color); 
      box-shadow: var(--shadow-sm); 
      border-radius: 16px; 
      padding: 20px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%; 
      min-height: 160px;
      justify-content: space-between;
      overflow: hidden;
      cursor: pointer;
    }
    .project-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .project-card:hover { 
      transform: translateY(-6px); 
      box-shadow: var(--shadow-lg), 0 0 0 1px var(--primary-light); 
      border-color: transparent;
    }
    .project-card:hover::before {
      opacity: 1;
    }
    
    .project-card .code {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }
    .project-card .name {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.4;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      letter-spacing: -0.01em;
    }
    .project-card .description {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .project-card .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      font-size: 12px;
      color: var(--text-muted);
      border-top: 1px solid var(--border-light);
      padding-top: 12px;
    }
    
    .card-grid { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 24px;
      padding-bottom: 32px; 
    }
    
    @media (max-width: 1400px) {
      .card-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 1000px) {
      .card-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; }
    }
    
    /* List View */
    .list-item { 
      position: relative; 
      padding: 16px 60px 16px 20px; 
      border: 1px solid var(--border-color); 
      border-radius: 14px; 
      margin-bottom: 12px; 
      background: var(--bg-surface); 
      transition: all 0.2s ease;
      cursor: pointer;
    } 
    .list-item:hover { 
      border-color: var(--primary); 
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }
    .list-item .card-actions { top: 50%; transform: translateY(-50%); right: 16px; }

    /* Pagination */
    .pagination { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 12px; 
      margin-top: 32px; 
      padding-bottom: 48px; 
    }
    .page-info { 
      font-size: 14px; 
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0 16px;
    }
    .page-btn { 
      padding: 10px 18px; 
      border: 1.5px solid var(--border-color); 
      background: var(--bg-surface); 
      border-radius: 10px; 
      cursor: pointer; 
      color: var(--text-main); 
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-btn:hover:not(:disabled) { 
      background: var(--primary-light); 
      border-color: var(--primary);
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div id="left-sidebar"></div>
  <div class="header">
    <div class="page-title">
      <h2>é¡¹ç›®åˆ—è¡¨</h2>
      <span class="count-badge" id="projectCount">0 ä¸ªé¡¹ç›®</span>
    </div>
    <div id="headerRight" style="display:flex; align-items:center; gap:12px;">
      <div class="view-toggle">
        <button id="btnCard" class="toggle-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          å¡ç‰‡
        </button>
        <button id="btnList" class="toggle-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
          åˆ—è¡¨
        </button>
      </div>
      <button id="btnCreateProject" class="btn-primary">æ–°å»ºé¡¹ç›®</button>
    </div>
  </div>
  <div id="list"></div>
  <div class="pagination" id="pagination">
    <button class="page-btn" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
    <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ</span>
    <button class="page-btn" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
  </div>

  <div id="projectCreateBackdrop" class="modal-backdrop">
    <div class="modal">
      <h4>æ–°å»ºé¡¹ç›®</h4>
      <div class="row"><label>é¡¹ç›®åç§°</label><input id="projNameInput" placeholder="ä¾‹å¦‚ å®˜ç½‘æ”¹ç‰ˆ 2026Q1" /></div>
      <div class="row"><label>é¡¹ç›®æè¿°</label><textarea id="projDescInput" placeholder="ä¾‹å¦‚ é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡" style="min-height:120px; resize:vertical; padding:8px; border:1px solid var(--border-color); border-radius:6px; width:100%; font-family:inherit; color: var(--text-main); background: var(--bg-input);"></textarea></div>
      <div class="row"><label>è´Ÿè´£äºº</label><input id="projOwnerInput" placeholder="è¾“å…¥é‚®ç®±æˆ–å‰ç¼€ï¼Œä¾‹å¦‚ zhangsan" /></div>
      <div id="projError" style="color:var(--danger); font-size:12px; margin-top:8px;"></div>
      <div class="actions"><button id="projCancelBtn" class="btn-ghost">å–æ¶ˆ</button><button id="projCreateBtn" class="btn-primary">åˆ›å»º</button></div>
    </div>
  </div>

  <div id="deleteConfirmBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 400px;">
      <h4 style="color:var(--danger)">åˆ é™¤é¡¹ç›®</h4>
      <p style="margin-bottom:24px; color:var(--text-secondary)">ç¡®å®šè¦åˆ é™¤é¡¹ç›® <strong id="deleteProjName" style="color:var(--text-main)"></strong> å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
      <div class="actions">
        <button id="deleteCancelBtn" class="btn-ghost">å–æ¶ˆ</button>
        <button id="deleteConfirmBtn" class="btn-primary" style="background-color:var(--danger)">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
  <script src="assets/header-user-menu.js"></script>
  <script src="assets/left-sidebar.js"></script>
  <script>
    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'login.html';

    let viewMode = localStorage.getItem('projectsViewMode') || 'card';
    let projectsData = null;
    let currentUser = null;
    let currentPage = 1;
    let pageSize = 20;
    let totalItems = 0;

    async function fetchCurrentUser() {
      try {
        const r = await fetch(`${API}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
        if (r.ok) {
           const raw = await r.json();
           currentUser = (raw && raw.user) ? raw.user : raw;
        }
      } catch (e) { console.error(e); }
    }

    function applyViewMode(mode) {
      viewMode = mode;
      localStorage.setItem('projectsViewMode', mode);
      document.getElementById('btnCard').classList.toggle('active', mode === 'card');
      document.getElementById('btnList').classList.toggle('active', mode === 'list');
      renderProjects();
    }

    function renderProjects() {
      const container = document.getElementById('list');
      container.className = viewMode === 'card' ? 'card-grid' : 'list-view';
      container.innerHTML = '';
      if (!projectsData) return;
      
      const isAdmin = currentUser && currentUser.username === 'admin';

      projectsData.forEach(p => {
        console.log('ğŸ”§ åˆ›å»ºé¡¹ç›®å¡ç‰‡:', p.name, 'ID:', p.id);
        const el = document.createElement('div');
        
        let html = '';
        if (viewMode === 'card') {
          el.className = 'card project-card';
          html = `
            <div>
              <div class="code">${p.code}</div>
              <div class="name">${p.name}</div>
              <div class="description" title="${p.description || ''}">${p.description || ''}</div>
            </div>
            <div class="meta">
              <div style="display:flex; align-items:center; gap:6px;">
                 <span style="width:8px; height:8px; border-radius:50%; background:${p.status==='active'?'var(--success)':'var(--text-secondary)'};"></span>
                 ${p.status==='active'?'è¿›è¡Œä¸­':'å·²å½’æ¡£'}
              </div>
              <div>${(p.created_at||'').substring(0,10)}</div>
            </div>
          `;
        } else {
          el.className = 'list-item';
          html = `
            <div style="flex:1; display:flex; align-items:center; gap:24px;">
              <div class="code" style="width:100px; font-family:monospace; font-weight:600;">${p.code}</div>
              <div class="name" style="width:200px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.name}</div>
              <div class="description" style="flex:1; color:var(--text-secondary); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${p.description || ''}">${p.description || ''}</div>
              <div style="width:100px; color:var(--text-secondary); font-size:13px;">${(p.created_at||'').substring(0,10)}</div>
              <div style="width:80px; display:flex; align-items:center; gap:6px; font-size:13px;">
                <span style="width:6px; height:6px; border-radius:50%; background:${p.status==='active'?'var(--success)':'var(--text-secondary)'};"></span>
                ${p.status==='active'?'è¿›è¡Œä¸­':'å·²å½’æ¡£'}
              </div>
            </div>
          `;
        }

        if (isAdmin) {
            html += `
            <div class="card-actions" onclick="event.stopPropagation()">
              <button class="action-btn" onclick="toggleCardMenu(this, ${p.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
              </button>
              <div class="card-dropdown" id="menu-${p.id}">
                <div class="card-dropdown-item danger" onclick="confirmDeleteProject(${p.id}, '${p.name.replace(/'/g, "\\'")}')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  åˆ é™¤é¡¹ç›®
                </div>
              </div>
            </div>`;
        }
        el.innerHTML = html;
        
        // Add debugging for click events
        el.addEventListener('click', (e) => {
           console.log('ğŸ–±ï¸ ç‚¹å‡»äº‹ä»¶è§¦å‘!');
           console.log('ğŸ–±ï¸ äº‹ä»¶ç›®æ ‡:', e.target);
           console.log('ğŸ–±ï¸ å½“å‰å…ƒç´ :', e.currentTarget);
           console.log('ğŸ–±ï¸ ç‚¹å‡»é¡¹ç›®:', p);
           console.log('ğŸ”— é¡¹ç›®ID:', p.id, 'ç±»å‹:', typeof p.id);
           
           // Stop propagation to prevent any parent handlers
           e.stopPropagation();
           
           // Check if clicking on action buttons
           if (e.target.closest('.card-actions') || e.target.closest('.action-btn') || e.target.closest('.card-dropdown')) {
             console.log('ğŸ–±ï¸ ç‚¹å‡»äº†æ“ä½œæŒ‰é’®ï¼Œé˜»æ­¢è·³è½¬');
             return;
           }
           
           const targetUrl = `project.html?id=${p.id}`;
           console.log('ğŸ”— å‡†å¤‡è·³è½¬åˆ°:', targetUrl);
           
           // Use window.location.href without leading slash to avoid URL rewriting issues
           window.location.href = targetUrl;
        });
        
        // Remove the old onclick handler to avoid conflicts
        el.onclick = null;
        
        container.appendChild(el);
        console.log('âœ… é¡¹ç›®å¡ç‰‡å·²æ·»åŠ åˆ°å®¹å™¨:', p.name);
      });
      
      console.log('ğŸ“Š æ¸²æŸ“å®Œæˆï¼Œæ€»å…±', projectsData.length, 'ä¸ªé¡¹ç›®å¡ç‰‡');
      console.log('ğŸ–±ï¸ å®¹å™¨ä¸­çš„å¡ç‰‡æ•°é‡:', container.children.length);
      
      updatePaginationUI();
    }

    function updatePaginationUI() {
      const totalPages = Math.ceil(totalItems / pageSize) || 1;
      document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ Â· å…± ${totalItems} ä¸ªé¡¹ç›®`;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }
    
    document.getElementById('prevPageBtn').onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        fetchProjects();
      }
    };
    
    document.getElementById('nextPageBtn').onclick = () => {
      const totalPages = Math.ceil(totalItems / pageSize) || 1;
      if (currentPage < totalPages) {
        currentPage++;
        fetchProjects();
      }
    };

    // Menu logic
    window.toggleCardMenu = function(btn, pid) {
      const menu = document.getElementById(`menu-${pid}`);
      if (!menu) return;
      document.querySelectorAll('.card-dropdown').forEach(m => {
         if (m !== menu) m.classList.remove('show');
      });
      menu.classList.toggle('show');
    };
    
    document.addEventListener('click', (e) => {
       if (!e.target.closest('.card-actions')) {
         document.querySelectorAll('.card-dropdown').forEach(m => m.classList.remove('show'));
       }
    });

    // Delete Logic
    let projectToDelete = null;
    window.confirmDeleteProject = function(pid, pname) {
       projectToDelete = pid;
       document.getElementById('deleteProjName').textContent = pname;
       document.getElementById('deleteConfirmBackdrop').style.display = 'flex';
    };
    
    document.getElementById('deleteCancelBtn').onclick = () => {
       document.getElementById('deleteConfirmBackdrop').style.display = 'none';
       projectToDelete = null;
    };
    
    document.getElementById('deleteConfirmBtn').onclick = async () => {
       if (!projectToDelete) return;
       const btn = document.getElementById('deleteConfirmBtn');
       btn.disabled = true;
       btn.textContent = 'åˆ é™¤ä¸­...';
       try {
         const res = await fetch(`${API}/projects/${projectToDelete}`, { 
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` }
         });
         if (res.ok) {
            document.getElementById('deleteConfirmBackdrop').style.display = 'none';
            await fetchProjects();
         } else {
            alert('åˆ é™¤å¤±è´¥');
         }
       } catch (e) {
          alert('ç½‘ç»œé”™è¯¯');
       } finally {
          btn.disabled = false;
          btn.textContent = 'ç¡®è®¤åˆ é™¤';
          projectToDelete = null;
       }
    };

    async function fetchProjects() {
      if (!currentUser) await fetchCurrentUser();
      console.log('ğŸ” å¼€å§‹è·å–é¡¹ç›®æ•°æ®...');
      try {
        const url = `${API}/projects?page=${currentPage}&size=${pageSize}`;
        console.log('ğŸ“¡ APIè°ƒç”¨:', url);
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', res.status, res.statusText);
        
        if (!res.ok) {
          throw new Error(`APIè°ƒç”¨å¤±è´¥: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();
        console.log('ğŸ“¡ APIè¿”å›æ•°æ®:', data);
        projectsData = data.items || [];
        totalItems = data.total || 0;
        console.log('âœ… è·å–åˆ°çœŸå®é¡¹ç›®æ•°æ®:', projectsData.length, 'ä¸ªé¡¹ç›®');
        console.log('ğŸ“‹ é¡¹ç›®æ•°æ®è¯¦æƒ…:', projectsData);
      } catch (e) {
        console.error('âŒ é¡¹ç›®æ•°æ®è·å–å¤±è´¥:', e.message);
        projectsData = [];
        totalItems = 0;
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        showProjectsError(e.message);
      } finally {
        renderProjects();
        // Update project count badge
        const countBadge = document.getElementById('projectCount');
        if (countBadge) countBadge.textContent = totalItems + ' ä¸ªé¡¹ç›®';
      }
    }

    function showProjectsError(message) {
      const container = document.getElementById('projectsContainer');
      if (container) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.7;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <h3 style="margin: 0 0 8px 0; color: var(--text-main);">é¡¹ç›®æ•°æ®è·å–å¤±è´¥</h3>
            <p style="margin: 0 0 16px 0; color: var(--text-secondary);">${message}</p>
            <button onclick="fetchProjects()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">é‡æ–°è·å–æ•°æ®</button>
          </div>
        `;
      }
    }

    async function fetchOwners(){ try{ const r=await fetch(`${API}/users`, { headers:{ Authorization:`Bearer ${token}` } }); if(r.ok){ const list=await r.json(); window.__assigneesIndex = Array.isArray(list)? list.map(function(u){ return { name: u.full_name || u.username || u.email_prefix, prefix: u.email_prefix || u.username || '', email: u.email || '' }; }) : []; } else { window.__assigneesIndex = []; } }catch(_){ window.__assigneesIndex = []; } }
    function getOwners(){ const a = (window.__assigneesIndex && Array.isArray(window.__assigneesIndex))? window.__assigneesIndex.slice() : []; return a; }
    function showOwnerDropdown(input, q){ let el=document.getElementById('ownerDropdown'); if(!el){ el=document.createElement('div'); el.id='ownerDropdown'; el.className='dropdown'; document.body.appendChild(el); } const rect=input.getBoundingClientRect(); const list=getOwners(); const query=String(q||'').toLowerCase(); const filtered = query? list.filter(function(u){ return String(u.name||'').toLowerCase().includes(query) || String(u.prefix||'').toLowerCase().includes(query) || String(u.email||'').toLowerCase().includes(query); }) : list.slice(); el.style.display='block'; el.style.left=(rect.left + window.scrollX) + 'px'; el.style.top=(rect.bottom + window.scrollY + 6) + 'px'; el.style.width=rect.width + 'px'; el.innerHTML = filtered.map(function(u){ const tip=u.prefix||u.email||''; const pref = u.prefix||''; return '<div class="dropdown-item" title="'+tip+'" data-name="'+(u.name||pref)+'" data-prefix="'+pref+'" data-email="'+(u.email||'')+'">'+(u.name||pref)+'</div>'; }).join(''); el.querySelectorAll('.dropdown-item').forEach(function(it){ it.onclick=function(){ input.value=this.getAttribute('data-name')||''; input.dataset.prefix=this.getAttribute('data-prefix')||''; input.dataset.email=this.getAttribute('data-email')||''; hideOwnerDropdown(); }; }); el.onmousedown=function(e){ e.preventDefault(); };
      document.addEventListener('mousedown', function onDoc(e){ const inside=e.target===el || el.contains(e.target) || e.target===input; if(!inside){ hideOwnerDropdown(); document.removeEventListener('mousedown', onDoc); } }); }
    function hideOwnerDropdown(){ const el=document.getElementById('ownerDropdown'); if(el) el.style.display='none'; }
    function enableOwnerDropdown(inputId){ const input=document.getElementById(inputId); if(!input) return; input.addEventListener('focus', function(){ showOwnerDropdown(input, input.value); }); input.addEventListener('input', function(){ showOwnerDropdown(input, input.value); }); input.addEventListener('blur', function(){ setTimeout(hideOwnerDropdown, 120); }); }

    function openCreateProjectModal(){ const b=document.getElementById('projectCreateBackdrop'); const name=document.getElementById('projNameInput'); const desc=document.getElementById('projDescInput'); const owner=document.getElementById('projOwnerInput'); const err=document.getElementById('projError'); if(b){ b.style.display='flex'; } if(name){ name.value=''; } if(desc){ desc.value=''; } if(owner){ owner.value=''; } if(err){ err.textContent=''; } }
    function closeCreateProjectModal(){ const b=document.getElementById('projectCreateBackdrop'); if(b){ b.style.display='none'; } }
    async function createProject(){ const name=document.getElementById('projNameInput').value.trim(); const desc=document.getElementById('projDescInput').value.trim(); const owner=document.getElementById('projOwnerInput').value.trim(); const err=document.getElementById('projError'); err.textContent=''; if(!name){ err.textContent='è¯·è¾“å…¥é¡¹ç›®åç§°'; return; } try{ const res=await fetch(`${API}/projects/`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ name, description: desc||undefined }) }); if(res.ok){ const p=await res.json(); const pid=p && p.id; if(owner && pid){ try{ const isEmail = owner.indexOf('@')>0; const body = isEmail? { owner_email: owner } : { owner_prefix: owner }; await fetch(`${API}/projects/${pid}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(body) }); }catch(_){ } } closeCreateProjectModal(); if(pid){ location.href = `project.html?id=${pid}`; } else { await fetchProjects(); } } else { try{ const txt=await res.text(); err.textContent = (txt||'åˆ›å»ºå¤±è´¥'); }catch(_){ err.textContent='åˆ›å»ºå¤±è´¥'; } } } catch(e){ err.textContent='ç½‘ç»œé”™è¯¯'; } }

    document.getElementById('btnCard').addEventListener('click', () => applyViewMode('card'));
    document.getElementById('btnList').addEventListener('click', () => applyViewMode('list'));
    document.getElementById('btnCreateProject').addEventListener('click', openCreateProjectModal);
    document.getElementById('projCancelBtn').addEventListener('click', closeCreateProjectModal);
    document.getElementById('projCreateBtn').addEventListener('click', createProject);
    setTimeout(function(){ try{ var right=document.getElementById('headerRight'); var um=document.getElementById('userMenuContainer'); if(right && um){ right.appendChild(um); } }catch(_){ } }, 0);
    fetchOwners().then(function(){ enableOwnerDropdown('projOwnerInput'); });
    applyViewMode(viewMode);
    fetchProjects();
  </script>
</body>
</html>
