<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>任务详情 - 项目管理系统</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <link rel="stylesheet" href="assets/issue-layout.css" />
  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
</head>
<body>
  <div id="left-sidebar"></div>
  <div class="header" style="display:flex; align-items:center; margin-bottom: 16px;">
    <div class="header-left" style="display:flex; align-items:center; gap:12px;">
      <div id="breadcrumb" class="breadcrumb"></div>
    </div>
    <div class="header-center" style="flex:1; display:none;">
      <div id="taskHeader" style="font-weight:600;"></div>
    </div>
    <div class="header-right" style="display:flex; align-items:center; gap:12px;">
      <div id="userMenuContainer"></div>
    </div>
  </div>

  <div id="taskMeta"></div>

  <div class="jira-card" style="margin-top:24px; position:relative;">
    <h4 style="display:flex; align-items:center;">
      Description
      <span id="projDescMenu" class="desc-menu-btn" title="编辑" style="display:none; margin-left:auto;">
        <svg viewBox="0 0 24 24" width="18" height="18"><circle cx="5" cy="12" r="2" fill="var(--primary)"/><circle cx="12" cy="12" r="2" fill="var(--primary)"/><circle cx="19" cy="12" r="2" fill="var(--primary)"/></svg>
      </span>
    </h4>
    <div id="issueDescProject" class="jira-desc"></div>
    <div id="projDescEditor" style="margin-top:8px; display:none;"></div>
  </div>

  <div class="gantt" style="margin-top:24px;">
    <div class="jira-tabs" style="margin-top:8px;">
      <div class="jira-tab active" id="tabComments">Comments</div>
    </div>
    <div id="commentsPane">
      <div id="comments"></div>
      <div id="commentEditor" style="margin-top:12px;"></div>
      <div style="margin-top:8px;"><span id="commentError" style="color:var(--danger);"></span></div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="addCommentBtn" class="primary-btn">添加评论</button>
        <button id="cancelCommentBtn" class="ghost-btn" style="display:none;">取消</button>
      </div>
    </div>
  </div>

  <script src="assets/rich-editor.js"></script>
  <script src="assets/meta-panel.js"></script>
  <script src="assets/label-cascader-multi.js"></script>
  <script src="assets/page-history.js"></script>
  <script src="assets/header-user-menu.js"></script>
  <script src="assets/left-sidebar.js"></script>
  <script src="assets/ux-enhancements.js"></script>
  <script src="assets/comments.js"></script>
  
  <script>
    // Global scroll listener
    document.addEventListener('scroll', function(e) {
      const target = e.target;
      if (target.nodeType === 1) { 
        target.classList.add('is-scrolling');
        if (target._scrollTimeout) clearTimeout(target._scrollTimeout);
        target._scrollTimeout = setTimeout(() => {
          target.classList.remove('is-scrolling');
          target._scrollTimeout = null;
        }, 2000);
      }
    }, true);

    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    const params = new URLSearchParams(location.search);
    const codeParam = params.get('code');
    const projectParam = params.get('project');
    const projectId = parseInt(projectParam || '', 10);

    window.__pageHistoryKey = `task:${codeParam||''}`;
    PageHistory.init(window.__pageHistoryKey);
    
    function showToast(text, type) { 
      const el = document.createElement('div'); 
      el.className = `toast ${type}`; 
      el.textContent = text; 
      document.body.appendChild(el); 
      setTimeout(()=>{ el.remove(); }, 1800); 
    }
    
    async function __showErrorFromResponse(res){ let msg=''; try{ const ct=(res.headers && res.headers.get && res.headers.get('content-type'))||''; if(ct.indexOf('application/json')>=0){ const data=await res.json(); const detail=typeof data==='string'? data : (data && (data.detail || data.message || '')); msg=String(detail||'').trim(); } else { msg=String((await res.text())||'').trim(); } } catch (e) { msg=''; } showToast(msg||'操作失败','error'); }

    async function fetchTask(){
      let task = null;
      try {
        // Try to fetch by ID if numeric
        if (/^\d+$/.test(codeParam)) {
            const r = await fetch(`${API}/work-items/${codeParam}`, { headers: { Authorization: `Bearer ${token}` } });
            if (r.ok) task = await r.json();
        }
        // If not found or not numeric, try by code
        if (!task) {
            const r = await fetch(`${API}/work-items/by-code/${codeParam}`, { headers: { Authorization: `Bearer ${token}` } });
            if (r.ok) task = await r.json();
        }
      } catch(e) {
        console.error(e);
      }
      
      if(!task){ 
        document.getElementById('taskHeader').textContent = `${codeParam} 未找到`; 
        return; 
      }
      
      document.getElementById('taskHeader').textContent = `${task.code} · ${task.title || task.name || ''}`;
      document.title = `${task.code} · ${task.title || task.name || ''} - 项目管理系统`;
      const metaTarget = document.getElementById('taskMeta');
      
      // Add Breadcrumbs
      let bc = `<a href="projects.html">Projects</a> / ${task.code}`;
      let projectCode = '';
      let rawProject = null;
      try {
        if (projectId) {
            const pr=await fetch(`${API}/projects/${projectId}`, { headers:{ Authorization:`Bearer ${token}` } }); 
            if(pr.ok){ 
                rawProject=await pr.json(); 
                projectCode = rawProject && rawProject.code ? rawProject.code : '';
            } 
        }
      }catch(_){ }
      
      const jobCode = params.get('job');
      if (projectCode) { 
          bc = `<a href="projects.html">Projects</a> / ${projectCode} / ${jobCode ? jobCode + ' / ' : ''}${task.code}`; 
      }
      
      try {
        const topBc = document.getElementById('breadcrumb');
        if (topBc) {
          const mid = projectCode ? `<a href="project.html?id=${projectId}">${projectCode}</a>` : '';
          const jobLink = jobCode ? `<a href="job.html?code=${jobCode}&project=${projectId}">${jobCode}</a>` : '';
          topBc.innerHTML = `<a href="projects.html">Projects</a><span class="sep">/</span>${mid ? mid + '<span class="sep">/</span>' : ''}${jobLink ? jobLink + '<span class="sep">/</span>' : ''}${task.code} · ${task.title || task.name || ''}`;
        }
      } catch (_) {}

      const entityObj = normalizeEntity('task', task, { project: { id: projectId } });
      if(rawProject && rawProject.priority){ entityObj.priority = rawProject.priority; }
      
      renderJiraIssueLayout(metaTarget, entityObj, { breadcrumb: bc, counter: '', linksHtml: '', project_id: projectId, rawProject: rawProject||null, rawItem: task, hideHeader: true });
      try{ setupLabelEditor(metaTarget, entityObj, { project_id: projectId, rawItem: task }); }catch(_){}
      
      const descEl=document.getElementById('issueDescProject'); 
      if(descEl) descEl.innerHTML = (task.description || '') || '暂无描述';
      
      // Description editor logic
      try{ 
        const meRes=await fetch(`${API}/auth/me`, { headers:{ Authorization:`Bearer ${token}` } }); 
        if(meRes.ok){ 
            const meRaw=await meRes.json(); 
            const me=(meRaw && meRaw.user) ? meRaw.user : meRaw; 
            window.__me = me; 
            window.__isAdmin = !!(me && (me.username==='admin')); 
            const canEdit = !!(me && ((me.username==='demo')||(me.username==='admin')||(me.id===task.creator_id))); 
            const menu=document.getElementById('projDescMenu'); 
            const editor=document.getElementById('projDescEditor'); 
            if(menu){ 
                menu.style.display = canEdit ? 'inline-flex' : 'none'; 
                menu.onclick=function(){ 
                    if(!canEdit) return; 
                    editor.style.display='block'; 
                    const view=document.getElementById('issueDescProject'); 
                    if(view) view.style.display='none'; 
                    const ed = createRichEditor('projDescEditor', { 
                        entityType: 'work_item', 
                        entityId: (task.id||0), 
                        saveText: '保存', 
                        onSave: async function(html){ 
                            try{ 
                                const wid=Number(task.id)||0; 
                                const res = await fetch(`${API}/work-items/${wid}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify({ description: html }) }); 
                                if(res.ok){ 
                                    const view=document.getElementById('issueDescProject'); 
                                    if(view){ view.innerHTML = html || '暂无描述'; view.style.display='block'; } 
                                    editor.style.display='none'; 
                                    showToast('描述已保存','success'); 
                                    return true; 
                                } else { 
                                    await __showErrorFromResponse(res); 
                                    return false; 
                                } 
                            } catch(e){ 
                                showToast('网络错误：' + (e && e.message ? e.message : ''), 'error'); 
                                return false; 
                            } 
                        } 
                    }); 
                    ed.setHTML(task.description || ''); 
                }; 
            } 
        } 
      }catch(_){ }
      
      window.__currentTaskId = task.id || null;
      if(window.__setupCommentsModule) window.__setupCommentsModule();
      if(window.__setupComments) window.__setupComments();
      await loadComments();
    }

    fetchTask();
    
    // Hash change handler for comments
    try{ const onHashChange=function(){ const h=(location.hash||'').trim(); const targetId = h && h.startsWith('#comment-') ? h.slice(1) : ''; if(targetId){ const target=document.getElementById(targetId); if(target){ target.scrollIntoView({ behavior:'smooth', block:'start' }); target.style.boxShadow='0 0 0 2px var(--primary) inset'; setTimeout(()=>{ target.style.boxShadow=''; }, 1500); } } }; window.addEventListener('hashchange', onHashChange); }catch(_){}

    function bindCommentTabs(){ const cTab=document.getElementById('tabComments'); const hTab=document.getElementById('tabHistory'); const cPane=document.getElementById('commentsPane'); const hPane=document.getElementById('historyPane'); if(cTab&&hTab){ cTab.onclick=function(){ cTab.classList.add('active'); hTab.classList.remove('active'); cPane.style.display='block'; hPane.style.display='none'; PageHistory.log('切换标签','Comments'); }; hTab.onclick=function(){ hTab.classList.add('active'); cTab.classList.remove('active'); cPane.style.display='none'; hPane.style.display='block'; PageHistory.renderTo('historyList'); PageHistory.log('切换标签','History'); }; } }
    window.__setupCommentsModule = function(){ var cm=CommentsModule.init({ entityType:'work_item', entityId:(window.__currentTaskId||0), selectors:{ listId:'comments', editorId:'commentEditor', addBtnId:'addCommentBtn', cancelBtnId:'cancelCommentBtn', errorId:'commentError', historyListId:'historyList' }, hooks:{ PageHistory: PageHistory } }); window.loadComments=cm.load; window.__disableLegacyTaskComments=true; bindCommentTabs(); };
    
    // Priority dropdown logic (copied from task.html)
    document.addEventListener('click', function(ev){ try{ var item = ev.target.closest('#priorityDropdown .dropdown-item'); if(!item) return; var p = item.getAttribute('data-p') || 'medium'; var link = document.getElementById('priorityEditLink'); var lab = document.getElementById('priorityLabel'); var color = (p==='low') ? 'var(--success)' : (p==='high' ? 'var(--danger)' : 'var(--warning)'); if(lab) { lab.textContent = (p==='low' ? 'Low' : (p==='high' ? 'High' : 'Medium')); } if(link){ var path = link.querySelector('path'); if(path){ path.setAttribute('fill', color); } } var menu = document.getElementById('priorityDropdown'); if(menu){ menu.style.width = '140px'; menu.style.minWidth = '120px'; } }catch(_){ } });
  </script>
</body>
</html>
