<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>甘特图项目管理工具 - 完整版</title>
    <script>
      if (location.pathname.endsWith('/') || location.pathname.endsWith('/index.html')) {
        location.replace('login.html');
      }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial','Microsoft YaHei',sans-serif; background-color: #f5f5f5; padding: 20px; }
        .gantt-chart { max-width: 1400px; margin: 0 auto; }
        .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border-radius:8px; }
        .page-header h1 { font-size:24px; font-weight:600; margin:0; }
        .header-actions { display:flex; align-items:center; gap:12px; }
        .gantt-container { background:#fff; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.1); overflow:hidden; position:relative; }
        .time-mode-toggle { display:inline-flex; background:#f0f2f5; border-radius:4px; overflow:hidden; }
        .time-mode-btn { padding:6px 12px; border:none; background:transparent; cursor:pointer; font-size:12px; color:#606266; transition:all .2s; }
        .time-mode-btn.active { background:#409eff; color:#fff; transform: translateY(-1px); transition: background-color .2s, color .2s, transform .2s; }
        .timeline-container { overflow-x:auto; overflow-y:hidden; position:relative; cursor: grab; }
        .timeline { position:relative; background:#fff; min-width:100%; }
        .gantt-header { display:flex; background:#f8f9fa; border-bottom:2px solid #e4e7ed; }
        .task-list-header,.assignee-header { height:120px; display:flex; align-items:center; justify-content:center; font-weight:600; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border-right:1px solid #e4e7ed; position:relative; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .task-list-header { width: clamp(140px, 16vw, 200px); }
        .assignee-header { width: clamp(100px, 12vw, 140px); border-left:1px solid #e4e7ed; border-right:1px solid #e4e7ed; }
        .time-header { flex:1; display:flex; flex-direction:column; position:relative; overflow-x:auto; overflow-y:hidden; cursor: grab; }
        .year-row,.month-row,.day-row { display:flex; height:40px; flex-wrap:nowrap; overflow:visible; min-width:100%; }
        .year-cell,.month-cell,.day-cell { display:flex; align-items:center; justify-content:center; border-right:1px solid #e4e7ed; font-weight:600; position:relative; flex-shrink:0; flex-grow:0; box-sizing:border-box; }
        .year-cell { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; font-size:14px; border-bottom:2px solid rgba(255,255,255,0.3); box-shadow:inset 0 1px 3px rgba(0,0,0,0.1); }
        .month-cell { background:linear-gradient(to bottom,#f8f9fc 0%,#e9ecef 100%); color:#495057; font-size:12px; min-width:30px; text-align:center; white-space:nowrap; border-bottom:1px solid #dee2e6; transition:background .2s; }
        .month-cell:hover { background:linear-gradient(to bottom,#e9ecef 0%,#dee2e6 100%); }
        .day-cell { background:linear-gradient(to bottom,#ffffff 0%,#f8f9fa 100%); color:#6c757d; font-size:11px; min-width:30px; text-align:center; white-space:nowrap; border-bottom:1px solid #e9ecef; border-right:1px solid rgba(0,0,0,0.05); transition:all .2s; }
        .day-cell:hover { background:linear-gradient(to bottom,#f8f9fa 0%,#e9ecef 100%); color:#495057; }
        .gantt-body { display:flex; position:relative; }
        .task-list { width: clamp(140px, 16vw, 200px); background:#fafafa; flex-shrink:0; max-height: calc(100vh - 300px); overflow-y: auto; }
        .timeline-container { flex:1; overflow-x:auto; overflow-y:hidden; position:relative; max-height:calc(100vh - 300px); }
        .timeline { position:relative; background:#fff; min-width:100%; }
        .assignee-list { width: clamp(100px, 12vw, 140px); background:#fafafa; border-left:1px solid #e4e7ed; flex-shrink:0; max-height: calc(100vh - 300px); overflow-y: auto; }
        .task-row { height:44px; display:flex; align-items:center; padding:0 10px; border-bottom:1px solid #f0f0f0; transition:background-color .2s; position:relative; }
        .task-row:hover { background-color:rgba(0,0,0,0.03) !important; }
        .assignee-row:hover { background-color:rgba(0,0,0,0.03) !important; }
        .parent-task { font-weight:600; }
        .subtask { padding-left:32px; font-size:14px; }
        .task-name { flex:1; }
        .task-title { color:#303133; line-height:1.4; user-select:none; pointer-events:none; font-size:13px; }
        .task-category { font-size:12px; color:#909399; margin-top:2px; padding:2px 6px; background:#f0f2f5; border-radius:3px; display:inline-block; width:fit-content; }
        .task-row-timeline { height:50px; position:relative; border-bottom:1px solid #f0f0f0; }
        .task-bar { position:absolute; top:8px; height:34px; border-radius:4px; display:flex; align-items:center; padding:0 8px; color:#fff; font-size:12px; cursor:move; box-shadow:0 2px 4px rgba(0,0,0,0.1); transition:all .2s; user-select:none; }
        .task-bar:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
        .task-bar-text { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; pointer-events:none; user-select:none; }
        .resize-handle { position:absolute; top:0; bottom:0; width:6px; cursor:ew-resize; background:rgba(255,255,255,0.3); opacity:0; transition:opacity .2s; }
        .resize-handle.left { left:0; border-radius:4px 0 0 4px; }
        .resize-handle.right { right:0; border-radius:0 4px 4px 0; }
        .task-bar:hover .resize-handle { opacity:1; }
        .assignee-row { height:44px; display:flex; align-items:center; padding:0 10px; border-bottom:1px solid #f0f0f0; font-size:12px; position:relative; }
        .assignee-avatar { width:24px; height:24px; border-radius:50%; background:#409eff; color:#fff; display:flex; align-items:center; justify-content:center; font-size:10px; margin-right:8px; flex-shrink:0; }
        .assignee-name { color:#606266; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .add-btn { position:absolute; right:52px; top:50%; transform:translateY(-50%); width:20px; height:20px; border:none; background:#409eff; color:#fff; border-radius:50%; font-size:12px; cursor:pointer; opacity:0; transition:all .2s; display:flex; align-items:center; justify-content:center; z-index:1; }
        .delete-btn,.task-delete-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); width:16px; height:16px; border:none; background:rgba(255,0,0,0.8); color:#fff; border-radius:50%; font-size:10px; line-height:1; cursor:pointer; opacity:0; transition:opacity .2s; display:flex; align-items:center; justify-content:center; z-index:3; }
        .edit-btn { position:absolute; right:25px; top:50%; transform:translateY(-50%); width:16px; height:16px; border:none; background:rgba(64,158,255,0.8); color:#fff; border-radius:50%; font-size:10px; cursor:pointer; opacity:0; transition:opacity .2s; display:flex; align-items:center; justify-content:center; z-index:2; }
        .task-row:hover .delete-btn,.task-row:hover .edit-btn,.task-row:hover .add-btn,.assignee-row:hover .delete-btn,.assignee-row:hover .edit-btn,.month-cell:hover .delete-btn,.month-cell:hover .edit-btn,.month-cell:hover .add-btn,.task-bar:hover .task-delete-btn { opacity:1; }
        .task-list-header:hover .add-btn,.assignee-header:hover .add-btn { opacity:1; }
        .date-picker-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .date-picker-modal.show { display:flex; }
        .date-picker-content { background:#fff; padding:24px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.3); width:400px; max-width:90vw; }
        .date-picker-content h3 { margin-bottom:20px; color:#303133; }
        .date-range-group { display:flex; gap:16px; margin-bottom:16px; }
        .date-range-group>div { flex:1; }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .modal.show { display:flex; }
        .modal-content { background:#fff; padding:24px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.3); width:400px; max-width:90vw; }
        .modal-content h3 { margin-bottom:20px; color:#303133; }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; margin-bottom:8px; color:#606266; font-weight:500; }
        .form-group input,.form-group select { width:100%; padding:8px 12px; border:1px solid #dcdfe6; border-radius:4px; font-size:14px; }
        .form-group input:focus,.form-group select:focus { outline:none; border-color:#409eff; }
        .form-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:24px; }
        .btn { padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-size:14px; }
        .btn-primary { background:#409eff; color:#fff; }
        .btn-primary:hover { background:#337ab7; }
        .btn-secondary { background:#f5f7fa; color:#606266; border:1px solid #dcdfe6; }
        .btn-secondary:hover { background:#ecf5ff; }
        .time-range-inputs { display:flex; align-items:center; gap:8px; }
        .time-range-inputs input[type="date"] { flex:1; padding:8px 12px; border:1px solid #dcdfe6; border-radius:4px; font-size:14px; }
        .time-range-separator { color:#909399; font-size:14px; white-space:nowrap; }
        .color-picker-container { display:flex; align-items:center; gap:12px; }
        .color-preview { height:36px; min-width:80px; background:#409eff; border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:500; border:1px solid #dcdfe6; transition:background-color .2s; }
        .is-panning { cursor: grabbing !important; }
    </style>
</head>
<body>
    <div class="gantt-chart">
        <div class="page-header">
            <h1>任务清单：2.4 执行管控 - "甘特图" 的应用案例</h1>
            <div class="header-actions">
                <div class="time-mode-toggle">
                    <button class="time-mode-btn active" data-mode="day" onclick="switchTimeMode('day')">日</button>
                    <button class="time-mode-btn" data-mode="month" onclick="switchTimeMode('month')">月</button>
                </div>
                <div id="userMenuContainer"></div>
            </div>
        </div>
        <div class="gantt-container">
            
            <div class="gantt-header">
                <div class="task-list-header">任务列表</div>
                <div class="assignee-header">负责人</div>
                <div class="time-header">
                    <div class="year-row" id="yearRow"></div>
                    <div class="month-row" id="monthRow"></div>
                    <div class="day-row" id="dayRow"></div>
                </div>
            </div>
            <div class="gantt-body">
                <div class="task-list" id="taskList"></div>
                <div class="assignee-list" id="assigneeList"></div>
                <div class="timeline-container" id="timelineContainer">
                    <div class="timeline" id="timeline"></div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="assets/header-user-menu.css" />
    <script src="assets/header-user-menu.js"></script>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">编辑项目</h3>
            <div class="form-group" id="nameGroup">
                <label>名称:</label>
                <input type="text" id="itemName" />
            </div>
            <div class="form-group" id="descriptionGroup">
                <label>描述:</label>
                <input type="text" id="itemDescription" />
            </div>
            <div class="form-group" id="categoryGroup">
                <label>分类:</label>
                <select id="itemCategory">
                    <option value="触达">触达</option>
                    <option value="孵育">孵育</option>
                    <option value="转化">转化</option>
                </select>
            </div>
            <div class="form-group" id="assigneeSelectGroup">
                <label>负责人:</label>
                <select id="itemAssigneeSelect"><option value="">选择现有负责人</option></select>
            </div>
            <div class="form-group" id="assigneeInputGroup">
                <label>或新增负责人:</label>
                <input type="text" id="itemAssigneeInput" placeholder="输入新负责人姓名" />
            </div>
            <div class="form-group" id="colorGroup">
                <label>颜色:</label>
                <div class="color-picker-container">
                    <input type="color" id="itemColor" onchange="updateColorPreview()" />
                    <div class="color-preview" id="colorPreview"><span>预览</span></div>
                </div>
            </div>
            <div class="form-group" id="timeRangeGroup">
                <label>时间范围:</label>
                <div class="time-range-inputs">
                    <input type="date" id="itemStartDate" placeholder="开始日期" />
                    <span class="time-range-separator">至</span>
                    <input type="date" id="itemEndDate" placeholder="结束日期" />
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveItem()">保存</button>
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <div id="dateRangeModal" class="date-picker-modal">
        <div class="date-picker-content">
            <h3>设置时间范围</h3>
            <div class="date-range-group">
                <div class="form-group">
                    <label>开始日期:</label>
                    <input type="date" id="startDate" />
                </div>
                <div class="form-group">
                    <label>结束日期:</label>
                    <input type="date" id="endDate" />
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="applyDateRange()">应用</button>
                <button class="btn btn-secondary" onclick="closeDateRangePicker()">取消</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditElement = null;
        let editMode = 'edit';
        let editType = 'task';
        let currentParentTaskIndex = -1;
        let taskIdCounter = 100;
        let timeIdCounter = 100;
        let assigneeIdCounter = 100;
        let startDate = new Date('2023-01-01');
        let endDate = new Date('2025-12-31');
        let totalDays = 0;
        let columnWidth = 3;
        let timeMode = 'day';
        let scrollPosition = 0;
        let viewportWidth = 1200;
        let currentDate = new Date();

        let ganttData = {
            tasks: [
                { id:1, name:'客户调研', category:'触达', startDay:0, duration:90, color:'#87ceeb', assignee:'武清高俊喜', description:'特变电业二总部筹组配置', type:'parent', subtasks:[
                    { id:11, name:'分层走访', startDay:0, duration:30, color:'#87ceeb', assignee:'武清高俊喜' },
                    { id:12, name:'获取商机', startDay:30, duration:30, color:'#87ceeb', assignee:'武清高俊喜' }
                ]},
                { id:2, name:'孵育', category:'孵育', startDay:90, duration:180, color:'#ff6b6b', assignee:'企要斯冰栋', description:'撰写方案', type:'parent', subtasks:[
                    { id:21, name:'制定方案', startDay:90, duration:60, color:'#98d982', assignee:'企要斯冰栋' },
                    { id:22, name:'沟通交流', startDay:150, duration:90, color:'#feca57', assignee:'企要斯冰栋', description:'撰写招标文件多轮议价' }
                ]},
                { id:3, name:'转化', category:'转化', startDay:210, duration:510, color:'#48dbfb', assignee:'集团教科刘保伟', type:'parent', subtasks:[
                    { id:31, name:'应标签约', startDay:210, duration:90, color:'#ff9ff3', assignee:'集团教科刘保伟', description:'应标签约' },
                    { id:32, name:'建设交付', startDay:300, duration:300, color:'#98d982', assignee:'集团教科刘保伟', description:'项目总体建设完成 95%' },
                    { id:33, name:'工单起租', startDay:600, duration:90, color:'#98d982', assignee:'集团教科刘保伟', description:'项目终验完成' },
                    { id:34, name:'计收回款', startDay:690, duration:30, color:'#feca57', assignee:'武清高俊喜', description:'项目计收82%，项目回款43%' }
                ]}
            ],
            timeColumns: [],
            assignees: []
        };

        function init() {
            try {
                totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                initScrollPosition();
                generateTimeColumns();
                generateAssignees();
                document.getElementById('startDate').value = formatDate(startDate);
                document.getElementById('endDate').value = formatDate(endDate);
                renderAll();
                setupScrollEvents();
            } catch (error) {
                alert('初始化错误: ' + error.message);
            }
        }

        function initScrollPosition() {
            const daysSinceStart = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
            columnWidth = timeMode === 'day' ? 30 : 100;
            scrollPosition = Math.max(0, daysSinceStart * columnWidth - viewportWidth / 2);
        }

        function setupScrollEvents() {
            const timelineContainer = document.getElementById('timelineContainer');
            const timeHeader = document.querySelector('.time-header');
            if (timelineContainer && timeHeader) {
                timelineContainer.removeEventListener('scroll', handleTimelineScroll);
                timeHeader.removeEventListener('scroll', handleHeaderScroll);
                timelineContainer.addEventListener('scroll', handleTimelineScroll);
                timeHeader.addEventListener('scroll', handleHeaderScroll);
            }
        }
        function handleTimelineScroll() {
            const timelineContainer = document.getElementById('timelineContainer');
            const timeHeader = document.querySelector('.time-header');
            if (timelineContainer && timeHeader) {
                scrollPosition = timelineContainer.scrollLeft;
                timeHeader.scrollLeft = scrollPosition;
            }
        }
        function handleHeaderScroll() {
            const timelineContainer = document.getElementById('timelineContainer');
            const timeHeader = document.querySelector('.time-header');
            if (timelineContainer && timeHeader) {
                scrollPosition = timeHeader.scrollLeft;
                timelineContainer.scrollLeft = scrollPosition;
            }
        }

        function generateAssignees() {
            const assigneeSet = new Set();
            ganttData.tasks.forEach(task => {
                if (task.assignee) assigneeSet.add(task.assignee);
                if (task.subtasks) task.subtasks.forEach(subtask => { if (subtask.assignee) assigneeSet.add(subtask.assignee); });
            });
            ganttData.assignees = Array.from(assigneeSet).map((name, index) => ({ id:index+1, name }));
        }

        function switchTimeMode(mode) {
            timeMode = mode;
            document.querySelectorAll('.time-mode-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.time-mode-btn[data-mode="${mode}"]`);
            if (btn) btn.classList.add('active');
            if (timeMode === 'day') columnWidth = 30; else columnWidth = 100;
            generateTimeColumns();
            renderAll();
            updateScrollPosition();
        }

        function updateScrollPosition() {
            const timelineContainer = document.getElementById('timelineContainer');
            if (timelineContainer) timelineContainer.scrollLeft = scrollPosition;
        }

        function generateTimeColumns() {
            ganttData.timeColumns = [];
            if (timeMode === 'day') {
                let d = new Date(startDate.getTime());
                for (let day = 0; day < totalDays; day++) {
                    ganttData.timeColumns.push({ id:`day-${day}`, label:`${d.getMonth()+1}/${d.getDate()}`, date:new Date(d.getTime()), type:'day', width:columnWidth });
                    d.setDate(d.getDate()+1);
                }
            } else {
                const startYear = startDate.getFullYear();
                const startMonth = startDate.getMonth();
                const endYear = endDate.getFullYear();
                const endMonth = endDate.getMonth();
                let current = new Date(startYear, startMonth, 1);
                let target = new Date(endYear, endMonth, 1);
                while (current <= target) {
                    const year = current.getFullYear();
                    const month = current.getMonth()+1;
                    const daysInMonth = new Date(year, current.getMonth()+1, 0).getDate();
                    ganttData.timeColumns.push({ id:`month-${year}-${month}`, label:`${month}月`, year, month, days:daysInMonth, type:'month', width:columnWidth });
                    current.setMonth(current.getMonth()+1);
                }
            }
        }

        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function showDateRangePicker() { document.getElementById('dateRangeModal').classList.add('show'); }
        function closeDateRangePicker() { document.getElementById('dateRangeModal').classList.remove('show'); }
        function applyDateRange() {
            const newStartDate = new Date(document.getElementById('startDate').value);
            const newEndDate = new Date(document.getElementById('endDate').value);
            if (newStartDate >= newEndDate) { alert('结束日期必须大于开始日期！'); return; }
            startDate = newStartDate; endDate = newEndDate; totalDays = Math.ceil((endDate - startDate)/(1000*60*60*24));
            generateTimeColumns(); renderAll(); closeDateRangePicker(); alert('时间范围已更新！');
        }

        function renderAll() { renderTimeHeader(); renderTaskList(); renderTimeline(); renderAssigneeList(); }
        function renderTimeHeader() {
            const yearRow = document.getElementById('yearRow');
            const monthRow = document.getElementById('monthRow');
            const dayRow = document.getElementById('dayRow');
            const timeline = document.getElementById('timeline');
            yearRow.innerHTML=''; monthRow.innerHTML=''; dayRow.innerHTML='';
            if (timeMode === 'day') {
                const totalWidth = ganttData.timeColumns.length * columnWidth;
                timeline.style.width = totalWidth + 'px';
                yearRow.style.width = totalWidth + 'px';
                monthRow.style.width = totalWidth + 'px';
                dayRow.style.width = totalWidth + 'px';
                dayRow.style.display = 'flex';
                const monthGroups = {};
                ganttData.timeColumns.forEach((col, index) => {
                    const date = col.date;
                    const ym = `${date.getFullYear()}-${date.getMonth()+1}`;
                    if (!monthGroups[ym]) monthGroups[ym] = { year:date.getFullYear(), month:date.getMonth()+1, count:0 };
                    monthGroups[ym].count++;
                });
                const yearGroups = {};
                Object.values(monthGroups).forEach(m => { if (!yearGroups[m.year]) yearGroups[m.year]=0; yearGroups[m.year]+=m.count; });
                Object.keys(yearGroups).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(year=>{
                    const div = document.createElement('div');
                    div.className='year-cell';
                    div.style.width=(yearGroups[year]*columnWidth)+'px';
                    div.style.minWidth=div.style.width;
                    div.style.flexShrink='0';
                    div.textContent=year+'年';
                    yearRow.appendChild(div);
                });
                Object.keys(monthGroups).sort((a,b)=>{const [ya,ma]=a.split('-').map(Number);const [yb,mb]=b.split('-').map(Number);return ya!==yb?ya-yb:ma-mb;}).forEach(key=>{
                    const m = monthGroups[key];
                    const div = document.createElement('div');
                    div.className='month-cell';
                    div.style.width=(m.count*columnWidth)+'px';
                    div.style.minWidth=div.style.width;
                    div.style.flexShrink='0';
                    div.textContent=`${m.month}月`;
                    monthRow.appendChild(div);
                });
                ganttData.timeColumns.forEach(col=>{
                    const div = document.createElement('div');
                    div.className='day-cell';
                    div.style.width=columnWidth+'px';
                    div.style.minWidth=div.style.width;
                    div.style.flexShrink='0';
                    div.textContent=col.date.getDate();
                    dayRow.appendChild(div);
                });
            } else {
                dayRow.style.display='none';
                const totalWidth = ganttData.timeColumns.length * columnWidth;
                timeline.style.width = totalWidth + 'px';
                yearRow.style.width = totalWidth + 'px';
                monthRow.style.width = totalWidth + 'px';
                const yearStructure = {};
                ganttData.timeColumns.forEach((col,index)=>{ if(!yearStructure[col.year]) yearStructure[col.year]={ months:[], startIndex:index, count:0 }; yearStructure[col.year].months.push(col); yearStructure[col.year].count++; });
                Object.keys(yearStructure).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(year=>{
                    const y = yearStructure[year];
                    const div = document.createElement('div');
                    div.className='year-cell';
                    div.style.width=(y.count*columnWidth)+'px';
                    div.style.minWidth=div.style.width; div.style.maxWidth=div.style.width; div.style.flexShrink='0';
                    div.textContent=year+'年';
                    yearRow.appendChild(div);
                });
                ganttData.timeColumns.forEach(col=>{
                    const div = document.createElement('div');
                    div.className='month-cell';
                    div.style.width=columnWidth+'px';
                    div.style.minWidth=div.style.width; div.style.maxWidth=div.style.width; div.style.flexShrink='0';
                    div.textContent=col.label;
                    monthRow.appendChild(div);
                });
            }
            updateScrollPosition();
            setupScrollEvents();
        }

        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML='';
            ganttData.tasks.forEach((task, taskIndex) => {
                const parentDiv = document.createElement('div');
                parentDiv.className='task-row parent-task';
                parentDiv.style.backgroundColor=getCategoryColor(task.category);
                parentDiv.innerHTML=`
                    <div class="task-name"><div class="task-title">${task.name}</div></div>
                    <button class="add-btn" onclick="addSubtask(${taskIndex})" title="新增子任务">+</button>
                    <button class="edit-btn" onclick="editTask(${taskIndex}, -1)" title="编辑">✎</button>
                    <button class="delete-btn" onclick="deleteTask(${taskIndex}, -1)" title="删除">×</button>
                `;
                taskList.appendChild(parentDiv);
                if (task.subtasks) task.subtasks.forEach((subtask, subtaskIndex) => {
                    const div = document.createElement('div');
                    div.className='task-row subtask';
                    div.innerHTML=`
                        <div class="task-name"><div class="task-title">${subtask.name}</div></div>
                        <button class="edit-btn" onclick="editTask(${taskIndex}, ${subtaskIndex})" title="编辑">✎</button>
                        <button class="delete-btn" onclick="deleteTask(${taskIndex}, ${subtaskIndex})" title="删除">×</button>
                    `;
                    taskList.appendChild(div);
                });
            });
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML='';
            ganttData.tasks.forEach((task, taskIndex) => {
                const parentTimeDiv = document.createElement('div');
                parentTimeDiv.className='task-row-timeline';
                const taskBar = createTaskBar(task, taskIndex, -1);
                parentTimeDiv.appendChild(taskBar);
                timeline.appendChild(parentTimeDiv);
                if (task.subtasks) task.subtasks.forEach((subtask, subtaskIndex) => {
                    const subtaskTimeDiv = document.createElement('div');
                    subtaskTimeDiv.className='task-row-timeline';
                    const subtaskBar = createTaskBar(subtask, taskIndex, subtaskIndex);
                    subtaskTimeDiv.appendChild(subtaskBar);
                    timeline.appendChild(subtaskTimeDiv);
                });
            });
        }

        function createTaskBar(task, taskIndex, subtaskIndex) {
            const taskBar = document.createElement('div');
            taskBar.className='task-bar';
            let left, width;
            if (timeMode === 'day') { left = task.startDay * columnWidth; width = Math.max(task.duration * columnWidth, 60); }
            else { const startMonth = Math.floor(task.startDay/30); const durationMonths = Math.max(Math.ceil(task.duration/30),1); left = startMonth * columnWidth; width = Math.max(durationMonths * columnWidth, 60); }
            taskBar.style.left = left + 'px'; taskBar.style.width = width + 'px'; taskBar.style.backgroundColor = task.color;
            taskBar.setAttribute('data-task-index', taskIndex); taskBar.setAttribute('data-subtask-index', subtaskIndex);
            taskBar.innerHTML = `
                <div class="resize-handle left"></div>
                <span class="task-bar-text">${task.description || task.name}</span>
                <div class="resize-handle right"></div>
                <button class="task-delete-btn" onclick="deleteTaskBar(${taskIndex}, ${subtaskIndex})" title="删除">×</button>
            `;
            return taskBar;
        }

        function renderAssigneeList() {
            const assigneeList = document.getElementById('assigneeList');
            assigneeList.innerHTML='';
            let rowIndex = 0;
            ganttData.tasks.forEach((task) => {
                const parentDiv = document.createElement('div');
                parentDiv.className='assignee-row';
                parentDiv.innerHTML=`
                    <div class="assignee-avatar">${getInitials(task.assignee)}</div>
                    <span class="assignee-name">${task.assignee}</span>
                    <button class="edit-btn" onclick="editAssignee(${rowIndex})" title="编辑">✎</button>
                    <button class="delete-btn" onclick="deleteAssigneeRow(${rowIndex})" title="删除">×</button>
                `;
                assigneeList.appendChild(parentDiv);
                rowIndex++;
                if (task.subtasks) task.subtasks.forEach((subtask)=>{
                    const div = document.createElement('div');
                    div.className='assignee-row';
                    div.innerHTML=`
                        <div class="assignee-avatar">${getInitials(subtask.assignee)}</div>
                        <span class="assignee-name">${subtask.assignee}</span>
                        <button class="edit-btn" onclick="editAssignee(${rowIndex})" title="编辑">✎</button>
                        <button class="delete-btn" onclick="deleteAssigneeRow(${rowIndex})" title="删除">×</button>
                    `;
                    assigneeList.appendChild(div);
                    rowIndex++;
                });
            });
        }

        function getCategoryColor(category) { const colors = { '触达':'#e6f7ff','孵育':'#fff2e8','转化':'#f6ffed' }; return colors[category] || '#f5f5f5'; }
        function getInitials(name) { if (!name) return 'NA'; return name.length>2 ? name.slice(-2) : name; }
        function updateAssigneeSelect() {
            const select = document.getElementById('itemAssigneeSelect');
            select.innerHTML = '<option value="">选择现有负责人</option>';
            const unique = new Set();
            ganttData.tasks.forEach(task=>{ if(task.assignee) unique.add(task.assignee); if(task.subtasks) task.subtasks.forEach(st=>{ if(st.assignee) unique.add(st.assignee); }); });
            Array.from(unique).forEach(a=>{ const opt=document.createElement('option'); opt.value=a; opt.textContent=a; select.appendChild(opt); });
        }
        function updateColorPreview() { const colorInput=document.getElementById('itemColor'); const colorPreview=document.getElementById('colorPreview'); if(colorInput&&colorPreview){ colorPreview.style.backgroundColor=colorInput.value; } }
        function closeModal() { document.getElementById('editModal').classList.remove('show'); currentEditElement=null; }
        function editTask(taskIndex, subtaskIndex) {
            editMode='edit'; editType='task'; currentEditElement={taskIndex, subtaskIndex};
            const task = subtaskIndex===-1 ? ganttData.tasks[taskIndex] : ganttData.tasks[taskIndex].subtasks[subtaskIndex];
            document.getElementById('modalTitle').textContent = subtaskIndex===-1 ? '编辑一级任务' : '编辑二级任务';
            document.getElementById('itemName').value = task.name || '';
            document.getElementById('itemDescription').value = task.description || '';
            document.getElementById('itemColor').value = task.color || '#409EFF';
            const taskStartDate = new Date(startDate); taskStartDate.setDate(taskStartDate.getDate() + (task.startDay||0)); const taskEndDate = new Date(taskStartDate); taskEndDate.setDate(taskEndDate.getDate() + (task.duration||1));
            document.getElementById('itemStartDate').value = formatDate(taskStartDate);
            document.getElementById('itemEndDate').value = formatDate(taskEndDate);
            updateAssigneeSelect(); document.getElementById('itemAssigneeSelect').value = task.assignee || ''; document.getElementById('itemAssigneeInput').value='';
            showFormGroups(['nameGroup','descriptionGroup','assigneeSelectGroup','assigneeInputGroup','colorGroup','timeRangeGroup']);
            updateColorPreview();
            document.getElementById('editModal').classList.add('show');
        }
        function editAssignee(rowIndex) {
            editMode='edit'; editType='assignee'; currentEditElement={rowIndex};
            let current=0; let target=null;
            for (let i=0;i<ganttData.tasks.length;i++) {
                if (current===rowIndex) { target=ganttData.tasks[i]; break; }
                current++;
                if (ganttData.tasks[i].subtasks) {
                    for (let j=0;j<ganttData.tasks[i].subtasks.length;j++) {
                        if (current===rowIndex) { target=ganttData.tasks[i].subtasks[j]; break; }
                        current++;
                    }
                }
                if (target) break;
            }
            document.getElementById('modalTitle').textContent='编辑负责人';
            document.getElementById('itemAssigneeSelect').value = target ? target.assignee : '';
            document.getElementById('itemAssigneeInput').value = '';
            updateAssigneeSelect();
            showFormGroups(['assigneeSelectGroup','assigneeInputGroup']);
            document.getElementById('editModal').classList.add('show');
        }
        function deleteAssigneeRow(rowIndex) {
            if (!confirm('确定要清空这个负责人吗？(任务本身不会被删除)')) return;
            let current=0; let updated=false;
            for (let i=0;i<ganttData.tasks.length && !updated;i++) {
                if (current===rowIndex) { ganttData.tasks[i].assignee=''; updated=true; break; }
                current++;
                if (ganttData.tasks[i].subtasks) {
                    for (let j=0;j<ganttData.tasks[i].subtasks.length;j++) {
                        if (current===rowIndex) { ganttData.tasks[i].subtasks[j].assignee=''; updated=true; break; }
                        current++;
                    }
                }
            }
            renderAll(); alert('负责人已清空！');
        }
        function addNewTask() {
            editMode='add'; editType='task'; currentEditElement=null; currentParentTaskIndex=-1;
            document.getElementById('modalTitle').textContent='新增一级任务';
            document.getElementById('itemName').value='';
            document.getElementById('itemDescription').value='';
            document.getElementById('itemColor').value='#409EFF';
            const today=new Date(); const defaultEnd=new Date(today); defaultEnd.setDate(today.getDate()+30);
            document.getElementById('itemStartDate').value=formatDate(today);
            document.getElementById('itemEndDate').value=formatDate(defaultEnd);
            updateAssigneeSelect(); document.getElementById('itemAssigneeSelect').value=''; document.getElementById('itemAssigneeInput').value='';
            showFormGroups(['nameGroup','descriptionGroup','assigneeSelectGroup','assigneeInputGroup','colorGroup','timeRangeGroup']);
            updateColorPreview();
            document.getElementById('editModal').classList.add('show');
        }
        function addSubtask(taskIndex) {
            editMode='add'; editType='subtask'; currentEditElement={ taskIndex }; currentParentTaskIndex=taskIndex;
            document.getElementById('modalTitle').textContent='新增二级任务';
            document.getElementById('itemName').value='';
            document.getElementById('itemDescription').value='';
            document.getElementById('itemColor').value=ganttData.tasks[taskIndex].color;
            const today=new Date(); const defaultEnd=new Date(today); defaultEnd.setDate(today.getDate()+15);
            document.getElementById('itemStartDate').value=formatDate(today);
            document.getElementById('itemEndDate').value=formatDate(defaultEnd);
            updateAssigneeSelect(); document.getElementById('itemAssigneeSelect').value=ganttData.tasks[taskIndex].assignee; document.getElementById('itemAssigneeInput').value='';
            showFormGroups(['nameGroup','descriptionGroup','assigneeSelectGroup','assigneeInputGroup','colorGroup','timeRangeGroup']);
            updateColorPreview();
            document.getElementById('editModal').classList.add('show');
        }
        function deleteTask(taskIndex, subtaskIndex) { if (!confirm('确定要删除这个任务吗？')) return; if (subtaskIndex===-1) ganttData.tasks.splice(taskIndex,1); else ganttData.tasks[taskIndex].subtasks.splice(subtaskIndex,1); renderAll(); alert('任务已删除！'); }
        function deleteTaskBar(taskIndex, subtaskIndex) { deleteTask(taskIndex, subtaskIndex); }
        function saveItem() {
            const name = document.getElementById('itemName').value.trim(); if (!name) { alert('请输入任务名称！'); return; }
            const description = document.getElementById('itemDescription').value.trim();
            const assigneeSelect = document.getElementById('itemAssigneeSelect').value;
            const assigneeInput = document.getElementById('itemAssigneeInput').value.trim();
            const assignee = assigneeInput || assigneeSelect;
            const color = document.getElementById('itemColor').value;
            let calculatedStartDay = 0; let calculatedDuration = 30;
            if (editMode==='add') {
                const itemStartDate = document.getElementById('itemStartDate').value;
                const itemEndDate = document.getElementById('itemEndDate').value;
                if (itemStartDate && itemEndDate) {
                    const s = new Date(itemStartDate); const e = new Date(itemEndDate);
                    if (s >= e) { alert('结束日期必须大于开始日期！'); return; }
                    calculatedStartDay = Math.max(0, Math.floor((s - startDate)/(1000*60*60*24)));
                    calculatedDuration = Math.max(1, Math.ceil((e - s)/(1000*60*60*24)));
                }
            }
            if (editMode==='edit') {
                if (editType==='assignee') {
                    const { rowIndex } = currentEditElement; let current=0; let updated=false;
                    for (let i=0;i<ganttData.tasks.length && !updated;i++) {
                        if (current===rowIndex) { ganttData.tasks[i].assignee=assignee; updated=true; break; }
                        current++;
                        if (ganttData.tasks[i].subtasks) {
                            for (let j=0;j<ganttData.tasks[i].subtasks.length;j++) {
                                if (current===rowIndex) { ganttData.tasks[i].subtasks[j].assignee=assignee; updated=true; break; }
                                current++;
                            }
                        }
                    }
                    alert('负责人已保存！');
                } else if (editType==='task') {
                    const { taskIndex, subtaskIndex } = currentEditElement;
                    const task = subtaskIndex===-1 ? ganttData.tasks[taskIndex] : ganttData.tasks[taskIndex].subtasks[subtaskIndex];
                    task.name=name; task.description=description; task.assignee=assignee; task.color=color;
                    const itemStartDate = document.getElementById('itemStartDate').value;
                    const itemEndDate = document.getElementById('itemEndDate').value;
                    if (itemStartDate && itemEndDate) {
                        const s = new Date(itemStartDate); const e = new Date(itemEndDate);
                        if (s >= e) { alert('结束日期必须大于开始日期！'); return; }
                        const calcStartDay = Math.max(0, Math.floor((s - startDate)/(1000*60*60*24)));
                        const calcDuration = Math.max(1, Math.ceil((e - s)/(1000*60*60*24)));
                        task.startDay = calcStartDay; task.duration = calcDuration;
                    }
                    alert('任务已保存！');
                }
            } else if (editMode==='add') {
                if (editType==='task') {
                    let category='触达';
                    if (name.includes('孵育')||name.includes('方案')||name.includes('沟通')) category='孵育';
                    else if (name.includes('转化')||name.includes('签约')||name.includes('交付')||name.includes('起租')||name.includes('计收')||name.includes('回款')) category='转化';
                    const newTask = { id:++taskIdCounter, name, category, startDay:calculatedStartDay, duration:calculatedDuration, color, assignee, description, type:'parent', subtasks:[] };
                    ganttData.tasks.push(newTask); alert('一级任务已添加！');
                } else if (editType==='subtask') {
                    const { taskIndex } = currentEditElement;
                    const newSubtask = { id:++taskIdCounter, name, startDay:calculatedStartDay, duration:calculatedDuration, color, assignee, description };
                    if (!ganttData.tasks[taskIndex].subtasks) ganttData.tasks[taskIndex].subtasks = [];
                    ganttData.tasks[taskIndex].subtasks.push(newSubtask); alert('二级任务已添加！');
                }
            }
            renderAll(); closeModal();
        }
        function showFormGroups(groups) {
            const all = ['nameGroup','descriptionGroup','categoryGroup','assigneeSelectGroup','assigneeInputGroup','colorGroup','timeRangeGroup'];
            all.forEach(id=>{ const el=document.getElementById(id); if(el){ el.style.display = groups.includes(id) ? 'block' : 'none'; } });
        }
        let isDragging=false, dragStartX=0, dragElement=null, originalLeft=0;
        let dragMoved = false;
        document.addEventListener('mousedown', function(e){ const taskBar=e.target.closest('.task-bar'); if(taskBar && !e.target.classList.contains('resize-handle') && !e.target.classList.contains('task-delete-btn')){ isDragging=true; dragMoved=false; dragElement=taskBar; dragStartX=e.clientX; originalLeft=parseInt(dragElement.style.left)||0; e.preventDefault(); e.stopPropagation(); document.body.style.userSelect='none'; }});
        document.addEventListener('mousemove', function(e){ if(isDragging && dragElement){ const deltaX=e.clientX-dragStartX; if (Math.abs(deltaX) > 4) dragMoved = true; const newLeft=Math.max(0, originalLeft+deltaX); const snapped=Math.round(newLeft/columnWidth)*columnWidth; dragElement.style.left=snapped+'px'; const ti=parseInt(dragElement.getAttribute('data-task-index')); const si=parseInt(dragElement.getAttribute('data-subtask-index')); const task=si===-1?ganttData.tasks[ti]:ganttData.tasks[ti].subtasks[si]; task.startDay=Math.round(snapped/columnWidth); }});
        document.addEventListener('mouseup', function(e){ if(isDragging && dragElement){ if (!dragMoved) { const ti=parseInt(dragElement.getAttribute('data-task-index')); const si=parseInt(dragElement.getAttribute('data-subtask-index')); if (!e.target.classList.contains('resize-handle') && !e.target.classList.contains('task-delete-btn')) { editTask(ti, si); } } } isDragging=false; dragElement=null; document.body.style.userSelect=''; });
        let isResizing=false, resizeDirection=null, resizeElement=null, resizeStartX=0, originalWidth=0;
        document.addEventListener('mousedown', function(e){ if(e.target.classList.contains('resize-handle')){ isResizing=true; resizeElement=e.target.closest('.task-bar'); resizeDirection=e.target.classList.contains('left')?'left':'right'; resizeStartX=e.clientX; originalLeft=parseInt(resizeElement.style.left)||0; originalWidth=parseInt(resizeElement.style.width)||0; e.preventDefault(); e.stopPropagation(); }});
        document.addEventListener('mousemove', function(e){ if(isResizing && resizeElement){ const dx=e.clientX-resizeStartX; if(resizeDirection==='left'){ const newLeft=Math.max(0, originalLeft+dx); const snappedLeft=Math.round(newLeft/columnWidth)*columnWidth; const newWidth=originalWidth-(snappedLeft-originalLeft); if(newWidth>columnWidth){ resizeElement.style.left=snappedLeft+'px'; resizeElement.style.width=newWidth+'px'; const ti=parseInt(resizeElement.getAttribute('data-task-index')); const si=parseInt(resizeElement.getAttribute('data-subtask-index')); const task=si===-1?ganttData.tasks[ti]:ganttData.tasks[ti].subtasks[si]; task.startDay=Math.round(snappedLeft/columnWidth); task.duration=Math.round(newWidth/columnWidth); } } else { const newWidth=Math.max(columnWidth, originalWidth+dx); const snappedWidth=Math.round(newWidth/columnWidth)*columnWidth; resizeElement.style.width=snappedWidth+'px'; const ti=parseInt(resizeElement.getAttribute('data-task-index')); const si=parseInt(resizeElement.getAttribute('data-subtask-index')); const task=si===-1?ganttData.tasks[ti]:ganttData.tasks[ti].subtasks[si]; task.duration=Math.round(snappedWidth/columnWidth); } }});
        document.addEventListener('mouseup', function(){ isResizing=false; resizeElement=null; resizeDirection=null; });
        // 轴平移
        let isPanning = false, panStartX = 0, panStartScroll = 0;
        function bindPan(el) {
            el.addEventListener('mousedown', function(e){ if (e.target.closest('.task-bar') || e.target.classList.contains('resize-handle')) return; isPanning = true; panStartX = e.clientX; const th = document.querySelector('.time-header'); panStartScroll = th.scrollLeft; el.classList.add('is-panning'); e.preventDefault(); });
            el.addEventListener('mousemove', function(e){ if (!isPanning) return; const th = document.querySelector('.time-header'); const tl = document.getElementById('timelineContainer'); const delta = e.clientX - panStartX; th.scrollLeft = panStartScroll - delta; tl.scrollLeft = th.scrollLeft; });
            el.addEventListener('mouseup', function(){ isPanning = false; el.classList.remove('is-panning'); });
            el.addEventListener('mouseleave', function(){ isPanning = false; el.classList.remove('is-panning'); });
        }
        bindPan(document.querySelector('.time-header'));
        bindPan(document.getElementById('timelineContainer'));
        
        document.addEventListener('click', function(e){ if(e.target.id==='editModal') closeModal(); if(e.target.id==='dateRangeModal') closeDateRangePicker(); });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
