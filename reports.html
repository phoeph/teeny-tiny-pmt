<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>汇报管理 - 项目管理系统</title>
  <link rel="stylesheet" href="assets/modern-theme.css" />
  <link rel="stylesheet" href="assets/header-user-menu.css" />
  <link rel="stylesheet" href="assets/left-sidebar.css" />
  <link rel="stylesheet" href="assets/non-dev-work-styles.css" />
  <style>
    /* Page Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title h2 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      color: var(--text-main);
      letter-spacing: -0.02em;
    }
    
    .page-title .type-badge {
      background: var(--primary-light);
      color: var(--primary);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    
    /* Filter Card */
    .filter-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
    }

    .filter-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .filter-card-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0;
    }
    
    .filter-card-header .icon {
      width: 36px;
      height: 36px;
      background: var(--primary-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }
    
    /* Filter Grid */
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-group label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .filter-group select,
    .filter-group input[type="date"] {
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-input);
      color: var(--text-main);
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .filter-group select:focus,
    .filter-group input[type="date"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* Project Selector */
    .project-selector-container {
      margin-top: 16px;
    }
    
    .project-selector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .project-selector-header label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .select-actions {
      display: flex;
      gap: 8px;
    }
    
    .select-actions button {
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .select-actions button:hover {
      background: var(--bg-hover);
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .project-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      max-height: 240px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .project-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-subtle);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .project-item:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
    }
    
    .project-item.selected {
      background: var(--primary-light);
      border-color: var(--primary);
    }
    
    .project-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    
    .project-item .project-info {
      flex: 1;
      min-width: 0;
    }
    
    .project-item .project-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .project-item .project-code {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* Generate Button */
    .filter-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-light);
    }
    
    /* Report Content */
    .report-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--shadow-sm);
      min-height: 500px;
      max-width: 900px;
      margin: 0 auto;
    }
    
    .report-header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .report-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }
    
    .report-period {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .kpi-card {
      background: linear-gradient(135deg, var(--bg-subtle) 0%, var(--bg-surface) 100%);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .kpi-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Section */
    .report-section {
      margin-bottom: 32px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
      padding-left: 12px;
      border-left: 4px solid var(--primary);
    }
    
    /* Category Section */
    .category-section {
      margin-bottom: 32px;
    }
    
    .category-section h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 16px;
      padding-left: 12px;
      border-left: 4px solid var(--primary);
    }
    
    .category-section h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 12px;
      padding-left: 8px;
      border-left: 2px solid var(--primary-light);
    }
    
    .job-list {
      margin: 0;
      padding-left: 20px;
      list-style: none;
    }
    
    .job-item {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }
    
    .job-item:hover {
      background: var(--bg-hover);
      border-radius: 4px;
      padding-left: 8px;
      margin-left: -8px;
    }
    
    .job-bullet {
      color: var(--text-secondary);
      font-weight: bold;
    }
    
    .job-name {
      flex: 1;
      color: var(--text-main);
      font-size: 14px;
    }
    
    .job-progress {
      font-weight: 600;
      font-size: 13px;
      min-width: 40px;
      text-align: right;
    }
    
    .progress-100 { color: var(--success); }
    .progress-50 { color: var(--warning); }
    .progress-0 { color: var(--text-secondary); }
    
    /* Task Table */
    .task-table {
      width: 100%;
      border-collapse: collapse;
      border: none;
    }
    
    .task-table th {
      background: var(--bg-element);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      text-align: left;
      border: none;
    }
    
    .task-table td {
      padding: 12px 16px;
      border: none;
      font-size: 14px;
      color: var(--text-main);
    }
    
    .task-table tr:hover {
      background: var(--bg-hover);
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .status-todo {
      background: var(--warning-light);
      color: #d97706;
    }
    
    .status-doing {
      background: var(--success-light);
      color: #059669;
    }
    
    .status-done {
      background: var(--primary-light);
      color: var(--primary);
    }

    /* Priority Badge */
    .priority-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .priority-high {
      background: var(--danger-light);
      color: #dc2626;
    }
    
    .priority-medium {
      background: var(--warning-light);
      color: #d97706;
    }
    
    .priority-low {
      background: var(--success-light);
      color: #059669;
    }
    
    /* Export Actions */
    .export-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-light);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state .icon {
      width: 80px;
      height: 80px;
      background: var(--bg-subtle);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    
    .empty-state .icon svg {
      width: 40px;
      height: 40px;
      color: var(--text-muted);
    }
    
    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 8px 0;
    }
    
    .empty-state p {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .filter-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      .project-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div id="left-sidebar"></div>
  
  <div class="header">
    <div class="header-left">
      <div class="page-title">
        <h2>汇报管理</h2>
        <span class="type-badge" id="reportTypeBadge">周报</span>
      </div>
    </div>
    <div class="header-right">
      <div id="userMenuContainer"></div>
    </div>
  </div>

  <div class="main-content">
    <!-- 筛选配置 -->
    <div class="filter-card">
      <div class="filter-card-header">
        <div class="icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
        </div>
        <h3>报告配置</h3>
      </div>
      
      <div class="filter-grid">
        <div class="filter-group">
          <label>报告类型</label>
          <select id="reportType">
            <option value="weekly">周报</option>
            <option value="monthly">月报</option>
            <option value="yearly">年报</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>开始日期</label>
          <input type="date" id="startDate" />
        </div>
        
        <div class="filter-group">
          <label>结束日期</label>
          <input type="date" id="endDate" />
        </div>
        
        <div class="filter-group" style="justify-content: flex-end;">
          <button class="primary-btn" id="generateBtn" style="height: 42px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
            </svg>
            生成报告
          </button>
        </div>
      </div>
      
      <div class="project-selector-container">
        <div class="project-selector-header">
          <label>选择项目</label>
          <div class="select-actions">
            <button id="selectAllBtn">全选</button>
            <button id="clearAllBtn">清空</button>
          </div>
        </div>
        <div class="project-list" id="projectList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>加载项目中...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 报告内容 -->
    <div class="report-card" id="reportContent">
      <div class="empty-state">
        <div class="icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
        </div>
        <h3>请配置报告参数</h3>
        <p>选择报告类型、时间范围和项目，然后点击"生成报告"按钮</p>
      </div>
    </div>

    <!-- 非开发工作管理 -->
    <div id="reportNonDevWorkContainer"></div>

    <!-- 导出操作 -->
    <div class="export-actions" id="exportActions" style="display: none;">
      <button class="primary-btn" id="exportWordBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7,10 12,15 17,10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        导出Word文档
      </button>
      <button class="ghost-btn" id="printBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
          <polyline points="6,9 6,2 18,2 18,9"></polyline>
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
          <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        打印报告
      </button>
    </div>
  </div>

  <script src="assets/header-user-menu.js"></script>
  <script src="assets/left-sidebar.js"></script>
  <script src="assets/report-non-dev-work-manager.js"></script>
  
  <script>
    const API = 'http://localhost:8000/api';
    const token = localStorage.getItem('token');
    
    // Check if user is authenticated
    if (!token) {
      // Redirect to login page if no token
      window.location.href = 'login.html';
      // Stop execution
      throw new Error('No authentication token found');
    }
    
    let allProjects = [];
    let reportData = null;
    let reportNonDevWorkManager = null;
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', async function() {
      await loadProjects();
      initDateInputs();
      bindEvents();
      
      // 初始化非开发工作管理器
      reportNonDevWorkManager = new ReportNonDevWorkManager(API);
    });
    
    // 加载项目列表
    async function loadProjects() {
      try {
        const response = await fetch(`${API}/projects?page=1&size=100`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (response.status === 401) {
          // Token expired or invalid, redirect to login
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }
        
        if (!response.ok) throw new Error('Failed to fetch projects');
        
        const data = await response.json();
        allProjects = data.items || [];
        
        // 将项目列表设为全局变量，供非开发工作管理器使用
        window.allProjects = allProjects;
        
        renderProjectList();
      } catch (error) {
        console.error('Error loading projects:', error);
        document.getElementById('projectList').innerHTML = 
          '<div style="padding: 20px; text-align: center; color: var(--danger);">加载项目失败，请刷新重试</div>';
      }
    }

    // 渲染项目列表
    function renderProjectList() {
      const container = document.getElementById('projectList');
      
      if (!allProjects.length) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">暂无项目</div>';
        return;
      }
      
      const html = allProjects.map(project => `
        <div class="project-item" onclick="toggleProject(this, ${project.id})">
          <input type="checkbox" id="project-${project.id}" value="${project.id}" onclick="event.stopPropagation()" onchange="updateProjectItemStyle(this)" />
          <div class="project-info">
            <div class="project-name">${project.name || project.title || `项目 ${project.id}`}</div>
            <div class="project-code">${project.code || `#${project.id}`}</div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }
    
    // 切换项目选择
    function toggleProject(el, projectId) {
      const checkbox = el.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      updateProjectItemStyle(checkbox);
    }
    
    // 更新项目项样式
    function updateProjectItemStyle(checkbox) {
      const item = checkbox.closest('.project-item');
      if (checkbox.checked) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    }
    
    // 初始化日期输入
    function initDateInputs() {
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay() + 1);
      
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      document.getElementById('startDate').value = formatDate(startOfWeek);
      document.getElementById('endDate').value = formatDate(endOfWeek);
    }
    
    // 绑定事件
    function bindEvents() {
      document.getElementById('reportType').addEventListener('change', function() {
        updateDateRange();
        updateTypeBadge();
      });
      document.getElementById('generateBtn').addEventListener('click', generateReport);
      document.getElementById('exportWordBtn').addEventListener('click', exportToWord);
      document.getElementById('printBtn').addEventListener('click', printReport);
      document.getElementById('selectAllBtn').addEventListener('click', selectAllProjects);
      document.getElementById('clearAllBtn').addEventListener('click', clearAllProjects);
    }
    
    // 更新类型徽章
    function updateTypeBadge() {
      const type = document.getElementById('reportType').value;
      const badge = document.getElementById('reportTypeBadge');
      const names = { weekly: '周报', monthly: '月报', yearly: '年报' };
      badge.textContent = names[type];
    }
    
    // 全选项目
    function selectAllProjects() {
      document.querySelectorAll('#projectList input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
        updateProjectItemStyle(cb);
      });
    }
    
    // 清空选择
    function clearAllProjects() {
      document.querySelectorAll('#projectList input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        updateProjectItemStyle(cb);
      });
    }

    // 更新日期范围
    function updateDateRange() {
      const reportType = document.getElementById('reportType').value;
      const today = new Date();
      let startDate, endDate;
      
      switch (reportType) {
        case 'weekly':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - today.getDay() + 1);
          endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + 6);
          break;
        case 'monthly':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          break;
        case 'yearly':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31);
          break;
      }
      
      document.getElementById('startDate').value = formatDate(startDate);
      document.getElementById('endDate').value = formatDate(endDate);
    }
    
    // 生成报告
    async function generateReport() {
      const selectedProjects = getSelectedProjects();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const reportType = document.getElementById('reportType').value;
      
      if (!selectedProjects.length) {
        showToast('请至少选择一个项目', 'error');
        return;
      }
      
      if (!startDate || !endDate) {
        showToast('请选择日期范围', 'error');
        return;
      }
      
      try {
        document.getElementById('reportContent').innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>正在生成报告...</div>
          </div>
        `;
        
        const projectsData = await Promise.all(
          selectedProjects.map(projectId => fetchProjectData(projectId, startDate, endDate))
        );
        
        reportData = processReportData(projectsData, reportType, startDate, endDate);
        renderReport(reportData);
        document.getElementById('exportActions').style.display = 'flex';
        
        // 初始化非开发工作管理器（等待数据加载完成）
        if (reportNonDevWorkManager) {
          await reportNonDevWorkManager.updateReportParams(selectedProjects, startDate, endDate);
        }
        
      } catch (error) {
        
        document.getElementById('reportContent').innerHTML = `
          <div class="empty-state">
            <div class="icon" style="background: var(--danger-light);">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </div>
            <h3>生成报告失败</h3>
            <p>请检查网络连接并重试</p>
          </div>
        `;
      }
    }
    
    // 获取选中的项目
    function getSelectedProjects() {
      const checkboxes = document.querySelectorAll('#projectList input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }
    
    // 获取项目数据
    async function fetchProjectData(projectId, startDate, endDate) {
      const response = await fetch(`${API}/work-items/by-project/${projectId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      if (response.status === 401) {
        // Token expired or invalid, redirect to login
        localStorage.removeItem('token');
        window.location.href = 'login.html';
        throw new Error('Authentication failed');
      }
      
      if (!response.ok) throw new Error(`Failed to fetch project ${projectId} data`);
      
      const data = await response.json();
      const workItems = data.items || [];
      const project = allProjects.find(p => p.id === projectId);
      
      // 获取非开发工作说明 - 使用新的by-report端点
      let nonDevWorks = [];
      try {
        const params = new URLSearchParams({
          project_ids: projectId.toString(),
          start_date: startDate,
          end_date: endDate
        });
        const nonDevResponse = await fetch(`${API}/non-dev-works/by-report?${params}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (nonDevResponse.ok) {
          nonDevWorks = await nonDevResponse.json();
        } else if (nonDevResponse.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          throw new Error('Authentication failed');
        }
      } catch (error) {
        
      }
      
      // 不按日期过滤，获取所有工作项
      return { project, workItems, nonDevWorks };
    }

    // 处理报告数据
    function processReportData(projectsData, reportType, startDate, endDate) {
      // 按项目分组处理数据
      const projectGroups = {};
      let totalTasks = 0;
      let completedTasks = 0;
      
      projectsData.forEach(pd => {
        const project = pd.project;
        const projectName = project.name || project.title || `项目 ${project.id}`;
        const workItems = pd.workItems || [];
        const nonDevWorks = pd.nonDevWorks || [];
        
        // 获取该项目的所有JOB
        const jobs = workItems.filter(item => item.kind === 'JOB' || !item.parent_id);
        
        // 收集该项目的所有JOB（不管是否有子任务，都显示JOB本身）
        const projectTasks = [];
        jobs.forEach(job => {
          // 始终添加JOB本身到任务列表中
          projectTasks.push({
            ...job,
            parentJob: null, // JOB本身没有父任务
            // 如果JOB有子任务，可以从子任务中汇总状态信息
            aggregatedStatus: job.subtasks && job.subtasks.length > 0 ? 
              getAggregatedStatus(job.subtasks) : job.status
          });
        });
        
        totalTasks += projectTasks.length;
        completedTasks += projectTasks.filter(t => t.status === 'done').length;
        
        // 构建标签层级结构
        const labelHierarchy = buildLabelHierarchy(projectTasks);
        
        projectGroups[project.id] = {
          project: project,
          projectName: projectName,
          labelHierarchy: labelHierarchy,
          nonDevWorks: nonDevWorks,
          stats: {
            total: projectTasks.length,
            done: projectTasks.filter(t => t.status === 'done').length,
            doing: projectTasks.filter(t => t.status === 'doing').length,
            todo: projectTasks.filter(t => t.status === 'todo' || !t.status).length
          }
        };
      });
      
      return {
        reportType,
        startDate,
        endDate,
        projects: projectsData.map(pd => pd.project),
        summary: {
          totalProjects: projectsData.length,
          totalJobs: projectsData.reduce((sum, pd) => sum + (pd.workItems || []).filter(item => item.kind === 'JOB' || !item.parent_id).length, 0),
          totalTasks: totalTasks,
          completedTasks: completedTasks
        },
        projectGroups: projectGroups
      };
    }
    
    // 构建标签层级结构（三级：项目 -> 第一级标签 -> 最后一级标签）
    function buildLabelHierarchy(tasks) {
      const hierarchy = {};
      
      tasks.forEach(task => {
        let labelPath = task.label_path || (task.parentJob && task.parentJob.label_path) || '';
        
        let firstPart, lastPart;
        
        if (!labelPath || !labelPath.trim()) {
          // 所有Labels为空的任务都归到同一个"其他"分类
          firstPart = '其他';
          lastPart = '其他';
        } else {
          // 按斜线分割标签路径
          const pathParts = labelPath.split('/').filter(Boolean);
          
          // 获取第一个和最后一个部分
          firstPart = pathParts[0] || '其他';
          lastPart = pathParts.length > 1 ? pathParts[pathParts.length - 1] : firstPart;
        }
        
        // 构建二级结构：第一级标签 -> 最后一级标签
        if (!hierarchy[firstPart]) {
          hierarchy[firstPart] = {
            name: firstPart,
            children: {},
            stats: { total: 0, done: 0, doing: 0, todo: 0 },
            isOther: firstPart === '其他' // 标记是否为"其他"分类
          };
        }
        
        if (!hierarchy[firstPart].children[lastPart]) {
          hierarchy[firstPart].children[lastPart] = {
            name: lastPart,
            tasks: [],
            stats: { total: 0, done: 0, doing: 0, todo: 0 }
          };
        }
        
        // 添加任务到最后一级
        hierarchy[firstPart].children[lastPart].tasks.push(task);
        hierarchy[firstPart].children[lastPart].stats.total++;
        
        // 使用汇总状态（如果存在）或原始状态
        const taskStatus = task.aggregatedStatus || task.status;
        switch (taskStatus) {
          case 'done': 
            hierarchy[firstPart].children[lastPart].stats.done++; 
            break;
          case 'doing': 
            hierarchy[firstPart].children[lastPart].stats.doing++; 
            break;
          default: 
            hierarchy[firstPart].children[lastPart].stats.todo++; 
            break;
        }
      });
      
      // 计算第一级标签的统计数据
      Object.values(hierarchy).forEach(firstLevel => {
        Object.values(firstLevel.children).forEach(lastLevel => {
          firstLevel.stats.total += lastLevel.stats.total;
          firstLevel.stats.done += lastLevel.stats.done;
          firstLevel.stats.doing += lastLevel.stats.doing;
          firstLevel.stats.todo += lastLevel.stats.todo;
        });
      });
      
      return hierarchy;
    }

    // 根据子任务状态计算JOB的汇总状态
    function getAggregatedStatus(subtasks) {
      if (!subtasks || subtasks.length === 0) {
        return 'todo';
      }
      
      const statusCounts = {
        done: 0,
        doing: 0,
        todo: 0,
        blocked: 0,
        cancelled: 0
      };
      
      subtasks.forEach(task => {
        const status = task.status || 'todo';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
      });
      
      const total = subtasks.length;
      
      // 如果所有子任务都完成，JOB状态为完成
      if (statusCounts.done === total) {
        return 'done';
      }
      
      // 如果有任何子任务在进行中，JOB状态为进行中
      if (statusCounts.doing > 0) {
        return 'doing';
      }
      
      // 如果有已完成的任务但不是全部，也算进行中
      if (statusCounts.done > 0) {
        return 'doing';
      }
      
      // 其他情况为待办
      return 'todo';
    }

    // 渲染报告
    function renderReport(data) {
      const reportTypeNames = { weekly: '周报', monthly: '月报', yearly: '年报' };
      const completionRate = data.summary.totalTasks > 0 
        ? Math.round(data.summary.completedTasks / data.summary.totalTasks * 100) 
        : 0;
      
      let html = `
        <div class="report-header">
          <div class="report-title">${reportTypeNames[data.reportType]}</div>
          <div class="report-period">${formatDateRange(data.startDate, data.endDate)}</div>
        </div>
        
        <div class="report-section">
          <div class="section-header">
            <h3 class="section-title">项目概览</h3>
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-value">${data.summary.totalProjects}</div>
              <div class="kpi-label">涉及项目</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${data.summary.totalTasks}</div>
              <div class="kpi-label">总任务数</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${data.summary.completedTasks}</div>
              <div class="kpi-label">已完成任务</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${completionRate}%</div>
              <div class="kpi-label">完成率</div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          ${renderProjectGroups(data.projectGroups)}
        </div>
      `;
      
      document.getElementById('reportContent').innerHTML = html;
    }
    
    // 渲染项目分组（三级：项目 -> 第一级标签 -> 最后一级标签）
    function renderProjectGroups(projectGroups) {
      if (!projectGroups || Object.keys(projectGroups).length === 0) {
        return '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">暂无任务数据</div>';
      }
      
      let html = '';
      let projectIndex = 1;
      
      Object.values(projectGroups).forEach(pg => {
        const projectProgress = pg.stats.total > 0 
          ? Math.round(pg.stats.done / pg.stats.total * 100) 
          : 0;
        const projectProgressColor = projectProgress >= 100 ? 'var(--success)' : (projectProgress >= 50 ? 'var(--warning)' : 'var(--text-secondary)');
        
        html += `
          <div class="category-section" style="margin-bottom: 32px;">
            <h4 style="font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 16px; padding-left: 12px; border-left: 4px solid var(--primary);">
              <span>${numberToChinese(projectIndex)}、${pg.projectName}</span>
            </h4>
        `;
        
        let firstLevelIndex = 1;
        
        if (Object.keys(pg.labelHierarchy).length === 0) {
          html += '<div style="margin-left: 20px; color: var(--text-secondary);">暂无任务</div>';
        } else {
          // 对标签进行排序：普通标签在前，"其他"分类在后
          const sortedFirstLevels = Object.values(pg.labelHierarchy).sort((a, b) => {
            // "其他"分类排在最后
            if (a.isOther && !b.isOther) return 1;
            if (!a.isOther && b.isOther) return -1;
            // 其他情况保持原顺序
            return 0;
          });
          
          // 渲染第一级标签
          sortedFirstLevels.forEach(firstLevel => {
            const firstLevelProgress = firstLevel.stats.total > 0 
              ? Math.round(firstLevel.stats.done / firstLevel.stats.total * 100) 
              : 0;
            const firstLevelProgressColor = firstLevelProgress >= 100 ? 'var(--success)' : (firstLevelProgress >= 50 ? 'var(--warning)' : 'var(--text-secondary)');
            
            html += `
              <div style="margin-left: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; margin-bottom: 16px; padding: 10px 16px; background: #f8fafc; border-radius: 8px; border-left: 3px solid var(--primary);">
                  <span style="font-size: 15px; font-weight: 600; color: var(--text-main);">
                    ${firstLevelIndex}. ${firstLevel.name}
                  </span>
                </div>
            `;
            
            let lastLevelIndex = 1;
            
            // 渲染最后一级标签
            Object.values(firstLevel.children).forEach(lastLevel => {
              const lastLevelProgress = lastLevel.stats.total > 0 
                ? Math.round(lastLevel.stats.done / lastLevel.stats.total * 100) 
                : 0;
              const lastLevelProgressColor = lastLevelProgress >= 100 ? 'var(--success)' : (lastLevelProgress >= 50 ? 'var(--warning)' : 'var(--text-secondary)');
              
              html += `
                <div style="margin-left: 20px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: #f8fafc; border-radius: 6px;">
                    <span style="font-size: 14px; font-weight: 600; color: var(--text-main);">
                      (${lastLevelIndex}) ${lastLevel.name}
                    </span>
                  </div>
                  
                  <div style="margin-left: 20px;">
                    <div style="margin: 0; padding-left: 0; list-style: none;">
              `;
              
              lastLevel.tasks.forEach((task, idx) => {
                const statusClass = `status-${task.aggregatedStatus || task.status || 'todo'}`;
                const statusText = getStatusText(task.aggregatedStatus || task.status);
                const taskProgress = calculateTaskProgress(task);
                const taskProgressColor = taskProgress >= 100 ? 'var(--success)' : (taskProgress >= 50 ? 'var(--warning)' : 'var(--text-secondary)');
                
                html += `
                      <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; margin-bottom: 6px; background: var(--bg-surface); border-radius: 6px;">
                        <span style="color: var(--text-secondary); font-size: 12px; min-width: 20px;">${numberToCircle(idx + 1)}</span>
                        <span style="flex: 1; color: var(--text-main); font-size: 13px;">${task.title || task.name || task.code || '未命名任务'}</span>
                        <div style="display: flex; align-items: center; gap: 6px; min-width: 80px;">
                          <div style="flex: 1; max-width: 40px; height: 4px; background: var(--border-light); border-radius: 2px; overflow: hidden;">
                            <div style="width: ${taskProgress}%; height: 100%; background: ${taskProgressColor}; border-radius: 2px;"></div>
                          </div>
                          <span style="color: ${taskProgressColor}; font-weight: 600; font-size: 11px; min-width: 28px;">${taskProgress}%</span>
                        </div>
                        <span class="status-badge ${statusClass}" style="font-size: 9px; padding: 2px 8px; flex-shrink: 0;">${statusText}</span>
                      </div>
                `;
              });
              
              html += `
                    </div>
                  </div>
                </div>
              `;
              lastLevelIndex++;
            });
            
            html += '</div>';
            firstLevelIndex++;
          });
        }
        
        // 添加非开发工作说明和下周工作计划
        if (pg.nonDevWorks && pg.nonDevWorks.length > 0) {
          // 按工作类型分组
          const otherWorks = pg.nonDevWorks.filter(w => w.work_type === 'other_work');
          const nextWeekPlans = pg.nonDevWorks.filter(w => w.work_type === 'next_week_plan');
          
          // 渲染其他工作说明
          if (otherWorks.length > 0) {
            html += `
              <div style="margin-left: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; margin-bottom: 16px; padding: 10px 16px; background: #f8fafc; border-radius: 8px; border-left: 3px solid var(--primary);">
                  <span style="font-size: 15px; font-weight: 600; color: var(--text-main);">
                    ${firstLevelIndex}. 其他工作说明
                  </span>
                </div>
                
                <div style="margin-left: 20px;">
                  <div style="margin: 0; padding-left: 0; list-style: none;">
            `;
            
            otherWorks.forEach((work, idx) => {
              html += `
                <div style="margin-left: 20px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: #f8fafc; border-radius: 6px;">
                    <span style="font-size: 14px; font-weight: 600; color: var(--text-main);">
                      (${idx + 1}) ${work.title || '未命名工作'}
                    </span>
                  </div>
              `;
              
              // 如果有描述，添加描述内容
              if (work.description) {
                html += `
                  <div style="margin-left: 20px;">
                    <div style="padding: 8px 12px; background: var(--bg-subtle); border-radius: 4px; border-left: 2px solid var(--border-light);">
                      <span style="color: var(--text-secondary); font-size: 13px; font-style: italic;">${work.description}</span>
                    </div>
                  </div>
                `;
              }
              
              html += `</div>`;
            });
            
            html += `
                  </div>
                </div>
              </div>
            `;
            firstLevelIndex++;
          }
          
          // 渲染下周工作计划
          if (nextWeekPlans.length > 0) {
            html += `
              <div style="margin-left: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; margin-bottom: 16px; padding: 10px 16px; background: #f8fafc; border-radius: 8px; border-left: 3px solid var(--primary);">
                  <span style="font-size: 15px; font-weight: 600; color: var(--text-main);">
                    ${firstLevelIndex}. 下周工作计划
                  </span>
                </div>
                
                <div style="margin-left: 20px;">
                  <div style="margin: 0; padding-left: 0; list-style: none;">
            `;
            
            nextWeekPlans.forEach((work, idx) => {
              html += `
                <div style="margin-left: 20px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: #f8fafc; border-radius: 6px;">
                    <span style="font-size: 14px; font-weight: 600; color: var(--text-main);">
                      (${idx + 1}) ${work.title || '未命名计划'}
                    </span>
                  </div>
              `;
              
              // 如果有描述，添加描述内容
              if (work.description) {
                html += `
                  <div style="margin-left: 20px;">
                    <div style="padding: 8px 12px; background: var(--bg-subtle); border-radius: 4px; border-left: 2px solid var(--border-light);">
                      <span style="color: var(--text-secondary); font-size: 13px; font-style: italic;">${work.description}</span>
                    </div>
                  </div>
                `;
              }
              
              html += `</div>`;
            });
            
            html += `
                  </div>
                </div>
              </div>
            `;
          }
        }
        
        html += '</div>';
        projectIndex++;
      });
      
      return html;
    }
    
    // 计算任务进度（根据开始/结束时间和当前时间，或子任务完成情况）
    function calculateTaskProgress(task) {
      // 如果是JOB且有子任务，根据子任务完成情况计算进度
      if (task.subtasks && Array.isArray(task.subtasks) && task.subtasks.length > 0) {
        const completedSubtasks = task.subtasks.filter(subtask => subtask.status === 'done').length;
        return Math.round((completedSubtasks / task.subtasks.length) * 100);
      }
      
      // 如果已完成，返回100%
      if (task.status === 'done' || task.aggregatedStatus === 'done') {
        return 100;
      }
      
      // 如果是待办，返回0%
      if (task.status === 'todo' || task.aggregatedStatus === 'todo' || !task.status) {
        return 0;
      }
      
      // 进行中状态，根据时间计算进度
      const startDate = task.planned_start || task.planned_start_date;
      const endDate = task.planned_end || task.planned_end_date;
      
      if (!startDate || !endDate) {
        // 没有时间信息，默认返回50%
        return 50;
      }
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      const now = new Date();
      
      // 如果当前时间早于开始时间，进度为0
      if (now < start) {
        return 0;
      }
      
      // 如果当前时间晚于或等于结束时间，进度为100
      if (now >= end) {
        return 100;
      }
      
      // 计算进度百分比
      const totalDuration = end.getTime() - start.getTime();
      const elapsed = now.getTime() - start.getTime();
      const progress = Math.round((elapsed / totalDuration) * 100);
      
      // 确保返回整数，范围在0-100之间
      return Math.max(0, Math.min(100, progress));
    }

    // 数字转中文数字
    function numberToChinese(num) {
      const chineseNumbers = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
      const chineseUnits = ['', '十', '百', '千'];
      
      if (num === 0) return '零';
      if (num < 10) return chineseNumbers[num];
      if (num === 10) return '十';
      if (num < 20) return '十' + chineseNumbers[num % 10];
      if (num < 100) {
        const tens = Math.floor(num / 10);
        const ones = num % 10;
        return chineseNumbers[tens] + '十' + (ones > 0 ? chineseNumbers[ones] : '');
      }
      
      // 处理更大的数字（简化版）
      return num.toString();
    }

    // 数字转圆圈数字
    function numberToCircle(num) {
      const circleNumbers = ['⓪', '①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩', 
                           '⑪', '⑫', '⑬', '⑭', '⑮', '⑯', '⑰', '⑱', '⑲', '⑳'];
      
      if (num >= 0 && num < circleNumbers.length) {
        return circleNumbers[num];
      }
      
      // 超出范围时使用普通数字加圆圈
      return `㊣${num}`;
    }

    // 导出Word文档
    function exportToWord() {
      if (!reportData) return;
      
      const reportTypeNames = { weekly: '周报', monthly: '月报', yearly: '年报' };
      const completionRate = reportData.summary.totalTasks > 0 
        ? Math.round(reportData.summary.completedTasks / reportData.summary.totalTasks * 100) 
        : 0;
      
      // 生成与页面一致的内容
      let contentHtml = `
        <div class="report-container">
          <div class="report-header">
            <div class="report-title">${reportTypeNames[reportData.reportType]}</div>
            <div class="report-period">${formatDateRange(reportData.startDate, reportData.endDate)}</div>
          </div>
          
          <div class="report-section">
            <h3 class="section-title">项目概览</h3>
            <table class="kpi-table">
              <tr>
                <td class="kpi-card">
                  <div class="kpi-value">${reportData.summary.totalProjects}</div>
                  <div class="kpi-label">涉及项目</div>
                </td>
                <td class="kpi-card">
                  <div class="kpi-value">${reportData.summary.totalTasks}</div>
                  <div class="kpi-label">总任务数</div>
                </td>
                <td class="kpi-card">
                  <div class="kpi-value">${reportData.summary.completedTasks}</div>
                  <div class="kpi-label">已完成任务</div>
                </td>
                <td class="kpi-card">
                  <div class="kpi-value">${completionRate}%</div>
                  <div class="kpi-label">完成率</div>
                </td>
              </tr>
            </table>
          </div>
          
          <div class="report-section">
            ${generateWordProjectGroups(reportData.projectGroups)}
          </div>
        </div>
      `;
      
      const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>工作报告</title>
          <style>
            @page {
              margin: 2cm 2.5cm;
              size: A4;
            }
            
            body { 
              font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif !important; 
              margin: 0 !important; 
              padding: 0 !important; 
              line-height: 1.6; 
              color: #2c3e50;
              background: #ffffff;
              font-size: 14px;
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
              zoom: 1.4; /* 140%缩放 */
            }
            
            * {
              font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif !important;
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            
            .report-container {
              width: calc(100% - 12cm) !important; /* 稍微增加左右留白，从10cm改为12cm */
              max-width: none !important;
              margin: 0 6cm !important; /* 左右各6cm留白，从5cm增加 */
              padding: 32px 0 !important;
              font-family: "Microsoft YaHei", "微软雅黑";
              background: #ffffff;
              border: none;
              box-sizing: border-box;
            }
            
            /* 报告头部 */
            .report-header { 
              text-align: center; 
              margin-bottom: 32px; 
              padding-bottom: 20px; 
              border-bottom: 3px solid #4f46e5; 
              font-family: "Microsoft YaHei", "微软雅黑";
              margin-left: 0px;
              margin-right: 0px;
            }
            .report-title { 
              font-size: 24px; 
              font-weight: bold; 
              margin-bottom: 8px; 
              color: #0f172a;
              letter-spacing: 1px;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            .report-period { 
              font-size: 16px; 
              color: #64748b; 
              font-weight: 500;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            /* 概览部分 */
            .report-section { 
              margin-bottom: 8px; 
              font-family: "Microsoft YaHei", "微软雅黑";
              margin-left: 0px;
              margin-right: 0px;
            }
            .section-title { 
              font-size: 18px; 
              font-weight: bold; 
              margin: 0 0 12px 0; 
              padding: 8px 0;
              color: #0f172a;
              background: transparent;
              border: none;
              font-family: "Microsoft YaHei", "微软雅黑";
              width: 100%;
              box-sizing: border-box;
            }
            
            /* KPI 卡片 */
            .kpi-table { 
              width: 70%; /* 恢复原来的70%宽度 */
              border-collapse: separate;
              border-spacing: 4px;
              margin-bottom: 20px; 
              table-layout: fixed;
              margin-left: auto;
              margin-right: auto;
            }
            .kpi-card { 
              border: 2px solid #bdc3c7; 
              padding: 12px 8px; 
              text-align: center; 
              width: 25%;
              background: #f8f9fa;
              border-radius: 8px;
              vertical-align: top;
            }
            .kpi-value { 
              font-size: 24px; 
              font-weight: bold; 
              color: #4f46e5; 
              margin-bottom: 4px; 
              display: block;
            }
            .kpi-label { 
              font-size: 11px; 
              color: #64748b; 
              font-weight: 500;
            }
            
            /* 项目部分 */
            .project-section {
              margin-bottom: 24px;
              margin-top: 8px;
              page-break-inside: avoid;
              margin-left: 0px;
              margin-right: 0px;
              max-width: 100%;
            }
            
            .project-header {
              color: #2c3e50 !important;
              padding: 16px 24px;
              margin-bottom: 4px;
              border-radius: 8px;
              font-size: 18px;
              font-weight: bold;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-family: "Microsoft YaHei", "微软雅黑" !important;
              width: 100%;
              box-sizing: border-box;
            }
            
            .project-header span {
              color: #2c3e50 !important;
              font-family: "Microsoft YaHei", "微软雅黑" !important;
            }
            
            .project-progress {
              font-size: 16px;
              font-weight: 600;
              background: #34495e !important;
              color: #ffffff !important;
              padding: 6px 16px;
              border-radius: 25px;
              font-family: "Microsoft YaHei", "微软雅黑" !important;
              border: 1px solid #ffffff;
            }
            
            /* 第一级标签 */
            .first-level-section {
              margin: 4px 0 4px 20px;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            .first-level-header {
              background: #f8fafc;
              border-left: 4px solid #4f46e5;
              padding: 10px 16px;
              margin-bottom: 4px;
              border-radius: 0 4px 4px 0;
              font-size: 15px;
              font-weight: 600;
              color: #0f172a;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            .first-level-stats {
              font-size: 13px;
              color: #7f8c8d;
              font-weight: 500;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            /* 最后一级标签 */
            .last-level-section {
              margin: 4px 0 4px 30px;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            .last-level-header {
              background: #f8fafc;
              border-left: 3px solid #4f46e5;
              padding: 6px 12px;
              margin-bottom: 4px;
              border-radius: 0 3px 3px 0;
              font-size: 14px;
              font-weight: 600;
              color: #0f172a;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            .last-level-progress {
              font-size: 12px;
              color: #7f8c8d;
              font-weight: 500;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            /* 任务列表 */
            .task-list {
              margin-left: 30px;
              font-family: "Microsoft YaHei", "微软雅黑";
            }
            
            .task-list table {
              border: 1px solid #f5f5f5;
              border-collapse: collapse;
            }
            
            .task-list table tr {
              border: 1px solid #f5f5f5;
            }
            
            .task-list table td {
              border: 1px solid #f8f8f8;
            }
            
            .task-item {
              margin-bottom: 2px;
              padding: 2px 0;
              font-size: 13px;
              line-height: 1.2;
            }
            
            .progress-high { color: #27ae60; }
            .progress-medium { color: #f39c12; }
            .progress-low { color: #95a5a6; }
            
            .status-done { color: #27ae60; }
            .status-doing { color: #f39c12; }
            .status-todo { color: #95a5a6; }
            
            /* 空状态 */
            .empty-tasks {
              color: #95a5a6;
              font-style: italic;
              font-size: 13px;
              padding: 8px 0;
            }
            
            .task-status {
              font-size: 11px;
              font-weight: 600;
              padding: 3px 8px;
              border-radius: 12px;
              text-align: center;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              display: inline-block;
              width: 50px;
            }
            
            .status-done {
              background: #d5f4e6;
              color: #27ae60;
              border: 1px solid #27ae60;
            }
            
            .status-doing {
              background: #fef9e7;
              color: #f39c12;
              border: 1px solid #f39c12;
            }
            
            .status-todo {
              background: #f4f6f7;
              color: #95a5a6;
              border: 1px solid #bdc3c7;
            }
            
            /* 空状态 */
            .empty-tasks {
              color: #95a5a6;
              font-style: italic;
              font-size: 13px;
              padding: 8px;
              text-align: center;
            }
            
            /* 打印样式 - 确保打印预览和Word导出一致 */
            @media print {
              body {
                font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.6;
                color: #2c3e50 !important;
                background: #ffffff !important;
                font-size: 14px;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                zoom: 1.4 !important; /* 保持140%缩放 */
              }
              
              .report-container {
                width: calc(100% - 12cm) !important; /* 稍微增加左右留白 */
                margin: 0 6cm !important;
                padding: 32px 0 !important;
                background: #ffffff !important;
                border: none !important;
                box-sizing: border-box;
              }
              
              .report-header {
                border-bottom: 3px solid #4f46e5 !important;
              }
              
              .project-header {
                color: #2c3e50 !important;
              }
              
              .kpi-table {
                width: 70% !important;
                margin-left: auto !important;
                margin-right: auto !important;
              }
              
              .kpi-card {
                border: 2px solid #bdc3c7 !important;
                background: #f8f9fa !important;
              }
            }
          </style>
        </head>
        <body>${contentHtml}</body>
        </html>
      `;
      
      const blob = new Blob([fullHtml], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `工作报告_${formatDate(new Date())}.docx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('报告已导出为DOCX格式', 'success');
    }
    
    // 生成Word文档的项目分组内容（三级：项目 -> 第一级标签 -> 最后一级标签）
    function generateWordProjectGroups(projectGroups) {
      if (!projectGroups || Object.keys(projectGroups).length === 0) {
        return '<div style="text-align: center; color: #95a5a6; font-style: italic; padding: 40px;">暂无任务数据</div>';
      }
      
      let html = '';
      let projectIndex = 1;
      
      Object.values(projectGroups).forEach(pg => {
        const projectProgress = pg.stats.total > 0 
          ? Math.round(pg.stats.done / pg.stats.total * 100) 
          : 0;
        
        // 项目标题
        html += `
          <div class="project-section">
            <div style="color: #0f172a !important; padding: 16px 0; margin-bottom: 20px; font-size: 18px; font-weight: bold; font-family: 'Microsoft YaHei', '微软雅黑' !important; width: 100%; box-sizing: border-box;">
              <span style="color: #0f172a !important; font-weight: bold !important; font-family: 'Microsoft YaHei', '微软雅黑' !important;">${numberToChinese(projectIndex)}、${pg.projectName}</span>
            </div>
        `;
        
        let firstLevelIndex = 1;
        
        if (Object.keys(pg.labelHierarchy).length === 0) {
          html += '<div class="empty-tasks">暂无任务</div>';
        } else {
          // 对标签进行排序：普通标签在前，"其他"分类在后
          const sortedFirstLevels = Object.values(pg.labelHierarchy).sort((a, b) => {
            // "其他"分类排在最后
            if (a.isOther && !b.isOther) return 1;
            if (!a.isOther && b.isOther) return -1;
            // 其他情况保持原顺序
            return 0;
          });
          
          // 渲染第一级标签
          sortedFirstLevels.forEach(firstLevel => {
            const firstLevelProgress = firstLevel.stats.total > 0 
              ? Math.round(firstLevel.stats.done / firstLevel.stats.total * 100) 
              : 0;
            
            html += `
              <div class="first-level-section">
                <div class="first-level-header">
                  <span>${firstLevelIndex}. ${firstLevel.name}</span>
                </div>
            `;
            
            let lastLevelIndex = 1;
            
            // 渲染最后一级标签
            Object.values(firstLevel.children).forEach(lastLevel => {
              const lastLevelProgress = lastLevel.stats.total > 0 
                ? Math.round(lastLevel.stats.done / lastLevel.stats.total * 100) 
                : 0;
              
              html += `
                <div class="last-level-section">
                  <div class="last-level-header">
                    <span>(${lastLevelIndex}) ${lastLevel.name}</span>
                  </div>
                  
                  <div class="task-list">
                    <table style="width: 60%; border-collapse: collapse; margin-left: 0; border: 1px solid #f5f5f5;">
              `;
              
              // 渲染任务列表
              if (lastLevel.tasks.length === 0) {
                html += '<tr><td colspan="4" style="color: #95a5a6; font-style: italic; padding: 8px 12px; border: 1px solid #f8f8f8; text-align: center; font-family: \'Microsoft YaHei\', \'微软雅黑\';">暂无任务</td></tr>';
              } else {
                lastLevel.tasks.forEach((task, idx) => {
                  const statusText = getStatusText(task.aggregatedStatus || task.status);
                  const taskProgress = calculateTaskProgress(task);
                  
                  const progressColor = taskProgress >= 80 ? '#27ae60' : (taskProgress >= 40 ? '#f39c12' : '#95a5a6');
                  const statusColor = (task.aggregatedStatus || task.status) === 'done' ? '#27ae60' : ((task.aggregatedStatus || task.status) === 'doing' ? '#f39c12' : '#95a5a6');
                  
                  html += `
                    <tr style="border: 1px solid #f5f5f5;">
                      <td style="width: 24px; color: #95a5a6; font-size: 12px; padding: 4px 1px; border: 1px solid #f8f8f8; vertical-align: top; text-align: center; font-family: 'Microsoft YaHei', '微软雅黑';">${numberToCircle(idx + 1)}</td>
                      <td style="width: 236px; color: #0f172a; font-size: 13px; padding: 4px 6px; border: 1px solid #f8f8f8; vertical-align: top; font-family: 'Microsoft YaHei', '微软雅黑';">${task.title || task.name || task.code || '未命名任务'}</td>
                      <td style="width: 50px; color: ${progressColor}; font-weight: 600; font-size: 12px; text-align: center; padding: 4px 6px; border: 1px solid #f8f8f8; vertical-align: top; font-family: 'Microsoft YaHei', '微软雅黑';">${taskProgress}%</td>
                      <td style="width: 60px; color: ${statusColor}; font-size: 11px; padding: 4px 6px; border: 1px solid #f8f8f8; vertical-align: top; text-align: center; font-family: 'Microsoft YaHei', '微软雅黑';">[${statusText}]</td>
                    </tr>
                  `;
                });
              }
              
              html += `
                    </table>
                  </div>
                </div>
              `;
              lastLevelIndex++;
            });
            
            html += '</div>';
            firstLevelIndex++;
          });
          
          // 添加非开发工作说明和下周工作计划
          if (pg.nonDevWorks && pg.nonDevWorks.length > 0) {
            // 按工作类型分组
            const otherWorks = pg.nonDevWorks.filter(w => w.work_type === 'other_work');
            const nextWeekPlans = pg.nonDevWorks.filter(w => w.work_type === 'next_week_plan');
            
            // 渲染其他工作说明
            if (otherWorks.length > 0) {
              html += `
                <div class="first-level-section">
                  <div class="first-level-header">
                    <span>${firstLevelIndex}. 其他工作说明</span>
                  </div>
              `;
              
              otherWorks.forEach((work, idx) => {
                html += `
                  <div class="last-level-section">
                    <div class="last-level-header">
                      <span>(${idx + 1}) ${work.title || '未命名工作'}</span>
                    </div>
                `;
                
                // 如果有描述，添加描述内容
                if (work.description) {
                  html += `
                    <div style="margin-left: 30px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px; border-left: 2px solid #ddd; margin-bottom: 10px;">
                      <span style="color: #64748b; font-size: 12px; font-style: italic; font-family: 'Microsoft YaHei', '微软雅黑';">${work.description}</span>
                    </div>
                  `;
                }
                
                html += `</div>`;
              });
              
              html += `</div>`;
              firstLevelIndex++;
            }
            
            // 渲染下周工作计划
            if (nextWeekPlans.length > 0) {
              html += `
                <div class="first-level-section">
                  <div class="first-level-header">
                    <span>${firstLevelIndex}. 下周工作计划</span>
                  </div>
              `;
              
              nextWeekPlans.forEach((work, idx) => {
                html += `
                  <div class="last-level-section">
                    <div class="last-level-header">
                      <span>(${idx + 1}) ${work.title || '未命名计划'}</span>
                    </div>
                `;
                
                // 如果有描述，添加描述内容
                if (work.description) {
                  html += `
                    <div style="margin-left: 30px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px; border-left: 2px solid #ddd; margin-bottom: 10px;">
                      <span style="color: #64748b; font-size: 12px; font-style: italic; font-family: 'Microsoft YaHei', '微软雅黑';">${work.description}</span>
                    </div>
                  `;
                }
                
                html += `</div>`;
              });
              
              html += `</div>`;
            }
          }
        }
        
        html += '</div>';
        projectIndex++;
      });
      
      return html;
    }
    
    // 打印报告
    function printReport() {
      if (!reportData) return;
      window.print();
    }
    
    // 工具函数
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function formatDateRange(startDate, endDate) {
      const start = new Date(startDate).toLocaleDateString('zh-CN');
      const end = new Date(endDate).toLocaleDateString('zh-CN');
      return `${start} - ${end}`;
    }
    
    function getStatusText(status) {
      const statusMap = { todo: '待办', doing: '进行中', done: '已完成', blocked: '阻塞', cancelled: '已取消' };
      return statusMap[status] || '待办';
    }
    
    function getPriorityText(priority) {
      const priorityMap = { low: 'Low', medium: 'Medium', high: 'High' };
      return priorityMap[priority] || 'Medium';
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // 当非开发工作发生变化时重新生成报告
    window.regenerateReportAfterNonDevWorkChange = async function() {
      if (reportData) {
        // 重新获取项目数据以包含最新的非开发工作
        const selectedProjects = getSelectedProjects();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const reportType = document.getElementById('reportType').value;
        
        try {
          const projectsData = await Promise.all(
            selectedProjects.map(projectId => fetchProjectData(projectId, startDate, endDate))
          );
          
          // 重新处理和渲染报告数据
          reportData = processReportData(projectsData, reportType, startDate, endDate);
          renderReport(reportData);
          
          // 注意：不需要再次更新非开发工作管理器，因为数据已经是最新的了
        } catch (error) {
          
        }
      }
    };
  </script>
</body>
</html>